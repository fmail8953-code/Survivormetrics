<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SurvivorMetrics</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,400;0,600;0,700;0,800;0,900;1,700;1,800;1,900&family=Barlow:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Barlow',sans-serif;background:#f1f5f9;color:#1e293b;min-height:100vh}
.app{max-width:1280px;margin:0 auto;padding:20px 12px 80px}
.panel{background:#fff;border-radius:14px;border:1px solid #e2e8f0;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.06);margin-bottom:20px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
label.lbl{display:block;font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px}
input[type=text],input[type=number],select{border:1px solid #cbd5e1;border-radius:8px;padding:7px 10px;font-size:14px;width:100%;outline:none;background:#f8fafc;transition:border .2s}
input:focus,select:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,.1)}
.field{display:flex;flex-direction:column;gap:4px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer;border:none;transition:all .15s;user-select:none;white-space:nowrap}
.btn:active{transform:scale(.97)}
.btn-indigo{background:#6366f1;color:#fff}.btn-indigo:hover{background:#4f46e5}
.btn-emerald{background:#10b981;color:#fff}.btn-emerald:hover{background:#059669}
.btn-amber{background:#f59e0b;color:#fff}.btn-amber:hover{background:#d97706}
.btn-pink{background:#ec4899;color:#fff}.btn-pink:hover{background:#db2777}
.btn-red{background:#ef4444;color:#fff}.btn-red:hover{background:#dc2626}
.btn-full{width:100%;justify-content:center}
.btn-sm{padding:7px 12px;font-size:12px}
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);backdrop-filter:blur(6px);z-index:50;justify-content:center;align-items:flex-start;padding:10px;overflow-y:auto}
.modal-bg.open{display:flex}
.modal{background:#fff;border-radius:18px;width:100%;max-width:980px;padding:24px;position:relative;margin:auto}
.modal-lg{max-width:1180px}
.modal-close{position:absolute;top:14px;right:14px;background:none;border:none;cursor:pointer;font-size:22px;color:#94a3b8;line-height:1;z-index:2}
.modal-close:hover{color:#1e293b}
.modal-title{font-size:22px;font-weight:900;text-transform:uppercase;border-bottom:2px solid #f1f5f9;padding-bottom:14px;margin-bottom:20px}
.section-label{font-size:11px;font-weight:900;color:#94a3b8;text-transform:uppercase;letter-spacing:.1em;border-bottom:1px solid #f1f5f9;padding-bottom:6px;margin-bottom:10px}
h2.panel-title{font-size:16px;font-weight:800;text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.dot{width:12px;height:12px;border-radius:50%;display:inline-block;flex-shrink:0}
.dot-red{background:#ef4444}.dot-blue{background:#3b82f6}
table{width:100%;border-collapse:collapse;font-size:13px}
th{padding:7px 8px;text-align:left;font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;border-bottom:2px solid #e2e8f0}
td{padding:10px 8px;border-bottom:1px solid #f1f5f9}
tr:hover td{background:#f8fafc}
.tc{text-align:center}
.preview-label{text-align:center;font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px}
.preview-wrap{overflow:hidden;background:#e2e8f0;border-radius:14px;border:2px dashed #cbd5e1;display:flex;justify-content:center;align-items:flex-start;padding:16px}
.scaler{transform-origin:top center;display:block}
.canvas{width:1080px;background:#0c0f18;display:flex;flex-direction:column;position:relative}
.cv-header{display:flex;flex-direction:column;align-items:center;padding:30px 20px 14px;color:white;position:relative;z-index:2}
.cv-ht{font-size:15px;letter-spacing:.5em;font-weight:700;opacity:.85;text-transform:uppercase;margin-bottom:10px;font-family:'Barlow Condensed',sans-serif}
.cv-title{font-size:66px;font-weight:900;letter-spacing:.25em;font-style:italic;margin-bottom:16px;font-family:'Barlow Condensed',sans-serif}
.cv-badges{display:flex;gap:16px;flex-wrap:wrap;justify-content:center}
.cv-badge{background:#1a2333;padding:9px 24px;border-radius:6px;font-size:12px;font-weight:700;letter-spacing:.14em;color:white;border:2px solid rgba(255,255,255,.15);text-transform:uppercase;font-family:'Barlow Condensed',sans-serif}
.wm{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:1;opacity:.13;user-select:none}
.wm span{font-size:86px;font-weight:800;text-transform:uppercase;letter-spacing:.3em;color:white;transform:rotate(-30deg);white-space:nowrap;font-family:'Barlow Condensed',sans-serif}
.divider{height:2px;background:rgba(0,0,0,.4);position:relative;z-index:2;flex-shrink:0}
.action-bar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:20px}
.vs-bar{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.vs-text{font-size:20px;font-weight:900}
@media(max-width:820px){
  .g2{grid-template-columns:1fr}
  .g4{grid-template-columns:1fr 1fr}
}
@media(max-width:520px){
  .g3,.g4{grid-template-columns:1fr 1fr}
  .btn{font-size:12px;padding:8px 10px}
  .modal{padding:14px}
  .app{padding:10px 8px 60px}
  .cv-title{font-size:44px}
  .cv-ht{font-size:11px;letter-spacing:.3em}
}
/* THEMES */
body.theme-dark{background:#0f172a;color:#e2e8f0}
body.theme-dark .panel{background:#1e293b;border-color:#334155;color:#e2e8f0}
body.theme-dark .modal{background:#1e293b;color:#e2e8f0}
body.theme-dark input,body.theme-dark select{background:#0f172a;color:#e2e8f0;border-color:#334155}
body.theme-dark .section-label{color:#64748b}
body.theme-dark table th{color:#64748b}
body.theme-dark tr:hover td{background:#0f172a}
body.theme-broadcast{background:#020617;color:#93c5fd}
body.theme-broadcast .panel{background:#0f172a;border-color:#1e40af;color:#bfdbfe}
body.theme-broadcast .modal{background:#0f172a;color:#bfdbfe}
body.theme-broadcast input,body.theme-broadcast select{background:#020617;color:#93c5fd;border-color:#1e40af}
body.theme-final{background:linear-gradient(135deg,#1c0a00,#2a1200)}
body.theme-final .panel{background:rgba(120,53,15,.3);border-color:#92400e;color:#fde68a}
body.theme-final .modal{background:#1c0a00;color:#fde68a}
body.theme-final input,body.theme-final select{background:#2a1200;color:#fde68a;border-color:#92400e}
body.theme-allstar{background:linear-gradient(135deg,#0d0520,#1e1b4b)}
body.theme-allstar .panel{background:rgba(76,29,149,.3);border-color:#6d28d9;color:#e9d5ff}
body.theme-allstar .modal{background:#0d0520;color:#e9d5ff}
body.theme-allstar input,body.theme-allstar select{background:#1e1b4b;color:#e9d5ff;border-color:#6d28d9}
/* POWER CARD */
.power-card{border-radius:16px;overflow:hidden;transition:transform .2s,box-shadow .2s;cursor:pointer}
.power-card:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(0,0,0,.18)}
.power-score-ring{width:90px;height:90px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;border:5px solid rgba(255,255,255,.3);margin:0 auto 10px;position:relative}
.power-badge{padding:5px 14px;border-radius:20px;font-size:12px;font-weight:800;display:inline-flex;align-items:center;gap:5px}
/* RANK BADGES */
@keyframes badgePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.rank-badge{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;font-size:14px;animation:badgePulse 2s infinite}
/* BROADCAST */
.broadcast-score{display:flex;align-items:center;justify-content:center;gap:40px;padding:24px;background:#0c0f18;color:white;border-radius:12px}
.broadcast-faces{display:flex;align-items:center;justify-content:space-around;padding:20px;background:#0c0f18;color:white;border-radius:12px}
.broadcast-bar{background:linear-gradient(to right,#1a0000,#000a2e);color:white;padding:10px 28px;border-radius:8px;display:flex;align-items:center;gap:24px}
/* SIM CARD */
.sim-card{background:#f8fafc;border-radius:12px;padding:12px;border:1px solid #e2e8f0}
/* H2H PLUS */
.h2h-stat-box{background:#f8fafc;border-radius:12px;padding:14px;text-align:center}
.h2h-stat-box .val{font-size:28px;font-weight:900}
.h2h-stat-box .lbl2{font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;margin-top:2px}
/* PERF FLOW */
.flow-item{padding:10px 16px;border-radius:10px;text-align:center;font-weight:700;font-size:13px;min-width:90px;position:relative}
.flow-item::after{content:'â†’';position:absolute;right:-14px;top:50%;transform:translateY(-50%);color:#94a3b8;font-size:16px}
.flow-item:last-child::after{display:none}
</style>

<style id="playerPhotoFix">
.player-photo{
  width:100%;
  height:100%;
  object-fit:cover;
  object-position:center;
  display:block;
}
.photo-container{
  width:60px;
  height:60px;
  border-radius:50%;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}
</style>

</head>
<body>
<div class="app">

<div class="panel">
  <div class="g4">
    <div class="field"><label class="lbl">Ãœst BaÅŸlÄ±k</label><input type="text" id="cfg_ht" value="DOKUNULMAZLIK OYUNU | SURVIVORMETRICS" oninput="renderMain()"></div>
    <div class="field"><label class="lbl">Ana BaÅŸlÄ±k</label><input type="text" id="cfg_title" value="SURVIVOR 2026" oninput="renderMain()"></div>
    <div class="field" style="grid-column:span 2">
      <label class="lbl">Oyun TÃ¼rÃ¼ (Rozet)</label>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:6px">
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <span style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;min-width:60px">Parkur</span>
          <button type="button" data-group="gt_parkur" data-val="PARKUR" onclick="toggleMainGT('gt_parkur','PARKUR',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸƒ Parkur</button>
          <button type="button" data-group="gt_parkur" data-val="PARKUR DIÅI" onclick="toggleMainGT('gt_parkur','PARKUR DIÅI',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ¯ Parkur DÄ±ÅŸÄ±</button>
        </div>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <span style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;min-width:60px">AtÄ±ÅŸ</span>
          <button type="button" data-group="gt_atis" data-val="TOP" onclick="toggleMainGT('gt_atis','TOP',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">âš½ Top</button>
          <button type="button" data-group="gt_atis" data-val="BASKET" onclick="toggleMainGT('gt_atis','BASKET',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ€ Basket</button>
          <button type="button" data-group="gt_atis" data-val="STICK" onclick="toggleMainGT('gt_atis','STICK',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ’ Stick</button>
          <button type="button" data-group="gt_atis" data-val="DÄ°SK" onclick="toggleMainGT('gt_atis','DÄ°SK',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ¥ Disk</button>
          <button type="button" data-group="gt_atis" data-val="BUMERANG" onclick="toggleMainGT('gt_atis','BUMERANG',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸªƒ Bumerang</button>
          <button type="button" data-group="gt_atis" data-val="DAMBIL" onclick="toggleMainGT('gt_atis','DAMBIL',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ‹ DambÄ±l</button>
          <button type="button" data-group="gt_atis" data-val="KÃœP" onclick="toggleMainGT('gt_atis','KÃœP',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ“¦ KÃ¼p</button>
          <button type="button" data-group="gt_atis" data-val="HALKA" onclick="toggleMainGT('gt_atis','HALKA',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">â­• Halka</button>
          <button type="button" data-group="gt_atis" data-val="Ã‡EKÄ°Ã‡" onclick="toggleMainGT('gt_atis','Ã‡EKÄ°Ã‡',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ”¨ Ã‡ekiÃ§</button>
          <button type="button" data-group="gt_atis" data-val="KUM TORBASI" onclick="toggleMainGT('gt_atis','KUM TORBASI',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ¥Š Kum TorbasÄ±</button>
          <button type="button" data-group="gt_atis" data-val="KONDURMA" onclick="toggleMainGT('gt_atis','KONDURMA',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ¯ Kondurma</button>
        </div>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <span style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;min-width:60px">Format</span>
          <button type="button" data-group="gt_format" data-val="BEST OFF" onclick="toggleMainGT('gt_format','BEST OFF',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">â­ Best Off</button>
        </div>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <span style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;min-width:60px">Oyun</span>
          <button type="button" data-group="gt_oyun" data-val="YARDIMCILI" onclick="toggleMainGT('gt_oyun','YARDIMCILI',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ¤ YardÄ±mcÄ±lÄ±</button>
        </div>
      </div>
      <input type="hidden" id="cfg_b1" value="">
      <input type="hidden" id="cfg_b2" value="">
      <div style="margin-top:10px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">
        <div class="field" style="margin:0;min-width:130px">
          <label class="lbl">ğŸ”´ KÄ±rmÄ±zÄ± TakÄ±m Skoru</label>
          <input type="text" id="e1_score" list="score_opts_main1" placeholder="0â€“12 veya yazÄ±n" oninput="upField(0,'score',this.value)" style="width:100%">
          <datalist id="score_opts_main1"><option value="1"><option value="2"><option value="3"><option value="4"><option value="5"><option value="6"><option value="7"><option value="8"><option value="9"><option value="10"><option value="11"><option value="12"></datalist>
        </div>
        <div class="field" style="margin:0;min-width:130px">
          <label class="lbl">ğŸ”µ Mavi TakÄ±m Skoru</label>
          <input type="text" id="e2_score" list="score_opts_main2" placeholder="0â€“12 veya yazÄ±n" oninput="upField(1,'score',this.value)" style="width:100%">
          <datalist id="score_opts_main2"><option value="1"><option value="2"><option value="3"><option value="4"><option value="5"><option value="6"><option value="7"><option value="8"><option value="9"><option value="10"><option value="11"><option value="12"></datalist>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="panel">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
    <div class="vs-bar">
      <div class="field"><label class="lbl">1. YarÄ±ÅŸmacÄ±</label><select id="sel1" onchange="onSel()"></select></div>
      <span class="vs-text">VS</span>
      <div class="field"><label class="lbl">2. YarÄ±ÅŸmacÄ±</label><select id="sel2" onchange="onSel()"></select></div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-indigo btn-sm" onclick="addPlayer()">+ Yeni YarÄ±ÅŸmacÄ±</button>
      <button class="btn btn-emerald btn-sm" onclick="openM('m_players')">ğŸ‘¥ TÃ¼m YarÄ±ÅŸmacÄ±lar</button>
    </div>
  </div>
</div>

<div class="g2">
  <div class="panel">
    <h2 class="panel-title"><span class="dot dot-red"></span>1. YarÄ±ÅŸmacÄ± AyarlarÄ±</h2>
    <div class="g2" style="margin-bottom:14px">
      <div class="field"><label class="lbl">Ä°sim</label><input type="text" id="e1_name" oninput="upField(0,'name',this.value)"></div>
      <div class="field"><label class="lbl">StatÃ¼</label><select id="e1_status" onchange="upField(0,'status',this.value)"><option value="">â€” Yok â€”</option><option value="KAZANAN">KAZANAN</option><option value="KAPTÄ°N">KAPTÄ°N</option><option value="FÄ°NALÄ°ST">FÄ°NALÄ°ST</option><option value="ELENEN">ELENEN</option></select></div>
      <div class="field"><label class="lbl">TakÄ±m</label><select id="e1_team" onchange="upField(0,'team',this.value)"><option value="kirmizi">KÄ±rmÄ±zÄ±</option><option value="mavi">Mavi</option></select></div>
      <div class="field" style="grid-column:1/-1"><label class="lbl">FotoÄŸraf</label><input type="file" accept="image/*" onchange="upImg(0,this)"></div>
    </div>
    <div class="section-label">Genel Ä°statistikler</div>
    <div class="g3" style="margin-bottom:14px">
      <div class="field"><label class="lbl">Toplam</label><input type="number" id="e1_tt" oninput="upTotal(0,'total',this.value)"></div>
      <div class="field"><label class="lbl">Galibiyet</label><input type="number" id="e1_tw" oninput="upTotal(0,'wins',this.value)"></div>
      <div class="field"><label class="lbl">Yenilgi</label><input type="number" id="e1_tl" oninput="upTotal(0,'losses',this.value)"></div>
    </div>
    <div class="section-label">Birebir Ä°statistikler (SeÃ§ili Rakibe KarÅŸÄ±)</div>
    <div class="g2">
      <div class="field"><label class="lbl">Galibiyet</label><input type="number" id="e1_hw" oninput="upH2H(0,1,'wins',this.value)"></div>
      <div class="field"><label class="lbl">Yenilgi</label><input type="number" id="e1_hl" oninput="upH2H(0,1,'losses',this.value)"></div>
    </div>
  </div>
  <div class="panel">
    <h2 class="panel-title"><span class="dot dot-blue"></span>2. YarÄ±ÅŸmacÄ± AyarlarÄ±</h2>
    <div class="g2" style="margin-bottom:14px">
      <div class="field"><label class="lbl">Ä°sim</label><input type="text" id="e2_name" oninput="upField(1,'name',this.value)"></div>
      <div class="field"><label class="lbl">StatÃ¼</label><select id="e2_status" onchange="upField(1,'status',this.value)"><option value="">â€” Yok â€”</option><option value="KAZANAN">KAZANAN</option><option value="KAPTÄ°N">KAPTÄ°N</option><option value="FÄ°NALÄ°ST">FÄ°NALÄ°ST</option><option value="ELENEN">ELENEN</option></select></div>
      <div class="field"><label class="lbl">TakÄ±m</label><select id="e2_team" onchange="upField(1,'team',this.value)"><option value="kirmizi">KÄ±rmÄ±zÄ±</option><option value="mavi">Mavi</option></select></div>
      <div class="field" style="grid-column:1/-1"><label class="lbl">FotoÄŸraf</label><input type="file" accept="image/*" onchange="upImg(1,this)"></div>
    </div>
    <div class="section-label">Genel Ä°statistikler</div>
    <div class="g3" style="margin-bottom:14px">
      <div class="field"><label class="lbl">Toplam</label><input type="number" id="e2_tt" oninput="upTotal(1,'total',this.value)"></div>
      <div class="field"><label class="lbl">Galibiyet</label><input type="number" id="e2_tw" oninput="upTotal(1,'wins',this.value)"></div>
      <div class="field"><label class="lbl">Yenilgi</label><input type="number" id="e2_tl" oninput="upTotal(1,'losses',this.value)"></div>
    </div>
    <div class="section-label">Birebir Ä°statistikler (SeÃ§ili Rakibe KarÅŸÄ±)</div>
    <div class="g2">
      <div class="field"><label class="lbl">Galibiyet</label><input type="number" id="e2_hw" oninput="upH2H(1,0,'wins',this.value)"></div>
      <div class="field"><label class="lbl">Yenilgi</label><input type="number" id="e2_hl" oninput="upH2H(1,0,'losses',this.value)"></div>
    </div>
  </div>
</div>

<div class="action-bar">
  <button class="btn btn-indigo" onclick="openM('m_stats')">ğŸ“Š Ä°statistik Tablosu</button>
  <button class="btn btn-amber" onclick="openM('m_flag')">ğŸš© Bayrak Oyunu</button>
  <button class="btn btn-pink" onclick="openM('m_duel')">âš”ï¸ DÃ¼ello Oyunu</button>
  <button class="btn btn-emerald" onclick="dlCanvas('main_cv','survivor')">â¬‡ GÃ¶rseli Kaydet</button>
  <button class="btn btn-indigo" onclick="saveGame('main')" style="background:#0d9488">ğŸ’¾ Oyunu Kaydet</button>
</div>
<div class="action-bar" style="margin-top:-10px">
  <button class="btn btn-indigo" onclick="openM('m_perf')" style="background:#7c3aed">ğŸ“ˆ Performans Grafikleri</button>
  <button class="btn btn-indigo" onclick="openM('m_power')" style="background:#0891b2">âš¡ GÃ¼Ã§ Endeksi</button>
  <button class="btn btn-indigo" onclick="openM('m_h2hplus')" style="background:#0f766e">ğŸ§  H2H Avantaj Analizi</button>
  <button class="btn btn-indigo" onclick="openM('m_broadcast')" style="background:#1e293b">ğŸ“¡ YayÄ±n Modu</button>
  <button class="btn btn-indigo" onclick="openM('m_seasons')" style="background:#b45309">ğŸ“‚ Sezon Sistemi</button>
  <button class="btn btn-indigo" onclick="openM('m_themes')" style="background:#9333ea">ğŸ¨ Tema SeÃ§imi</button>
  <button class="btn btn-indigo" onclick="openM('m_export')" style="background:#065f46">ğŸ’¾ Veri Yedekleme</button>
  <button class="btn btn-indigo" onclick="openM('m_sim')" style="background:#92400e">ğŸ² SimÃ¼lasyon Modu</button>
  <button class="btn btn-indigo" onclick="openM('m_elim')" style="background:#be123c">ğŸš¨ Eleme AdayÄ±</button>
</div>
<div class="action-bar" style="margin-top:-10px">
  <button class="btn btn-indigo" onclick="openM('m_games')" style="background:#0f766e">ğŸ—‚ï¸ Oyunlar</button>
  <button class="btn btn-indigo" onclick="openM('m_mvp')" style="background:#b45309">ğŸ… GÃ¼nlÃ¼k MVP</button>
  <button class="btn btn-indigo" onclick="openM('m_new_design')" style="background:#7c3aed">ğŸ† Final ve Ã–zel Oyunu TasarÄ±mÄ±</button>
  <button class="btn btn-indigo" onclick="openM('m_top10')" style="background:#0d9488">ğŸ… En Ä°yi 10 Listesi</button>
  <button class="btn btn-indigo" onclick="openM('m_timeline')" style="background:#7e22ce">â³ Zaman TÃ¼neli</button>
  <button class="btn btn-indigo" onclick="openM('m_deepstats')" style="background:#0369a1">ğŸ”¬ Derin Analiz</button>
  <button class="btn btn-indigo" onclick="openM('m_mental')" style="background:#be185d">ğŸ§  Psikolojik Durum</button>
  <button class="btn btn-indigo" onclick="openM('m_tourney')" style="background:#92400e">ğŸ† Turnuva SimÃ¼lasyonu</button>
  <button class="btn btn-indigo" onclick="openM('m_achievements')" style="background:#b45309">ğŸ–ï¸ BaÅŸarÄ±lar & Rozetler</button>
  <button class="btn btn-indigo" onclick="openM('m_alltime')" style="background:linear-gradient(135deg,#7c3aed,#b45309)">ğŸ›ï¸ TÃ¼m ZamanlarÄ±n En Ä°yileri</button>
</div>

<div class="preview-label">Ã–nizleme â€” "GÃ¶rseli Kaydet" ile indirin</div>
<div class="preview-wrap" id="main_wrap">
  <div class="scaler" id="main_scaler">
    <div class="canvas" id="main_cv">
      <div class="wm"><span>SurvivorMetrics</span></div>
      <div class="cv-header">
        <div class="cv-title" id="cv_title"></div>
        <div class="cv-ht" id="cv_ht" style="font-size:28px;font-weight:900;letter-spacing:.18em;opacity:1;"></div>
        <div class="cv-badges"><div class="cv-badge" id="cv_b1"></div><div class="cv-badge" id="cv_b2"></div></div>
      </div>
      <div id="cv_r1"></div>
      <div class="divider"></div>
      <div id="cv_r2"></div>
    </div>
  </div>
</div>
</div>

<!-- MODAL: TÃœM YARIÅMACILAR -->
<div class="modal-bg" id="m_players">
  <div class="modal">
    <button class="modal-close" onclick="closeM('m_players')">âœ•</button>
    <div class="modal-title">TÃ¼m YarÄ±ÅŸmacÄ±lar</div>
    <div style="display:flex;justify-content:flex-end;margin-bottom:12px">
      <button class="btn btn-indigo btn-sm" onclick="addPlayer();buildPlayersGrid()">+ Yeni Ekle</button>
    </div>
    <div id="players_grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:14px"></div>
  </div>
</div>

<!-- MODAL: Ä°STATÄ°STÄ°KLER -->
<div class="modal-bg" id="m_stats">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_stats')">âœ•</button>
    <div class="modal-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <span>SURVIVOR TÃœRKÄ°YE 2026 GENEL Ä°STATÄ°STÄ°K TABLOSU</span>
      <div style="display:flex;gap:8px">
        <button class="btn btn-indigo btn-sm" onclick="sortStats('percent')">ğŸ“Š % GÃ¶re SÄ±rala</button>
        <button class="btn btn-emerald btn-sm" onclick="sortStats('score')">ğŸ† Puana GÃ¶re SÄ±rala</button>
      </div>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-bottom:10px">
<button id="statsDownloadBtnCustom" class="btn btn-emerald btn-sm" onclick="downloadStatsImage()">â¬‡ Tabloyu PNG Ä°ndir</button>
<button class="btn btn-indigo btn-sm" onclick="openStatsDesignModal()" style="background:#7c3aed">ğŸ¨ TasarÄ±m OluÅŸtur</button>
</div>
<div class="section-label" style="margin-bottom:10px">Genel BaÅŸarÄ± Tablosu</div>
    <div style="overflow-x:auto;margin-bottom:24px">
      <table><thead><tr>
        <th>SÄ±ra</th><th>Foto</th><th>YarÄ±ÅŸmacÄ±</th><th>TakÄ±m</th>
        <th class="tc">Toplam</th><th class="tc">G</th><th class="tc">Y</th><th class="tc">%</th><th class="tc">Puan</th>
      </tr></thead><tbody id="stats_body"></tbody></table>
    </div>
    <div class="section-label" style="margin-bottom:10px">Birebir KarÅŸÄ±laÅŸtÄ±rma (SeÃ§ili YarÄ±ÅŸmacÄ±lar)</div>
    <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center;text-align:center;margin-bottom:24px">
      <div style="background:#fee2e2;border-radius:12px;padding:16px">
        <div id="h2h_n1" style="font-size:18px;font-weight:900"></div>
        <div id="h2h_w1" style="font-size:42px;font-weight:900;color:#dc2626"></div>
      </div>
      <div style="font-size:11px;font-weight:900;color:#94a3b8">BÄ°REBÄ°R<br>GALÄ°BÄ°YET</div>
      <div style="background:#dbeafe;border-radius:12px;padding:16px">
        <div id="h2h_n2" style="font-size:18px;font-weight:900"></div>
        <div id="h2h_w2" style="font-size:42px;font-weight:900;color:#2563eb"></div>
      </div>
    </div>
    <div class="section-label" style="margin-bottom:10px">Birebir Ä°statistik GÃ¼ncelleme</div>
    <div style="display:grid;grid-template-columns:1fr auto 1fr auto auto;gap:10px;align-items:end;margin-bottom:20px">
      <div class="field"><label class="lbl" id="h2h_lbl1">P1 Galibiyet</label><input type="number" id="h2h_inp1" oninput="upH2HModal(0,1,'wins',this.value)"></div>
      <div style="font-size:18px;font-weight:900;padding-bottom:6px">VS</div>
      <div class="field"><label class="lbl" id="h2h_lbl2">P2 Galibiyet</label><input type="number" id="h2h_inp2" oninput="upH2HModal(1,0,'wins',this.value)"></div>
      <div class="field"><label class="lbl">P1 Yenilgi</label><input type="number" id="h2h_inp1l" oninput="upH2HModal(0,1,'losses',this.value)"></div>
      <button class="btn btn-red btn-sm" onclick="resetH2H()">SÄ±fÄ±rla</button>
    </div>
    <div class="section-label" style="margin-bottom:8px">Detay (tabloda bir isime tÄ±kla)</div>
    <div id="h2h_detail"></div>
  </div>
</div>

<!-- MODAL: DÃœELLO -->
<div class="modal-bg" id="m_duel">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_duel')">âœ•</button>
    <div class="modal-title">âš”ï¸ DÃ¼ello Oyunu</div>
    <div class="g2" style="margin-bottom:18px">
      <div class="panel" style="background:#fef2f2">
        <div class="section-label" style="color:#dc2626">1. YarÄ±ÅŸmacÄ±</div>
        <div class="field" style="margin-bottom:10px"><label class="lbl">YarÄ±ÅŸmacÄ±</label><select id="d_s1" onchange="duelLoadPlayer(1)"></select></div>
        <div class="field" style="margin-bottom:10px"><label class="lbl">Renk</label><select id="d_t1" onchange="renderDuel()"><option value="kirmizi">KÄ±rmÄ±zÄ±</option><option value="mavi">Mavi</option></select></div>
        <div class="g3">
          <div class="field"><label class="lbl">Toplam</label><input type="number" id="d_tt1" oninput="renderDuel()"></div>
          <div class="field"><label class="lbl">Galibiyet</label><input type="number" id="d_tw1" oninput="renderDuel()"></div>
          <div class="field"><label class="lbl">Yenilgi</label><input type="number" id="d_tl1" oninput="renderDuel()"></div>
        </div>
      </div>
      <div class="panel" style="background:#eff6ff">
        <div class="section-label" style="color:#2563eb">2. YarÄ±ÅŸmacÄ±</div>
        <div class="field" style="margin-bottom:10px"><label class="lbl">YarÄ±ÅŸmacÄ±</label><select id="d_s2" onchange="duelLoadPlayer(2)"></select></div>
        <div class="field" style="margin-bottom:10px"><label class="lbl">Renk</label><select id="d_t2" onchange="renderDuel()"><option value="kirmizi">KÄ±rmÄ±zÄ±</option><option value="mavi" selected>Mavi</option></select></div>
        <div class="g3">
          <div class="field"><label class="lbl">Toplam</label><input type="number" id="d_tt2" oninput="renderDuel()"></div>
          <div class="field"><label class="lbl">Galibiyet</label><input type="number" id="d_tw2" oninput="renderDuel()"></div>
          <div class="field"><label class="lbl">Yenilgi</label><input type="number" id="d_tl2" oninput="renderDuel()"></div>
        </div>
      </div>
    </div>
    <div class="preview-label">Ã–nizleme</div>
    <div class="preview-wrap" id="duel_wrap" style="margin-bottom:12px">
      <div class="scaler" id="duel_scaler">
        <div class="canvas" id="duel_cv">
          <div class="wm"><span>SurvivorMetrics</span></div>
          <div class="cv-header" style="padding:26px 20px 10px">
            <div class="cv-title" style="font-size:60px;margin-bottom:6px">SURVIVOR 2026</div>
            <div class="cv-ht" style="font-size:32px;font-weight:900;letter-spacing:.18em;opacity:1;">DÃœELLO OYUNU | SURVIVORMETRICS</div>
            <div class="cv-badges" id="duel_badges" style="margin-top:8px"></div>
          </div>
          <div id="duel_r1"></div>
          <div class="divider"></div>
          <div id="duel_r2"></div>
          <div id="duel_extra" style="display:none"></div>
        </div>
      </div>
    </div>
    <div style="background:#f8fafc;border-radius:12px;padding:14px;margin-bottom:12px">
      <div style="display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start">
        <div style="flex:1;min-width:200px">
          <label class="lbl" style="display:block;margin-bottom:8px">âš½ AtÄ±ÅŸ Tipi</label>
          <div style="display:flex;gap:5px;flex-wrap:wrap">
            <button type="button" data-group="dgt_atis" data-val="TOP" onclick="toggleDuelGT('dgt_atis','TOP',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">âš½ Top</button>
            <button type="button" data-group="dgt_atis" data-val="BASKET" onclick="toggleDuelGT('dgt_atis','BASKET',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ€ Basket</button>
            <button type="button" data-group="dgt_atis" data-val="STICK" onclick="toggleDuelGT('dgt_atis','STICK',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ’ Stick</button>
            <button type="button" data-group="dgt_atis" data-val="DÄ°SK" onclick="toggleDuelGT('dgt_atis','DÄ°SK',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ¥ Disk</button>
            <button type="button" data-group="dgt_atis" data-val="BUMERANG" onclick="toggleDuelGT('dgt_atis','BUMERANG',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸªƒ Bumerang</button>
            <button type="button" data-group="dgt_atis" data-val="DAMBIL" onclick="toggleDuelGT('dgt_atis','DAMBIL',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ‹ DambÄ±l</button>
            <button type="button" data-group="dgt_atis" data-val="KÃœP" onclick="toggleDuelGT('dgt_atis','KÃœP',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ“¦ KÃ¼p</button>
            <button type="button" data-group="dgt_atis" data-val="HALKA" onclick="toggleDuelGT('dgt_atis','HALKA',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">â­• Halka</button>
            <button type="button" data-group="dgt_atis" data-val="Ã‡EKÄ°Ã‡" onclick="toggleDuelGT('dgt_atis','Ã‡EKÄ°Ã‡',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ”¨ Ã‡ekiÃ§</button>
            <button type="button" data-group="dgt_atis" data-val="KUM TORBASI" onclick="toggleDuelGT('dgt_atis','KUM TORBASI',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ¥Š Kum TorbasÄ±</button>
            <button type="button" data-group="dgt_atis" data-val="KONDURMA" onclick="toggleDuelGT('dgt_atis','KONDURMA',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ¯ Kondurma</button>
          </div>
        </div>
        <div style="min-width:160px">
          <label class="lbl" style="display:block;margin-bottom:8px">ğŸ‘¤ 3. YarÄ±ÅŸmacÄ± (opsiyonel)</label>
          <select id="d_s3" onchange="renderDuel()" style="width:100%;padding:6px 10px;border:2px solid #e2e8f0;border-radius:8px;font-size:12px;font-weight:600;background:#fff">
            <option value="">â€” SeÃ§ilmedi â€”</option>
          </select>
        </div>
      </div>
      <input type="hidden" id="duel_game_type" value="">
      <div style="margin-top:12px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">
        <div class="field" style="margin:0;min-width:130px">
          <label class="lbl">ğŸ”´ KÄ±rmÄ±zÄ± TakÄ±m Skoru</label>
          <input type="text" id="d_sc1" value="0" list="score_opts_d1" placeholder="0â€“12 veya yazÄ±n" oninput="renderDuel()" style="width:100%">
          <datalist id="score_opts_d1"><option value="1"><option value="2"><option value="3"><option value="4"><option value="5"><option value="6"><option value="7"><option value="8"><option value="9"><option value="10"><option value="11"><option value="12"></datalist>
        </div>
        <div class="field" style="margin:0;min-width:130px">
          <label class="lbl">ğŸ”µ Mavi TakÄ±m Skoru</label>
          <input type="text" id="d_sc2" value="0" list="score_opts_d2" placeholder="0â€“12 veya yazÄ±n" oninput="renderDuel()" style="width:100%">
          <datalist id="score_opts_d2"><option value="1"><option value="2"><option value="3"><option value="4"><option value="5"><option value="6"><option value="7"><option value="8"><option value="9"><option value="10"><option value="11"><option value="12"></datalist>
        </div>
      </div>
    </div>
    <div style="background:#f0fdf4;border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid #bbf7d0">
      <div class="section-label" style="margin-bottom:12px;color:#15803d">ğŸ† SonuÃ§ Bilgileri (Opsiyonel)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
        <div class="field">
          <label class="lbl">ğŸ† Kazanan</label>
          <select id="d_winner" onchange="renderDuel()" style="border:1px solid #cbd5e1;border-radius:8px;padding:7px 10px;font-size:14px;width:100%;background:#f8fafc">
            <option value="">â€” SeÃ§ilmedi â€”</option>
          </select>
        </div>
        <div class="field">
          <label class="lbl">âŒ Elenen</label>
          <select id="d_loser" onchange="renderDuel()" style="border:1px solid #cbd5e1;border-radius:8px;padding:7px 10px;font-size:14px;width:100%;background:#f8fafc">
            <option value="">â€” SeÃ§ilmedi â€”</option>
          </select>
        </div>
        <div class="field">
          <label class="lbl">ğŸ¯ AtÄ±ÅŸ SeÃ§en</label>
          <select id="d_shooter" onchange="renderDuel()" style="border:1px solid #cbd5e1;border-radius:8px;padding:7px 10px;font-size:14px;width:100%;background:#f8fafc">
            <option value="">â€” SeÃ§ilmedi â€”</option>
          </select>
        </div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <button class="btn btn-pink btn-full" onclick="dlCanvas('duel_cv','survivor-duello')">â¬‡ DÃ¼ello GÃ¶rselini Kaydet</button>
      <button class="btn btn-full" onclick="saveGame('duel')" style="background:#0d9488;color:white;font-weight:700;border:none;border-radius:10px;padding:10px;cursor:pointer">ğŸ’¾ Oyunu Kaydet</button>
    </div>
  </div>
</div>

<!-- MODAL: BAYRAK -->
<div class="modal-bg" id="m_flag">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_flag')">âœ•</button>
    <div class="modal-title">ğŸš© Bayrak Oyunu</div>
    <div class="g4" style="margin-bottom:18px">
      <div class="field"><label class="lbl">Ãœst BaÅŸlÄ±k</label><input type="text" id="f_ht" value="BAYRAK OYUNU | SURVIVORMETRICS" oninput="renderFlag()"></div>
      <div class="field"><label class="lbl">Ana BaÅŸlÄ±k</label><input type="text" id="f_title" value="SURVIVOR 2026" oninput="renderFlag()"></div>
      <div class="field" style="grid-column:span 2">
        <label class="lbl">Oyun TÃ¼rÃ¼ (Rozet)</label>
        <div style="display:flex;flex-direction:column;gap:7px;margin-top:5px">
          <div style="display:flex;align-items:center;gap:5px;flex-wrap:wrap">
            <span style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;min-width:52px">Parkur</span>
            <button type="button" data-group="fgt_parkur" data-val="PARKUR" onclick="toggleFlagGT('fgt_parkur','PARKUR',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸƒ Parkur</button>
            <button type="button" data-group="fgt_parkur" data-val="PARKUR DIÅI" onclick="toggleFlagGT('fgt_parkur','PARKUR DIÅI',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ¯ Parkur DÄ±ÅŸÄ±</button>
          </div>
          <div style="display:flex;align-items:center;gap:5px;flex-wrap:wrap">
            <span style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;min-width:52px">AtÄ±ÅŸ</span>
            <button type="button" data-group="fgt_atis" data-val="TOP" onclick="toggleFlagGT('fgt_atis','TOP',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">âš½ Top</button>
            <button type="button" data-group="fgt_atis" data-val="BASKET" onclick="toggleFlagGT('fgt_atis','BASKET',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ€ Basket</button>
            <button type="button" data-group="fgt_atis" data-val="STICK" onclick="toggleFlagGT('fgt_atis','STICK',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ’ Stick</button>
            <button type="button" data-group="fgt_atis" data-val="DÄ°SK" onclick="toggleFlagGT('fgt_atis','DÄ°SK',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ¥ Disk</button>
            <button type="button" data-group="fgt_atis" data-val="BUMERANG" onclick="toggleFlagGT('fgt_atis','BUMERANG',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸªƒ Bumerang</button>
            <button type="button" data-group="fgt_atis" data-val="DAMBIL" onclick="toggleFlagGT('fgt_atis','DAMBIL',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ‹ DambÄ±l</button>
            <button type="button" data-group="fgt_atis" data-val="KÃœP" onclick="toggleFlagGT('fgt_atis','KÃœP',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ“¦ KÃ¼p</button>
            <button type="button" data-group="fgt_atis" data-val="HALKA" onclick="toggleFlagGT('fgt_atis','HALKA',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">â­• Halka</button>
            <button type="button" data-group="fgt_atis" data-val="Ã‡EKÄ°Ã‡" onclick="toggleFlagGT('fgt_atis','Ã‡EKÄ°Ã‡',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ”¨ Ã‡ekiÃ§</button>
            <button type="button" data-group="fgt_atis" data-val="KUM TORBASI" onclick="toggleFlagGT('fgt_atis','KUM TORBASI',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ¥Š Kum TorbasÄ±</button>
            <button type="button" data-group="fgt_atis" data-val="KONDURMA" onclick="toggleFlagGT('fgt_atis','KONDURMA',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸ¯ Kondurma</button>
          </div>
          <div style="display:flex;align-items:center;gap:5px;flex-wrap:wrap">
            <span style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;min-width:52px">Format</span>
            <button type="button" data-group="fgt_format" data-val="BEST OFF" onclick="toggleFlagGT('fgt_format','BEST OFF',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">â­ Best Off</button>
            <button type="button" data-group="fgt_format" data-val="BAYRAK TURU" onclick="toggleFlagGT('fgt_format','BAYRAK TURU',this)" style="padding:5px 11px;border-radius:7px;font-size:11px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s;white-space:nowrap">ğŸš© Bayrak Turu</button>
          </div>
        </div>
        <input type="hidden" id="f_b1" value="PARKUR DIÅI">
        <input type="hidden" id="f_b2" value="BAYRAK TURU">
        <div style="margin-top:10px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">
          <div class="field" style="margin:0;min-width:130px">
            <label class="lbl">ğŸ”´ KÄ±rmÄ±zÄ± TakÄ±m Skoru</label>
            <input type="text" id="f_rs" value="0" list="score_opts_fr" placeholder="0â€“12 veya yazÄ±n" oninput="renderFlag()" style="width:100%">
            <datalist id="score_opts_fr"><option value="1"><option value="2"><option value="3"><option value="4"><option value="5"><option value="6"><option value="7"><option value="8"><option value="9"><option value="10"><option value="11"><option value="12"></datalist>
          </div>
          <div class="field" style="margin:0;min-width:130px">
            <label class="lbl">ğŸ”µ Mavi TakÄ±m Skoru</label>
            <input type="text" id="f_bs" value="0" list="score_opts_fb" placeholder="0â€“12 veya yazÄ±n" oninput="renderFlag()" style="width:100%">
            <datalist id="score_opts_fb"><option value="1"><option value="2"><option value="3"><option value="4"><option value="5"><option value="6"><option value="7"><option value="8"><option value="9"><option value="10"><option value="11"><option value="12"></datalist>
          </div>
        </div>
      </div>
    </div>
    <div class="g2" style="margin-bottom:18px">
      <div class="panel" style="background:#fef2f2">
        <div class="section-label" style="color:#dc2626">KÄ±rmÄ±zÄ± TakÄ±m</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
          <div class="field"><label class="lbl">1. Oyuncu</label><select id="f_r1" onchange="renderFlag()"></select></div>
          <div class="field"><label class="lbl">2. Oyuncu</label><select id="f_r2" onchange="renderFlag()"></select></div>
          <div class="field"><label class="lbl">1. FotoÄŸraf</label><input type="file" accept="image/*" onchange="upFlagImg('red',0,this)"></div>
          <div class="field"><label class="lbl">2. FotoÄŸraf</label><input type="file" accept="image/*" onchange="upFlagImg('red',1,this)"></div>
        </div>
        <div class="g3" style="margin-bottom:10px">
          <div class="field"><label class="lbl">Toplam</label><input type="number" id="f_rt" value="0" oninput="renderFlag()"></div>
          <div class="field"><label class="lbl">Galibiyet</label><input type="number" id="f_rw" value="0" oninput="renderFlag()"></div>
          <div class="field"><label class="lbl">Yenilgi</label><input type="number" id="f_rl" value="0" oninput="renderFlag()"></div>
        </div>
      </div>
      <div class="panel" style="background:#eff6ff">
        <div class="section-label" style="color:#2563eb">Mavi TakÄ±m</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
          <div class="field"><label class="lbl">1. Oyuncu</label><select id="f_b1s" onchange="renderFlag()"></select></div>
          <div class="field"><label class="lbl">2. Oyuncu</label><select id="f_b2s" onchange="renderFlag()"></select></div>
          <div class="field"><label class="lbl">1. FotoÄŸraf</label><input type="file" accept="image/*" onchange="upFlagImg('blue',0,this)"></div>
          <div class="field"><label class="lbl">2. FotoÄŸraf</label><input type="file" accept="image/*" onchange="upFlagImg('blue',1,this)"></div>
        </div>
        <div class="g3" style="margin-bottom:10px">
          <div class="field"><label class="lbl">Toplam</label><input type="number" id="f_bt" value="0" oninput="renderFlag()"></div>
          <div class="field"><label class="lbl">Galibiyet</label><input type="number" id="f_bw" value="0" oninput="renderFlag()"></div>
          <div class="field"><label class="lbl">Yenilgi</label><input type="number" id="f_bl" value="0" oninput="renderFlag()"></div>
        </div>
      </div>
    </div>
    <div class="preview-label">Ã–nizleme</div>
    <div class="preview-wrap" id="flag_wrap" style="margin-bottom:12px">
      <div class="scaler" id="flag_scaler">
        <div class="canvas" id="flag_cv">
          <div class="wm"><span>SurvivorMetrics</span></div>
          <div class="cv-header">
            <div class="cv-title" id="f_cv_title">SURVIVOR 2026</div>
            <div class="cv-ht" id="f_cv_ht" style="font-size:34px;font-weight:900;letter-spacing:.18em;opacity:1;">BAYRAK OYUNU | SURVIVORMETRICS</div>
            <div class="cv-badges">
              <div class="cv-badge" id="f_cv_b1">PARKUR DIÅI</div>
              <div class="cv-badge" id="f_cv_b2">BAYRAK TURU</div>
            </div>
          </div>
          <div id="flag_r1"></div>
          <div class="divider"></div>
          <div id="flag_r2"></div>
        </div>
      </div>
    </div>
    <div style="margin-bottom:12px">
      <label class="lbl" style="display:block;margin-bottom:6px">Oyun TÃ¼rÃ¼</label>
      <div style="display:flex;gap:6px;flex-wrap:wrap" id="gt_flag_btns">
        <button type="button" onclick="selectFlagGameType('Parkur',this)" style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s">ğŸƒ Parkur</button>
        <button type="button" onclick="selectFlagGameType('Parkur DÄ±ÅŸÄ±',this)" style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s">ğŸ¯ Parkur DÄ±ÅŸÄ±</button>
        <button type="button" onclick="selectFlagGameType('Best Off',this)" style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s">â­ Best Off</button>
        <button type="button" onclick="selectFlagGameType('YarÄ±mdÄ±clÄ±',this)" style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:700;border:2px solid #cbd5e1;background:#f1f5f9;cursor:pointer;transition:all .15s">ğŸ‘¥ YarÄ±mdÄ±clÄ±</button>
      </div>
      <input type="hidden" id="flag_game_type" value="">
    </div>
    <div style="background:#f0fdf4;border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid #bbf7d0">
      <div class="section-label" style="margin-bottom:12px;color:#15803d">ğŸ† SonuÃ§ Bilgisi (Opsiyonel)</div>
      <div style="display:grid;grid-template-columns:1fr;gap:12px;max-width:260px">
        <div class="field">
          <label class="lbl">ğŸ† Kazanan TakÄ±m</label>
          <select id="f_winner" onchange="renderFlag()" style="border:1px solid #cbd5e1;border-radius:8px;padding:7px 10px;font-size:14px;width:100%;background:#f8fafc">
            <option value="">â€” SeÃ§ilmedi â€”</option>
            <option value="KÄ±rmÄ±zÄ±">ğŸ”´ KÄ±rmÄ±zÄ± TakÄ±m</option>
            <option value="Mavi">ğŸ”µ Mavi TakÄ±m</option>
          </select>
        </div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <button class="btn btn-amber btn-full" onclick="dlCanvas('flag_cv','survivor-bayrak')">â¬‡ Bayrak GÃ¶rselini Kaydet</button>
      <button class="btn btn-full" onclick="saveGame('flag')" style="background:#0d9488;color:white;font-weight:700;border:none;border-radius:10px;padding:10px;cursor:pointer">ğŸ’¾ Oyunu Kaydet</button>
    </div>
  </div>
</div>

<!-- MODAL: DETAY -->
<div class="modal-bg" id="m_detail">
  <div class="modal" style="z-index:60">
    <button class="modal-close" onclick="closeM('m_detail')">âœ•</button>
    <div id="detail_body"></div>
  </div>
</div>

<!-- MODAL: PERFORMANS GRAFÄ°KLERÄ° -->
<div class="modal-bg" id="m_perf">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_perf')">âœ•</button>
    <div class="modal-title">ğŸ“ˆ Performans Grafikleri</div>
    <div style="display:flex;gap:10px;align-items:flex-end;margin-bottom:18px;flex-wrap:wrap">
      <div class="field" style="flex:1;max-width:300px">
        <label class="lbl">YarÄ±ÅŸmacÄ± SeÃ§</label>
        <select id="perf_sel" onchange="renderPerfCharts()"></select>
      </div>
      <button class="btn btn-indigo btn-sm" onclick="openDetailFromPerf()">ğŸ” Detay & H2H GÃ¶rÃ¼ntÃ¼le</button>
      <button class="btn btn-emerald btn-sm" onclick="downloadPerfDesign()">â¬‡ HD TasarÄ±mÄ± Ä°ndir</button>
    </div>
    <!-- HD TasarÄ±m Ã–nizlemesi -->
    <div class="preview-label" style="margin-bottom:6px">ğŸ“Š TasarÄ±m Ã–nizlemesi</div>
    <div style="overflow:auto;background:#111;border-radius:14px;padding:16px;display:flex;justify-content:center;margin-bottom:20px;">
      <div id="perf_design_canvas" style="width:1080px;flex-shrink:0;"></div>
    </div>
    <!-- Klasik Grafikler -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
      <div style="background:#f8fafc;border-radius:14px;padding:16px">
        <div class="section-label" style="margin-bottom:12px">MaÃ§ BaÅŸÄ±na Galibiyet GrafiÄŸi</div>
        <canvas id="chart_winrate" height="160"></canvas>
      </div>
      <div style="background:#f8fafc;border-radius:14px;padding:16px">
        <div class="section-label" style="margin-bottom:12px">Son 10 MaÃ§ Form GrafiÄŸi</div>
        <canvas id="chart_form" height="160"></canvas>
      </div>
    </div>
    <div style="background:#f8fafc;border-radius:14px;padding:16px;margin-bottom:20px">
      <div class="section-label" style="margin-bottom:12px">Sezona GÃ¶re Performans Trendi</div>
      <canvas id="chart_season" height="120"></canvas>
    </div>
    <div id="perf_flow" style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;padding:10px 0"></div>
  </div>
</div>

<!-- MODAL: GÃœÃ‡ ENDEKSÄ° -->
<div class="modal-bg" id="m_power">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_power')">âœ•</button>
    <div class="modal-title">âš¡ YarÄ±ÅŸmacÄ± GÃ¼Ã§ Endeksi (Power Score)</div>
    <div id="power_grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px"></div>
  </div>
</div>

<!-- MODAL: H2H AVANTAJ ANALÄ°ZÄ° -->
<div class="modal-bg" id="m_h2hplus">
  <div class="modal modal-lg" style="background:#0f172a;color:#e2e8f0;border:1px solid #1e3a5f;">
    <button class="modal-close" onclick="closeM('m_h2hplus')" style="color:#94a3b8">âœ•</button>
    <div class="modal-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;color:white;border-bottom-color:#1e3a5f">
      <span>ğŸ§  Head-to-Head Avantaj Analizi</span>
      <button class="btn btn-sm" onclick="openH2HDesign()" style="background:linear-gradient(135deg,#7c3aed,#4f46e5);color:white;font-weight:800">ğŸ¨ TasarÄ±m OluÅŸtur</button>
    </div>
    <div style="background:#0c2a4a;border:1px solid #1e40af;border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:12px;color:#93c5fd;font-weight:600">
      ğŸŒ FarklÄ± sezonlardan yarÄ±ÅŸmacÄ±larÄ± karÅŸÄ±laÅŸtÄ±rabilirsiniz â€” sezon etiketi parantez iÃ§inde gÃ¶sterilir
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
      <div class="field"><label class="lbl" style="color:#64748b">1. YarÄ±ÅŸmacÄ±</label><select id="h2hp_s1" onchange="renderH2HPlus()" style="background:#1e293b;color:#e2e8f0;border-color:#334155"></select></div>
      <div class="field"><label class="lbl" style="color:#64748b">2. YarÄ±ÅŸmacÄ±</label><select id="h2hp_s2" onchange="renderH2HPlus()" style="background:#1e293b;color:#e2e8f0;border-color:#334155"></select></div>
    </div>
    <div id="h2hplus_body"></div>
  </div>
</div>

<!-- MODAL: H2H TASARIM -->
<div class="modal-bg" id="m_h2h_design">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_h2h_design')">âœ•</button>
    <div class="modal-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <span>ğŸ¨ H2H TasarÄ±m â€” DÃ¼ello KartÄ±</span>
      <button class="btn btn-emerald btn-sm" onclick="downloadH2HDesignImage()">â¬‡ HD Ä°ndir</button>
    </div>
    <!-- TasarÄ±ma Ã¶zel bÃ¼yÃ¼k fotoÄŸraflar -->
    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px">ğŸ“· TasarÄ±ma Ã–zel BÃ¼yÃ¼k FotoÄŸraflar (Ä°steÄŸe BaÄŸlÄ±)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="field">
          <label class="lbl">Sol YarÄ±ÅŸmacÄ± BÃ¼yÃ¼k Foto</label>
          <input type="file" id="h2h_bigphoto1" accept="image/*" onchange="h2hLoadBigPhoto(1)" style="font-size:12px">
          <div id="h2h_bp1_preview" style="margin-top:6px;font-size:11px;color:#64748b"></div>
        </div>
        <div class="field">
          <label class="lbl">SaÄŸ YarÄ±ÅŸmacÄ± BÃ¼yÃ¼k Foto</label>
          <input type="file" id="h2h_bigphoto2" accept="image/*" onchange="h2hLoadBigPhoto(2)" style="font-size:12px">
          <div id="h2h_bp2_preview" style="margin-top:6px;font-size:11px;color:#64748b"></div>
        </div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn btn-sm" onclick="h2hClearPhoto(1)" style="background:#fecdd3;color:#9f1239;font-size:11px">Sol Fotoyu Temizle</button>
        <button class="btn btn-sm" onclick="h2hClearPhoto(2)" style="background:#fecdd3;color:#9f1239;font-size:11px">SaÄŸ Fotoyu Temizle</button>
      </div>
    </div>
    <div class="preview-label">TasarÄ±m Ã–nizlemesi</div>
    <div style="overflow:auto;background:#111;border-radius:14px;padding:16px;display:flex;justify-content:center;">
      <div id="h2h_design_canvas" style="width:1080px;flex-shrink:0;"></div>
    </div>
  </div>
</div>

<!-- MODAL: YAYIN MODU -->
<div class="modal-bg" id="m_broadcast">
  <div class="modal modal-lg" id="broadcast_modal_inner">
    <button class="modal-close" onclick="closeM('m_broadcast')">âœ•</button>
    <div class="modal-title">ğŸ“¡ YayÄ±n Modu (Broadcast)</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px">
      <button class="btn btn-sm" onclick="setBroadcastMode('score')" style="background:#1e293b;color:white">ğŸ’¯ Sadece Skor</button>
      <button class="btn btn-sm" onclick="setBroadcastMode('faces')" style="background:#1e293b;color:white">ğŸ‘¥ Sadece YÃ¼zler</button>
      <button class="btn btn-sm" onclick="setBroadcastMode('bar')" style="background:#1e293b;color:white">ğŸ“Š Alt Bant</button>
      <button class="btn btn-sm" onclick="setBroadcastMode('full')" style="background:#6366f1;color:white">â¬› Tam YayÄ±n</button>
    </div>
    <div id="broadcast_canvas" style="background:#0c0f18;border-radius:12px;overflow:hidden;min-height:160px;display:flex;align-items:center;justify-content:center"></div>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="btn btn-emerald btn-sm" onclick="copyBroadcastHTML()">ğŸ“‹ HTML Kopyala</button>
      <span style="color:#64748b;font-size:12px;align-self:center">OBS Browser Source iÃ§in HTML kopyala</span>
    </div>
  </div>
</div>

<!-- MODAL: SEZON SÄ°STEMÄ° -->
<div class="modal-bg" id="m_seasons">
  <div class="modal">
    <button class="modal-close" onclick="closeM('m_seasons')">âœ•</button>
    <div class="modal-title">ğŸ“‚ Sezon Sistemi</div>
    <!-- Yeni Sezon Ekleme -->
    <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:14px;margin-bottom:16px">
      <div class="section-label" style="margin-bottom:10px;color:#0369a1">â• Yeni Sezon Ekle</div>
      <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
        <div class="field" style="flex:1;min-width:140px">
          <label class="lbl">Sezon AdÄ±</label>
          <input type="text" id="new_season_name" placeholder="Ã–rn: 2028, All-Star 2, Ã–zel..." style="background:white">
        </div>
        <button class="btn btn-indigo btn-sm" onclick="addNewSeason()">â• Ekle</button>
      </div>
    </div>
    <!-- Aktif Sezon SeÃ§ -->
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap">
      <div class="field" style="flex:1;min-width:150px"><label class="lbl">Aktif Sezon</label>
        <select id="season_sel" onchange="onSeasonSelChange(this.value)"></select>
      </div>
      <button class="btn btn-indigo btn-sm" onclick="saveSeasonData()">ğŸ’¾ Sezonu Kaydet</button>
      <button class="btn btn-amber btn-sm" onclick="loadSeasonData()">ğŸ“‚ Sezonu YÃ¼kle</button>
    </div>
    <div id="active_season_badge" style="margin-bottom:10px"></div>
    <div id="season_status" style="background:#f8fafc;border-radius:10px;padding:14px;font-size:13px;min-height:40px"></div>
    <div style="margin-top:14px">
      <div class="section-label">KaydedilmiÅŸ Sezonlar</div>
      <div id="seasons_list" style="display:flex;flex-direction:column;gap:8px;margin-top:10px"></div>
    </div>
  </div>
</div>

<!-- MODAL: TEMA SEÃ‡Ä°MÄ° -->
<div class="modal-bg" id="m_themes">
  <div class="modal">
    <button class="modal-close" onclick="closeM('m_themes')">âœ•</button>
    <div class="modal-title">ğŸ¨ Tema SeÃ§imi</div>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:14px">
      <div onclick="applyTheme('dark')" style="background:#0f172a;color:white;padding:24px;border-radius:14px;cursor:pointer;border:2px solid #334155;transition:all .2s;text-align:center" onmouseover="this.style.borderColor='#6366f1'" onmouseout="this.style.borderColor='#334155'">
        <div style="font-size:36px;margin-bottom:8px">ğŸŒ‘</div>
        <div style="font-size:16px;font-weight:900">KaranlÄ±k Tema</div>
        <div style="font-size:12px;opacity:.7;margin-top:4px">Derin siyah, neon vurgular</div>
      </div>
      <div onclick="applyTheme('broadcast')" style="background:#020617;color:white;padding:24px;border-radius:14px;cursor:pointer;border:2px solid #3b82f6;transition:all .2s;text-align:center" onmouseover="this.style.borderColor='#60a5fa'" onmouseout="this.style.borderColor='#3b82f6'">
        <div style="font-size:36px;margin-bottom:8px">ğŸ“º</div>
        <div style="font-size:16px;font-weight:900">YayÄ±n TemasÄ±</div>
        <div style="font-size:12px;opacity:.7;margin-top:4px">Profesyonel TV gÃ¶rÃ¼nÃ¼mÃ¼</div>
      </div>
      <div onclick="applyTheme('final')" style="background:linear-gradient(135deg,#78350f,#92400e);color:white;padding:24px;border-radius:14px;cursor:pointer;border:2px solid #f59e0b;transition:all .2s;text-align:center" onmouseover="this.style.borderColor='#fbbf24'" onmouseout="this.style.borderColor='#f59e0b'">
        <div style="font-size:36px;margin-bottom:8px">ğŸ†</div>
        <div style="font-size:16px;font-weight:900">Final TemasÄ±</div>
        <div style="font-size:12px;opacity:.7;margin-top:4px">AltÄ±n tonlar, bÃ¼yÃ¼k final enerjisi</div>
      </div>
      <div onclick="applyTheme('allstar')" style="background:linear-gradient(135deg,#4c1d95,#1e1b4b);color:white;padding:24px;border-radius:14px;cursor:pointer;border:2px solid #a855f7;transition:all .2s;text-align:center" onmouseover="this.style.borderColor='#c084fc'" onmouseout="this.style.borderColor='#a855f7'">
        <div style="font-size:36px;margin-bottom:8px">â­</div>
        <div style="font-size:16px;font-weight:900">All Star TemasÄ±</div>
        <div style="font-size:12px;opacity:.7;margin-top:4px">Mor galaksi efektleri</div>
      </div>
      <div onclick="applyTheme('light')" style="background:#f1f5f9;color:#1e293b;padding:24px;border-radius:14px;cursor:pointer;border:2px solid #e2e8f0;transition:all .2s;text-align:center;grid-column:span 2" onmouseover="this.style.borderColor='#6366f1'" onmouseout="this.style.borderColor='#e2e8f0'">
        <div style="font-size:36px;margin-bottom:8px">â˜€ï¸</div>
        <div style="font-size:16px;font-weight:900">VarsayÄ±lan (AÃ§Ä±k Tema)</div>
        <div style="font-size:12px;margin-top:4px;opacity:.7">Orijinal beyaz tema</div>
      </div>
    </div>
    <div id="theme_applied" style="margin-top:14px;text-align:center;font-weight:700;color:#10b981"></div>
  </div>
</div>

<!-- MODAL: VERÄ° YEDEKLEME -->
<div class="modal-bg" id="m_export">
  <div class="modal">
    <button class="modal-close" onclick="closeM('m_export')">âœ•</button>
    <div class="modal-title">ğŸ’¾ Veri Yedekleme / JSON Export</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px">
      <div style="background:#f0fdf4;border-radius:12px;padding:20px;text-align:center">
        <div style="font-size:32px;margin-bottom:8px">â¬‡ï¸</div>
        <div style="font-weight:900;margin-bottom:6px">Verileri DÄ±ÅŸa Aktar</div>
        <div style="font-size:12px;color:#64748b;margin-bottom:14px">TÃ¼m yarÄ±ÅŸmacÄ± verilerini JSON olarak indir</div>
        <button class="btn btn-emerald btn-full" onclick="exportJSON()">ğŸ“¥ JSON Ä°ndir</button>
      </div>
      <div style="background:#eff6ff;border-radius:12px;padding:20px;text-align:center">
        <div style="font-size:32px;margin-bottom:8px">â¬†ï¸</div>
        <div style="font-weight:900;margin-bottom:6px">Verileri Ä°Ã§e Aktar</div>
        <div style="font-size:12px;color:#64748b;margin-bottom:14px">Daha Ã¶nce dÄ±ÅŸa aktarÄ±lan JSON dosyasÄ±nÄ± yÃ¼kle</div>
        <label for="import_file" class="btn btn-indigo btn-full" style="cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px">
          ğŸ“¤ JSON YÃ¼kle
          <input type="file" accept=".json,application/json" id="import_file" style="position:absolute;width:1px;height:1px;opacity:0;overflow:hidden" onchange="importJSON(this)">
        </label>
      </div>
    </div>
    <div id="export_status" style="background:#f8fafc;border-radius:10px;padding:14px;font-size:13px;min-height:48px"></div>
  </div>
</div>

<!-- MODAL: SÄ°MÃœLASYON MODU -->
<div class="modal-bg" id="m_sim">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_sim')">âœ•</button>
    <div class="modal-title">ğŸ² SimÃ¼lasyon Modu</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
      <div>
        <div class="section-label" style="margin-bottom:8px">SimÃ¼lasyon YarÄ±ÅŸmacÄ±larÄ±</div>
        <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
          <button class="btn btn-indigo btn-sm" onclick="addSimPlayer()">+ Yeni Ekle</button>
          <button class="btn btn-amber btn-sm" onclick="loadFromMain()">ğŸ”„ Ana Listeden YÃ¼kle</button>
        </div>
        <div id="sim_players_list" style="display:flex;flex-direction:column;gap:8px;max-height:320px;overflow-y:auto"></div>
      </div>
      <div>
        <div class="section-label" style="margin-bottom:8px">100 MaÃ§lÄ±k SimÃ¼lasyon</div>
        <div style="background:#f8fafc;border-radius:12px;padding:14px;margin-bottom:10px">
          <div class="g2" style="gap:10px">
            <div class="field"><label class="lbl">1. YarÄ±ÅŸmacÄ±</label><select id="sim_s1"></select></div>
            <div class="field"><label class="lbl">2. YarÄ±ÅŸmacÄ±</label><select id="sim_s2"></select></div>
          </div>
          <button class="btn btn-pink btn-full" style="margin-top:12px" onclick="runSimulation()">ğŸ¯ 100 MaÃ§ SimÃ¼le Et!</button>
        </div>

      </div>
    </div>
    <div class="section-label" style="margin-bottom:10px">SimÃ¼lasyon YarÄ±ÅŸmacÄ± Tablosu</div>
    <div style="overflow-x:auto">
      <table><thead><tr>
        <th>YarÄ±ÅŸmacÄ±</th><th class="tc">Toplam</th><th class="tc">G</th><th class="tc">Y</th><th class="tc">%</th><th class="tc">Puan</th><th></th>
      </tr></thead><tbody id="sim_table_body"></tbody></table>
    </div>
  </div>
</div>

<!-- MODAL: EN Ä°YÄ° 10 LÄ°STESÄ° -->
<div class="modal-bg" id="m_top10">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_top10')">âœ•</button>
    <div class="modal-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <span>ğŸ… EN Ä°YÄ° 10 YARIÅMACI</span>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-sm" onclick="top10Sort='wr';buildTop10()" style="background:#0d9488;color:white">% OranÄ±</button>
        <button class="btn btn-sm" onclick="top10Sort='wins';buildTop10()" style="background:#0369a1;color:white">Galibiyet</button>
        <button class="btn btn-sm" onclick="top10Sort='power';buildTop10()" style="background:#7c3aed;color:white">Power Score</button>
        <button class="btn btn-sm" onclick="top10Sort='total';buildTop10()" style="background:#92400e;color:white">Toplam MaÃ§</button>
      </div>
    </div>
    <div id="top10_body" style="margin-top:10px"></div>
  </div>
</div>

<!-- MODAL: ZAMAN TÃœNELÄ° -->
<div class="modal-bg" id="m_timeline">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_timeline')">âœ•</button>
    <div class="modal-title">â³ Zaman TÃ¼neli / Performans Takibi</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;align-items:flex-end">
      <div class="field" style="min-width:180px"><label class="lbl">YarÄ±ÅŸmacÄ±</label><select id="tl_sel" onchange="buildTimeline()"></select></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-sm" onclick="tlPeriod='1m';buildTimeline()" id="tl_btn_1m" style="background:#7e22ce;color:white">Son 1 Ay</button>
        <button class="btn btn-sm" onclick="tlPeriod='6m';buildTimeline()" id="tl_btn_6m" style="background:#e2e8f0;color:#1e293b">Son 6 Ay</button>
        <button class="btn btn-sm" onclick="tlPeriod='12m';buildTimeline()" id="tl_btn_12m" style="background:#e2e8f0;color:#1e293b">Son 12 Ay</button>
        <button class="btn btn-sm" onclick="tlPeriod='all';buildTimeline()" id="tl_btn_all" style="background:#e2e8f0;color:#1e293b">TÃ¼mÃ¼</button>
      </div>
    </div>
    <div id="timeline_chart_wrap" style="background:#f8fafc;border-radius:14px;padding:16px;margin-bottom:16px">
      <canvas id="timeline_chart" height="140"></canvas>
    </div>
    <div id="timeline_events" style="display:flex;flex-direction:column;gap:8px;max-height:260px;overflow-y:auto"></div>
  </div>
</div>

<!-- MODAL: DERÄ°N ANALÄ°Z -->
<div class="modal-bg" id="m_deepstats">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_deepstats')">âœ•</button>
    <div class="modal-title">ğŸ”¬ Derin Ä°statistik Analizi</div>
    <div class="field" style="margin-bottom:18px;max-width:300px"><label class="lbl">YarÄ±ÅŸmacÄ± SeÃ§</label><select id="ds_sel" onchange="buildDeepStats()"></select></div>
    <div id="deepstats_body"></div>
  </div>
</div>

<!-- MODAL: PSÄ°KOLOJÄ°K DURUM -->
<div class="modal-bg" id="m_mental">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_mental')">âœ•</button>
    <div class="modal-title">ğŸ§  Psikolojik Durum Analizi</div>
    <div class="field" style="margin-bottom:18px;max-width:300px"><label class="lbl">YarÄ±ÅŸmacÄ± SeÃ§</label><select id="ms_sel" onchange="buildMentalState()"></select></div>
    <div id="mental_body"></div>
  </div>
</div>

<!-- MODAL: TURNUVA SÄ°MÃœLASYONU -->
<div class="modal-bg" id="m_tourney">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_tourney')">âœ•</button>
    <div class="modal-title">ğŸ† Turnuva SimÃ¼lasyonu & Tahmin</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
      <div>
        <div class="section-label" style="margin-bottom:8px">Turnuva AyarlarÄ±</div>
        <div class="field" style="margin-bottom:10px"><label class="lbl">Format</label>
          <select id="tn_format">
            <option value="elimination">Eleme (Tek MaÃ§)</option>
            <option value="roundrobin">Lig (Herkes Herkesle)</option>
            <option value="doubleelim">Ã‡ift Eleme</option>
          </select>
        </div>
        <div class="field" style="margin-bottom:10px"><label class="lbl">Tur SayÄ±sÄ±</label>
          <select id="tn_rounds"><option value="1">1 Tur</option><option value="3" selected>3 Tur</option><option value="5">5 Tur</option></select>
        </div>
        <button class="btn btn-indigo btn-full" onclick="runTournament()" style="background:#92400e">ğŸ¯ TurnuvayÄ± BaÅŸlat!</button>
      </div>
      <div>
        <div class="section-label" style="margin-bottom:8px">Tahmin Yap</div>
        <div class="field" style="margin-bottom:10px"><label class="lbl">Kazanacak YarÄ±ÅŸmacÄ±</label><select id="tn_pred_sel"></select></div>
        <button class="btn btn-emerald btn-full" onclick="savePrediction()">âœ… Tahminimi Kaydet</button>
        <div id="tn_pred_status" style="margin-top:8px;font-size:12px;color:#10b981;font-weight:700"></div>
      </div>
    </div>
    <div id="tourney_result" style="margin-top:4px"></div>
  </div>
</div>

<!-- MODAL: BAÅARILAR & ROZETLER -->
<div class="modal-bg" id="m_achievements">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_achievements')">âœ•</button>
    <div class="modal-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <span>ğŸ–ï¸ BaÅŸarÄ±lar & Rozetler Sistemi</span>
      <button class="btn btn-emerald btn-sm" onclick="downloadAchievementCard()">â¬‡ BaÅŸarÄ± KartÄ±nÄ± Ä°ndir</button>
    </div>
    <!-- YarÄ±ÅŸmacÄ± seÃ§im ve fotoÄŸraf kartÄ± -->
    <div style="display:flex;gap:20px;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap">
      <!-- Sol: SeÃ§im ve kÃ¼Ã§Ã¼k galeri -->
      <div style="flex:1;min-width:220px">
        <div class="field" style="margin-bottom:14px"><label class="lbl">YarÄ±ÅŸmacÄ± SeÃ§</label><select id="ach_sel" onchange="buildAchievements()"></select></div>
        <div class="section-label" style="margin-bottom:8px">ğŸ‘¥ YarÄ±ÅŸmacÄ±lar</div>
        <div id="ach_players_gallery" style="display:flex;gap:8px;flex-wrap:wrap;padding:4px 0"></div>
      </div>
      <!-- SaÄŸ: SeÃ§ilen yarÄ±ÅŸmacÄ± profil kartÄ± -->
      <div id="ach_profile_card" style="flex-shrink:0"></div>
    </div>
    <div id="achievements_body"></div>
    <!-- Ä°ndirilebilir tasarÄ±m canvas (gizli) -->
    <div style="margin-top:20px">
      <div class="section-label" style="margin-bottom:10px">ğŸ¨ Ä°ndirilebilir BaÅŸarÄ± KartÄ± Ã–nizlemesi</div>
      <div style="overflow:auto;background:#111;border-radius:14px;padding:16px;display:flex;justify-content:center;">
        <div id="ach_design_canvas" style="width:1080px;flex-shrink:0;"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Ä°STATÄ°STÄ°K TASARIM -->
<div class="modal-bg" id="m_stats_design">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_stats_design')">âœ•</button>
    <div class="modal-title">ğŸ¨ Ä°statistik Tablosu TasarÄ±mÄ±</div>
    <div class="preview-label" style="margin-bottom:6px">ğŸ“Š TasarÄ±m 1 â€” Genel Performans (Puan)</div>
    <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
      <button class="btn btn-emerald btn-sm" onclick="downloadStatsDesignImage(1)">â¬‡ Puan TasarÄ±mÄ± Ä°ndir</button>
    </div>
    <div style="overflow:auto;background:#e2e8f0;border-radius:14px;padding:16px;display:flex;justify-content:center;margin-bottom:20px;">
      <div id="stats_design_canvas" style="width:1080px;flex-shrink:0;"></div>
    </div>
    <div class="preview-label" style="margin-bottom:6px">ğŸ“ˆ TasarÄ±m 2 â€” Genel Performans (YÃ¼zde)</div>
    <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
      <button class="btn btn-emerald btn-sm" onclick="downloadStatsDesignImage(2)">â¬‡ YÃ¼zde TasarÄ±mÄ± Ä°ndir</button>
    </div>
    <div style="overflow:auto;background:#e2e8f0;border-radius:14px;padding:16px;display:flex;justify-content:center;">
      <div id="stats_design_canvas2" style="width:1080px;flex-shrink:0;"></div>
    </div>
  </div>
</div>

<!-- MODAL: ELEME ADAYI TASARIM -->
<div class="modal-bg" id="m_elim_design">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_elim_design')">âœ•</button>
    <div class="modal-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <span>ğŸ¨ Eleme AdayÄ± TasarÄ±mÄ±</span>
      <button class="btn btn-emerald btn-sm" onclick="downloadElimDesignImage()">â¬‡ TasarÄ±mÄ± Ä°ndir</button>
    </div>
    <div class="preview-label">TasarÄ±m Ã–nizlemesi</div>
    <div style="overflow:auto;background:#e2e8f0;border-radius:14px;padding:16px;display:flex;justify-content:center;">
      <div id="elim_design_canvas" style="width:1080px;flex-shrink:0;"></div>
    </div>
  </div>
</div>

<!-- MODAL: GÃœNLÃœK MVP -->
<div class="modal-bg" id="m_mvp">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_mvp')">âœ•</button>
    <div class="modal-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <span>ğŸ… GÃ¼nlÃ¼k MVP Tablosu</span>
      <button class="btn btn-emerald btn-sm" onclick="downloadMVPImage()">â¬‡ MVP TasarÄ±mÄ±nÄ± Ä°ndir</button>
    </div>
    <div class="preview-label">TasarÄ±m Ã–nizlemesi</div>
    <div style="overflow:auto;background:#e2e8f0;border-radius:14px;padding:16px;display:flex;justify-content:center;margin-bottom:14px;">
      <div id="mvp_design_canvas" style="width:1080px;flex-shrink:0;"></div>
    </div>
  </div>
</div>

<!-- MODAL: YENÄ° TASARIM -->
<div class="modal-bg" id="m_new_design">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_new_design')">âœ•</button>
    <div class="modal-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <span>ğŸ† Final ve Ã–zel Oyunu TasarÄ±mÄ±</span>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-sm" onclick="ndSaveToGames()" style="background:#0d9488;color:white;font-weight:800">ğŸ’¾ Oyunu Kaydet</button>
        <button class="btn btn-emerald btn-sm" onclick="downloadNewDesignImage()">â¬‡ HD Ä°ndir</button>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px">
      <div class="field">
        <label class="lbl">Sol YarÄ±ÅŸmacÄ±</label>
        <select id="nd_p1" onchange="buildNewDesign()"></select>
      </div>
      <div class="field">
        <label class="lbl">SaÄŸ YarÄ±ÅŸmacÄ±</label>
        <select id="nd_p2" onchange="buildNewDesign()"></select>
      </div>
      <div class="field">
        <label class="lbl">Kazanan</label>
        <select id="nd_winner" onchange="this.dataset.userEdited='1';buildNewDesign()">
          <option value="">â€” SeÃ§ilmedi â€”</option>
          <option value="p1">Sol YarÄ±ÅŸmacÄ±</option>
          <option value="p2">SaÄŸ YarÄ±ÅŸmacÄ±</option>
          <option value="draw">Berabere</option>
        </select>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
      <div class="field"><label class="lbl">BaÅŸlÄ±k (Oyun AdÄ±)</label><input type="text" id="nd_title" value="BÄ°REYSEL DOKUNULMAZLIK" oninput="this.dataset.userEdited='1';buildNewDesign()"></div>
      <div class="field"><label class="lbl">Alt BaÅŸlÄ±k (Sezon)</label><input type="text" id="nd_subtitle" value="SURVIVOR 2026" oninput="this.dataset.userEdited='1';buildNewDesign()"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-bottom:14px">
      <div class="field"><label class="lbl">Sol Skor</label><input type="number" id="nd_s1" value="1" min="0" oninput="this.dataset.userEdited='1';buildNewDesign()"></div>
      <div class="field"><label class="lbl">SaÄŸ Skor</label><input type="number" id="nd_s2" value="0" min="0" oninput="this.dataset.userEdited='1';buildNewDesign()"></div>
      <div class="field"><label class="lbl">Oyun / AtÄ±ÅŸ TÃ¼rÃ¼</label><input type="text" id="nd_gametype" value="" placeholder="Ã–rn: PARKUR, TOP, BASKET..." oninput="this.dataset.userEdited='1';buildNewDesign()"></div>
      <div class="field"><label class="lbl">Birebir Skor (Ã¶r: 32/13)</label><input type="text" id="nd_h2h_score" value="" placeholder="otomatik" oninput="buildNewDesign()"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-bottom:14px">
      <div class="field"><label class="lbl">Sol G/T/M (Ã¶r: 96G 32M)</label><input type="text" id="nd_stat1" value="" placeholder="otomatik" oninput="buildNewDesign()"></div>
      <div class="field"><label class="lbl">Sol WR%</label><input type="text" id="nd_wr1" value="" placeholder="otomatik" oninput="buildNewDesign()"></div>
      <div class="field"><label class="lbl">SaÄŸ G/T/M (Ã¶r: 54G 46M)</label><input type="text" id="nd_stat2" value="" placeholder="otomatik" oninput="buildNewDesign()"></div>
      <div class="field"><label class="lbl">SaÄŸ WR%</label><input type="text" id="nd_wr2" value="" placeholder="otomatik" oninput="buildNewDesign()"></div>
    </div>
    <!-- Arka plan rengi + Ã§erÃ§eve -->
    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px">ğŸ¨ TasarÄ±m TemasÄ±</div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <span style="font-size:11px;font-weight:700;color:#475569;min-width:70px">Arka Plan</span>
        <button type="button" id="ndt_dark"   onclick="ndSetTheme('dark')"   style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:800;border:2px solid #1e293b;background:#0f172a;color:white;cursor:pointer">â¬› Siyah</button>
        <button type="button" id="ndt_gold"   onclick="ndSetTheme('gold')"   style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:800;border:2px solid #b8860b;background:#78350f;color:#FFD700;cursor:pointer">âœ¨ AltÄ±n</button>
        <button type="button" id="ndt_red"    onclick="ndSetTheme('red')"    style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:800;border:2px solid #dc2626;background:#450a0a;color:#fca5a5;cursor:pointer">ğŸ”´ KÄ±rmÄ±zÄ±</button>
        <button type="button" id="ndt_blue"   onclick="ndSetTheme('blue')"   style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:800;border:2px solid #2563eb;background:#0c1a4a;color:#93c5fd;cursor:pointer">ğŸ”µ Mavi</button>
        <button type="button" id="ndt_redblu" onclick="ndSetTheme('redblu')" style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:800;border:2px solid #9333ea;background:linear-gradient(90deg,#450a0a,#0c1a4a);color:white;cursor:pointer">ğŸ”´ğŸ”µ KÄ±rmÄ±zÄ±&Mavi</button>
        <button type="button" id="ndt_allstars" onclick="ndSetTheme('allstars')" style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:800;border:2px solid #a855f7;background:linear-gradient(135deg,#1a0030,#3b0070);color:#e9d5ff;cursor:pointer">â­ All Stars</button>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <span style="font-size:11px;font-weight:700;color:#475569;min-width:70px">Mod</span>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;font-weight:700;color:#334155">
          <input type="checkbox" id="nd_frame_mode" onchange="buildNewDesign()" style="width:16px;height:16px;accent-color:#6366f1;cursor:pointer">
          <span>ğŸ–¼ï¸ Ã‡erÃ§eveli Mod</span>
          <span style="font-size:10px;font-weight:600;color:#94a3b8">(yuvarlak fotoÄŸraflar)</span>
        </label>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:11px;font-weight:700;color:#475569;min-width:70px">Ä°statistik</span>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;font-weight:700;color:#334155">
          <input type="checkbox" id="nd_stat_light" onchange="buildNewDesign()" style="width:16px;height:16px;accent-color:#6366f1;cursor:pointer">
          <span>â¬œ Beyaz Kutu</span>
          <span style="font-size:10px;font-weight:600;color:#94a3b8">(siyah yazÄ±lar)</span>
        </label>
      </div>
    </div>

    <!-- TasarÄ±ma Ã¶zel bÃ¼yÃ¼k fotoÄŸraflar -->
    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px">ğŸ“· BÃ¼yÃ¼k FotoÄŸraflar â€” AkÄ±llÄ± KÄ±rpma Aktif</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="field">
          <label class="lbl">Sol YarÄ±ÅŸmacÄ± BÃ¼yÃ¼k Foto</label>
          <input type="file" id="nd_bigphoto1" accept="image/*" onchange="ndLoadBigPhoto(1)" style="font-size:12px">
          <div id="nd_bp1_preview" style="margin-top:6px;font-size:11px;color:#64748b"></div>
        </div>
        <div class="field">
          <label class="lbl">SaÄŸ YarÄ±ÅŸmacÄ± BÃ¼yÃ¼k Foto</label>
          <input type="file" id="nd_bigphoto2" accept="image/*" onchange="ndLoadBigPhoto(2)" style="font-size:12px">
          <div id="nd_bp2_preview" style="margin-top:6px;font-size:11px;color:#64748b"></div>
        </div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn btn-sm" onclick="ndClearPhoto(1)" style="background:#fecdd3;color:#9f1239;font-size:11px">Sol Fotoyu Temizle</button>
        <button class="btn btn-sm" onclick="ndClearPhoto(2)" style="background:#fecdd3;color:#9f1239;font-size:11px">SaÄŸ Fotoyu Temizle</button>
      </div>
    </div>
    <div class="preview-label">TasarÄ±m Ã–nizlemesi</div>
    <div style="overflow:auto;background:#111;border-radius:14px;padding:16px;display:flex;justify-content:center;">
      <div id="new_design_canvas" style="width:1080px;flex-shrink:0;"></div>
    </div>
  </div>
</div>

<!-- MODAL: OYUNLAR -->
<div class="modal-bg" id="m_games">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_games')">âœ•</button>
    <!-- Tekli kayÄ±t formu -->
    <div id="solo_entry_form" style="display:none;background:#fffbeb;border:1px solid #fcd34d;border-radius:12px;padding:14px;margin-bottom:14px">
      <div class="section-label" style="margin-bottom:10px;color:#92400e">ğŸ“ Tekli Ä°statistik KaydÄ± (Eski Veri / Rakipsiz Oyun)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:flex-end">
        <div class="field"><label class="lbl">YarÄ±ÅŸmacÄ±</label><select id="solo_player"></select></div>
        <div class="field"><label class="lbl">SonuÃ§</label>
          <select id="solo_result">
            <option value="win">ğŸ† Galibiyet</option>
            <option value="loss">âŒ MaÄŸlubiyet</option>
          </select>
        </div>
        <div class="field"><label class="lbl">AtÄ±ÅŸ Tipi</label>
          <select id="solo_atis">
            <option value="">â€” SeÃ§ilmedi â€”</option>
            <option>TOP</option><option>BASKET</option><option>STICK</option><option>DÄ°SK</option>
            <option>BUMERANG</option><option>DAMBIL</option><option>KÃœP</option><option>HALKA</option>
            <option>Ã‡EKÄ°Ã‡</option><option>KUM TORBASI</option><option>KONDURMA</option>
          </select>
        </div>
        <div class="field"><label class="lbl">Adet</label><input type="number" id="solo_count" value="1" min="1" max="99" style="width:70px"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;align-items:flex-end">
        <div class="field" style="flex:1"><label class="lbl">Not</label><input type="text" id="solo_note" placeholder="Ã–rn: Ocak ayÄ± parkur verileri..."></div>
        <button class="btn btn-emerald btn-sm" onclick="saveSoloEntry()">ğŸ’¾ Kaydet</button>
        <button class="btn btn-sm" onclick="document.getElementById('solo_entry_form').style.display='none'" style="background:#e2e8f0">Ä°ptal</button>
      </div>
      <div id="solo_status" style="margin-top:8px;font-size:13px"></div>
    </div>
    <div class="modal-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <span>ğŸ—‚ï¸ Kaydedilen Oyunlar</span>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-amber btn-sm" onclick="openSoloEntry()">ğŸ“ Tekli KayÄ±t (Eski Veri)</button>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="btn btn-sm" onclick="filterGames('all')" id="gf_all" style="background:#0d9488;color:white">TÃ¼mÃ¼</button>
        <button class="btn btn-sm" onclick="filterGames('Parkur')" id="gf_parkur" style="background:#e2e8f0;color:#1e293b">ğŸƒ Parkur</button>
        <button class="btn btn-sm" onclick="filterGames('Parkur DÄ±ÅŸÄ±')" id="gf_parkurdisi" style="background:#e2e8f0;color:#1e293b">ğŸ¯ Parkur DÄ±ÅŸÄ±</button>
        <button class="btn btn-sm" onclick="filterGames('Best Off')" id="gf_bestoff" style="background:#e2e8f0;color:#1e293b">â­ Best Off</button>
        <button class="btn btn-sm" onclick="filterGames('YarÄ±mdÄ±clÄ±')" id="gf_yarimdicli" style="background:#e2e8f0;color:#1e293b">ğŸ‘¥ YarÄ±mdÄ±clÄ±</button>
      </div>
    <!-- AtÄ±ÅŸ Tipi Sekmeleri -->
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;padding:10px 0 4px;border-bottom:1px solid #f1f5f9">
      <span style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;align-self:center;min-width:60px">AtÄ±ÅŸ Tipi:</span>
      <button class="btn btn-sm" onclick="filterGamesByAtis('all')" id="gfa_all" style="background:#6366f1;color:white;font-size:11px;padding:5px 10px">TÃ¼mÃ¼</button>
      <button class="btn btn-sm" onclick="filterGamesByAtis('TOP')" id="gfa_TOP" style="background:#e2e8f0;color:#1e293b;font-size:11px;padding:5px 10px">âš½ Top</button>
      <button class="btn btn-sm" onclick="filterGamesByAtis('BASKET')" id="gfa_BASKET" style="background:#e2e8f0;color:#1e293b;font-size:11px;padding:5px 10px">ğŸ€ Basket</button>
      <button class="btn btn-sm" onclick="filterGamesByAtis('STICK')" id="gfa_STICK" style="background:#e2e8f0;color:#1e293b;font-size:11px;padding:5px 10px">ğŸ’ Stick</button>
      <button class="btn btn-sm" onclick="filterGamesByAtis('DÄ°SK')" id="gfa_DISK" style="background:#e2e8f0;color:#1e293b;font-size:11px;padding:5px 10px">ğŸ¥ Disk</button>
      <button class="btn btn-sm" onclick="filterGamesByAtis('BUMERANG')" id="gfa_BUMERANG" style="background:#e2e8f0;color:#1e293b;font-size:11px;padding:5px 10px">ğŸªƒ Bumerang</button>
      <button class="btn btn-sm" onclick="filterGamesByAtis('DAMBIL')" id="gfa_DAMBIL" style="background:#e2e8f0;color:#1e293b;font-size:11px;padding:5px 10px">ğŸ‹ DambÄ±l</button>
      <button class="btn btn-sm" onclick="filterGamesByAtis('KÃœP')" id="gfa_KUP" style="background:#e2e8f0;color:#1e293b;font-size:11px;padding:5px 10px">ğŸ“¦ KÃ¼p</button>
      <button class="btn btn-sm" onclick="filterGamesByAtis('HALKA')" id="gfa_HALKA" style="background:#e2e8f0;color:#1e293b;font-size:11px;padding:5px 10px">â­• Halka</button>
      <button class="btn btn-sm" onclick="filterGamesByAtis('Ã‡EKÄ°Ã‡')" id="gfa_CEKIC" style="background:#e2e8f0;color:#1e293b;font-size:11px;padding:5px 10px">ğŸ”¨ Ã‡ekiÃ§</button>
      <button class="btn btn-sm" onclick="filterGamesByAtis('KUM TORBASI')" id="gfa_KUMTORBASI" style="background:#e2e8f0;color:#1e293b;font-size:11px;padding:5px 10px">ğŸ¥Š Kum TorbasÄ±</button>
      <button class="btn btn-sm" onclick="filterGamesByAtis('KONDURMA')" id="gfa_KONDURMA" style="background:#e2e8f0;color:#1e293b;font-size:11px;padding:5px 10px">ğŸ¯ Kondurma</button>
    </div>
    <!-- Kaynak sekmeleri -->
    <div style="display:flex;gap:0;margin-bottom:16px;border-bottom:2px solid #e2e8f0;overflow-x:auto">
      <button id="gsrc_all" onclick="filterGamesBySource('all')" style="padding:9px 20px;font-size:13px;font-weight:700;border:none;border-bottom:3px solid #0d9488;background:transparent;cursor:pointer;color:#0d9488">TÃ¼mÃ¼</button>
      <button id="gsrc_duel" onclick="filterGamesBySource('duel')" style="padding:9px 20px;font-size:13px;font-weight:700;border:none;border-bottom:3px solid transparent;background:transparent;cursor:pointer;color:#94a3b8">âš”ï¸ DÃ¼ello Oyunu</button>
      <button id="gsrc_flag" onclick="filterGamesBySource('flag')" style="padding:9px 20px;font-size:13px;font-weight:700;border:none;border-bottom:3px solid transparent;background:transparent;cursor:pointer;color:#94a3b8">ğŸš© Bayrak YarÄ±ÅŸÄ±</button>
    </div>
    <div id="games_stats_bar" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px"></div>
    <div id="games_list" style="display:flex;flex-direction:column;gap:10px;max-height:420px;overflow-y:auto"></div>
    <div style="margin-top:12px;text-align:right">
      <button class="btn btn-red btn-sm" onclick="if(confirm('TÃ¼m oyun kayÄ±tlarÄ± silinsin mi?'))clearAllGames()">ğŸ—‘ TÃ¼m KayÄ±tlarÄ± Sil</button>
    </div>
  </div>
</div>

<!-- MODAL: SÄ°MÃœLASYON SONUCU -->
<div class="modal-bg" id="m_sim_result">
  <div class="modal" style="max-width:480px;text-align:center">
    <button class="modal-close" onclick="closeM('m_sim_result')">âœ•</button>
    <div id="sim_result_body" style="color:#0c0f18"></div>
  </div>
</div>

<!-- MODAL: ELEME ADAYI -->
<div class="modal-bg" id="m_elim">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_elim')">âœ•</button>
    <div class="modal-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <span>ğŸš¨ Eleme AdayÄ± Analizi</span>
      <button class="btn btn-indigo btn-sm" onclick="openElimDesignFromElim()" style="background:#7c3aed">ğŸ¨ TasarÄ±m OluÅŸtur</button>
    </div>
    <div class="field" style="margin-bottom:18px;max-width:300px">
      <label class="lbl">YarÄ±ÅŸmacÄ± SeÃ§</label>
      <select id="elim_sel" onchange="renderElimPanel()"></select>
    </div>
    <div id="elim_body"></div>
  </div>
</div>

<!-- MODAL: TÃœM ZAMANLARIN EN Ä°YÄ°LERÄ° -->
<div class="modal-bg" id="m_alltime">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeM('m_alltime')">âœ•</button>
    <div class="modal-title">ğŸ›ï¸ TÃ¼m ZamanlarÄ±n En Ä°yileri â€” TÃ¼m Sezonlar</div>
    <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap">
      <button class="btn btn-sm" onclick="buildAlltimeList('wr')" style="background:#7c3aed;color:white">ğŸ“Š WR%</button>
      <button class="btn btn-sm" onclick="buildAlltimeList('wins')" style="background:#10b981;color:white">ğŸ† Galibiyet</button>
      <button class="btn btn-sm" onclick="buildAlltimeList('total')" style="background:#0369a1;color:white">ğŸ® Toplam Oyun</button>
      <button class="btn btn-sm" onclick="buildAlltimeList('score')" style="background:#b45309;color:white">âš¡ Net Puan</button>
      <button class="btn btn-sm" onclick="buildAlltimeList('streak')" style="background:#be123c;color:white">ğŸ”¥ Seri</button>
    </div>
    <div id="alltime_body"></div>
  </div>
</div>

<script>
// ======================================================
// STATE
// ======================================================
let players=[], p1i=0, p2i=1;
let flagImgs={red:[null,null],blue:[null,null]};

function uid(){return Math.random().toString(36).substr(2,9);}

function save(){
  try{
    localStorage.setItem('sm2_players',JSON.stringify(players));
  }catch(e){}
}

// ======================================================
// LOAD â€” with image restoration from separate localStorage keys
// ======================================================
function load(){
  try{
    const d=localStorage.getItem('sm2_players');
    if(d){
      players=JSON.parse(d);
      players.forEach(p=>{
        if(!p.h2hRegistry) p.h2hRegistry={};
        // Restore image from separate localStorage key if not already embedded in player object
        if(!p.image){
          try{
            const img=localStorage.getItem('sm2_img_'+p.id);
            if(img) p.image=img;
          }catch(e){}
        }
      });
      if(players.length<2) while(players.length<2) players.push(mkP());
      return;
    }
  }catch(e){}
  players=[
    {id:uid(),name:'SEREN AY',status:'KAZANAN',image:null,team:'kirmizi',score:'7',totalStats:{total:74,wins:41,losses:30},h2hRegistry:{}},
    {id:uid(),name:'LÄ°NA',status:'',image:null,team:'mavi',score:'3',totalStats:{total:81,wins:25,losses:57},h2hRegistry:{}}
  ];
}

function mkP(){return{id:uid(),name:'YENÄ° YARIÅMACI',status:'',image:null,team:'kirmizi',score:'0',totalStats:{total:0,wins:0,losses:0},h2hRegistry:{}};}

// ======================================================
// H2H
// ======================================================
function getH2H(fi,ti){const f=players[fi],t=players[ti];if(!f||!t)return{total:0,wins:0,losses:0};return f.h2hRegistry[t.id]||{total:0,wins:0,losses:0};}
function setH2H(fi,ti,s){players[fi].h2hRegistry[players[ti].id]={...s};}

// ======================================================
// UPDATE FUNCTIONS
// ======================================================
function upField(slot,field,value){
  const idx=slot===0?p1i:p2i;
  players[idx][field]=value;
  save();renderMain();updateSelects();
}

function upTotal(slot,field,value){
  const idx=slot===0?p1i:p2i;
  players[idx].totalStats[field]=Number(value)||0;

  if(field==='wins' || field==='losses'){
      const w = players[idx].totalStats.wins || 0;
      const l = players[idx].totalStats.losses || 0;
      players[idx].totalStats.total = w + l;

      const totalInputId = slot===0 ? 'e1_tt' : 'e2_tt';
      document.getElementById(totalInputId).value = w + l;
  }

  save();
  renderMain();
}

function upH2H(fromSlot,toSlot,field,value){
  const fi=fromSlot===0?p1i:p2i;
  const ti=toSlot===0?p1i:p2i;
  const oldH={...getH2H(fi,ti)};
  const newH={...oldH,[field]:Number(value)||0};
  if(field==='wins'||field==='losses'){
    const w=field==='wins'?Number(value)||0:oldH.wins||0;
    const l=field==='losses'?Number(value)||0:oldH.losses||0;
    newH.total=w+l;
  }
  setH2H(fi,ti,newH);
  setH2H(ti,fi,{total:newH.total,wins:newH.losses||0,losses:newH.wins||0});
  save();refreshH2HFields();renderMain();
}

function upH2HModal(fs,ts,field,value){
  upH2H(fs,ts,field,value);
  refreshStatsModal();
}

function resetH2H(){
  const e={total:0,wins:0,losses:0};
  setH2H(p1i,p2i,e);setH2H(p2i,p1i,e);
  save();refreshH2HFields();renderMain();refreshStatsModal();
}

// ======================================================
// IMAGE UPLOAD â€” saves to both player object AND separate localStorage key
// ======================================================

function cropToSquare(dataURL, size, cb){
  const img = new Image();
  img.onload = function(){
    const canvas = document.createElement('canvas');
    canvas.width = size; canvas.height = size;
    const ctx = canvas.getContext('2d');
    // Center-crop: find the shortest side and crop square from center
    const s = Math.min(img.width, img.height);
    const sx = (img.width - s) / 2;
    const sy = (img.height - s) / 2;
    ctx.drawImage(img, sx, sy, s, s, 0, 0, size, size);
    cb(canvas.toDataURL('image/jpeg', 0.92));
  };
  img.src = dataURL;
}

function upImg(slot,input){
  const file=input.files[0];
  if(!file) return;
  const idx = slot===0 ? p1i : p2i;
  const reader = new FileReader();
  reader.onload = function(e){
    cropToSquare(e.target.result, 600, function(cropped){
      players[idx].image = cropped;
      try{
        localStorage.setItem('sm2_img_'+players[idx].id, cropped);
      }catch(err){ alert("Depolama doldu."); }
      save();
      renderMain();
    });
  };
  reader.readAsDataURL(file);
}



function upImgById(playerIdx,input){
  const file=input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    cropToSquare(e.target.result, 600, function(cropped){
      players[playerIdx].image = cropped;
      try{
        localStorage.setItem('sm2_img_'+players[playerIdx].id, cropped);
      }catch(err){ alert("Depolama doldu."); }
      save();
      renderMain();
      buildPlayersGrid();
    });
  };
  reader.readAsDataURL(file);
}

function deletePlayerCustom(index){
  const p = players[index];
  if(!p) return;
  if(!confirm("Bu yarÄ±ÅŸmacÄ±yÄ± silmek istediÄŸine emin misin?")) return;
  try{ localStorage.removeItem('sm2_img_'+p.id); }catch(e){}
  players.splice(index,1);
  if(players.length<2) players.push(mkP());
  p1i=0; p2i=1;
  save();
  updateSelects();
  renderMain();
  buildPlayersGrid();
}


function upFlagImg(team,pi,input){
  const file=input.files[0];if(!file)return;
  const r=new FileReader();
  r.onloadend=()=>{
    cropToSquare(r.result, 600, function(cropped){
      flagImgs[team][pi]=cropped;renderFlag();
    });
  };
  r.readAsDataURL(file);
}

// ======================================================
// SELECTS & EDITORS
// ======================================================
function updateSelects(){
  ['sel1','sel2','d_s1','d_s2','f_r1','f_r2','f_b1s','f_b2s'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    const cur=el.value;
    el.innerHTML=players.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
    if(cur!==''&&el.querySelector(`option[value="${cur}"]`))el.value=cur;
  });
  // d_s3 iÃ§in boÅŸ seÃ§enek + tÃ¼m yarÄ±ÅŸmacÄ±lar
  const d_s3el = document.getElementById('d_s3');
  if(d_s3el){
    d_s3el.innerHTML = '<option value="">â€” SeÃ§ilmedi â€”</option>' +
      players.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
  }
  document.getElementById('sel1').value=p1i;
  document.getElementById('sel2').value=p2i;
}

function onSel(){
  p1i=Number(document.getElementById('sel1').value);
  p2i=Number(document.getElementById('sel2').value);
  refreshEditors();renderMain();
}

function sv(id,v){const el=document.getElementById(id);if(el)el.value=v??'';}

function refreshEditors(){
  const p1=players[p1i],p2=players[p2i];if(!p1||!p2)return;
  sv('e1_name',p1.name);svStatus('e1_status',p1.status);sv('e1_score',p1.score);sv('e1_team',p1.team);
  sv('e1_tt',p1.totalStats.total);sv('e1_tw',p1.totalStats.wins);sv('e1_tl',p1.totalStats.losses);
  const h1=getH2H(p1i,p2i);sv('e1_hw',h1.wins);sv('e1_hl',h1.losses);
  sv('e2_name',p2.name);svStatus('e2_status',p2.status);sv('e2_score',p2.score);sv('e2_team',p2.team);
  sv('e2_tt',p2.totalStats.total);sv('e2_tw',p2.totalStats.wins);sv('e2_tl',p2.totalStats.losses);
  const h2=getH2H(p2i,p1i);sv('e2_hw',h2.wins);sv('e2_hl',h2.losses);
}

function svStatus(id, val) {
  const el = document.getElementById(id); if (!el) return;
  // EÄŸer deÄŸer seÃ§eneklerde yoksa Ã¶zel seÃ§enek ekle
  if (val && !el.querySelector(`option[value="${val}"]`)) {
    const opt = document.createElement('option');
    opt.value = val; opt.textContent = val;
    el.appendChild(opt);
  }
  el.value = val || '';
}

function refreshH2HFields(){
  const h1=getH2H(p1i,p2i),h2=getH2H(p2i,p1i);
  sv('e1_hw',h1.wins);sv('e1_hl',h1.losses);
  sv('e2_hw',h2.wins);sv('e2_hl',h2.losses);
}

// ======================================================
// CANVAS HELPERS
// ======================================================
function pct(w,t){return t?((w/t)*100).toFixed(2):'0.00';}
function dstr(w,l){const d=w-l;return d>0?'+'+d:String(d);}

function statBox(label,s){
  return `<div style="border:3px solid white;border-radius:12px;overflow:hidden;background:rgba(0,0,0,.62);">
    <div style="background:white;color:black;text-align:center;padding:4px 0;font-weight:800;font-size:13px;text-transform:uppercase;letter-spacing:.12em;font-family:'Barlow Condensed',sans-serif;">${label}</div>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);text-align:center;font-size:10px;font-weight:700;padding:8px 0;border-bottom:2px solid rgba(255,255,255,.25);text-transform:uppercase;color:white;font-family:'Barlow Condensed',sans-serif;letter-spacing:.06em;">
      <div>TOPLAM</div><div>GALÄ°BÄ°YET</div><div>YENÄ°LGÄ°</div><div>%</div><div>PUAN</div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);text-align:center;font-size:30px;font-weight:700;padding:14px 0;color:white;font-family:'Barlow Condensed',sans-serif;">
      <div>${s.total}</div><div>${s.wins}</div><div>${s.losses}</div><div>${pct(s.wins,s.total)}</div><div>${dstr(s.wins,s.losses)}</div>
    </div>
  </div>`;
}

function imgEl(img){
  return img
    ?`<div style="width:100%;height:100%;background-image:url('${img}');background-size:cover;background-position:center;background-repeat:no-repeat;"></div>`
    :`<div style="color:rgba(255,255,255,.2);font-weight:900;font-size:15px;text-align:center;">RESÄ°M YOK</div>`;
}

function buildMainRow(p,h2h,rev){
  const bg=p.team==='kirmizi'?'background:linear-gradient(to right,#5a0000,#8b0000)':'background:linear-gradient(to right,#001f5c,#003399)';
  const dir=rev?'flex-direction:row-reverse':'';
  const tl=p.team==='kirmizi'?'KIRMIZÄ±':'MAVÄ°';
  const stag=p.status?`<div style="position:absolute;bottom:60px;left:50%;transform:translateX(-50%);background:none;color:#FFD700;font-size:40px;font-weight:900;text-transform:uppercase;z-index:3;white-space:nowrap;font-family:'Barlow Condensed',sans-serif;text-shadow:0 0 12px rgba(0,0,0,1);">${p.status}</div>`:'';
  return `<div style="display:flex;align-items:center;width:1080px;min-height:310px;padding:30px 40px;color:white;position:relative;overflow:hidden;${bg};">
    <div style="display:flex;width:100%;align-items:center;gap:28px;${dir}">
      <div style="display:flex;flex-direction:column;align-items:center;min-width:120px;">
        <span style="font-size:100px;font-weight:700;font-style:italic;line-height:1;font-family:'Barlow Condensed',sans-serif;">${p.score}</span>
        <span style="font-size:19px;font-weight:700;letter-spacing:.3em;text-transform:uppercase;font-family:'Barlow Condensed',sans-serif;">${tl}</span>
      </div>
      <div style="flex:1;display:flex;flex-direction:column;gap:12px;max-width:410px;">
        ${statBox('TOPLAM',p.totalStats)}
        ${statBox('KARÅILIKLI',h2h)}
      </div>
      <div style="position:relative;display:flex;flex-direction:column;align-items:center;">
        <div style="width:280px;height:280px;border-radius:50%;border:8px solid white;overflow:hidden;background:#1e293b;box-shadow:0 8px 40px rgba(0,0,0,.5);">${imgEl(p.image)}</div>
        ${stag}
        <div style="position:absolute;bottom:-18px;left:50%;transform:translateX(-50%) skewX(-12deg);background:rgba(0,0,0,.92);color:white;padding:10px 30px;font-size:25px;font-weight:700;text-transform:uppercase;white-space:nowrap;border-left:4px solid white;border-right:4px solid white;letter-spacing:.08em;font-family:'Barlow Condensed',sans-serif;">${p.name}</div>
      </div>
    </div>
  </div>`;
}

function renderMain(){
  const gv=id=>document.getElementById(id)?.value||'';
  document.getElementById('cv_ht').textContent=gv('cfg_ht');
  document.getElementById('cv_title').textContent=gv('cfg_title');
  const b1val=gv('cfg_b1'), b2val=gv('cfg_b2');
  const b1el=document.getElementById('cv_b1'), b2el=document.getElementById('cv_b2');
  if(b1el){b1el.textContent=b1val; b1el.style.display=b1val?'':'none';}
  if(b2el){b2el.textContent=b2val; b2el.style.display=b2val?'':'none';}
  const p1=players[p1i],p2=players[p2i];if(!p1||!p2)return;
  document.getElementById('cv_r1').innerHTML=buildMainRow(p1,getH2H(p1i,p2i),false);
  document.getElementById('cv_r2').innerHTML=buildMainRow(p2,getH2H(p2i,p1i),true);
  scaleAll();
}

function buildDuelRow(p,rev,statusTag){
  const bg=p.team==='kirmizi'?'background:linear-gradient(to right,#5a0000,#8b0000)':'background:linear-gradient(to right,#001f5c,#003399)';
  const dir=rev?'flex-direction:row-reverse':'';
  const s=p.totalStats;
  const stag=statusTag?`<div style="position:absolute;bottom:60px;left:50%;transform:translateX(-50%);background:none;color:#FFD700;font-size:40px;font-weight:900;text-transform:uppercase;z-index:3;white-space:nowrap;font-family:'Barlow Condensed',sans-serif;text-shadow:0 0 12px rgba(0,0,0,1);">${statusTag}</div>`:'';
  return `<div style="display:flex;align-items:center;width:1080px;min-height:265px;padding:26px 40px;color:white;position:relative;overflow:hidden;${bg};">
    <div style="display:flex;width:100%;align-items:center;gap:24px;${dir}">
      <div style="display:flex;flex-direction:column;align-items:center;min-width:108px;">
        <span style="font-size:92px;font-weight:700;font-style:italic;line-height:1;font-family:'Barlow Condensed',sans-serif;">${p.score}</span>
        <span style="font-size:17px;font-weight:700;letter-spacing:.3em;text-transform:uppercase;font-family:'Barlow Condensed',sans-serif;">${p.name}</span>
      </div>
      <div style="flex:1;max-width:420px;">${statBox('GENEL TOPLAM',s)}</div>
      <div style="position:relative;display:flex;flex-direction:column;align-items:center;">
        <div style="width:255px;height:255px;border-radius:50%;border:7px solid white;overflow:hidden;background:#1e293b;box-shadow:0 8px 36px rgba(0,0,0,.5);">${imgEl(p.image)}</div>
        ${stag}
        <div style="position:absolute;bottom:-16px;left:50%;transform:translateX(-50%) skewX(-12deg);background:rgba(0,0,0,.92);color:white;padding:9px 26px;font-size:23px;font-weight:700;text-transform:uppercase;white-space:nowrap;border-left:4px solid white;border-right:4px solid white;font-family:'Barlow Condensed',sans-serif;">${p.name}</div>
      </div>
    </div>
  </div>`;
}

function duelLoadPlayer(slot){
  const selId=slot===1?'d_s1':'d_s2';
  const idx=Number(document.getElementById(selId)?.value||0);
  const p=players[idx];if(!p)return;
  sv('d_tt'+slot,p.totalStats.total);
  sv('d_tw'+slot,p.totalStats.wins);
  sv('d_tl'+slot,p.totalStats.losses);
  sv('d_sc'+slot,p.score);
  sv('d_t'+slot,p.team);
  renderDuel();
}

function renderDuel(){
  const gv=id=>document.getElementById(id)?.value||'0';
  const gvStr=id=>document.getElementById(id)?.value||'';
  const i1=Number(gv('d_s1')),i2=Number(gv('d_s2'));
  const p1={
    ...players[i1],
    score:gv('d_sc1'),
    team:document.getElementById('d_t1')?.value||'kirmizi',
    totalStats:{total:Number(gv('d_tt1'))||0,wins:Number(gv('d_tw1'))||0,losses:Number(gv('d_tl1'))||0}
  };
  const p2={
    ...players[i2],
    score:gv('d_sc2'),
    team:document.getElementById('d_t2')?.value||'mavi',
    totalStats:{total:Number(gv('d_tt2'))||0,wins:Number(gv('d_tw2'))||0,losses:Number(gv('d_tl2'))||0}
  };
  // Kazanan / Elenen â€” sadece aÃ§Ä±kÃ§a seÃ§ilmiÅŸse gÃ¶ster, Ã§akÄ±ÅŸma Ã¶nle
  const winner = gvStr('d_winner');
  const loser = gvStr('d_loser');
  const shooter = gvStr('d_shooter');
  // p1 statÃ¼sÃ¼: kazanan seÃ§ildiyse ve p1 kazanandaysa KAZANAN; elenen seÃ§ildiyse ve p1 elenendeyse ve p1 kazanan DEÄÄ°LSE ELENEN
  const p1Status = (winner && winner===p1.name) ? 'KAZANAN' : (loser && loser===p1.name && winner!==p1.name) ? 'ELENDÄ°' : '';
  // p2 statÃ¼sÃ¼: aynÄ± mantÄ±k
  const p2Status = (winner && winner===p2.name) ? 'KAZANAN' : (loser && loser===p2.name && winner!==p2.name) ? 'ELENDÄ°' : '';
  document.getElementById('duel_r1').innerHTML=buildDuelRow(p1,false,p1Status);
  document.getElementById('duel_r2').innerHTML=buildDuelRow(p2,true,p2Status);
  // AtÄ±ÅŸ tipi badge ve atÄ±ÅŸ seÃ§en bilgisi gÃ¼ncelle
  const atisBtn=document.querySelector('[data-group="dgt_atis"][data-active="1"]');
  const atisVal=atisBtn?atisBtn.dataset.val:'';
  const badgeEl=document.getElementById('duel_badges');
  if(badgeEl){
    let badgeHTML = atisVal?`<div class="cv-badge">${atisVal}</div>`:'';
    if(shooter) badgeHTML += `<div class="cv-badge" style="background:#1a2333;border-color:rgba(255,255,255,.3);">ğŸ¯ AtÄ±ÅŸ SeÃ§en: ${shooter}</div>`;
    badgeEl.innerHTML = badgeHTML;
  }
  // 3. yarÄ±ÅŸmacÄ± varsa gÃ¶ster
  const i3val=document.getElementById('d_s3')?.value;
  const i3=i3val?Number(i3val):null;
  const duelExtra=document.getElementById('duel_extra');
  if(duelExtra){
    if(i3!==null && players[i3]){
      const p3={...players[i3],score:'',team:players[i3].team,totalStats:players[i3].totalStats};
      duelExtra.style.display='';
      duelExtra.innerHTML=buildDuelRow(p3,false,'');
    } else { duelExtra.style.display='none'; duelExtra.innerHTML=''; }
  }
  scaleAll();
}

function buildFlagRow(score,team,stats,imgs,rev,winnerTag,names){
  const bg=team==='kirmizi'?'background:linear-gradient(to right,#5a0000,#8b0000)':'background:linear-gradient(to right,#001f5c,#003399)';
  const dir=rev?'flex-direction:row-reverse':'';
  const tl=team==='kirmizi'?'KIRMIZI':'MAVÄ°';
  const n1=names&&names[0]?names[0]:'';
  const n2=names&&names[1]?names[1]:'';
  const topHalf=imgs[0]?`<div style="width:100%;height:100%;background-image:url('${imgs[0]}');background-size:cover;background-position:center top;"></div>`:'<div style="font-size:11px;font-weight:700;color:rgba(255,255,255,.5);text-align:center;">1</div>';
  const botHalf=imgs[1]?`<div style="width:100%;height:100%;background-image:url('${imgs[1]}');background-size:cover;background-position:center top;"></div>`:'<div style="font-size:11px;font-weight:700;color:rgba(255,255,255,.5);text-align:center;">2</div>';
  const s=stats;
  const stag=winnerTag?`<div style="background:none;color:#FFD700;font-size:40px;font-weight:900;text-transform:uppercase;z-index:3;white-space:nowrap;font-family:'Barlow Condensed',sans-serif;text-shadow:0 0 12px rgba(0,0,0,1);text-align:center;margin-bottom:6px;">${winnerTag}</div>`:'';
  return `<div style="display:flex;align-items:center;width:1080px;min-height:260px;padding:22px 34px;color:white;position:relative;overflow:hidden;${bg};">
    <div style="display:flex;width:100%;align-items:center;gap:22px;${dir}">
      <div style="display:flex;flex-direction:column;align-items:center;min-width:96px;">
        <span style="font-size:84px;font-weight:700;font-style:italic;line-height:1;font-family:'Barlow Condensed',sans-serif;">${score}</span>
        <span style="font-size:15px;font-weight:700;letter-spacing:.3em;text-transform:uppercase;font-family:'Barlow Condensed',sans-serif;">${tl}</span>
      </div>
      <div style="flex:1;max-width:390px;">
        <div style="border:2px solid white;border-radius:10px;overflow:hidden;background:rgba(0,0,0,.58);">
          <div style="background:white;color:black;text-align:center;padding:3px 0;font-weight:800;font-size:11px;text-transform:uppercase;font-family:'Barlow Condensed',sans-serif;letter-spacing:.1em;">TOPLAM</div>
          <div style="display:grid;grid-template-columns:repeat(5,1fr);text-align:center;font-size:9px;font-weight:700;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.28);text-transform:uppercase;color:white;font-family:'Barlow Condensed',sans-serif;letter-spacing:.04em;">
            <div>TOPLAM</div><div>GALÄ°BÄ°YET</div><div>YENÄ°LGÄ°</div><div>%</div><div>PUAN</div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(5,1fr);text-align:center;font-size:22px;font-weight:700;padding:12px 0;color:white;font-family:'Barlow Condensed',sans-serif;">
            <div>${s.total}</div><div>${s.wins}</div><div>${s.losses}</div><div>${pct(s.wins,s.total)}</div><div>${dstr(s.wins,s.losses)}</div>
          </div>
        </div>
      </div>
      <div style="position:relative;display:flex;flex-direction:column;align-items:center;">
        ${stag}
        <div style="display:flex;align-items:flex-end;gap:18px;">
          <div style="display:flex;flex-direction:column;align-items:center;gap:0">
            <div style="width:190px;height:190px;border-radius:50%;border:6px solid white;overflow:hidden;background:#1e293b;box-shadow:0 8px 36px rgba(0,0,0,.5);">${topHalf}</div>
            ${n1?`<div style="margin-top:8px;background:rgba(0,0,0,.85);color:white;padding:5px 14px;font-size:16px;font-weight:900;text-transform:uppercase;white-space:nowrap;font-family:'Barlow Condensed',sans-serif;border-left:3px solid white;border-right:3px solid white;letter-spacing:.08em;">${n1}</div>`:''}
          </div>
          <div style="display:flex;flex-direction:column;align-items:center;gap:0">
            <div style="width:190px;height:190px;border-radius:50%;border:6px solid white;overflow:hidden;background:#1e293b;box-shadow:0 8px 36px rgba(0,0,0,.5);">${botHalf}</div>
            ${n2?`<div style="margin-top:8px;background:rgba(0,0,0,.85);color:white;padding:5px 14px;font-size:16px;font-weight:900;text-transform:uppercase;white-space:nowrap;font-family:'Barlow Condensed',sans-serif;border-left:3px solid white;border-right:3px solid white;letter-spacing:.08em;">${n2}</div>`:''}
          </div>
        </div>
        <div style="position:absolute;bottom:-13px;left:50%;transform:translateX(-50%) skewX(-10deg);background:rgba(0,0,0,.9);color:white;padding:6px 20px;font-size:16px;font-weight:700;text-transform:uppercase;white-space:nowrap;font-family:'Barlow Condensed',sans-serif;">${tl} TAKIM</div>
      </div>
    </div>
  </div>`;
}

function renderFlag(){
  const gv=id=>document.getElementById(id)?.value||'';
  document.getElementById('f_cv_ht').textContent=gv('f_ht');
  document.getElementById('f_cv_title').textContent=gv('f_title');
  document.getElementById('f_cv_b1').textContent=gv('f_b1');
  document.getElementById('f_cv_b2').textContent=gv('f_b2');
  const ri1=Number(gv('f_r1')),ri2=Number(gv('f_r2'));
  const bi1=Number(gv('f_b1s')),bi2=Number(gv('f_b2s'));
  const rS={total:+gv('f_rt'),wins:+gv('f_rw'),losses:+gv('f_rl')};
  const bS={total:+gv('f_bt'),wins:+gv('f_bw'),losses:+gv('f_bl')};
  const rI=[flagImgs.red[0]||(players[ri1]?.image)||null, flagImgs.red[1]||(players[ri2]?.image)||null];
  const bI=[flagImgs.blue[0]||(players[bi1]?.image)||null, flagImgs.blue[1]||(players[bi2]?.image)||null];
  const winner=gv('f_winner');
  const redTag=winner==='KÄ±rmÄ±zÄ±' ? 'KAZANAN' : '';
  const blueTag=winner==='Mavi' ? 'KAZANAN' : '';
  document.getElementById('flag_r1').innerHTML=buildFlagRow(gv('f_rs'),'kirmizi',rS,rI,false,redTag,[players[ri1]?.name||'',players[ri2]?.name||'']);
  document.getElementById('flag_r2').innerHTML=buildFlagRow(gv('f_bs'),'mavi',bS,bI,true,blueTag,[players[bi1]?.name||'',players[bi2]?.name||'']);
  scaleAll();
}

// ======================================================
// STATS MODAL
// ======================================================
function refreshStatsModal(){
  const tb=document.getElementById('stats_body');if(!tb)return;
  const sorted=[...players].map((p,i)=>({i,wr:p.totalStats.total?(p.totalStats.wins/p.totalStats.total)*100:0})).sort((a,b)=>b.wr-a.wr);
  const rankMap={};sorted.forEach((item,rank)=>rankMap[item.i]=rank);
  tb.innerHTML=players.map((p,i)=>{
    const wr=p.totalStats.total?((p.totalStats.wins/p.totalStats.total)*100).toFixed(1)+'%':'0.0%';
    const sc=p.totalStats.wins-p.totalStats.losses;
    const tc=p.team==='kirmizi'?'#dc2626':'#2563eb';
    const rank=rankMap[i]??i;
    const rankCell=rank===0?'ğŸ¥‡':rank===1?'ğŸ¥ˆ':rank===2?'ğŸ¥‰':`${rank+1}`;
    return `<tr onclick="openDetail(${i})" style="cursor:pointer">
      <td style="font-weight:700;text-align:center">${rankCell}</td>
      <td class="tc">
        ${p.image 
            ? `<div class="photo-container" style="border:3px solid ${tc};"><img src="${p.image}" class="player-photo"></div>`
            : `<div style="width:60px;height:60px;border-radius:50%;background:#e2e8f0;display:flex;align-items:center;justify-content:center;font-weight:900;color:${tc};">${p.name.charAt(0)}</div>`}
      </td>
      <td style="font-weight:700;color:${tc}">${p.name}</td>
      <td style="text-transform:uppercase;font-size:11px;font-weight:600;color:${tc}">${p.team}</td>
      <td class="tc" style="font-weight:700;color:black">${p.totalStats.total}</td>
      <td class="tc" style="font-weight:700;color:black">${p.totalStats.wins}</td>
      <td class="tc" style="font-weight:700;color:black">${p.totalStats.losses}</td>
      <td class="tc" style="font-weight:700;color:black">${wr}</td>
      <td class="tc" style="font-weight:700;color:black">${sc>0?'+':''}${sc}</td>
    </tr>`;
  }).join('');
  const p1=players[p1i],p2=players[p2i];
  if(p1&&p2){
    const h1=getH2H(p1i,p2i),h2=getH2H(p2i,p1i);
    document.getElementById('h2h_n1').textContent=p1.name;
    document.getElementById('h2h_n2').textContent=p2.name;
    document.getElementById('h2h_w1').textContent=h1.wins;
    document.getElementById('h2h_w2').textContent=h2.wins;
    document.getElementById('h2h_lbl1').textContent=p1.name+' Galibiyet';
    document.getElementById('h2h_lbl2').textContent=p2.name+' Galibiyet';
    sv('h2h_inp1',h1.wins);sv('h2h_inp2',h2.wins);sv('h2h_inp1l',h1.losses);
  }
}

// ======================================================
// SORT STATS
// ======================================================
function sortStats(type){
  if(type==='percent'){
    players.sort((a,b)=>{
      const pa=a.totalStats.total?(a.totalStats.wins/a.totalStats.total)*100:0;
      const pb=b.totalStats.total?(b.totalStats.wins/b.totalStats.total)*100:0;
      return pb-pa;
    });
  }
  if(type==='score'){
    players.sort((a,b)=>{
      const sa=(b.totalStats.wins||0)-(b.totalStats.losses||0);
      const sb=(a.totalStats.wins||0)-(a.totalStats.losses||0);
      return sa-sb;
    });
  }
  save();
  updateSelects();
  refreshStatsModal();
}

// ======================================================
// DETAIL MODAL
// ======================================================
let _detailIdx = 0;
let _detailSort = 'total'; // 'total','percent','score'

function openDetail(idx){
  _detailIdx = idx;
  _detailSort = 'total';
  renderDetailModal();
  openM('m_detail');
}

function renderDetailModal(){
  const idx = _detailIdx;
  const p=players[idx];
  if(!p) return;
  const tc=p.team==='kirmizi'?'#dc2626':'#2563eb';
  const bg=p.team==='kirmizi'?'#fee2e2':'#dbeafe';
  const wr=p.totalStats.total?((p.totalStats.wins/p.totalStats.total)*100).toFixed(1):'0.0';
  const score=(p.totalStats.wins||0)-(p.totalStats.losses||0);
  const ps=calcPowerScore(p);

  // H2H verisini topla
  let h2hData=[];
  players.forEach((opp,oi)=>{
    if(oi===idx)return;
    const h=p.h2hRegistry[opp.id]||{total:0,wins:0,losses:0};
    const oc=opp.team==='kirmizi'?'#dc2626':'#2563eb';
    const pct=h.total?((h.wins/h.total)*100):0;
    const pu=h.wins-h.losses;
    h2hData.push({opp,oi,h,oc,pct,pu});
  });

  // SÄ±rala
  if(_detailSort==='percent') h2hData.sort((a,b)=>b.pct-a.pct||b.h.total-a.h.total);
  else if(_detailSort==='score') h2hData.sort((a,b)=>b.pu-a.pu||b.h.total-a.h.total);
  else h2hData.sort((a,b)=>b.h.total-a.h.total||b.pct-a.pct);

  let rows=h2hData.map(({opp,oi,h,oc,pct,pu})=>{
    const bg2=pct>=60?'#f0fdf4':pct<=40?'#fef2f2':'#f8fafc';
    return `<tr style="background:${bg2}">
      <td>
        ${opp.image?`<img src="${opp.image}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid ${oc};vertical-align:middle;margin-right:6px;">`:''}
        <span style="font-weight:700;color:${oc}">${opp.name}</span>
      </td>
      <td class="tc"><input type="number" style="width:52px;text-align:center;border:1px solid #e2e8f0;border-radius:6px;padding:4px;font-weight:700;color:#16a34a" value="${h.wins}" onchange="h2hDetailChange(${idx},${oi},this.value,${h.losses})"></td>
      <td class="tc"><input type="number" style="width:52px;text-align:center;border:1px solid #e2e8f0;border-radius:6px;padding:4px;font-weight:700;color:#dc2626" value="${h.losses}" onchange="h2hDetailChange(${idx},${oi},${h.wins},this.value)"></td>
      <td class="tc" style="font-weight:900;font-size:15px;color:${pct>=50?'#16a34a':'#dc2626'}">${pct.toFixed(0)}%</td>
      <td class="tc" style="font-weight:900;font-size:15px;color:${pu>=0?'#16a34a':'#dc2626'}">${pu>0?'+':''}${pu}</td>
      <td class="tc" style="font-size:11px;color:#94a3b8">${h.total}T</td>
    </tr>`;
  }).join('');

  // Son 8 maÃ§
  const recentGames = loadGames().filter(g=>g.p1Name===p.name||g.p2Name===p.name)
    .sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,8);
  const formHtml = recentGames.length>0
    ? recentGames.map(g=>{
        const win=g.winner===p.name; const draw=g.winner==='Berabere';
        const opp=g.p1Name===p.name?g.p2Name:g.p1Name;
        return `<div style="display:flex;align-items:center;gap:6px;padding:4px 8px;background:${draw?'#fef3c7':win?'#f0fdf4':'#fef2f2'};border-radius:8px;border-left:3px solid ${draw?'#f59e0b':win?'#16a34a':'#dc2626'}">
          <span style="font-size:12px;font-weight:900;color:${draw?'#d97706':win?'#16a34a':'#dc2626'}">${draw?'B':win?'G':'M'}</span>
          <span style="font-size:12px;font-weight:600;flex:1">${opp}</span>
          <span style="font-size:11px;color:#94a3b8">${g.gameType||'â€”'}</span>
        </div>`;
      }).join('')
    : '<div style="color:#94a3b8;font-size:13px;padding:8px">HenÃ¼z kayÄ±tlÄ± maÃ§ yok</div>';

  document.getElementById('detail_body').innerHTML=`
    <!-- BaÅŸlÄ±k -->
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:18px;padding:16px;background:${bg};border-radius:14px;">
      ${p.image
        ? `<div style="width:80px;height:80px;border-radius:50%;overflow:hidden;border:3px solid ${tc};flex-shrink:0;"><img src="${p.image}" style="width:100%;height:100%;object-fit:cover;"></div>`
        : `<div style="width:80px;height:80px;border-radius:50%;background:${tc};display:flex;align-items:center;justify-content:center;color:white;font-size:30px;font-weight:900;flex-shrink:0;">${p.name.charAt(0)}</div>`}
      <div style="flex:1">
        <h2 style="font-size:24px;font-weight:900;text-transform:uppercase;color:${tc};margin-bottom:4px">${p.name}</h2>
        <div style="font-size:12px;font-weight:700;color:#64748b;text-transform:uppercase">${p.team==='kirmizi'?'ğŸ”´ KÄ±rmÄ±zÄ± TakÄ±m':'ğŸ”µ Mavi TakÄ±m'} Â· ${p.status||'YarÄ±ÅŸmacÄ±'}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;color:#94a3b8;font-weight:700">POWER SCORE</div>
        <div style="font-size:36px;font-weight:900;color:${ps.scoreColor}">${ps.score}</div>
        <div style="font-size:12px;font-weight:700;color:${ps.scoreColor}">${ps.badge}</div>
      </div>
    </div>

    <!-- Ä°statistik kartlarÄ± -->
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:18px">
      <div style="background:#f8fafc;padding:12px;border-radius:10px;text-align:center;border:1px solid #e2e8f0"><div style="font-size:9px;color:#94a3b8;font-weight:700;text-transform:uppercase">TOPLAM</div><div style="font-size:24px;font-weight:900">${p.totalStats.total||0}</div></div>
      <div style="background:#f0fdf4;padding:12px;border-radius:10px;text-align:center;border:1px solid #bbf7d0"><div style="font-size:9px;color:#16a34a;font-weight:700;text-transform:uppercase">GALÄ°BÄ°YET</div><div style="font-size:24px;font-weight:900;color:#16a34a">${p.totalStats.wins||0}</div></div>
      <div style="background:#fef2f2;padding:12px;border-radius:10px;text-align:center;border:1px solid #fecaca"><div style="font-size:9px;color:#dc2626;font-weight:700;text-transform:uppercase">YENÄ°LGÄ°</div><div style="font-size:24px;font-weight:900;color:#dc2626">${p.totalStats.losses||0}</div></div>
      <div style="background:#eff6ff;padding:12px;border-radius:10px;text-align:center;border:1px solid #bfdbfe"><div style="font-size:9px;color:#2563eb;font-weight:700;text-transform:uppercase">WIN %</div><div style="font-size:24px;font-weight:900;color:#2563eb">${wr}%</div></div>
      <div style="background:#faf5ff;padding:12px;border-radius:10px;text-align:center;border:1px solid #e9d5ff"><div style="font-size:9px;color:#7c3aed;font-weight:700;text-transform:uppercase">PUAN</div><div style="font-size:24px;font-weight:900;color:${score>=0?'#16a34a':'#dc2626'}">${score>=0?'+':''}${score}</div></div>
    </div>

    <!-- Son maÃ§lar -->
    <div style="margin-bottom:18px">
      <div style="font-size:11px;font-weight:900;color:#94a3b8;text-transform:uppercase;letter-spacing:.1em;border-bottom:1px solid #f1f5f9;padding-bottom:5px;margin-bottom:8px">ğŸ“‹ Son 8 MaÃ§</div>
      <div style="display:flex;flex-direction:column;gap:4px">${formHtml}</div>
    </div>

    <!-- H2H baÅŸlÄ±k + sÄ±ralama -->
    <div style="display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #f1f5f9;padding-bottom:8px;margin-bottom:10px">
      <div style="font-size:11px;font-weight:900;color:#94a3b8;text-transform:uppercase;letter-spacing:.1em">âš”ï¸ Birebir Ä°statistikler</div>
      <div style="display:flex;gap:6px">
        <button onclick="_detailSort='total';renderDetailModal()" style="padding:4px 10px;border-radius:6px;border:1px solid #e2e8f0;font-size:11px;font-weight:700;cursor:pointer;background:${_detailSort==='total'?tc:'white'};color:${_detailSort==='total'?'white':'#374151'}">Toplam</button>
        <button onclick="_detailSort='percent';renderDetailModal()" style="padding:4px 10px;border-radius:6px;border:1px solid #e2e8f0;font-size:11px;font-weight:700;cursor:pointer;background:${_detailSort==='percent'?tc:'white'};color:${_detailSort==='percent'?'white':'#374151'}">% SÄ±rala</button>
        <button onclick="_detailSort='score';renderDetailModal()" style="padding:4px 10px;border-radius:6px;border:1px solid #e2e8f0;font-size:11px;font-weight:700;cursor:pointer;background:${_detailSort==='score'?tc:'white'};color:${_detailSort==='score'?'white':'#374151'}">Puan</button>
      </div>
    </div>
    <div style="overflow-x:auto">
      <table><thead><tr><th>Rakip</th><th class="tc">G</th><th class="tc">Y</th><th class="tc">Win%</th><th class="tc">Puan</th><th class="tc">Top</th></tr></thead>
      <tbody>${rows||'<tr><td colspan="6" style="text-align:center;padding:14px;color:#94a3b8">Rakip verisi yok</td></tr>'}</tbody></table>
    </div>`;
}

function h2hDetailChange(fi,ti,w,l){
  const wins=Number(w)||0,losses=Number(l)||0;
  const newH={total:wins+losses,wins,losses};
  setH2H(fi,ti,newH);
  setH2H(ti,fi,{total:wins+losses,wins:losses,losses:wins});
  save();refreshH2HFields();renderMain();refreshStatsModal();
}

// ======================================================
// PLAYERS GRID
// ======================================================
function buildPlayersGrid(){

  const g=document.getElementById('players_grid');if(!g)return;
  g.innerHTML=players.map((p,i)=>{
    const tc=p.team==='kirmizi'?'#dc2626':'#2563eb';
    const imgThumb=p.image
      ?`<div style="width:48px;height:48px;border-radius:50%;background-image:url('${p.image}');background-size:cover;background-position:center;border:2px solid ${tc};flex-shrink:0;"></div>`
      :`<div style="width:48px;height:48px;border-radius:50%;background:#e2e8f0;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;color:${tc};flex-shrink:0;">${p.name.charAt(0)}</div>`;
    return `<div style="background:#f8fafc;border-radius:12px;padding:14px;border:1px solid #e2e8f0">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        ${imgThumb}
        <div style="font-size:15px;font-weight:900;color:${tc}">${p.name}</div>
      </div>
      <div style="margin-bottom:8px">
        <label style="font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;display:block;margin-bottom:3px">FotoÄŸraf GÃ¼ncelle</label>
        <input type="file" accept="image/*" onchange="upImgById(${i},this)" style="font-size:11px;width:100%">
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:9px">
        <div style="background:white;padding:7px;border-radius:7px;text-align:center"><div style="font-size:9px;color:#94a3b8;font-weight:700">Toplam</div><div style="font-size:15px;font-weight:900">${p.totalStats.total}</div></div>
        <div style="background:white;padding:7px;border-radius:7px;text-align:center"><div style="font-size:9px;color:#16a34a;font-weight:700">G</div><div style="font-size:15px;font-weight:900;color:#16a34a">${p.totalStats.wins}</div></div>
        <div style="background:white;padding:7px;border-radius:7px;text-align:center"><div style="font-size:9px;color:#dc2626;font-weight:700">Y</div><div style="font-size:15px;font-weight:900;color:#dc2626">${p.totalStats.losses}</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <button onclick="p1i=${i};updateSelects();refreshEditors();renderMain();closeM('m_players')" style="background:#2563eb;color:white;border:none;padding:7px;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer">1. SeÃ§</button>
        <button onclick="p2i=${i};updateSelects();refreshEditors();renderMain();closeM('m_players')" style="background:#dc2626;color:white;border:none;padding:7px;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer">2. SeÃ§</button>
        <button onclick="deletePlayer(${i})" style="margin-top:8px;background:#ef4444;color:white;border:none;padding:8px;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;width:100%">ğŸ—‘ Sil</button>
      </div>
    </div>`;
  }).join('');
}


function deletePlayer(index){
  const p = players[index];
  if(!p) return;
  if(!confirm("YarÄ±ÅŸmacÄ± silinsin mi?")) return;
  try{ localStorage.removeItem('sm2_img_'+p.id); }catch(e){}
  players.splice(index,1);
  if(players.length < 2){
    while(players.length < 2) players.push(mkP());
  }
  p1i = 0;
  p2i = 1;
  save();
  updateSelects();
  renderMain();
  buildPlayersGrid();
}

function addPlayer(){
  players.push(mkP());save();updateSelects();buildPlayersGrid();
}

// ======================================================
// MODALS
// ======================================================
function openM(id){
  document.getElementById(id)?.classList.add('open');
  if(id==='m_stats'){refreshStatsModal();}
  else if(id==='m_players'){buildPlayersGrid();}
  else if(id==='m_duel'){updateSelects();populateDuelResultSelects();setTimeout(()=>{duelLoadPlayer(1);duelLoadPlayer(2);},60);}
  else if(id==='m_flag'){updateSelects();setTimeout(renderFlag,60);}
  else if(id==='m_perf'){populatePerfSel();setTimeout(renderPerfCharts,100);}
  else if(id==='m_power'){renderPowerGrid();}
  else if(id==='m_h2hplus'){populateH2HSels();setTimeout(renderH2HPlus,60);}
  else if(id==='m_alltime'){setTimeout(()=>buildAlltimeList('wr'),80);}
  else if(id==='m_broadcast'){setTimeout(()=>setBroadcastMode('full'),60);}
  else if(id==='m_seasons'){buildSeasonsList();populateSeasonSel();}
  else if(id==='m_sim'){if(simPlayers.length===0)loadFromMain();renderSimPlayers();}
  else if(id==='m_elim'){populateElimSel();setTimeout(renderElimPanel,60);}
  else if(id==='m_new_design'){ populateNewDesignSels(); setTimeout(buildNewDesign, 80); }
  else if(id==='m_h2h_design'){ setTimeout(buildH2HDesign, 80); }
  setTimeout(scaleAll,120);
}
function closeM(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-bg').forEach(bg=>{
  bg.addEventListener('click',e=>{if(e.target===bg)bg.classList.remove('open');});
});

// ======================================================
// SCALE
// ======================================================
function scalePreview(scalerId,wrapId){
  const scaler=document.getElementById(scalerId);
  const wrap=document.getElementById(wrapId);
  if(!scaler||!wrap)return;
  const avail=wrap.clientWidth-32;
  const scale=Math.min(1,avail/1080);
  scaler.style.transform=`scale(${scale})`;
  scaler.style.transformOrigin='top center';
  requestAnimationFrame(()=>{
    const canvas=scaler.firstElementChild;
    if(!canvas)return;
    const ch=canvas.getBoundingClientRect().height/scale;
    scaler.style.height=(ch*scale)+'px';
    wrap.style.height=(ch*scale+32)+'px';
  });
}

function scaleAll(){
  scalePreview('main_scaler','main_wrap');
  scalePreview('duel_scaler','duel_wrap');
  scalePreview('flag_scaler','flag_wrap');
}
window.addEventListener('resize',scaleAll);

// ======================================================
// DOWNLOAD
// ======================================================
function dlCanvas(cvId,fname){
  const el=document.getElementById(cvId);if(!el){alert('Canvas bulunamadÄ±');return;}
  const scaler=el.parentElement;
  const wrap=scaler.parentElement;
  const sT=scaler.style.transform;
  const sH=scaler.style.height;
  const wH=wrap.style.height;
  const wO=wrap.style.overflow;
  scaler.style.transform='none';
  scaler.style.height='auto';
  wrap.style.height='auto';
  wrap.style.overflow='visible';
  setTimeout(()=>{
    html2canvas(el,{
      useCORS:true,
      allowTaint:true,
      scale:Math.max(3,window.devicePixelRatio||1),
      backgroundColor:'#000000',
      logging:false
    }).then(cv=>{
      scaler.style.transform=sT;scaler.style.height=sH;
      wrap.style.height=wH;wrap.style.overflow=wO;
      scaleAll();
      const a=document.createElement('a');
      a.download=`${fname}-${Date.now()}.png`;
      a.href=cv.toDataURL('image/png');
      document.body.appendChild(a);a.click();document.body.removeChild(a);
    }).catch(err=>{
      scaler.style.transform=sT;scaler.style.height=sH;
      wrap.style.height=wH;wrap.style.overflow=wO;
      scaleAll();
      alert('Hata: '+err.message);
    });
  },150);
}

// ======================================================
// INIT
// ======================================================
load();
updateSelects();
refreshEditors();
renderMain();
setTimeout(()=>{scaleAll();renderFlag();renderDuel();},200);

function downloadStatsImage(){
  const original = document.querySelector("#m_stats .modal");
  const clone = original.cloneNode(true);
  clone.style.transform = "none";
  clone.style.width = "1180px";
  clone.style.maxWidth = "1180px";
  clone.style.position = "absolute";
  clone.style.left = "-9999px";
  clone.style.top = "0";
  clone.style.background = "#ffffff";
  clone.style.color = "#1e293b";
  document.body.appendChild(clone);
  clone.querySelectorAll('.photo-container').forEach(c=>{
    c.style.width='60px';c.style.height='60px';c.style.borderRadius='50%';
    c.style.overflow='hidden';c.style.flexShrink='0';c.style.display='flex';
    c.style.alignItems='center';c.style.justifyContent='center';
  });
  clone.querySelectorAll('.player-photo').forEach(img=>{
    img.style.width='100%';img.style.height='100%';img.style.objectFit='cover';
    img.style.objectPosition='center';img.style.display='block';
    img.style.maxWidth='none';img.style.minWidth='0';
  });
  html2canvas(clone,{
    scale:2,useCORS:true,allowTaint:true,backgroundColor:'#ffffff',
    width:1180,windowWidth:1180,logging:false
  }).then(canvas=>{
    document.body.removeChild(clone);
    const link=document.createElement("a");
    link.download="survivor-istatistik-tablosu-"+Date.now()+".png";
    link.href=canvas.toDataURL("image/png",1.0);
    link.click();
  }).catch(err=>{document.body.removeChild(clone);alert('Hata: '+err.message);});
}

function downloadElimImage(){
  const body = document.getElementById('elim_body');
  if (!body || !body.innerHTML.trim()) { alert('Ã–nce bir yarÄ±ÅŸmacÄ± seÃ§in.'); return; }
  const original = document.querySelector("#m_elim .modal");
  const clone = original.cloneNode(true);
  clone.style.transform = "none";
  clone.style.width = "980px";
  clone.style.maxWidth = "980px";
  clone.style.position = "absolute";
  clone.style.left = "-9999px";
  clone.style.top = "0";
  clone.style.background = "#ffffff";
  clone.style.color = "#1e293b";
  // Ä°ndirme butonunu gizle
  clone.querySelectorAll('button').forEach(btn => { btn.style.display='none'; });
  document.body.appendChild(clone);
  html2canvas(clone, {
    scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#ffffff',
    width: 980, windowWidth: 980, logging: false
  }).then(canvas => {
    document.body.removeChild(clone);
    const link = document.createElement('a');
    link.download = 'eleme-adayi-analizi-' + Date.now() + '.png';
    link.href = canvas.toDataURL('image/png', 1.0);
    link.click();
  }).catch(err => { document.body.removeChild(clone); alert('Hata: ' + err.message); });
}

// ======================================================
// STATS RANKING BADGES
// ======================================================
function rankBadge(i){
  if(i===0) return '<span style="font-size:18px" title="Lider">ğŸ¥‡</span>';
  if(i===1) return '<span style="font-size:18px" title="2. SÄ±ra">ğŸ¥ˆ</span>';
  if(i===2) return '<span style="font-size:18px" title="3. SÄ±ra">ğŸ¥‰</span>';
  return `<span style="font-weight:700;color:#64748b">${i+1}</span>`;
}

// ======================================================
// POWER SCORE
// ======================================================
function calcPowerScore(p){
  const s=p.totalStats;
  const wr=s.total?(s.wins/s.total)*100:0;
  const totalScore=Math.min(s.total/100,1)*25;
  const wrScore=(wr/100)*40;
  let h2hTotal=0,h2hWins=0;
  Object.values(p.h2hRegistry||{}).forEach(h=>{h2hTotal+=h.total||0;h2hWins+=h.wins||0;});
  const h2hScore=h2hTotal?((h2hWins/h2hTotal)*25):0;
  const formScore=wr>60?10:wr>40?7:wr>25?4:2;
  const total=Math.round(totalScore+wrScore+h2hScore+formScore);
  let badge,scoreColor;
  if(total>=70){badge='ğŸ”¥ Dominant';scoreColor='#ef4444';}
  else if(total>=45){badge='âš” Dengeli';scoreColor='#3b82f6';}
  else{badge='âš  Form DÃ¼ÅŸÃ¼ÅŸÃ¼';scoreColor='#f59e0b';}
  return {score:total,badge,scoreColor,wr:wr.toFixed(1),h2hWins,h2hTotal};
}

function renderPowerGrid(){
  const g=document.getElementById('power_grid');if(!g)return;
  const sorted=[...players].sort((a,b)=>calcPowerScore(b).score-calcPowerScore(a).score);
  g.innerHTML=sorted.map((p,rank)=>{
    const ps=calcPowerScore(p);
    const teamBg=p.team==='kirmizi'?'linear-gradient(135deg,#5a0000,#991b1b)':'linear-gradient(135deg,#001f5c,#1e40af)';
    const imgHtml=p.image
      ?`<div style="width:100%;height:100%;border-radius:50%;background-image:url('${p.image}');background-size:cover;background-position:center;"></div>`
      :`<div style="width:100%;height:100%;border-radius:50%;background:#1e293b;display:flex;align-items:center;justify-content:center;color:white;font-size:28px;font-weight:900">${p.name.charAt(0)}</div>`;
    const rankEmoji=rank===0?'ğŸ¥‡':rank===1?'ğŸ¥ˆ':rank===2?'ğŸ¥‰':`#${rank+1}`;
    return `<div style="background:${teamBg};border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .2s;box-shadow:0 4px 16px rgba(0,0,0,.2)" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='none'">
      <div style="padding:18px;text-align:center;color:white">
        <div style="font-size:16px;font-weight:400;margin-bottom:4px;opacity:.8">${rankEmoji}</div>
        <div style="width:80px;height:80px;border-radius:50%;border:4px solid rgba(255,255,255,.4);overflow:hidden;margin:0 auto 10px;background:#1e293b">${imgHtml}</div>
        <div style="font-size:15px;font-weight:900;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">${p.name}</div>
        <div style="font-size:48px;font-weight:900;line-height:1;color:${ps.scoreColor};text-shadow:0 0 20px ${ps.scoreColor}80">${ps.score}</div>
        <div style="font-size:10px;font-weight:700;opacity:.6;letter-spacing:.1em;text-transform:uppercase;margin-bottom:10px">POWER SCORE</div>
        <div style="display:inline-flex;align-items:center;gap:5px;padding:5px 14px;border-radius:20px;font-size:12px;font-weight:800;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25)">${ps.badge}</div>
        <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:6px;text-align:center">
          <div style="background:rgba(0,0,0,.3);border-radius:8px;padding:6px"><div style="font-size:8px;opacity:.6;text-transform:uppercase">Win Rate</div><div style="font-size:16px;font-weight:900">${ps.wr}%</div></div>
          <div style="background:rgba(0,0,0,.3);border-radius:8px;padding:6px"><div style="font-size:8px;opacity:.6;text-transform:uppercase">H2H G</div><div style="font-size:16px;font-weight:900">${ps.h2hWins}/${ps.h2hTotal}</div></div>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ======================================================
// PERFORMANS GRAFÄ°KLERÄ° (Chart.js)
// ======================================================
let perfCharts={};

function loadChartJS(cb){
  if(window.Chart){cb();return;}
  const s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
  s.onload=cb;document.head.appendChild(s);
}

function openDetailFromPerf(){
  const sel = document.getElementById('perf_sel');
  if(!sel) return;
  const idx = Number(sel.value||0);
  closeM('m_perf');
  setTimeout(()=>openDetail(idx), 100);
}

// ======================================================
// PERFORMANS GRAFÄ°KLERÄ° HD TASARIMI (Adem kartÄ± stili)
// ======================================================
function buildPerfDesign(idx) {
  const cvDiv = document.getElementById('perf_design_canvas');
  if (!cvDiv) return;
  const p = players[idx !== undefined ? idx : (Number(document.getElementById('perf_sel')?.value||0))];
  if (!p) return;

  const s = p.totalStats;
  const wr = s.total ? ((s.wins/s.total)*100).toFixed(2) : '0.00';
  const score = s.wins - s.losses;
  const scoreStr = score >= 0 ? '+' + score : String(score);
  const tc = p.team === 'kirmizi' ? '#e53e3e' : '#3182ce';
  const tcDark = p.team === 'kirmizi' ? '#9b1c1c' : '#1e40af';
  const bg1 = p.team === 'kirmizi' ? 'linear-gradient(135deg,#7b1d1d,#991b1b)' : 'linear-gradient(135deg,#1e3a5f,#1e40af)';
  const dateStr = new Date().toLocaleDateString('tr-TR', {day:'2-digit',month:'long',year:'numeric'});

  const photoHtml = p.image
    ? `<img src="${p.image}" style="width:100%;height:100%;object-fit:cover;object-position:center top;display:block;">`
    : `<div style="width:100%;height:100%;background:#1e293b;display:flex;align-items:center;justify-content:center;font-size:80px;font-weight:900;color:white;">${p.name.charAt(0)}</div>`;

  // AtÄ±ÅŸ tipi istatistikleri
  const atisTypes = ['TOP','BASKET','STICK','DÄ°SK','BUMERANG','DAMBIL','KÃœP','HALKA','Ã‡EKÄ°Ã‡','KUM TORBASI','KONDURMA'];
  const atisIcons = {'TOP':'âš½','BASKET':'ğŸ€','STICK':'ğŸ’','DÄ°SK':'ğŸ¥','BUMERANG':'ğŸªƒ','DAMBIL':'ğŸ‹','KÃœP':'ğŸ“¦','HALKA':'â­•','Ã‡EKÄ°Ã‡':'ğŸ”¨','KUM TORBASI':'ğŸ¥Š','KONDURMA':'ğŸ¯'};
  const atisStats = {}; atisTypes.forEach(at => { atisStats[at] = {wins:0, total:0}; });
  const allGm = loadGames();
  allGm.forEach(g => {
    if (g.p1Name !== p.name && g.p2Name !== p.name) return;
    const isW = g.winner === p.name;
    const key = g.atisType || '';
    if (key && atisStats[key] !== undefined) { atisStats[key].total++; if(isW) atisStats[key].wins++; }
  });

  // Parkur / Parkur DÄ±ÅŸÄ± / Best Off stats
  const gtypes = {parkur:{wins:0,total:0}, parkurDisi:{wins:0,total:0}, bestoff:{wins:0,total:0}};
  allGm.forEach(g => {
    if (g.p1Name !== p.name && g.p2Name !== p.name) return;
    const isW = g.winner === p.name;
    const gt = (g.gameType||'').toUpperCase();
    if (gt.includes('PARKUR DIÅI') || gt.includes('PARKUR DI')) { gtypes.parkurDisi.total++; if(isW) gtypes.parkurDisi.wins++; }
    else if (gt.includes('PARKUR')) { gtypes.parkur.total++; if(isW) gtypes.parkur.wins++; }
    else if (gt.includes('BEST')) { gtypes.bestoff.total++; if(isW) gtypes.bestoff.wins++; }
  });

  const pct = (w,t) => t > 0 ? (w/t*100).toFixed(2) : '0.00';
  const dstr = (w,l) => { const d = w-l; return (d>=0?'+':'')+d; };

  // H2H rakip tablosu
  const h2hRows = players.filter(opp => opp.id !== p.id).map(opp => {
    const h = p.h2hRegistry[opp.id] || {total:0, wins:0, losses:0};
    if (h.total === 0) return null;
    const oppTc = opp.team === 'kirmizi' ? '#e53e3e' : '#3182ce';
    const rowScore = h.wins - h.losses;
    return `<div style="display:flex;align-items:center;border-bottom:1px solid rgba(255,255,255,.08);padding:8px 0;">
      <div style="font-size:16px;font-weight:900;color:${oppTc};width:180px;letter-spacing:.04em;text-transform:uppercase">${opp.name}</div>
      <div style="font-size:14px;color:rgba(255,255,255,.6);width:80px;text-align:center">${h.wins}/${h.total}</div>
      <div style="font-size:14px;color:rgba(255,255,255,.6);width:80px;text-align:center">${h.wins>0?h.wins+'/'+h.total:'â€”'}</div>
      <div style="font-size:14px;color:rgba(255,255,255,.6);width:80px;text-align:center">${h.losses>0?h.losses:'â€”'}</div>
      <div style="font-size:18px;font-weight:900;color:${h.wins>=h.losses?'#4ade80':'#f87171'};width:80px;text-align:center">${rowScore>=0?'+':''}${rowScore}</div>
    </div>`;
  }).filter(Boolean).join('');

  // KÃ¼mÃ¼latif WR trend iÃ§in sparkline SVG
  const trendGames = allGm.filter(g=>g.p1Name===p.name||g.p2Name===p.name).sort((a,b)=>new Date(a.date)-new Date(b.date));
  let sparkSvg = '';
  if (trendGames.length >= 2) {
    let cw=0, ct=0;
    const pts = trendGames.map(g => { ct++; if(g.winner===p.name) cw++; return Math.round((cw/ct)*100); });
    const maxV=100, minV=0, w=1000, h=80;
    const xStep = w / (pts.length-1||1);
    const yScale = v => h - ((v-minV)/(maxV-minV||1))*h;
    const pathD = pts.map((v,i) => `${i===0?'M':'L'}${Math.round(i*xStep)},${Math.round(yScale(v))}`).join(' ');
    const fillD = `${pathD} L${Math.round((pts.length-1)*xStep)},${h} L0,${h} Z`;
    sparkSvg = `<svg width="100%" height="80" viewBox="0 0 1000 80" preserveAspectRatio="none">
      <defs><linearGradient id="sgr" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${tc}" stop-opacity="0.6"/><stop offset="100%" stop-color="${tc}" stop-opacity="0.05"/></linearGradient></defs>
      <path d="${fillD}" fill="url(#sgr)"/>
      <path d="${pathD}" fill="none" stroke="${tc}" stroke-width="3"/>
    </svg>`;
  }

  // AtÄ±ÅŸ tipi grid
  const atisEntries = atisTypes.map(at=>({at,st:atisStats[at]})).filter(x=>x.st.total>0);
  const atisGrid = atisEntries.length > 0
    ? `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px">` +
      atisEntries.map(({at,st}) => {
        const wr2 = Math.round((st.wins/st.total)*100);
        const c = wr2>=60?'#4ade80':wr2>=40?'#fbbf24':'#f87171';
        return `<div style="background:rgba(255,255,255,.06);border-radius:10px;padding:10px;text-align:center;border:1px solid ${c}30">
          <div style="font-size:22px;margin-bottom:4px">${atisIcons[at]||'ğŸ¯'}</div>
          <div style="font-size:11px;font-weight:700;color:rgba(255,255,255,.6);margin-bottom:2px;text-transform:uppercase">${at}</div>
          <div style="font-size:20px;font-weight:900;color:${c}">%${wr2}</div>
          <div style="font-size:10px;color:rgba(255,255,255,.35);margin-top:2px">${st.wins}G / ${st.total}T</div>
        </div>`;
      }).join('') + '</div>'
    : '<div style="color:rgba(255,255,255,.3);font-size:12px;text-align:center;padding:12px">KayÄ±tlÄ± atÄ±ÅŸ tipi verisi yok</div>';

  cvDiv.innerHTML = `<div id="perf_design_inner" style="background:#0c0f18;width:1080px;font-family:'Barlow Condensed',sans-serif;position:relative;overflow:hidden;">

    <!-- Arkaplan Ä±ÅŸÄ±k efektleri -->
    <div style="position:absolute;top:-80px;left:-80px;width:500px;height:500px;background:radial-gradient(circle,${tc}22 0%,transparent 65%);pointer-events:none;z-index:0;"></div>
    <div style="position:absolute;bottom:-80px;right:-80px;width:400px;height:400px;background:radial-gradient(circle,${tcDark}18 0%,transparent 65%);pointer-events:none;z-index:0;"></div>
    <!-- Watermark -->
    <div style="position:absolute;inset:0;opacity:.04;display:flex;align-items:center;justify-content:center;pointer-events:none;overflow:hidden;z-index:1">
      <span style="font-size:100px;font-weight:900;color:white;transform:rotate(-25deg);white-space:nowrap;letter-spacing:.2em">SurvivorMetrics</span>
    </div>

    <!-- ÃœST KISIM: FotoÄŸraf + Ä°sim + Ana Ä°statistikler -->
    <div style="position:relative;z-index:3;display:grid;grid-template-columns:300px 1fr;min-height:380px">
      <!-- Sol: FotoÄŸraf -->
      <div style="position:relative;overflow:hidden;background:${bg1}">
        <div style="width:100%;height:100%;min-height:380px;position:relative;">
          ${photoHtml}
          <!-- Gradient overlay -->
          <div style="position:absolute;inset:0;background:linear-gradient(to right,transparent 50%,#0c0f18 100%);"></div>
          <div style="position:absolute;bottom:0;left:0;right:0;height:100px;background:linear-gradient(to top,${bg1.includes('e53e3e')?'#9b1c1c':'#1e3a5f'} 0%,transparent 100%);"></div>
        </div>
      </div>

      <!-- SaÄŸ: Ä°sim + 4 stat kutu -->
      <div style="padding:28px 32px;display:flex;flex-direction:column;justify-content:center;">
        <!-- BaÅŸlÄ±k Ã§izgisi -->
        <div style="font-size:11px;color:rgba(255,255,255,.35);letter-spacing:.5em;text-transform:uppercase;margin-bottom:6px">SURVIVOR 2026 â€” SURVIVORMETRICS</div>
        <!-- Ä°sim -->
        <div style="font-size:56px;font-weight:900;color:white;text-transform:uppercase;letter-spacing:.05em;line-height:1;text-shadow:0 2px 20px rgba(0,0,0,.8);margin-bottom:6px">${p.name}</div>
        ${p.status?`<div style="display:inline-block;width:fit-content;background:rgba(255,215,0,.15);border:1px solid #fbbf24;border-radius:20px;padding:3px 14px;font-size:14px;font-weight:900;color:#fbbf24;letter-spacing:.1em;margin-bottom:14px">${p.status}</div>`:'<div style="margin-bottom:14px"></div>'}
        <!-- 4 ana istatistik -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <!-- BÄ°REYSEL -->
          <div style="background:rgba(0,0,0,.5);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,.1)">
            <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,.4);letter-spacing:.2em;text-transform:uppercase;text-align:center;margin-bottom:8px">BÄ°REYSEL</div>
            <div style="font-size:36px;font-weight:900;color:${score>=0?'#4ade80':'#f87171'};text-align:center;line-height:1">${scoreStr}</div>
            <div style="font-size:14px;color:rgba(255,255,255,.5);text-align:center;margin-top:4px">(%${wr})</div>
            <div style="display:flex;justify-content:center;gap:16px;margin-top:8px;font-size:13px;color:rgba(255,255,255,.6)">
              <span style="color:rgba(255,100,100,.8)">${s.losses}M</span>
              <span>${s.total}O</span>
              <span style="color:#4ade80">${s.wins}G</span>
            </div>
          </div>
          <!-- PARKUR -->
          <div style="background:rgba(0,0,0,.5);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,.1)">
            <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,.4);letter-spacing:.2em;text-transform:uppercase;text-align:center;margin-bottom:8px">PARKUR</div>
            <div style="font-size:36px;font-weight:900;color:${dstr(gtypes.parkur.wins,gtypes.parkur.losses)[0]!=='-'?'#4ade80':'#f87171'};text-align:center;line-height:1">${dstr(gtypes.parkur.wins,gtypes.parkur.losses)}</div>
            <div style="font-size:14px;color:rgba(255,255,255,.5);text-align:center;margin-top:4px">(%${pct(gtypes.parkur.wins,gtypes.parkur.total)})</div>
            <div style="display:flex;justify-content:center;gap:16px;margin-top:8px;font-size:13px;color:rgba(255,255,255,.6)">
              <span style="color:rgba(255,100,100,.8)">${gtypes.parkur.total-gtypes.parkur.wins}M</span>
              <span>${gtypes.parkur.total}O</span>
              <span style="color:#4ade80">${gtypes.parkur.wins}G</span>
            </div>
          </div>
          <!-- PARKUR DIÅI -->
          <div style="background:rgba(0,0,0,.5);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,.1)">
            <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,.4);letter-spacing:.2em;text-transform:uppercase;text-align:center;margin-bottom:8px">PARKUR DIÅI</div>
            <div style="font-size:36px;font-weight:900;color:${dstr(gtypes.parkurDisi.wins,gtypes.parkurDisi.total-gtypes.parkurDisi.wins)[0]!=='-'?'#4ade80':'#f87171'};text-align:center;line-height:1">${dstr(gtypes.parkurDisi.wins,gtypes.parkurDisi.total-gtypes.parkurDisi.wins)}</div>
            <div style="font-size:14px;color:rgba(255,255,255,.5);text-align:center;margin-top:4px">(%${pct(gtypes.parkurDisi.wins,gtypes.parkurDisi.total)})</div>
            <div style="display:flex;justify-content:center;gap:16px;margin-top:8px;font-size:13px;color:rgba(255,255,255,.6)">
              <span style="color:rgba(255,100,100,.8)">${gtypes.parkurDisi.total-gtypes.parkurDisi.wins}M</span>
              <span>${gtypes.parkurDisi.total}O</span>
              <span style="color:#4ade80">${gtypes.parkurDisi.wins}G</span>
            </div>
          </div>
          <!-- BEST OF -->
          <div style="background:rgba(0,0,0,.5);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,.1)">
            <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,.4);letter-spacing:.2em;text-transform:uppercase;text-align:center;margin-bottom:8px">BEST OF</div>
            <div style="font-size:36px;font-weight:900;color:${dstr(gtypes.bestoff.wins,gtypes.bestoff.total-gtypes.bestoff.wins)[0]!=='-'?'#4ade80':'#f87171'};text-align:center;line-height:1">${dstr(gtypes.bestoff.wins,gtypes.bestoff.total-gtypes.bestoff.wins)}</div>
            <div style="font-size:14px;color:rgba(255,255,255,.5);text-align:center;margin-top:4px">(%${pct(gtypes.bestoff.wins,gtypes.bestoff.total)})</div>
            <div style="display:flex;justify-content:center;gap:16px;margin-top:8px;font-size:13px;color:rgba(255,255,255,.6)">
              <span style="color:rgba(255,100,100,.8)">${gtypes.bestoff.total-gtypes.bestoff.wins}M</span>
              <span>${gtypes.bestoff.total}O</span>
              <span style="color:#4ade80">${gtypes.bestoff.wins}G</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ATTIÅ TÄ°PÄ° GRÄ°DÄ° -->
    <div style="position:relative;z-index:3;border-top:1px solid rgba(255,255,255,.08);border-bottom:1px solid rgba(255,255,255,.08);padding:20px 32px;">
      <div style="font-size:11px;color:rgba(255,255,255,.3);letter-spacing:.4em;text-transform:uppercase;margin-bottom:14px;font-weight:800">ğŸ¯ ATIÅ TÄ°PÄ° PERFORMANSI</div>
      ${atisGrid}
    </div>

    <!-- RAKÄ°P TABLOSU -->
    ${h2hRows ? `<div style="position:relative;z-index:3;padding:20px 32px;border-bottom:1px solid rgba(255,255,255,.08);">
      <div style="font-size:11px;color:rgba(255,255,255,.3);letter-spacing:.4em;text-transform:uppercase;margin-bottom:10px;font-weight:800">âš”ï¸ RAKÄ°P KARÅILAÅMA TABLOSU</div>
      <div style="display:flex;align-items:center;border-bottom:1px solid rgba(255,255,255,.15);padding-bottom:6px;margin-bottom:4px;font-size:10px;color:rgba(255,255,255,.3);letter-spacing:.1em;font-weight:700;text-transform:uppercase">
        <div style="width:180px">RAKÄ°P</div>
        <div style="width:80px;text-align:center">BEST OF</div>
        <div style="width:80px;text-align:center">PARKUR</div>
        <div style="width:80px;text-align:center">PARKUR DIÅI</div>
        <div style="width:80px;text-align:center">PUAN</div>
      </div>
      ${h2hRows}
    </div>` : ''}

    <!-- TREND GRAFÄ°ÄÄ° -->
    <div style="position:relative;z-index:3;padding:16px 32px;">
      <div style="font-size:11px;color:rgba(255,255,255,.3);letter-spacing:.4em;text-transform:uppercase;margin-bottom:10px;font-weight:800">ğŸ“ˆ PERFORMANS TRENDÄ°</div>
      <div style="border-radius:8px;overflow:hidden;background:rgba(255,255,255,.03);padding:8px">${sparkSvg||'<div style="color:rgba(255,255,255,.3);font-size:12px;text-align:center;padding:20px">Trend verisi iÃ§in oyun kaydedin</div>'}</div>
    </div>

    <!-- FOOTER -->
    <div style="position:relative;z-index:5;background:rgba(0,0,0,.8);border-top:1px solid rgba(255,255,255,.06);padding:12px 32px;display:flex;justify-content:space-between;align-items:center;">
      <div style="display:flex;align-items:center;gap:8px">
        <div style="width:6px;height:6px;border-radius:50%;background:${tc};box-shadow:0 0 6px ${tc}"></div>
        <span style="font-size:10px;color:rgba(255,255,255,.3);letter-spacing:.2em;text-transform:uppercase;font-weight:700">SURVIVORMETRICS</span>
      </div>
      <span style="font-size:10px;color:rgba(255,255,255,.2);letter-spacing:.1em;font-weight:700">${dateStr}</span>
    </div>
  </div>`;
}

function downloadPerfDesign() {
  const cvDiv = document.getElementById('perf_design_canvas');
  if (!cvDiv || !cvDiv.innerHTML.trim()) { alert('Ã–nce tasarÄ±m oluÅŸturun.'); return; }
  const inner = cvDiv.querySelector('#perf_design_inner') || cvDiv.firstElementChild;
  if (!inner) return;
  _downloadDesignHD(inner, 'performans-tasarim-' + Date.now() + '.png');
}

function renderPerfCharts(){
  // Build HD design first
  buildPerfDesign();
  loadChartJS(()=>{
    const sel=document.getElementById('perf_sel');if(!sel)return;
    const idx=Number(sel.value||0);
    const p=players[idx];if(!p)return;
    const s=p.totalStats;
    const wr=s.total?(s.wins/s.total)*100:0;
    Object.values(perfCharts).forEach(c=>{try{c.destroy();}catch(e){}});
    perfCharts={};
    const ctx1=document.getElementById('chart_winrate');
    if(ctx1){
      perfCharts.wr=new Chart(ctx1,{type:'doughnut',data:{
        labels:['Galibiyet','Yenilgi'],
        datasets:[{data:[s.wins||0,s.losses||0],backgroundColor:['#10b981','#ef4444'],hoverOffset:6,borderWidth:2}]
      },options:{responsive:true,cutout:'65%',plugins:{legend:{position:'bottom'},
        tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.raw}`}}}}});
    }
    // Son 10 maÃ§ - gerÃ§ek verilerden
    const ctx2=document.getElementById('chart_form');
    if(ctx2){
      const allGmPerf = loadGames().filter(g => g.p1Name === p.name || g.p2Name === p.name)
        .sort((a,b) => new Date(a.date)-new Date(b.date)).slice(-10);
      const labels=[],vals=[],colors=[];
      if(allGmPerf.length > 0){
        allGmPerf.forEach((g,i)=>{
          const win = g.winner === p.name;
          const draw = g.winner === 'Berabere';
          labels.push('M'+(i+1));vals.push(draw?0.5:win?1:0);colors.push(draw?'#f59e0b':win?'#10b981':'#ef4444');
        });
      } else {
        // KayÄ±tlÄ± oyun yoksa totalStats'tan tek bar gÃ¶ster
        labels.push('Genel');vals.push(wr/100);colors.push(wr>50?'#10b981':'#ef4444');
      }
      perfCharts.form=new Chart(ctx2,{type:'bar',data:{
        labels,datasets:[{data:vals,backgroundColor:colors,borderRadius:6,label:'SonuÃ§'}]
      },options:{responsive:true,plugins:{legend:{display:false}},
        scales:{y:{beginAtZero:true,max:1.4,ticks:{callback:v=>v===1?'G':v===0.5?'B':v===0?'M':''},grid:{color:'#f1f5f9'}},
        x:{grid:{display:false}}}}});
    }
    // HaftalÄ±k trend - gerÃ§ek oyunlardan cumulative WR
    const ctx3=document.getElementById('chart_season');
    if(ctx3){
      const allGmTrend = loadGames().filter(g => g.p1Name === p.name || g.p2Name === p.name)
        .sort((a,b) => new Date(a.date)-new Date(b.date));
      let trendLabels=[], trendVals=[];
      if(allGmTrend.length >= 2){
        let cw=0, ct=0;
        allGmTrend.forEach((g,i)=>{
          ct++;
          if(g.winner===p.name) cw++;
          trendLabels.push('M'+(i+1));
          trendVals.push(Math.round((cw/ct)*100));
        });
      } else {
        trendLabels=['BaÅŸlangÄ±Ã§','GÃ¼ncel'];
        trendVals=[50, Math.round(wr)];
      }
      perfCharts.season=new Chart(ctx3,{type:'line',data:{
        labels:trendLabels,
        datasets:[{data:trendVals,borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,.1)',fill:true,tension:.4,pointBackgroundColor:'#6366f1',pointRadius:trendLabels.length<=20?4:1,borderWidth:2}]
      },options:{responsive:true,plugins:{legend:{display:false}},
        scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'},grid:{color:'#f1f5f9'}},
        x:{grid:{display:false},ticks:{maxTicksLimit:8,maxRotation:0}}}}}); 
    }
    const flow=document.getElementById('perf_flow');
    if(flow){
      const ps=calcPowerScore(p);
      const items=[
        {v:s.total,l:'Toplam MaÃ§',c:'#e0f2fe',tc:'#0369a1'},
        {v:s.wins,l:'Galibiyet',c:'#dcfce7',tc:'#15803d'},
        {v:s.losses,l:'Yenilgi',c:'#fee2e2',tc:'#dc2626'},
        {v:wr.toFixed(1)+'%',l:'Win Rate',c:'#ede9fe',tc:'#7c3aed'},
        {v:ps.score,l:'Power Score',c:'#fef9c3',tc:'#b45309'},
      ];
      flow.innerHTML=items.map((it,i)=>`
        <div style="display:flex;align-items:center;gap:8px">
          <div style="background:${it.c};color:${it.tc};padding:10px 16px;border-radius:10px;text-align:center;min-width:90px">
            <div style="font-size:22px;font-weight:900">${it.v}</div>
            <div style="font-size:9px;text-transform:uppercase;letter-spacing:.05em;margin-top:2px;font-weight:700">${it.l}</div>
          </div>
          ${i<items.length-1?'<div style="font-size:18px;color:#cbd5e1">â†’</div>':''}
        </div>`).join('');
    }
  });
}

function populatePerfSel(){
  const sel=document.getElementById('perf_sel');if(!sel)return;
  sel.innerHTML=players.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
}

// ======================================================
// H2H PLUS
// ======================================================
function renderH2HPlus(){
  const s1=document.getElementById('h2hp_s1');
  const s2=document.getElementById('h2hp_s2');
  if(!s1||!s2)return;
  const id1 = s1.value.replace('s_','');
  const id2 = s2.value.replace('s_','');
  const allP = getAllSeasonsPlayers();
  let p1 = allP.find(p => p.id === id1) || allP[0];
  let p2 = allP.find(p => p.id === id2) || allP[1];
  if(p1 && p1.id === p2.id) { p2 = allP.find(p => p.id !== p1.id) || allP[1]; }
  if(!p1||!p2)return;
  const h1=p1.h2hRegistry[p2.id]||{total:0,wins:0,losses:0};
  const h2=p2.h2hRegistry[p1.id]||{total:0,wins:0,losses:0};
  const total=h1.wins+h2.wins;
  const p1AdvPct=total?Math.round((h1.wins/total)*100):50;
  const p2AdvPct=100-p1AdvPct;
  const lastResult=h1.wins>h2.wins?`${p1.name} daha Ã§ok kazandÄ±`
    :h2.wins>h1.wins?`${p2.name} daha Ã§ok kazandÄ±`
    :'Birebir eÅŸit';
  const psych=p1AdvPct>=p2AdvPct?`${p1.name} psikolojik Ã¼stÃ¼nlÃ¼ÄŸe sahip`:`${p2.name} psikolojik Ã¼stÃ¼nlÃ¼ÄŸe sahip`;
  const tc1=p1.team==='kirmizi'?'#dc2626':'#2563eb';
  const tc2=p2.team==='kirmizi'?'#dc2626':'#2563eb';
  const wr1h=p1.totalStats?.total?((p1.totalStats.wins/p1.totalStats.total)*100).toFixed(1):'0.0';
  const wr2h=p2.totalStats?.total?((p2.totalStats.wins/p2.totalStats.total)*100).toFixed(1):'0.0';
  const season1Label = p1._seasonLabel || '';
  const season2Label = p2._seasonLabel || '';
  const isCrossSeason = season1Label !== season2Label;
  const img1Html=p1.image?`<div style="width:80px;height:80px;border-radius:50%;background-image:url('${p1.image}');background-size:cover;background-position:center top;border:3px solid ${tc1};"></div>`:`<div style="width:80px;height:80px;border-radius:50%;background:${tc1};display:flex;align-items:center;justify-content:center;color:white;font-size:28px;font-weight:900">${p1.name.charAt(0)}</div>`;
  const img2Html=p2.image?`<div style="width:80px;height:80px;border-radius:50%;background-image:url('${p2.image}');background-size:cover;background-position:center top;border:3px solid ${tc2};"></div>`:`<div style="width:80px;height:80px;border-radius:50%;background:${tc2};display:flex;align-items:center;justify-content:center;color:white;font-size:28px;font-weight:900">${p2.name.charAt(0)}</div>`;
  document.getElementById('h2hplus_body').innerHTML=`
    ${isCrossSeason?`<div style="background:#1c2a1a;border:1px solid #4ade80;border-radius:10px;padding:8px 14px;margin-bottom:14px;font-size:12px;font-weight:700;color:#4ade80">âš¡ Sezon ArasÄ± KarÅŸÄ±laÅŸtÄ±rma: <strong>${p1.name}</strong> (${season1Label}) vs <strong>${p2.name}</strong> (${season2Label}) â€” birebir veri olmayabilir</div>`:''}
    <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center;margin-bottom:20px">
      <div style="text-align:center;background:${tc1}18;border:1px solid ${tc1}40;border-radius:14px;padding:18px 10px">${img1Html}
        <div style="font-weight:900;margin-top:8px;font-size:18px;color:${tc1};text-transform:uppercase">${p1.name}</div>
        ${season1Label?`<div style="font-size:10px;background:${tc1}22;color:${tc1};border-radius:8px;padding:2px 8px;display:inline-block;margin-top:2px;font-weight:700">ğŸ“‚ ${season1Label}</div>`:''}
        <div style="font-size:56px;font-weight:900;color:${tc1};line-height:1;margin-top:12px;text-shadow:0 0 20px ${tc1}60">${h1.wins}</div>
        <div style="font-size:11px;color:#64748b">Birebir Galibiyet</div>
        <div style="font-size:14px;font-weight:700;color:#94a3b8;margin-top:6px">${p1.totalStats?.wins||0}G / ${p1.totalStats?.losses||0}Y</div>
        <div style="font-size:16px;font-weight:900;color:${Number(wr1h)>=50?'#4ade80':'#f87171'};margin-top:2px">%${Math.round(Number(wr1h))} WR</div>
      </div>
      <div style="text-align:center;padding:0 12px">
        <div style="background:#1e293b;border:2px solid #334155;border-radius:50%;width:48px;height:48px;display:flex;align-items:center;justify-content:center;margin:0 auto"><span style="font-size:16px;font-weight:900;color:#64748b">VS</span></div>
      </div>
      <div style="text-align:center;background:${tc2}18;border:1px solid ${tc2}40;border-radius:14px;padding:18px 10px">${img2Html}
        <div style="font-weight:900;margin-top:8px;font-size:18px;color:${tc2};text-transform:uppercase">${p2.name}</div>
        ${season2Label?`<div style="font-size:10px;background:${tc2}22;color:${tc2};border-radius:8px;padding:2px 8px;display:inline-block;margin-top:2px;font-weight:700">ğŸ“‚ ${season2Label}</div>`:''}
        <div style="font-size:56px;font-weight:900;color:${tc2};line-height:1;margin-top:12px;text-shadow:0 0 20px ${tc2}60">${h2.wins}</div>
        <div style="font-size:11px;color:#64748b">Birebir Galibiyet</div>
        <div style="font-size:14px;font-weight:700;color:#94a3b8;margin-top:6px">${p2.totalStats?.wins||0}G / ${p2.totalStats?.losses||0}Y</div>
        <div style="font-size:16px;font-weight:900;color:${Number(wr2h)>=50?'#4ade80':'#f87171'};margin-top:2px">%${Math.round(Number(wr2h))} WR</div>
      </div>
    </div>
    <div style="background:#1e293b;border-radius:12px;padding:6px;margin-bottom:16px">
      <div style="display:flex;height:28px;border-radius:8px;overflow:hidden">
        <div style="width:${p1AdvPct}%;background:linear-gradient(to right,${tc1}cc,${tc1});display:flex;align-items:center;justify-content:center;color:white;font-size:12px;font-weight:800">${p1AdvPct>15?p1AdvPct+'%':''}</div>
        <div style="flex:1;background:linear-gradient(to right,${tc2},${tc2}cc);display:flex;align-items:center;justify-content:center;color:white;font-size:12px;font-weight:800">${p2AdvPct>15?p2AdvPct+'%':''}</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
      <div style="background:#1e293b;border:1px solid #334155;border-radius:12px;padding:14px;text-align:center"><div style="font-size:32px;font-weight:900;color:${tc1}">${p1AdvPct}%</div><div style="font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;margin-top:2px">Psikolojik ÃœstÃ¼nlÃ¼k â€” ${p1.name}</div></div>
      <div style="background:#1e293b;border:1px solid #334155;border-radius:12px;padding:14px;text-align:center"><div style="font-size:32px;font-weight:900;color:${tc2}">${p2AdvPct}%</div><div style="font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;margin-top:2px">Psikolojik ÃœstÃ¼nlÃ¼k â€” ${p2.name}</div></div>
      <div style="background:#1e293b;border:1px solid #334155;border-radius:12px;padding:14px;text-align:center"><div style="font-size:32px;font-weight:900;color:#e2e8f0">${total}</div><div style="font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;margin-top:2px">Toplam KarÅŸÄ±laÅŸma</div></div>
      <div style="background:#1e293b;border:1px solid #334155;border-radius:12px;padding:14px;text-align:center"><div style="font-size:18px;font-weight:900;color:#4ade80;margin-bottom:4px">â†’ SonuÃ§</div><div style="font-size:12px;font-weight:700;color:#94a3b8">${lastResult}</div></div>
    </div>
    <div style="background:linear-gradient(135deg,#0c2a4a,#0f172a);border:1px solid #1e40af;border-radius:12px;padding:14px">
      <div style="font-size:11px;font-weight:900;color:#60a5fa;text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px">ğŸ¤– Otomatik Yorum</div>
      <div style="font-size:14px;line-height:1.9;color:#cbd5e1">
        <p>â€¢ <strong style="color:white">${psych}</strong> (%${Math.max(p1AdvPct,p2AdvPct)} oranÄ±nda)</p>
        <p>â€¢ ${total>0?`Son ${total} karÅŸÄ±laÅŸmada ${p1.name} <strong>${h1.wins}</strong>, ${p2.name} <strong>${h2.wins}</strong> galibiyet aldÄ±.`:'HenÃ¼z birebir maÃ§ verisi girilmemiÅŸ.'}</p>
        <p>â€¢ ${p1AdvPct>60?`<strong>${p1.name}</strong> bu karÅŸÄ±laÅŸmada net favori konumunda.`:p2AdvPct>60?`<strong>${p2.name}</strong> bu karÅŸÄ±laÅŸmada net favori konumunda.`:'Ä°ki yarÄ±ÅŸmacÄ± birbirine Ã§ok yakÄ±n gÃ¼Ã§te.'}</p>
        <p>â€¢ ${lastResult}.</p>
      </div>
    </div>`;
}

function getAllSeasonsPlayers(){
  // TÃ¼m sezonlardan tÃ¼m yarÄ±ÅŸmacÄ±larÄ± topla (benzersiz ID'ye gÃ¶re)
  const seasonNames = getSeasonNames();
  const allPlayers = [];
  const seenIds = new Set();
  // Ã–nce aktif sezon
  players.forEach(p => {
    if(!seenIds.has(p.id)) {
      const activeSeason = localStorage.getItem('sm2_active_season') || 'Aktif';
      allPlayers.push({...p, _seasonLabel: activeSeason, _isActive: true});
      seenIds.add(p.id);
    }
  });
  // DiÄŸer sezonlar
  seasonNames.forEach(sName => {
    try {
      const raw = localStorage.getItem('sm2_season_'+sName);
      if(!raw) return;
      const data = JSON.parse(raw);
      if(!data.players) return;
      data.players.forEach(p => {
        if(!seenIds.has(p.id)) {
          if(!p.image){try{const img=localStorage.getItem('sm2_img_'+p.id);if(img)p.image=img;}catch(e){}}
          allPlayers.push({...p, _seasonLabel: sName, _isActive: false});
          seenIds.add(p.id);
        }
      });
    } catch(e){}
  });
  return allPlayers;
}

function buildAlltimeList(sortBy){
  const body = document.getElementById('alltime_body');
  if(!body) return;

  // TÃ¼m sezonlardan tÃ¼m yarÄ±ÅŸmacÄ±larÄ± topla
  const seasonNames = getSeasonNames();
  const allEntries = []; // {player, season}
  const seenIds = new Set();

  // Aktif sezon
  const activeSeason = localStorage.getItem('sm2_active_season') || 'Aktif';
  players.forEach(p => {
    if(!seenIds.has(p.id)) {
      allEntries.push({p: {...p}, season: activeSeason});
      seenIds.add(p.id);
    }
  });

  // DiÄŸer sezonlar
  seasonNames.forEach(sName => {
    try {
      const raw = localStorage.getItem('sm2_season_'+sName);
      if(!raw) return;
      const data = JSON.parse(raw);
      if(!data.players) return;
      data.players.forEach(p => {
        if(!seenIds.has(p.id)) {
          if(!p.image){try{const img=localStorage.getItem('sm2_img_'+p.id);if(img)p.image=img;}catch(e){}}
          allEntries.push({p: {...p}, season: sName});
          seenIds.add(p.id);
        }
      });
    } catch(e){}
  });

  if(allEntries.length === 0) {
    body.innerHTML = '<div style="text-align:center;padding:40px;color:#94a3b8;font-size:14px">HenÃ¼z sezon verisi yok. Sezon sistemi Ã¼zerinden veri kaydedin.</div>';
    return;
  }

  // SÄ±rala
  allEntries.forEach(entry => {
    const p = entry.p;
    const s = p.totalStats || {wins:0,losses:0,total:0};
    entry.wins = s.wins || 0;
    entry.losses = s.losses || 0;
    entry.total = s.total || 0;
    entry.wr = s.total ? (s.wins / s.total) * 100 : 0;
    entry.score = (s.wins || 0) - (s.losses || 0);
    // Seri hesabÄ± (h2hRegistry'den basit)
    let maxStreak = 0;
    if(p.h2hRegistry) {
      Object.values(p.h2hRegistry).forEach(h => {
        if(h.wins > maxStreak) maxStreak = h.wins;
      });
    }
    entry.streak = maxStreak;
  });

  const sortFns = {
    wr: (a,b) => b.wr - a.wr || b.total - a.total,
    wins: (a,b) => b.wins - a.wins || b.wr - a.wr,
    total: (a,b) => b.total - a.total || b.wr - a.wr,
    score: (a,b) => b.score - a.score || b.wr - a.wr,
    streak: (a,b) => b.streak - a.streak || b.wins - a.wins,
  };
  allEntries.sort(sortFns[sortBy] || sortFns.wr);

  const sortLabels = {wr:'Win Rate %', wins:'Galibiyet', total:'Toplam Oyun', score:'Net Puan', streak:'En YÃ¼ksek H2H Serisi'};
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];

  body.innerHTML = `
    <div style="font-size:12px;color:#64748b;margin-bottom:16px;font-weight:600">
      ${allEntries.length} yarÄ±ÅŸmacÄ± Â· ${[...new Set(allEntries.map(e=>e.season))].length} sezon Â· SÄ±ralama: <strong>${sortLabels[sortBy]||sortBy}</strong>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px">
      ${allEntries.map((entry, rank) => {
        const p = entry.p;
        const tc = p.team==='kirmizi'?'#dc2626':'#2563eb';
        const tcLight = p.team==='kirmizi'?'#fee2e2':'#dbeafe';
        const medal = medals[rank] || '';
        const rankNumColor = rank===0?'#f59e0b':rank===1?'#94a3b8':rank===2?'#b45309':'#94a3b8';
        const statVal = sortBy==='wr'?Math.round(entry.wr)+'%':
                        sortBy==='wins'?entry.wins:
                        sortBy==='total'?entry.total:
                        sortBy==='score'?(entry.score>=0?'+':'')+entry.score:
                        entry.streak;
        const statColor = sortBy==='wr'?(entry.wr>=50?'#10b981':'#ef4444'):
                          sortBy==='score'?(entry.score>=0?'#10b981':'#ef4444'):'#1e293b';
        const photoHtml = p.image
          ? `<img src="${p.image}" style="width:100%;height:100%;object-fit:cover;object-position:center top;" crossorigin="anonymous">`
          : `<div style="width:100%;height:100%;background:${tc};display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:white">${p.name.charAt(0)}</div>`;
        return `<div style="display:flex;align-items:center;gap:12px;background:${rank===0?'linear-gradient(to right,#fffbeb,#fef3c7)':rank<3?'#f8fafc':'#ffffff'};border:${rank===0?'2px solid #fbbf24':rank<3?'2px solid '+tcLight:'1px solid #f1f5f9'};border-radius:14px;padding:10px 14px;transition:all .2s">
          <!-- SÄ±ra -->
          <div style="min-width:32px;text-align:center">
            ${medal?`<div style="font-size:24px">${medal}</div>`:`<div style="font-size:16px;font-weight:900;color:${rankNumColor}">${rank+1}</div>`}
          </div>
          <!-- FotoÄŸraf -->
          <div style="width:56px;height:56px;border-radius:50%;overflow:hidden;border:3px solid ${tc};flex-shrink:0;box-shadow:${rank===0?'0 4px 12px rgba(251,191,36,.4)':'0 2px 6px rgba(0,0,0,.1)'}">
            ${photoHtml}
          </div>
          <!-- Ä°sim + sezon -->
          <div style="flex:1;min-width:0">
            <div style="font-size:16px;font-weight:900;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}</div>
            <div style="display:flex;gap:6px;align-items:center;margin-top:2px;flex-wrap:wrap">
              <span style="font-size:10px;background:${tc}22;color:${tc};border-radius:6px;padding:2px 7px;font-weight:700">${p.team==='kirmizi'?'KIRMIZI':'MAVÄ°'}</span>
              <span style="font-size:10px;background:#f1f5f9;color:#64748b;border-radius:6px;padding:2px 7px;font-weight:700">ğŸ“‚ ${entry.season}</span>
            </div>
          </div>
          <!-- Ana stat (sÄ±ralama kriteri) -->
          <div style="text-align:center;min-width:60px">
            <div style="font-size:26px;font-weight:900;color:${statColor}">${statVal}</div>
            <div style="font-size:9px;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em">${sortLabels[sortBy]||sortBy}</div>
          </div>
          <!-- Yan istatistikler -->
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;min-width:180px">
            <div style="text-align:center;background:#f8fafc;border-radius:8px;padding:4px">
              <div style="font-size:15px;font-weight:900;color:#10b981">${entry.wins}</div>
              <div style="font-size:8px;color:#94a3b8;text-transform:uppercase">GALÄ°B.</div>
            </div>
            <div style="text-align:center;background:#f8fafc;border-radius:8px;padding:4px">
              <div style="font-size:15px;font-weight:900;color:#f87171">${entry.losses}</div>
              <div style="font-size:8px;color:#94a3b8;text-transform:uppercase">YENÄ°L.</div>
            </div>
            <div style="text-align:center;background:#f8fafc;border-radius:8px;padding:4px">
              <div style="font-size:15px;font-weight:900;color:#6366f1">${entry.total}</div>
              <div style="font-size:8px;color:#94a3b8;text-transform:uppercase">TOPLAM</div>
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

function populateH2HSels(){
  const allP = getAllSeasonsPlayers();
  ['h2hp_s1','h2hp_s2'].forEach((id,i)=>{
    const el=document.getElementById(id);if(!el)return;
    // Gruplara gÃ¶re gÃ¶ster
    const activeSeason = localStorage.getItem('sm2_active_season') || 'Aktif';
    // Aktif sezon grubu
    const activeGroup = allP.filter(p => p._isActive);
    const otherGroups = {};
    allP.filter(p => !p._isActive).forEach(p => {
      if(!otherGroups[p._seasonLabel]) otherGroups[p._seasonLabel] = [];
      otherGroups[p._seasonLabel].push(p);
    });
    let html = `<optgroup label="â–¶ Aktif Sezon (${activeSeason})">`;
    activeGroup.forEach((p,j) => {
      html += `<option value="s_${p.id}">${p.name}</option>`;
    });
    html += '</optgroup>';
    Object.keys(otherGroups).forEach(sLabel => {
      html += `<optgroup label="ğŸ“‚ Sezon: ${sLabel}">`;
      otherGroups[sLabel].forEach(p => {
        html += `<option value="s_${p.id}">${p.name} (${sLabel})</option>`;
      });
      html += '</optgroup>';
    });
    el.innerHTML = html;
    // VarsayÄ±lan: 1. iÃ§in ilk, 2. iÃ§in ikinci
    const opts = el.querySelectorAll('option');
    if(opts[i]) opts[i].selected = true;
  });
}

// ======================================================
// BROADCAST MODE
// ======================================================
let broadcastMode='full';
function setBroadcastMode(mode){broadcastMode=mode;renderBroadcast();}
function renderBroadcast(){
  const bc=document.getElementById('broadcast_canvas');if(!bc)return;
  const p1=players[p1i],p2=players[p2i];if(!p1||!p2)return;
  const tc1=p1.team==='kirmizi'?'#ef4444':'#3b82f6';
  const tc2=p2.team==='kirmizi'?'#ef4444':'#3b82f6';
  const mkImg=(p,sz)=>{
    if(p.image)return `<div style="width:${sz}px;height:${sz}px;border-radius:50%;background-image:url('${p.image}');background-size:cover;background-position:center;"></div>`;
    return `<div style="width:${sz}px;height:${sz}px;border-radius:50%;background:#1e293b;display:flex;align-items:center;justify-content:center;color:white;font-size:${Math.floor(sz*.4)}px;font-weight:900">${p.name.charAt(0)}</div>`;
  };
  if(broadcastMode==='score'){
    bc.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;gap:60px;padding:30px;background:#0c0f18;width:100%;border-radius:12px"><div style="text-align:center"><div style="font-size:72px;font-weight:900;color:${tc1};font-family:'Barlow Condensed',sans-serif">${p1.score}</div><div style="font-size:14px;color:white;font-weight:700">${p1.name}</div></div><div style="font-size:28px;font-weight:900;color:#475569">VS</div><div style="text-align:center"><div style="font-size:72px;font-weight:900;color:${tc2};font-family:'Barlow Condensed',sans-serif">${p2.score}</div><div style="font-size:14px;color:white;font-weight:700">${p2.name}</div></div></div>`;
  }else if(broadcastMode==='faces'){
    bc.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-around;padding:24px;background:#0c0f18;width:100%;border-radius:12px;gap:20px"><div style="text-align:center"><div style="border:4px solid ${tc1};border-radius:50%;overflow:hidden;display:inline-block">${mkImg(p1,100)}</div><div style="font-size:13px;color:white;font-weight:700;margin-top:8px">${p1.name}</div></div><div style="font-size:24px;font-weight:900;color:#475569">VS</div><div style="text-align:center"><div style="border:4px solid ${tc2};border-radius:50%;overflow:hidden;display:inline-block">${mkImg(p2,100)}</div><div style="font-size:13px;color:white;font-weight:700;margin-top:8px">${p2.name}</div></div></div>`;
  }else if(broadcastMode==='bar'){
    bc.innerHTML=`<div style="background:linear-gradient(to right,#1a0000,#000a2e);color:white;padding:12px 28px;border-radius:8px;display:flex;align-items:center;gap:28px;width:100%"><span style="font-size:10px;font-weight:800;letter-spacing:.1em;opacity:.5;text-transform:uppercase">LIVE</span><span style="font-weight:900;color:${tc1}">${p1.name}</span><span style="font-size:28px;font-weight:900;color:${tc1}">${p1.score}</span><span style="color:#475569;font-weight:700">â€”</span><span style="font-size:28px;font-weight:900;color:${tc2}">${p2.score}</span><span style="font-weight:900;color:${tc2}">${p2.name}</span><span style="margin-left:auto;font-size:10px;opacity:.4">${new Date().toLocaleTimeString('tr')}</span></div>`;
  }else{
    bc.innerHTML=`<div style="background:#0c0f18;width:100%;border-radius:12px;overflow:hidden"><div style="text-align:center;padding:8px;font-size:10px;font-weight:700;letter-spacing:.2em;color:#475569;text-transform:uppercase">SurvivorMetrics LIVE</div><div style="display:flex"><div style="flex:1;padding:18px;background:linear-gradient(to right,#5a0000,#8b0000);text-align:center;color:white"><div style="border:3px solid white;border-radius:50%;overflow:hidden;width:70px;height:70px;margin:0 auto 8px">${mkImg(p1,70)}</div><div style="font-weight:900;font-size:13px">${p1.name}</div><div style="font-size:42px;font-weight:900;font-family:'Barlow Condensed',sans-serif">${p1.score}</div></div><div style="flex:1;padding:18px;background:linear-gradient(to right,#001f5c,#003399);text-align:center;color:white"><div style="border:3px solid white;border-radius:50%;overflow:hidden;width:70px;height:70px;margin:0 auto 8px">${mkImg(p2,70)}</div><div style="font-weight:900;font-size:13px">${p2.name}</div><div style="font-size:42px;font-weight:900;font-family:'Barlow Condensed',sans-serif">${p2.score}</div></div></div></div>`;
  }
}
function copyBroadcastHTML(){
  const el=document.getElementById('broadcast_canvas');if(!el)return;
  navigator.clipboard.writeText(el.innerHTML).then(()=>alert('HTML kopyalandÄ±! OBS Browser Source\'a yapÄ±ÅŸtÄ±rabilirsiniz.')).catch(()=>alert('KopyalanamadÄ±.'));
}

// ======================================================
// SEZON SÄ°STEMÄ°
// ======================================================
function saveSeasonData(){
  const s=document.getElementById('season_sel')?.value||'2026';
  try{
    // TÃ¼m verileri kaydet: yarÄ±ÅŸmacÄ±lar + oyunlar + oyun konfigÃ¼rasyonu
    const games = loadGames();
    const data={
      players:JSON.parse(JSON.stringify(players)),
      games: games,
      savedAt:new Date().toISOString(),
      seasonName: s,
      // Ana ekran konfigÃ¼rasyonu
      cfg: {
        ht: document.getElementById('cfg_ht')?.value||'',
        title: document.getElementById('cfg_title')?.value||'',
      }
    };
    localStorage.setItem('sm2_season_'+s,JSON.stringify(data));
    document.getElementById('season_status').innerHTML=`<span style="color:#10b981">âœ“ ${s} sezonu kaydedildi! (${new Date().toLocaleString('tr')}) â€” ${players.length} yarÄ±ÅŸmacÄ±, ${games.length} oyun</span>`;
    buildSeasonsList();
  }catch(e){document.getElementById('season_status').innerHTML=`<span style="color:#ef4444">Hata: ${e.message}</span>`;}
}
function loadSeasonData(){
  const s=document.getElementById('season_sel')?.value||'2026';
  try{
    const raw=localStorage.getItem('sm2_season_'+s);
    if(!raw){document.getElementById('season_status').innerHTML=`<span style="color:#f59e0b">âš  ${s} iÃ§in kayÄ±t bulunamadÄ±.</span>`;return;}
    if(!confirm(`${s} sezonunu yÃ¼klemek mevcut verilerin Ã¼zerine yazacak. Devam?`))return;
    const data=JSON.parse(raw);
    players=data.players.map(p=>{
      if(!p.h2hRegistry)p.h2hRegistry={};
      if(!p.image){try{const img=localStorage.getItem('sm2_img_'+p.id);if(img)p.image=img;}catch(e){}}
      return p;
    });
    while(players.length<2)players.push(mkP());
    // OyunlarÄ± da yÃ¼kle
    if(data.games && Array.isArray(data.games)){
      try{ localStorage.setItem('sm2_games', JSON.stringify(data.games)); }catch(e){}
    }
    // KonfigÃ¼rasyonu yÃ¼kle
    if(data.cfg){
      if(data.cfg.ht && document.getElementById('cfg_ht')) document.getElementById('cfg_ht').value=data.cfg.ht;
      if(data.cfg.title && document.getElementById('cfg_title')) document.getElementById('cfg_title').value=data.cfg.title;
    }
    // Aktif sezon bilgisini kaydet
    localStorage.setItem('sm2_active_season', s);
    p1i=0;p2i=1;
    save();updateSelects();refreshEditors();renderMain();
    document.getElementById('season_status').innerHTML=`<span style="color:#10b981">âœ“ ${s} sezonu yÃ¼klendi! KayÄ±t: ${new Date(data.savedAt).toLocaleString('tr')} â€” ${players.length} yarÄ±ÅŸmacÄ±${data.games?', '+data.games.length+' oyun':''}</span>`;
  }catch(e){document.getElementById('season_status').innerHTML=`<span style="color:#ef4444">Hata: ${e.message}</span>`;}
}
function getSeasonNames(){
  // VarsayÄ±lan sezonlar + kullanÄ±cÄ± eklenenler
  const defaults = ['2026','2027','allstar'];
  let custom = [];
  try { custom = JSON.parse(localStorage.getItem('sm2_custom_seasons')||'[]'); } catch(e){}
  return [...new Set([...defaults,...custom])];
}
function addNewSeason(){
  const nameEl = document.getElementById('new_season_name');
  const name = (nameEl?.value||'').trim();
  if(!name){alert('Sezon adÄ± girin!');return;}
  let custom = [];
  try { custom = JSON.parse(localStorage.getItem('sm2_custom_seasons')||'[]'); } catch(e){}
  // Store original name (with spaces preserved but safe for key)
  const key = name.replace(/\s+/g,'_');
  if(!custom.includes(key)){
    custom.push(key);
    localStorage.setItem('sm2_custom_seasons',JSON.stringify(custom));
    // Store display label mapping
    const labels = JSON.parse(localStorage.getItem('sm2_season_labels')||'{}');
    labels[key] = name;
    localStorage.setItem('sm2_season_labels', JSON.stringify(labels));
  }
  if(nameEl) nameEl.value='';
  populateSeasonSel();
  buildSeasonsList();
  // Yeni sezonu seÃ§
  const sel = document.getElementById('season_sel');
  if(sel) { sel.value = key; onSeasonSelChange(key); }
  document.getElementById('season_status').innerHTML=`<span style="color:#10b981">âœ“ "${name}" sezonu eklendi. Mevcut veriyi bu sezona kaydetmek iÃ§in "Sezonu Kaydet", ya da temiz baÅŸlamak iÃ§in "BoÅŸ Sezon Olarak BaÅŸlat" butonunu kullanÄ±n.</span>
  <div style="margin-top:8px"><button onclick="startFreshSeason('${key}')" class="btn btn-sm" style="background:#7c3aed;color:white">ğŸ†• BoÅŸ Sezon Olarak BaÅŸlat</button></div>`;
}

function startFreshSeason(key) {
  if(!confirm(`"${getSeasonLabel(key)}" sezonu boÅŸ olarak baÅŸlatÄ±lsÄ±n mÄ±? Mevcut veriler deÄŸiÅŸmeyecek.`)) return;
  // Save current state as new season with empty data
  const emptyData = {
    players: [mkP(), mkP()],
    games: [],
    savedAt: new Date().toISOString(),
    seasonName: key,
    cfg: { ht: '', title: 'SURVIVOR ' + getSeasonLabel(key) }
  };
  localStorage.setItem('sm2_season_'+key, JSON.stringify(emptyData));
  // Switch to new season
  players = emptyData.players;
  localStorage.setItem('sm2_games', JSON.stringify([]));
  const cfgHt = document.getElementById('cfg_ht'); if(cfgHt) cfgHt.value = '';
  const cfgTitle = document.getElementById('cfg_title'); if(cfgTitle) cfgTitle.value = emptyData.cfg.title;
  localStorage.setItem('sm2_active_season', key);
  p1i=0; p2i=1;
  save(); updateSelects(); refreshEditors(); renderMain();
  buildSeasonsList();
  document.getElementById('season_status').innerHTML=`<span style="color:#10b981">âœ“ "${getSeasonLabel(key)}" sezonu boÅŸ olarak baÅŸlatÄ±ldÄ± ve aktif edildi!</span>`;
}

function getSeasonLabel(s) {
  if(s==='allstar') return 'All-Star';
  const labels = JSON.parse(localStorage.getItem('sm2_season_labels')||'{}');
  return labels[s] || s.replace(/_/g,' ');
}

function switchToSeason(s) {
  const raw = localStorage.getItem('sm2_season_'+s);
  if (!raw) return; // KayÄ±t yoksa geÃ§iÅŸ yapma
  const data = JSON.parse(raw);
  players = data.players.map(p => {
    if (!p.h2hRegistry) p.h2hRegistry = {};
    if (!p.image) { try { const img = localStorage.getItem('sm2_img_'+p.id); if(img) p.image = img; } catch(e){} }
    return p;
  });
  while(players.length < 2) players.push(mkP());
  if (data.games && Array.isArray(data.games)) {
    try { localStorage.setItem('sm2_games', JSON.stringify(data.games)); } catch(e){}
  }
  if (data.cfg) {
    if (data.cfg.ht && document.getElementById('cfg_ht')) document.getElementById('cfg_ht').value = data.cfg.ht;
    if (data.cfg.title && document.getElementById('cfg_title')) document.getElementById('cfg_title').value = data.cfg.title;
  }
  localStorage.setItem('sm2_active_season', s);
  p1i = 0; p2i = 1;
  save(); updateSelects(); refreshEditors(); renderMain();
}
function onSeasonSelChange(s) {
  const badge = document.getElementById('active_season_badge');
  const hasData = !!localStorage.getItem('sm2_season_'+s);
  const activeSeason = localStorage.getItem('sm2_active_season') || '';
  if (badge) {
    if (hasData) {
      const isActive = activeSeason === s;
      badge.innerHTML = `<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:${isActive?'#f0fdf4':'#eff6ff'};border-radius:8px;border:1px solid ${isActive?'#bbf7d0':'#bfdbfe'}">
        <span style="font-size:12px;font-weight:700;color:${isActive?'#16a34a':'#2563eb'}">${isActive?'âœ… Bu sezon aktif yÃ¼klÃ¼':'ğŸ“‚ Bu sezon kaydedilmiÅŸ â€” yÃ¼klemek iÃ§in "Sezonu YÃ¼kle" butonuna basÄ±n'}</span>
        ${!isActive?`<button onclick="loadSeasonData()" class="btn btn-sm" style="background:#2563eb;color:white;font-size:11px;padding:4px 10px">Hemen YÃ¼kle</button>`:''}
      </div>`;
    } else {
      badge.innerHTML = `<div style="padding:8px 12px;background:#fef9c3;border-radius:8px;border:1px solid #fcd34d;font-size:12px;font-weight:700;color:#92400e">âš ï¸ Bu sezon iÃ§in kayÄ±t yok â€” "Sezonu Kaydet" ile kaydedin</div>`;
    }
  }
}

function populateSeasonSel(){
  const sel = document.getElementById('season_sel');
  if(!sel) return;
  const seasons = getSeasonNames();
  const cur = sel.value;
  sel.innerHTML = seasons.map(s=>{
    const label = getSeasonLabel(s);
    return `<option value="${s}" ${s===cur?'selected':''}>${label}</option>`;
  }).join('');
  // Badge gÃ¼ncelle
  setTimeout(()=>onSeasonSelChange(sel.value), 50);
}
function buildSeasonsList(){
  const el=document.getElementById('seasons_list');if(!el)return;
  populateSeasonSel();
  const seasons = getSeasonNames();
  const activeSeason = localStorage.getItem('sm2_active_season') || '';
  el.innerHTML=seasons.map(s=>{
    const label = getSeasonLabel(s);
    const has=!!localStorage.getItem('sm2_season_'+s);
    const isActive = activeSeason === s;
    return `<div style="display:flex;align-items:center;gap:12px;padding:10px 14px;background:${isActive?'#f0fdf4':has?'#eff6ff':'#f8fafc'};border-radius:10px;border:1px solid ${isActive?'#16a34a':has?'#bfdbfe':'#e2e8f0'}">
      <span style="font-weight:700;flex:1">${label} Sezonu ${isActive?'<span style="font-size:10px;color:#16a34a;font-weight:700;background:#dcfce7;padding:2px 6px;border-radius:10px;margin-left:4px">AKTÄ°F</span>':''}</span>
      ${has
        ? `<span style="font-size:11px;color:${isActive?'#16a34a':'#2563eb'};font-weight:700">${isActive?'âœ“ YÃ¼klÃ¼':'KayÄ±tlÄ±'}</span>
           ${!isActive?`<button onclick="document.getElementById('season_sel').value='${s}';loadSeasonData()" style="background:#2563eb;color:white;border:none;border-radius:6px;padding:5px 12px;cursor:pointer;font-size:11px;font-weight:700">â–¶ YÃ¼kle</button>`:''}
           <button onclick="deleteSeasonData('${s}')" style="background:#ef4444;color:white;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:11px">Sil</button>`
        : `<button onclick="startFreshSeason('${s}')" style="background:#7c3aed;color:white;border:none;border-radius:6px;padding:5px 12px;cursor:pointer;font-size:11px;font-weight:700">ğŸ†• BaÅŸlat</button>`}
      <button onclick="removeSeasonFromList('${s}')" style="background:#94a3b8;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:11px" title="Listeden kaldÄ±r">âœ•</button>
    </div>`;
  }).join('');
}
function removeSeasonFromList(s){
  const defaults=['2026','2027','allstar'];
  if(defaults.includes(s)){alert('VarsayÄ±lan sezonlar listeden kaldÄ±rÄ±lamaz.');return;}
  if(!confirm(`"${s}" sezonu listeden kaldÄ±rÄ±lsÄ±n mÄ±? (KaydedilmiÅŸ veri de silinir)`))return;
  localStorage.removeItem('sm2_season_'+s);
  let custom=[];
  try{custom=JSON.parse(localStorage.getItem('sm2_custom_seasons')||'[]');}catch(e){}
  custom=custom.filter(c=>c!==s);
  localStorage.setItem('sm2_custom_seasons',JSON.stringify(custom));
  buildSeasonsList();
}
function deleteSeasonData(s){
  if(!confirm(`${s} sezon verisini silmek istiyor musun?`))return;
  localStorage.removeItem('sm2_season_'+s);buildSeasonsList();
}

// ======================================================
// TEMA SEÃ‡Ä°MÄ°
// ======================================================
function applyTheme(theme){
  document.body.className='';
  if(theme!=='light')document.body.classList.add('theme-'+theme);
  localStorage.setItem('sm2_theme',theme);
  const el=document.getElementById('theme_applied');
  if(el){el.textContent='âœ“ Tema uygulandÄ±: '+theme.toUpperCase();setTimeout(()=>{el.textContent='';},2000);}
}
function loadTheme(){
  const t=localStorage.getItem('sm2_theme');
  if(t&&t!=='light')document.body.classList.add('theme-'+t);
}

// ======================================================
// JSON EXPORT / IMPORT
// ======================================================
function exportJSON(){
  const games = loadGames();
  const blob=new Blob([JSON.stringify({version:'SurvivorMetrics-v2',exportedAt:new Date().toISOString(),players,games},null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='survivormetrics-backup-'+Date.now()+'.json';
  a.click();
  const el=document.getElementById('export_status');
  if(el)el.innerHTML=`<span style="color:#10b981">âœ“ JSON indirildi! ${players.length} yarÄ±ÅŸmacÄ±, ${games.length} oyun aktarÄ±ldÄ±.</span>`;
}
function importJSON(input){
  const file=input.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(!data.players||!Array.isArray(data.players))throw new Error('GeÃ§ersiz format');
      if(!confirm(`${data.players.length} yarÄ±ÅŸmacÄ±${data.games?', '+data.games.length+' oyun':''} iÃ§e aktarÄ±lacak. Mevcut veriler silinecek. Devam?`))return;
      players=data.players.map(p=>{
        if(!p.h2hRegistry)p.h2hRegistry={};
        if(!p.id)p.id=uid();
        if(p.image)try{localStorage.setItem('sm2_img_'+p.id,p.image);}catch(e){}
        return p;
      });
      // OyunlarÄ± da iÃ§e aktar
      if(data.games && Array.isArray(data.games)){
        try{ localStorage.setItem('sm2_games', JSON.stringify(data.games)); }catch(e){}
      }
      while(players.length<2)players.push(mkP());
      p1i=0;p2i=1;
      save();updateSelects();refreshEditors();renderMain();
      const el=document.getElementById('export_status');
      if(el)el.innerHTML=`<span style="color:#10b981">âœ“ Ä°Ã§e aktarma baÅŸarÄ±lÄ±! ${players.length} yarÄ±ÅŸmacÄ±${data.games?', '+data.games.length+' oyun':''} yÃ¼klendi.</span>`;
    }catch(err){
      const el=document.getElementById('export_status');
      if(el)el.innerHTML=`<span style="color:#ef4444">Hata: ${err.message}</span>`;
    }
  };
  r.readAsText(file);
}

// ======================================================
// SÄ°MÃœLASYON MODU
// ======================================================
let simPlayers=[];
function mkSimP(){return{id:uid(),name:'YENÄ° YARIÅMACI',image:null,team:'kirmizi',totalStats:{total:0,wins:0,losses:0}};}
function addSimPlayer(){simPlayers.push(mkSimP());renderSimPlayers();}
function loadFromMain(){simPlayers=players.map(p=>({...p,totalStats:{...p.totalStats}}));renderSimPlayers();}
function renderSimPlayers(){
  const el=document.getElementById('sim_players_list');if(!el)return;
  el.innerHTML=simPlayers.map((p,i)=>`<div style="background:#f8fafc;border-radius:12px;padding:12px;border:1px solid #e2e8f0">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      ${p.image?`<div style="width:36px;height:36px;border-radius:50%;background-image:url('${p.image}');background-size:cover;background-position:center;flex-shrink:0;"></div>`:`<div style="width:36px;height:36px;border-radius:50%;background:#e2e8f0;display:flex;align-items:center;justify-content:center;font-weight:900;flex-shrink:0">${p.name.charAt(0)}</div>`}
      <input type="text" value="${p.name}" style="flex:1;font-size:13px" onchange="simPlayers[${i}].name=this.value;updateSimSelects();renderSimTable()">
      <input type="file" accept="image/*" onchange="simUpImg(${i},this)" style="display:none" id="sim_img_${i}">
      <button onclick="document.getElementById('sim_img_${i}').click()" style="background:#e2e8f0;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:11px">ğŸ“·</button>
      <button onclick="simPlayers.splice(${i},1);renderSimPlayers()" style="background:#ef4444;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:11px">âœ•</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">
      <div><label style="font-size:9px;font-weight:700;color:#94a3b8;display:block;margin-bottom:2px">GALÄ°BÄ°YET</label><input type="number" value="${p.totalStats.wins}" style="font-size:12px" onchange="simUpStat(${i},'wins',this.value)"></div>
      <div><label style="font-size:9px;font-weight:700;color:#94a3b8;display:block;margin-bottom:2px">YENÄ°LGÄ°</label><input type="number" value="${p.totalStats.losses}" style="font-size:12px" onchange="simUpStat(${i},'losses',this.value)"></div>
      <div><label style="font-size:9px;font-weight:700;color:#6366f1;display:block;margin-bottom:2px">WR%</label><div style="font-size:13px;font-weight:900;color:#6366f1;padding:7px 0">${p.totalStats.total?((p.totalStats.wins/p.totalStats.total)*100).toFixed(0)+'%':'0%'}</div></div>
    </div></div>`).join('');
  updateSimSelects();renderSimTable();
}
function simUpStat(i,field,v){
  simPlayers[i].totalStats[field]=Number(v)||0;
  simPlayers[i].totalStats.total=simPlayers[i].totalStats.wins+simPlayers[i].totalStats.losses;
  renderSimPlayers();
}
function simUpImg(i,input){
  const f=input.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    cropToSquare(e.target.result,600,function(cropped){
      simPlayers[i].image=cropped;renderSimPlayers();
    });
  };
  r.readAsDataURL(f);
}
function updateSimSelects(){
  ['sim_s1','sim_s2'].forEach((id,idx)=>{
    const el=document.getElementById(id);if(!el)return;
    const cur=el.value;
    el.innerHTML=simPlayers.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
    if(cur!==''&&el.querySelector(`option[value="${cur}"]`))el.value=cur;
    else el.value=Math.min(idx,Math.max(0,simPlayers.length-1));
  });
}
function renderSimTable(){
  const tb=document.getElementById('sim_table_body');if(!tb)return;
  tb.innerHTML=simPlayers.map((p,i)=>{
    const s=p.totalStats;const wr=s.total?((s.wins/s.total)*100).toFixed(1)+'%':'0.0%';const sc=s.wins-s.losses;const tc=p.team==='kirmizi'?'#dc2626':'#2563eb';
    return `<tr><td style="font-weight:700;color:${tc}">${p.name}</td><td class="tc">${s.total}</td><td class="tc" style="color:#10b981;font-weight:700">${s.wins}</td><td class="tc" style="color:#ef4444;font-weight:700">${s.losses}</td><td class="tc" style="color:#6366f1;font-weight:700">${wr}</td><td class="tc" style="color:${sc>=0?'#10b981':'#ef4444'};font-weight:700">${sc>=0?'+':''}${sc}</td><td><button onclick="simPlayers.splice(${i},1);renderSimPlayers()" style="background:#ef4444;color:white;border:none;border-radius:6px;padding:3px 8px;cursor:pointer;font-size:11px">Sil</button></td></tr>`;
  }).join('');
}
function runSimulation(){
  const i1=Number(document.getElementById('sim_s1')?.value||0);
  const i2=Number(document.getElementById('sim_s2')?.value||1);
  const p1=simPlayers[i1],p2=simPlayers[i2];
  if(!p1||!p2||i1===i2){alert('Ä°ki farklÄ± yarÄ±ÅŸmacÄ± seÃ§in!');return;}
  const wr1=p1.totalStats.total?(p1.totalStats.wins/p1.totalStats.total):0.5;
  const wr2=p2.totalStats.total?(p2.totalStats.wins/p2.totalStats.total):0.5;
  const totalWr=wr1+wr2||1;const p1Prob=wr1/totalWr;
  let w1=0,w2=0;for(let i=0;i<100;i++){Math.random()<p1Prob?w1++:w2++;}
  const tc1=p1.team==='kirmizi'?'#ef4444':'#3b82f6';const tc2=p2.team==='kirmizi'?'#ef4444':'#3b82f6';
  const winner=w1>=w2?p1:p2;const winColor=w1>=w2?tc1:tc2;
  document.getElementById('sim_result_body').innerHTML=`
    <div style="font-size:11px;font-weight:700;letter-spacing:.1em;color:#94a3b8;text-transform:uppercase;margin-bottom:16px">ğŸ² 100 MAÃ‡LIK SÄ°MÃœLASYON SONUCU</div>
    <div style="display:flex;align-items:center;justify-content:center;gap:28px;margin-bottom:20px">
      <div style="text-align:center">
        <div style="font-size:13px;font-weight:700;color:${tc1};margin-bottom:4px">${p1.name}</div>
        <div style="font-size:64px;font-weight:900;color:${tc1};font-family:'Barlow Condensed',sans-serif;line-height:1">${w1}</div>
      </div>
      <div style="font-size:24px;font-weight:900;color:#cbd5e1">â€”</div>
      <div style="text-align:center">
        <div style="font-size:13px;font-weight:700;color:${tc2};margin-bottom:4px">${p2.name}</div>
        <div style="font-size:64px;font-weight:900;color:${tc2};font-family:'Barlow Condensed',sans-serif;line-height:1">${w2}</div>
      </div>
    </div>
    <div style="background:${winColor}18;border:2px solid ${winColor}40;border-radius:12px;padding:14px;margin-bottom:16px">
      <div style="font-size:15px;font-weight:900;color:${winColor}">ğŸ† ${winner.name} kazandÄ±!</div>
      <div style="font-size:12px;color:#64748b;margin-top:4px">${Math.max(w1,w2)} â€” ${Math.min(w1,w2)} galibiyetle Ã¶ne Ã§Ä±ktÄ±</div>
    </div>
    <div style="background:#f1f5f9;border-radius:10px;padding:10px;margin-bottom:16px">
      <div style="height:14px;border-radius:7px;overflow:hidden;display:flex;margin-bottom:6px">
        <div style="width:${w1}%;background:${tc1};transition:width .5s"></div>
        <div style="flex:1;background:${tc2}"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;font-weight:700">
        <span style="color:${tc1}">${p1.name} %${w1}</span>
        <span style="color:${tc2}">${p2.name} %${w2}</span>
      </div>
    </div>
    <div style="font-size:11px;color:#94a3b8">Ä°statistiksel olasÄ±lÄ±k bazlÄ± rastgele simÃ¼lasyon</div>`;
  openM('m_sim_result');
}

// ======================================================
// ELEME ADAYI
// ======================================================
function populateElimSel(){
  const sel=document.getElementById('elim_sel');if(!sel)return;
  sel.innerHTML=players.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
}
function renderElimPanel(){
  const sel=document.getElementById('elim_sel');if(!sel)return;
  const idx=Number(sel.value||0);
  const p=players[idx];if(!p)return;
  const s=p.totalStats;const ps=calcPowerScore(p);
  const tc=p.team==='kirmizi'?'#dc2626':'#2563eb';
  const teamBg=p.team==='kirmizi'?'linear-gradient(135deg,#5a0000,#991b1b)':'linear-gradient(135deg,#001f5c,#1e40af)';
  const wr=s.total?(s.wins/s.total*100).toFixed(1):0;
  const imgHtml=p.image?`<div style="width:120px;height:120px;border-radius:50%;background-image:url('${p.image}');background-size:cover;background-position:center;border:5px solid white;box-shadow:0 8px 24px rgba(0,0,0,.4);"></div>`:`<div style="width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:900;color:white;border:5px solid white">${p.name.charAt(0)}</div>`;
  let worstOpp=null,worstWr=999;
  players.forEach((opp,oi)=>{if(oi===idx)return;const h=p.h2hRegistry[opp.id]||{total:0,wins:0,losses:0};if(h.total>0){const w=h.wins/h.total*100;if(w<worstWr){worstWr=w;worstOpp=opp;}}});
  const chartId='elim_chart_'+idx+'_'+Date.now();
  document.getElementById('elim_body').innerHTML=`
    <div style="background:${teamBg};border-radius:16px;padding:28px;color:white;margin-bottom:20px;display:flex;gap:24px;align-items:center;flex-wrap:wrap">
      <div style="text-align:center">${imgHtml}</div>
      <div style="flex:1;min-width:200px">
        <div style="font-size:28px;font-weight:900;text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px">${p.name}</div>
        <div style="opacity:.8;margin-bottom:14px">${p.status||'YarÄ±ÅŸmacÄ±'} Â· ${p.team.toUpperCase()} TAKIM</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
          <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:10px;text-align:center"><div style="font-size:9px;opacity:.7;text-transform:uppercase">Toplam</div><div style="font-size:22px;font-weight:900">${s.total}</div></div>
          <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:10px;text-align:center"><div style="font-size:9px;color:#86efac;text-transform:uppercase">G</div><div style="font-size:22px;font-weight:900;color:#86efac">${s.wins}</div></div>
          <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:10px;text-align:center"><div style="font-size:9px;color:#fca5a5;text-transform:uppercase">Y</div><div style="font-size:22px;font-weight:900;color:#fca5a5">${s.losses}</div></div>
          <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:10px;text-align:center"><div style="font-size:9px;opacity:.7;text-transform:uppercase">%</div><div style="font-size:22px;font-weight:900">${wr}</div></div>
        </div>
      </div>
      <div style="text-align:center;min-width:140px">
        <div style="font-size:64px;font-weight:900;line-height:1;color:${ps.scoreColor};text-shadow:0 0 20px ${ps.scoreColor}80">${ps.score}</div>
        <div style="font-size:10px;font-weight:700;opacity:.6;letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px">POWER SCORE</div>
        <div style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);border-radius:20px;padding:5px 14px;font-size:12px;font-weight:800">${ps.badge}</div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:14px;margin-bottom:20px">
      <div style="background:#f8fafc;border-radius:14px;padding:16px">
        <div class="section-label" style="margin-bottom:12px">Performans GrafiÄŸi</div>
        <canvas id="${chartId}" height="120"></canvas>
      </div>
      <div style="background:#f8fafc;border-radius:14px;padding:16px">
        <div class="section-label" style="margin-bottom:10px">âš ï¸ Eleme Risk Analizi</div>
        <div style="font-size:13px;line-height:1.9">
          <div>â€¢ Win Rate: <strong style="color:${Number(wr)>50?'#10b981':'#ef4444'}">${wr}%</strong></div>
          <div>â€¢ Power Score: <strong style="color:${ps.scoreColor}">${ps.score}/100</strong></div>
          <div>â€¢ StatÃ¼: <strong>${ps.badge}</strong></div>
          ${worstOpp?`<div>â€¢ ZayÄ±f olduÄŸu rakip: <strong style="color:#ef4444">${worstOpp.name}</strong> (%${worstWr.toFixed(0)} WR)</div>`:''}
        </div>
        <div style="margin-top:12px;padding:12px;border-radius:10px;background:${ps.score<45?'#fee2e2':ps.score<70?'#fef3c7':'#dcfce7'}">
          <div style="font-weight:900;font-size:14px">${ps.score<45?'ğŸš¨ YÃ¼ksek Eleme Riski':ps.score<70?'âš ï¸ Orta Risk':'âœ… GÃ¼Ã§lÃ¼ Konumda'}</div>
          <div style="font-size:12px;margin-top:4px;color:#475569">${ps.score<45?'Bu yarÄ±ÅŸmacÄ± eleme adayÄ± olarak deÄŸerlendirilebilir.':ps.score<70?'PerformansÄ±nÄ± geliÅŸtirmesi gerekiyor.':'Bu yarÄ±ÅŸmacÄ± gÃ¼Ã§lÃ¼ bir konumda.'}</div>
        </div>
      </div>
      <div style="background:#f8fafc;border-radius:14px;padding:16px">
        <div class="section-label" style="margin-bottom:12px">ğŸ¯ Oyun BaÅŸarÄ±sÄ± (AtÄ±ÅŸ Tipine GÃ¶re)</div>
        ${(()=>{
          const atisTypes2 = ['TOP', 'BASKET', 'STICK', 'DÄ°SK', 'BUMERANG', 'DAMBIL', 'KÃœP', 'HALKA', 'Ã‡EKÄ°Ã‡', 'KUM TORBASI', 'KONDURMA'];
          const atisIcons2 = {'TOP':'âš½','BASKET':'ğŸ€','STICK':'ğŸ’','DÄ°SK':'ğŸ¥','BUMERANG':'ğŸªƒ','DAMBIL':'ğŸ‹','KÃœP':'ğŸ“¦','HALKA':'â­•','Ã‡EKÄ°Ã‡':'ğŸ”¨','KUM TORBASI':'ğŸ¥Š','KONDURMA':'ğŸ¯'};
          const atisStats2 = {};
          atisTypes2.forEach(at => { atisStats2[at] = { wins: 0, total: 0 }; });
          const allGames2 = loadGames();
          allGames2.forEach(g => {
            if (g.p1Name !== p.name && g.p2Name !== p.name) return;
            const isWinner2 = g.winner === p.name;
            const atisKey2 = g.atisType || '';
            if (atisKey2 && atisStats2[atisKey2] !== undefined) {
              atisStats2[atisKey2].total++;
              if (isWinner2) atisStats2[atisKey2].wins++;
            } else {
              const searchStr2 = (atisKey2 + ' ' + (g.gameType || '')).toUpperCase();
              atisTypes2.forEach(at => {
                if (searchStr2.includes(at.toUpperCase())) {
                  atisStats2[at].total++;
                  if (isWinner2) atisStats2[at].wins++;
                }
              });
            }
          });
          const atisEntries2 = atisTypes2.map(at => ({ at, st: atisStats2[at] })).filter(x => x.st.total > 0);
          if (atisEntries2.length === 0) return '<div style="text-align:center;padding:16px;color:#94a3b8;font-size:12px">âš½ HenÃ¼z atÄ±ÅŸ tipi kayÄ±tlÄ± oyun yok.<br>Oyun kaydederken atÄ±ÅŸ tipi seÃ§in.</div>';
          return '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px">' +
            atisEntries2.map(({at, st}) => {
              const atWr2 = Math.round((st.wins / st.total) * 100);
              const color2 = atWr2 >= 60 ? '#10b981' : atWr2 >= 40 ? '#f59e0b' : '#ef4444';
              return `<div style="background:white;border-radius:10px;padding:10px;text-align:center;border:2px solid ${color2}22">
                <div style="font-size:18px">${atisIcons2[at]||'ğŸ¯'}</div>
                <div style="font-size:11px;font-weight:800;margin:3px 0">${at}</div>
                <div style="font-size:18px;font-weight:900;color:${color2}">%${atWr2}</div>
                <div style="font-size:9px;color:#94a3b8">${st.wins}G / ${st.total}T</div>
                <div style="height:5px;border-radius:3px;background:#e2e8f0;overflow:hidden;margin-top:5px">
                  <div style="height:100%;width:${atWr2}%;background:${color2};border-radius:3px"></div>
                </div>
              </div>`;
            }).join('') + '</div>';
        })()}
      </div>
    </div>`;
  // AtÄ±ÅŸ tipi istatistiklerini hesapla (derin analiz ile aynÄ± mantÄ±k)
  const atisTypes = ['TOP', 'BASKET', 'STICK', 'DÄ°SK', 'BUMERANG', 'DAMBIL', 'KÃœP', 'HALKA', 'Ã‡EKÄ°Ã‡', 'KUM TORBASI', 'KONDURMA'];
  const atisIcons = {'TOP':'âš½','BASKET':'ğŸ€','STICK':'ğŸ’','DÄ°SK':'ğŸ¥','BUMERANG':'ğŸªƒ','DAMBIL':'ğŸ‹','KÃœP':'ğŸ“¦','HALKA':'â­•','Ã‡EKÄ°Ã‡':'ğŸ”¨','KUM TORBASI':'ğŸ¥Š','KONDURMA':'ğŸ¯'};
  const allGamesElim = loadGames();
  const atisStatsElim = {};
  atisTypes.forEach(at => { atisStatsElim[at] = { wins: 0, total: 0 }; });
  allGamesElim.forEach(g => {
    const pName = p.name;
    const isParticipant = g.p1Name === pName || g.p2Name === pName;
    if (!isParticipant) return;
    const isWinner = g.winner === pName;
    const atisKey = g.atisType || '';
    if (atisKey && atisStatsElim[atisKey] !== undefined) {
      atisStatsElim[atisKey].total++;
      if (isWinner) atisStatsElim[atisKey].wins++;
    } else {
      const searchStr = (atisKey + ' ' + (g.gameType || '')).toUpperCase();
      atisTypes.forEach(at => {
        if (searchStr.includes(at.toUpperCase())) {
          atisStatsElim[at].total++;
          if (isWinner) atisStatsElim[at].wins++;
        }
      });
    }
  });
  const atisEntriesElim = atisTypes.map(at => ({ at, st: atisStatsElim[at] })).filter(x => x.st.total > 0);
  const atisElimHTML = atisEntriesElim.length === 0
    ? '<div style="text-align:center;padding:16px;color:#94a3b8;font-size:12px">âš½ HenÃ¼z atÄ±ÅŸ tipi kayÄ±tlÄ± oyun yok.</div>'
    : '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px">' +
      atisEntriesElim.map(({at, st}) => {
        const atWr = Math.round((st.wins / st.total) * 100);
        const color = atWr >= 60 ? '#10b981' : atWr >= 40 ? '#f59e0b' : '#ef4444';
        return `<div style="background:white;border-radius:10px;padding:10px;text-align:center;border:2px solid ${color}22">
          <div style="font-size:18px">${atisIcons[at]||'ğŸ¯'}</div>
          <div style="font-size:11px;font-weight:800;margin:3px 0">${at}</div>
          <div style="font-size:18px;font-weight:900;color:${color}">%${atWr}</div>
          <div style="font-size:9px;color:#94a3b8">${st.wins}G / ${st.total}T</div>
          <div style="height:5px;border-radius:3px;background:#e2e8f0;overflow:hidden;margin-top:5px">
            <div style="height:100%;width:${atWr}%;background:${color};border-radius:3px"></div>
          </div>
        </div>`;
      }).join('') + '</div>';
  document.getElementById('elim_body').innerHTML += '';
  loadChartJS(()=>{
    const ctx=document.getElementById(chartId);if(!ctx)return;
    const elimGames = loadGames().filter(g => g.p1Name === p.name || g.p2Name === p.name)
      .sort((a,b)=>new Date(a.date)-new Date(b.date)).slice(-12);
    let fvLabels=[], fvData=[], fvColors=[];
    if(elimGames.length > 0){
      elimGames.forEach((g,i)=>{
        const win = g.winner === p.name;
        const draw = g.winner === 'Berabere';
        fvLabels.push('M'+(i+1));
        fvData.push(draw?0.5:win?1:0);
        fvColors.push(draw?'#f59e0b':win?tc:'#ef4444');
      });
    } else {
      fvLabels=['Genel'];fvData=[Number(wr)/100];fvColors=[tc];
    }
    new Chart(ctx,{type:'bar',data:{labels:fvLabels,datasets:[{data:fvData,backgroundColor:fvColors,borderRadius:5,label:'SonuÃ§'}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{min:0,max:1.3,ticks:{callback:v=>v===1?'G':v===0.5?'B':v===0?'M':''},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}}}});
  });
}




// ======================================================
// OYUN KAYDETME SÄ°STEMÄ°
// ======================================================

function loadGames() {
  try {
    const d = localStorage.getItem('sm2_games');
    return d ? JSON.parse(d) : [];
  } catch(e) { return []; }
}

function saveGames(games) {
  try { localStorage.setItem('sm2_games', JSON.stringify(games)); } catch(e) {}
}

function selectGameType(slot, type, btn) {
  // Bu fonksiyon artÄ±k saveGame iÃ§inden Ã§aÄŸrÄ±labilir, UI butonlarÄ± yok
}

// â”€â”€ Genel toggle yardÄ±mcÄ±sÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _toggleGTBtn(group, val, btn, activeColor) {
  // AynÄ± gruptaki tÃ¼m butonlarÄ± sÄ±fÄ±rla
  document.querySelectorAll(`[data-group="${group}"]`).forEach(b => {
    b.style.background = '#f1f5f9';
    b.style.borderColor = '#cbd5e1';
    b.style.color = '#1e293b';
    b.dataset.active = '';
  });
  // Zaten seÃ§iliyse (toggle off) â€” seÃ§imi kaldÄ±r
  if (btn.dataset.active === '1') {
    btn.dataset.active = '';
    return null; // boÅŸ
  }
  // SeÃ§
  btn.style.background = activeColor;
  btn.style.borderColor = activeColor;
  btn.style.color = 'white';
  btn.dataset.active = '1';
  return val;
}

function _buildMainLabel() {
  // 3 grubun seÃ§ili deÄŸerini topla, boÅŸlarÄ± atla, birleÅŸtir
  const parts = [];
  ['gt_parkur','gt_atis','gt_format','gt_oyun'].forEach(g => {
    const active = document.querySelector(`[data-group="${g}"][data-active="1"]`);
    if (active && active.dataset.val) parts.push(active.dataset.val);
  });
  // b1 = ilk kÄ±sÄ±m (parkur + atÄ±ÅŸ), b2 = format
  const b1 = parts.slice(0,-1).join(' Â· ') || parts[0] || '';
  const b2 = parts.length > 1 ? parts[parts.length-1] : (parts.length===1 && document.querySelector('[data-group="gt_format"][data-active="1"]') ? parts[0] : '');
  // Rozet 1 tÃ¼m seÃ§imler birleÅŸik, Rozet 2 sadece format
  const allParts = parts.join(' Â· ');
  return allParts;
}



function _buildFlagLabel() {
  const parts = [];
  ['fgt_parkur','fgt_atis','fgt_format'].forEach(g => {
    const active = document.querySelector(`[data-group="${g}"][data-active="1"]`);
    if (active && active.dataset.val) parts.push(active.dataset.val);
  });
  return { b1: parts.slice(0,2).join(' Â· ') || '', b2: parts[2] || parts[0] || '' };
}

function toggleMainGT(group, val, btn) {
  _toggleGTBtn(group, val, btn, '#6366f1');
  const label = _buildMainLabel();
  const b1 = document.getElementById('cfg_b1');
  const b2 = document.getElementById('cfg_b2');
  if (b1) b1.value = label;
  if (b2) b2.value = '';
  renderMain();
}

function toggleDuelGT(group, val, btn) {
  _toggleGTBtn(group, val, btn, '#ec4899');
  const label = _buildDuelLabel();
  currentDuelGameType = label;
  const h = document.getElementById('duel_game_type');
  if (h) h.value = label;
  renderDuel(); // badge'i tasarÄ±ma yansÄ±t
}

function _buildDuelLabel() {
  const parts = [];
  ['dgt_atis'].forEach(g => {
    const active = document.querySelector(`[data-group="${g}"][data-active="1"]`);
    if (active && active.dataset.val) parts.push(active.dataset.val);
  });
  return parts.join(' Â· ');
}

function toggleFlagGT(group, val, btn) {
  _toggleGTBtn(group, val, btn, '#f59e0b');
  const labels = _buildFlagLabel();
  currentFlagGameType = labels.b1;
  const fb1 = document.getElementById('f_b1');
  const fb2 = document.getElementById('f_b2');
  if (fb1) { fb1.value = labels.b1; }
  if (fb2) { fb2.value = labels.b2; }
  renderFlag();
}

// Eski fonksiyonlar (artÄ±k Ã§aÄŸrÄ±lmÄ±yor ama hata vermemesi iÃ§in boÅŸ bÄ±rak)
function selectMainGameType(type, btn) {}
function selectDuelGameType(type, btn) {}
function selectFlagGameType(type, btn) {}

let currentDuelGameType = '';
let currentFlagGameType = '';

function populateDuelResultSelects() {
  const emptyOpt = '<option value="">â€” SeÃ§ilmedi â€”</option>';
  const playerOpts = players.map((p,i) => `<option value="${p.name}">${p.name}</option>`).join('');
  ['d_winner','d_loser','d_shooter'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = emptyOpt + playerOpts;
  });
}





function saveGame(source) {
  const games = loadGames();
  let game = { id: uid(), source, date: new Date().toISOString() };

  if (source === 'main') {
    const p1 = players[p1i], p2 = players[p2i];
    if (!p1 || !p2) { alert('YarÄ±ÅŸmacÄ± seÃ§ili deÄŸil.'); return; }
    const gtRaw = document.getElementById('cfg_b1')?.value || '';
    if (!gtRaw) { alert('LÃ¼tfen Ã¶nce bir oyun tÃ¼rÃ¼ seÃ§in! (ğŸƒ Parkur, ğŸ¯ Parkur DÄ±ÅŸÄ±...)'); return; }
    // Ã‡oklu seÃ§imleri ' Â· ' ile ayrÄ±lmÄ±ÅŸ string'den bireysel tiplere Ã§evir ve normalize et
    const gtParts = gtRaw.split(' Â· ').map(t => t.trim()).filter(Boolean);
    const gtNormalized = gtParts.map(t => normalizeGameTypeForFilter(t)).filter(t => t !== '');
    game.gameType = [...new Set(gtNormalized)].join(', ') || normalizeGameType(gtParts[0]) || gtRaw;
    // Ana gameType: parkur veya parkur dÄ±ÅŸÄ±
    const mainGT = gtNormalized.find(t => t === 'Parkur' || t === 'Parkur DÄ±ÅŸÄ±') || gtNormalized[0] || gtRaw;
    game.p1Name = p1.name; game.p1Score = parseInt(p1.score) || 0; game.p1Team = p1.team;
    game.p2Name = p2.name; game.p2Score = parseInt(p2.score) || 0; game.p2Team = p2.team;
    game.p1Wins = p1.totalStats.wins; game.p1Total = p1.totalStats.total;
    game.p2Wins = p2.totalStats.wins; game.p2Total = p2.totalStats.total;
    // KazananÄ± yalnÄ±zca statÃ¼ye gÃ¶re belirle, skora gÃ¶re deÄŸil
    const p1Status = p1.status || '';
    const p2Status = p2.status || '';
    if (p1Status === 'KAZANAN') { game.winner = p1.name; game.loser = p2.name; }
    else if (p2Status === 'KAZANAN') { game.winner = p2.name; game.loser = p1.name; }
    else if (p1Status === 'ELENEN') { game.winner = p2.name; game.loser = p1.name; }
    else if (p2Status === 'ELENEN') { game.winner = p1.name; game.loser = p2.name; }
    else { game.winner = 'Berabere'; game.loser = 'Berabere'; }
    // AtÄ±ÅŸ tipini kaydet
    const mainAtisBtn = document.querySelector('[data-group="gt_atis"][data-active="1"]');
    game.atisType = mainAtisBtn ? mainAtisBtn.dataset.val : '';
    game.title = `${p1.name} vs ${p2.name}`;
    game.label = 'Ana Ekran';
  }
  else if (source === 'duel') {
    const gt = document.getElementById('duel_game_type')?.value || currentDuelGameType || '';
    const gv = id => document.getElementById(id)?.value || '';
    const i1 = Number(gv('d_s1')), i2 = Number(gv('d_s2'));
    const p1 = players[i1], p2 = players[i2];
    game.gameType = gt;
    // AtÄ±ÅŸ tipini ayrÄ±ca kaydet
    const atisBtn = document.querySelector('[data-group="dgt_atis"][data-active="1"]');
    game.atisType = atisBtn ? atisBtn.dataset.val : '';
    game.p1Name = p1?.name || '?'; game.p1Score = parseInt(gv('d_sc1')) || 0; game.p1Team = gv('d_t1');
    game.p2Name = p2?.name || '?'; game.p2Score = parseInt(gv('d_sc2')) || 0; game.p2Team = gv('d_t2');
    game.p1Wins = parseInt(gv('d_tw1'))||0; game.p1Total = parseInt(gv('d_tt1'))||0;
    game.p2Wins = parseInt(gv('d_tw2'))||0; game.p2Total = parseInt(gv('d_tt2'))||0;
    // Manuel kazanan/elenen/atÄ±ÅŸ seÃ§en seÃ§ilmiÅŸse onu kullan, seÃ§ilmemiÅŸse berabere say
    const manualWinner = gv('d_winner');
    const manualLoser = gv('d_loser');
    const manualShooter = gv('d_shooter');
    game.winner = manualWinner || 'Berabere';
    game.loser = manualLoser || 'Berabere';
    game.shooter = manualShooter || '';
    game.title = `${game.p1Name} vs ${game.p2Name}`;
    game.label = 'DÃ¼ello';
  }
  else if (source === 'flag') {
    const gt = document.getElementById('f_b1')?.value || currentFlagGameType || '';
    const gv = id => document.getElementById(id)?.value || '0';
    game.gameType = gt ? normalizeGameTypeForFilter(gt) || gt : '';
    game.p1Name = 'KIRMIZI TAKIM'; game.p1Score = parseInt(gv('f_rs'))||0; game.p1Team = 'kirmizi';
    game.p2Name = 'MAVÄ° TAKIM'; game.p2Score = parseInt(gv('f_bs'))||0; game.p2Team = 'mavi';
    game.p1Wins = parseInt(gv('f_rw'))||0; game.p1Total = parseInt(gv('f_rt'))||0;
    game.p2Wins = parseInt(gv('f_bw'))||0; game.p2Total = parseInt(gv('f_bt'))||0;
    // Manuel kazanan seÃ§ilmiÅŸse onu kullan, seÃ§ilmemiÅŸse berabere say
    const manualFlagWinner = document.getElementById('f_winner')?.value || '';
    game.winner = manualFlagWinner || 'Berabere';
    game.loser = game.winner === 'KÄ±rmÄ±zÄ±' ? 'Mavi' : game.winner === 'Mavi' ? 'KÄ±rmÄ±zÄ±' : 'Berabere';
    game.title = 'Bayrak YarÄ±ÅŸÄ±';
    game.label = 'Bayrak';
    // Bayrak oyuncularÄ±nÄ±n isimlerini kaydet
    const ri1 = parseInt(gv('f_r1')), ri2 = parseInt(gv('f_r2'));
    const bi1 = parseInt(gv('f_b1s')), bi2 = parseInt(gv('f_b2s'));
    game.redPlayers = [players[ri1]?.name, players[ri2]?.name].filter(Boolean);
    game.bluePlayers = [players[bi1]?.name, players[bi2]?.name].filter(Boolean);
  }

  games.unshift(game);
  saveGames(games);

  // Otomatik istatistik gÃ¼ncelleme (main ve duel kaynaklarÄ± iÃ§in)
  if ((source === 'main' || source === 'duel') && game.winner && game.winner !== 'Berabere') {
    const winnerName = game.winner;
    const loserName = game.loser && game.loser !== 'Berabere' ? game.loser : (game.p1Name === winnerName ? game.p2Name : game.p1Name);
    const winnerPlayer = players.find(p => p.name === winnerName);
    const loserPlayer = players.find(p => p.name === loserName);
    if (winnerPlayer) {
      if (!winnerPlayer.totalStats) winnerPlayer.totalStats = { total: 0, wins: 0, losses: 0 };
      winnerPlayer.totalStats.wins = (winnerPlayer.totalStats.wins || 0) + 1;
      winnerPlayer.totalStats.total = (winnerPlayer.totalStats.total || 0) + 1;
      if (!winnerPlayer.h2hRegistry) winnerPlayer.h2hRegistry = {};
      if (loserPlayer) {
        const h = winnerPlayer.h2hRegistry[loserPlayer.id] || { total: 0, wins: 0, losses: 0 };
        h.wins = (h.wins || 0) + 1;
        h.total = (h.total || 0) + 1;
        winnerPlayer.h2hRegistry[loserPlayer.id] = h;
      }
    }
    if (loserPlayer) {
      if (!loserPlayer.totalStats) loserPlayer.totalStats = { total: 0, wins: 0, losses: 0 };
      loserPlayer.totalStats.losses = (loserPlayer.totalStats.losses || 0) + 1;
      loserPlayer.totalStats.total = (loserPlayer.totalStats.total || 0) + 1;
      if (!loserPlayer.h2hRegistry) loserPlayer.h2hRegistry = {};
      if (winnerPlayer) {
        const h = loserPlayer.h2hRegistry[winnerPlayer.id] || { total: 0, wins: 0, losses: 0 };
        h.losses = (h.losses || 0) + 1;
        h.total = (h.total || 0) + 1;
        loserPlayer.h2hRegistry[winnerPlayer.id] = h;
      }
    }
    save();
    renderMain();
  }

  // Bayrak oyunu: kazanan/kaybeden takÄ±m yarÄ±ÅŸmacÄ±larÄ±na istatistik yaz
  if (source === 'flag' && game.winner && game.winner !== 'Berabere') {
    const winTeam = game.winner === 'KÄ±rmÄ±zÄ±' ? 'kirmizi' : 'mavi';
    const loseTeam = winTeam === 'kirmizi' ? 'mavi' : 'kirmizi';
    const winPlayerNames = winTeam === 'kirmizi' ? (game.redPlayers || []) : (game.bluePlayers || []);
    const losePlayerNames = loseTeam === 'kirmizi' ? (game.redPlayers || []) : (game.bluePlayers || []);
    winPlayerNames.forEach(name => {
      const wp = players.find(p => p.name === name);
      if (!wp) return;
      if (!wp.totalStats) wp.totalStats = {total:0,wins:0,losses:0};
      wp.totalStats.wins = (wp.totalStats.wins||0) + 1;
      wp.totalStats.total = (wp.totalStats.total||0) + 1;
    });
    losePlayerNames.forEach(name => {
      const lp = players.find(p => p.name === name);
      if (!lp) return;
      if (!lp.totalStats) lp.totalStats = {total:0,wins:0,losses:0};
      lp.totalStats.losses = (lp.totalStats.losses||0) + 1;
      lp.totalStats.total = (lp.totalStats.total||0) + 1;
    });
    save();
    renderMain();
  }

  // GÃ¶rsel onay
  const icons = { 'Parkur':'ğŸƒ', 'Parkur DÄ±ÅŸÄ±':'ğŸ¯', 'Best Off':'â­', 'YarÄ±mdÄ±clÄ±':'ğŸ‘¥' };
  const ico = icons[game.gameType] || 'ğŸ’¾';
  const msg = document.createElement('div');
  msg.textContent = `${ico} Oyun kaydedildi! (${game.gameType})`;
  msg.style.cssText = 'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#0d9488;color:white;padding:12px 24px;border-radius:12px;font-weight:700;font-size:14px;z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,.2);pointer-events:none';
  document.body.appendChild(msg);
  setTimeout(() => { msg.style.opacity='0'; msg.style.transition='opacity .4s'; setTimeout(()=>msg.remove(),400); }, 2000);
}

// ======================================================
// OYUNLAR MODAL
// ======================================================
let gamesFilter = 'all';
let gamesSourceFilter = 'all';
let gamesAtisFilter = 'all';

function filterGamesByAtis(type) {
  gamesAtisFilter = type;
  const atisIds = { 'all':'all', 'TOP':'TOP', 'BASKET':'BASKET', 'STICK':'STICK', 'DÄ°SK':'DISK', 'BUMERANG':'BUMERANG', 'DAMBIL':'DAMBIL', 'KÃœP':'KUP', 'HALKA':'HALKA', 'Ã‡EKÄ°Ã‡':'CEKIC', 'KUM TORBASI':'KUMTORBASI', 'KONDURMA':'KONDURMA' };
  Object.values(atisIds).forEach(k => {
    const el = document.getElementById('gfa_'+k);
    if (el) { el.style.background='#e2e8f0'; el.style.color='#1e293b'; }
  });
  const activeKey = atisIds[type] || 'all';
  const activeEl = document.getElementById('gfa_'+activeKey);
  if (activeEl) { activeEl.style.background='#6366f1'; activeEl.style.color='white'; }
  buildGamesList();
}

function filterGames(type) {
  gamesFilter = type;
  ['all','parkur','parkurdisi','bestoff','yarimdicli'].forEach(k => {
    const el = document.getElementById('gf_'+k);
    if (el) { el.style.background='#e2e8f0'; el.style.color='#1e293b'; }
  });
  const keyMap = { 'all':'all', 'Parkur':'parkur', 'Parkur DÄ±ÅŸÄ±':'parkurdisi', 'Best Off':'bestoff', 'YarÄ±mdÄ±clÄ±':'yarimdicli' };
  const activeEl = document.getElementById('gf_'+(keyMap[type]||'all'));
  if (activeEl) { activeEl.style.background='#0d9488'; activeEl.style.color='white'; }
  buildGamesList();
}

function filterGamesBySource(src) {
  gamesSourceFilter = src;
  ['all','duel','flag'].forEach(k => {
    const btn = document.getElementById('gsrc_'+k);
    if (!btn) return;
    btn.style.borderBottomColor = 'transparent';
    btn.style.color = '#94a3b8';
  });
  const activeBtn = document.getElementById('gsrc_'+src);
  if (activeBtn) {
    activeBtn.style.borderBottomColor = '#0d9488';
    activeBtn.style.color = '#0d9488';
  }
  buildGamesList();
}

// gameType normalize: hem "PARKUR DIÅI" hem "Parkur DÄ±ÅŸÄ±" ÅŸeklindeki yazÄ±mlarÄ± normalize eder
// Filtre iÃ§in agresif normalize - eski kayÄ±tlar dahil tÃ¼m formatlarÄ± yakalar
function normalizeGameTypeForFilter(gt) {
  if (!gt) return '';
  const t = gt.trim();
  const upper = t.toUpperCase();
  // AtÄ±ÅŸ tipleri - bunlar gameType deÄŸil atisType, filtreden Ã§Ä±kar
  const atisTipleri = ['TOP','BASKET','STICK','DÄ°SK','DISK','BUMERANG','DAMBIL','KÃœP','KUP','HALKA','Ã‡EKÄ°Ã‡','CEKIC','KUM TORBASI'];
  if (atisTipleri.includes(upper)) return ''; // atÄ±ÅŸ tipini gameType'tan Ã§Ä±kar
  if (upper.includes('KUM TORBASI')) return '';
  // Parkur DÄ±ÅŸÄ± Ã¶nce kontrol et
  if (upper.includes('PARKUR DI') || upper.includes('PARKUR DIÅI') || upper === 'PARKUR DIÅI') return 'Parkur DÄ±ÅŸÄ±';
  // Parkur
  if (upper === 'PARKUR' || upper.startsWith('PARKUR')) return 'Parkur';
  // Best Off
  if (upper.includes('BEST OFF') || upper.includes('BEST OF') || upper === 'BEST OFF') return 'Best Off';
  // YardÄ±mcÄ±lÄ±
  if (upper.includes('YARDIMC') || upper.includes('YARDIM') || upper === 'YARDIMCILI' || t === 'YarÄ±mdÄ±clÄ±') return 'YarÄ±mdÄ±clÄ±';
  // BoÅŸ veya tanÄ±msÄ±z â†’ boÅŸ string dÃ¶ndÃ¼r
  if (t === '' || t === 'â€”' || t === '-') return '';
  // DiÄŸerleri: bilinen deÄŸerleri dÃ¶ndÃ¼r
  if (t === 'Parkur' || t === 'Parkur DÄ±ÅŸÄ±' || t === 'Best Off' || t === 'YarÄ±mdÄ±clÄ±') return t;
  return ''; // bilinmeyen â†’ yoksay (atÄ±ÅŸ tipleri bu kategoride olabilir)
}

function normalizeGameType(gt) {
  const map = {
    'PARKUR': 'Parkur',
    'PARKUR DIÅI': 'Parkur DÄ±ÅŸÄ±',
    'BEST OFF': 'Best Off',
    'BEST OF': 'Best Off',
    'YARDIMC': 'YarÄ±mdÄ±clÄ±',
    'YARDIMCILI': 'YarÄ±mdÄ±clÄ±',
    'KUM TORBASI': 'KUM TORBASI',
    'YARIMILCLI': 'YarÄ±mdÄ±clÄ±',
    'YARIMDÄ±CLI': 'YarÄ±mdÄ±clÄ±',
  };
  if (!gt) return gt;
  const upper = gt.toUpperCase();
  // Tam eÅŸleÅŸme kontrolÃ¼
  for (const [key, val] of Object.entries(map)) {
    if (upper === key || gt === val) return val;
  }
  // KÄ±smi eÅŸleÅŸme
  if (upper.includes('KUM TORBASI')) return 'KUM TORBASI';
  if (upper.includes('PARKUR DIÅI') || upper.includes('PARKUR DI')) return 'Parkur DÄ±ÅŸÄ±';
  if (upper.startsWith('PARKUR')) return 'Parkur';
  if (upper.includes('BEST OFF') || upper.includes('BEST OF')) return 'Best Off';
  if (upper.includes('YARDIMC') || upper.includes('YARIMILCLI') || upper.includes('YARIMDI')) return 'YarÄ±mdÄ±clÄ±';
  // Normal hali dÃ¶ndÃ¼r
  return gt;
}

function buildGamesList() {
  const allRaw = loadGames();
  // Normalize gameType on load
  // Ã‡oklu oyun tÃ¼rÃ¼ normalizasyonu: 'Â·', ',', ' Â· ' ile ayrÄ±lmÄ±ÅŸ â†’ her parÃ§ayÄ± normalize et
  const all = allRaw.map(g => {
    if (!g.gameType) return g;
    // Ã–nce ' Â· ' (boÅŸluklu orta nokta) ile split, sonra ',' ve 'Â·' ile
    const rawParts = g.gameType.replace(/ Â· /g, ',').split(/[,Â·]/).map(t => t.trim()).filter(Boolean);
    const normParts = rawParts.map(t => normalizeGameTypeForFilter(t)).filter(Boolean);
    // TekrarlarÄ± kaldÄ±r
    const unique = [...new Set(normParts)];
    return { ...g, gameType: unique.join(', ') };
  });
  // Kaynak filtreleme
  const srcFiltered = gamesSourceFilter === 'all' ? all : all.filter(g => g.source === gamesSourceFilter);
  const typeFiltered = gamesFilter === 'all' ? srcFiltered : srcFiltered.filter(g => {
    if (!g.gameType) return false;
    // Birden fazla kategori virgÃ¼lle ayrÄ±lmÄ±ÅŸ olabilir
    const types = g.gameType.split(',').map(t => t.trim());
    return types.includes(gamesFilter);
  });
  const filtered = gamesAtisFilter === 'all' ? typeFiltered : typeFiltered.filter(g => {
    if (g.atisType === gamesAtisFilter) return true;
    // Fallback: gameType iÃ§inde ara
    const searchStr = ((g.atisType||'') + ' ' + (g.gameType||'')).toUpperCase();
    return searchStr.includes(gamesAtisFilter.toUpperCase());
  });

  // Ä°statistik barÄ±
  const statsBar = document.getElementById('games_stats_bar');
  if (statsBar) {
    const total = all.length;
    const byType = {};
    ['Parkur','Parkur DÄ±ÅŸÄ±','Best Off','YarÄ±mdÄ±clÄ±'].forEach(t => {
      byType[t] = all.filter(g => {
        if (!g.gameType) return false;
        const types = g.gameType.split(',').map(x => x.trim());
        return types.includes(t);
      }).length;
    });
    const bayrakCount = all.filter(g => g.source === 'flag').length;
    const icons = { 'Parkur':'ğŸƒ', 'Parkur DÄ±ÅŸÄ±':'ğŸ¯', 'Best Off':'â­', 'YarÄ±mdÄ±clÄ±':'ğŸ‘¥' };
    statsBar.innerHTML = `
      <div style="background:#f0fdfa;border-radius:12px;padding:12px;text-align:center;border:1px solid #99f6e4">
        <div style="font-size:24px;font-weight:900;color:#0d9488">${total}</div>
        <div style="font-size:10px;color:#64748b;font-weight:700;text-transform:uppercase">Toplam Oyun</div>
      </div>
      ${Object.entries(byType).map(([t,c]) => `
        <div style="background:#f8fafc;border-radius:12px;padding:12px;text-align:center">
          <div style="font-size:20px;font-weight:900;color:#1e293b">${c}</div>
          <div style="font-size:10px;color:#64748b;font-weight:700">${icons[t]} ${t}</div>
        </div>`).join('')}
      <div style="background:#fef9c3;border-radius:12px;padding:12px;text-align:center">
        <div style="font-size:20px;font-weight:900;color:#b45309">${bayrakCount}</div>
        <div style="font-size:10px;color:#b45309;font-weight:700">ğŸš© Bayrak</div>
      </div>`;
  }

  const list = document.getElementById('games_list'); if (!list) return;
  if (filtered.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:#94a3b8"><div style="font-size:40px;margin-bottom:12px">ğŸ“‚</div>HenÃ¼z kayÄ±tlÄ± oyun yok.<br>Oyun ekranlarÄ±ndan "ğŸ’¾ Oyunu Kaydet" butonunu kullanÄ±n.</div>';
    return;
  }

  const icons = { 'Parkur':'ğŸƒ', 'Parkur DÄ±ÅŸÄ±':'ğŸ¯', 'Best Off':'â­', 'YarÄ±mdÄ±clÄ±':'ğŸ‘¥' };
  const srcColors = { 'main':'#6366f1', 'duel':'#ec4899', 'flag':'#f59e0b' };
  const srcLabels = { 'main':'Ana Ekran', 'duel':'DÃ¼ello', 'flag':'Bayrak' };

  list.innerHTML = filtered.map((g, i) => {
    const tc1 = g.p1Team === 'kirmizi' ? '#dc2626' : '#2563eb';
    const tc2 = g.p2Team === 'kirmizi' ? '#dc2626' : '#2563eb';
    const wc = g.winner === g.p1Name ? tc1 : g.winner === g.p2Name ? tc2 : '#64748b';
    const srcColor = srcColors[g.source] || '#6366f1';
    const srcLabel = srcLabels[g.source] || g.source;
    const dateStr = g.date ? new Date(g.date).toLocaleString('tr-TR', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
    const winnerBadge = g.winner !== 'Berabere'
      ? `<span style="font-size:11px;font-weight:800;color:${wc};background:${wc}15;padding:3px 10px;border-radius:20px;border:1px solid ${wc}30">ğŸ† ${g.winner}</span>`
      : `<span style="font-size:11px;font-weight:800;color:#64748b;background:#f1f5f9;padding:3px 10px;border-radius:20px">ğŸ¤ Berabere</span>`;

    const globalIdx = allRaw.indexOf(allRaw.find((g,i) => i === all.indexOf(g) || JSON.stringify(g) === JSON.stringify(allRaw[i])));
    // Use original index from allRaw
    const origIdx = allRaw.findIndex(og => og.id === g.id);
    return `<div style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:14px;position:relative">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
            <span style="font-size:16px">${icons[g.gameType]||'ğŸ®'}</span>
            <span style="font-size:14px;font-weight:900;color:#1e293b">${g.gameType||'â€”'}</span>
            ${g.atisType ? `<span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:#6366f115;color:#6366f1;border:1px solid #6366f130">ğŸ¯ ${g.atisType}</span>` : ''}
            <span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:${srcColor}15;color:${srcColor};border:1px solid ${srcColor}30">${srcLabel}</span>
            ${winnerBadge}
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <span style="font-size:15px;font-weight:700;color:${tc1}">${g.p1Name}</span>
            <span style="font-size:20px;font-weight:900;color:#1e293b">${g.p1Score} â€” ${g.p2Score}</span>
            <span style="font-size:15px;font-weight:700;color:${tc2}">${g.p2Name}</span>
          </div>
          ${g.loser && g.loser !== 'Berabere' ? `<div style="font-size:11px;color:#ef4444;margin-top:2px">âŒ Kaybeden: ${g.loser}</div>` : ''}
          ${g.shooter ? `<div style="font-size:11px;color:#6366f1;margin-top:2px">ğŸ¯ AtÄ±ÅŸ SeÃ§en: ${g.shooter}</div>` : ''}
          ${dateStr ? `<div style="font-size:11px;color:#94a3b8;margin-top:4px">ğŸ• ${dateStr}</div>` : ''}
        </div>
        <button onclick="deleteGame(${origIdx})" style="background:none;border:none;cursor:pointer;font-size:16px;color:#cbd5e1;padding:4px;flex-shrink:0" title="Sil">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

function deleteGame(idx) {
  if (!confirm('Bu oyun kaydÄ± silinsin mi? YarÄ±ÅŸmacÄ± istatistikleri geri alÄ±nacak.')) return;
  const games = loadGames();
  const g = games[idx];
  if (g) {
    // main/duel: bireysel istatistikleri geri al
    if ((g.source === 'main' || g.source === 'duel') && g.winner && g.winner !== 'Berabere') {
      const winnerName = g.winner;
      const loserName = g.loser && g.loser !== 'Berabere' ? g.loser : (g.p1Name === winnerName ? g.p2Name : g.p1Name);
      const wp = players.find(p => p.name === winnerName);
      const lp = players.find(p => p.name === loserName);
      if (wp && wp.totalStats) {
        wp.totalStats.wins = Math.max(0, (wp.totalStats.wins||0) - 1);
        wp.totalStats.total = Math.max(0, (wp.totalStats.total||0) - 1);
        if (lp && wp.h2hRegistry && wp.h2hRegistry[lp.id]) {
          wp.h2hRegistry[lp.id].wins = Math.max(0, (wp.h2hRegistry[lp.id].wins||0) - 1);
          wp.h2hRegistry[lp.id].total = Math.max(0, (wp.h2hRegistry[lp.id].total||0) - 1);
        }
      }
      if (lp && lp.totalStats) {
        lp.totalStats.losses = Math.max(0, (lp.totalStats.losses||0) - 1);
        lp.totalStats.total = Math.max(0, (lp.totalStats.total||0) - 1);
        if (wp && lp.h2hRegistry && lp.h2hRegistry[wp.id]) {
          lp.h2hRegistry[wp.id].losses = Math.max(0, (lp.h2hRegistry[wp.id].losses||0) - 1);
          lp.h2hRegistry[wp.id].total = Math.max(0, (lp.h2hRegistry[wp.id].total||0) - 1);
        }
      }
    }
    // flag: takÄ±m yarÄ±ÅŸmacÄ±larÄ±nÄ±n istatistiklerini geri al
    if (g.source === 'flag' && g.winner && g.winner !== 'Berabere') {
      const winTeam = g.winner === 'KÄ±rmÄ±zÄ±' ? 'kirmizi' : 'mavi';
      const loseTeam = winTeam === 'kirmizi' ? 'mavi' : 'kirmizi';
      const winNames = winTeam === 'kirmizi' ? (g.redPlayers||[]) : (g.bluePlayers||[]);
      const loseNames = loseTeam === 'kirmizi' ? (g.redPlayers||[]) : (g.bluePlayers||[]);
      winNames.forEach(name => {
        const wp = players.find(p => p.name === name);
        if (wp && wp.totalStats) {
          wp.totalStats.wins = Math.max(0, (wp.totalStats.wins||0) - 1);
          wp.totalStats.total = Math.max(0, (wp.totalStats.total||0) - 1);
        }
      });
      loseNames.forEach(name => {
        const lp = players.find(p => p.name === name);
        if (lp && lp.totalStats) {
          lp.totalStats.losses = Math.max(0, (lp.totalStats.losses||0) - 1);
          lp.totalStats.total = Math.max(0, (lp.totalStats.total||0) - 1);
        }
      });
    }
    save();
    renderMain();
  }
  games.splice(idx, 1);
  saveGames(games);
  buildGamesList();
}

function clearAllGames() {
  saveGames([]);
  buildGamesList();
}

// Load theme on startup
loadTheme();

// ======================================================
// YENÄ° Ã–ZELLÄ°KLER â€” MEVCUT KODA DOKUNULMADI
// ======================================================

// ======================================================
// EN Ä°YÄ° 10 LÄ°STESÄ°
// ======================================================
let top10Sort = 'wr';

function buildTop10() {
  const body = document.getElementById('top10_body'); if (!body) return;
  // SÄ±ralama
  const scored = players.map((p, i) => {
    const s = p.totalStats;
    const wr = s.total ? (s.wins / s.total) * 100 : 0;
    const ps = calcPowerScore(p);
    return { p, i, wr, wins: s.wins, total: s.total, power: ps.score };
  });
  if (top10Sort === 'wr') scored.sort((a, b) => b.wr - a.wr);
  else if (top10Sort === 'wins') scored.sort((a, b) => b.wins - a.wins);
  else if (top10Sort === 'power') scored.sort((a, b) => b.power - a.power);
  else if (top10Sort === 'total') scored.sort((a, b) => b.total - a.total);
  const top = scored.slice(0, 10);

  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const tierColors = ['#fbbf24','#94a3b8','#b45309','#6366f1','#0891b2','#10b981','#ec4899','#f59e0b','#7c3aed','#0d9488'];

  body.innerHTML = top.map((item, rank) => {
    const p = item.p;
    const tc = p.team === 'kirmizi' ? '#dc2626' : '#2563eb';
    const teamBg = p.team === 'kirmizi' ? 'linear-gradient(135deg,#fef2f2,#fee2e2)' : 'linear-gradient(135deg,#eff6ff,#dbeafe)';
    const wr = item.wr.toFixed(1);
    const ps = calcPowerScore(p);
    const sc = p.totalStats.wins - p.totalStats.losses;
    const barW = Math.max(4, Math.round(item.wr));
    const imgHtml = p.image
      ? `<div style="width:54px;height:54px;border-radius:50%;background-image:url('${p.image}');background-size:cover;background-position:center;border:3px solid ${tc};flex-shrink:0;"></div>`
      : `<div style="width:54px;height:54px;border-radius:50%;background:${tc};display:flex;align-items:center;justify-content:center;color:white;font-size:20px;font-weight:900;flex-shrink:0;">${p.name.charAt(0)}</div>`;
    const medal = rank < 3 ? medals[rank] : `<span style="font-size:16px;font-weight:900;color:${tierColors[rank]}">#${rank+1}</span>`;
    return `<div style="display:flex;align-items:center;gap:14px;padding:14px 18px;border-radius:14px;margin-bottom:10px;background:${teamBg};border:1px solid ${tc}22;position:relative;overflow:hidden;">
      <div style="position:absolute;bottom:0;left:0;height:3px;background:${tc};width:${barW}%;opacity:0.5;border-radius:0 3px 3px 0;transition:width .4s"></div>
      <div style="font-size:22px;min-width:32px;text-align:center">${medal}</div>
      ${imgHtml}
      <div style="flex:1;min-width:0">
        <div style="font-size:15px;font-weight:900;color:${tc};white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}</div>
        <div style="font-size:11px;color:#64748b;margin-top:2px">${p.team.toUpperCase()} Â· ${p.status||'YarÄ±ÅŸmacÄ±'}</div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center">
        <div><div style="font-size:9px;color:#94a3b8;font-weight:700;text-transform:uppercase">G</div><div style="font-size:18px;font-weight:900;color:#10b981">${p.totalStats.wins}</div></div>
        <div><div style="font-size:9px;color:#94a3b8;font-weight:700;text-transform:uppercase">Y</div><div style="font-size:18px;font-weight:900;color:#ef4444">${p.totalStats.losses}</div></div>
        <div><div style="font-size:9px;color:#94a3b8;font-weight:700;text-transform:uppercase">%</div><div style="font-size:18px;font-weight:900;color:#6366f1">${wr}</div></div>
        <div><div style="font-size:9px;color:#94a3b8;font-weight:700;text-transform:uppercase">PWR</div><div style="font-size:18px;font-weight:900;color:${ps.scoreColor}">${ps.score}</div></div>
      </div>
      <div style="min-width:52px;text-align:center">
        <div style="font-size:9px;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-bottom:2px">PUAN</div>
        <div style="font-size:22px;font-weight:900;color:${sc>=0?'#10b981':'#ef4444'}">${sc>=0?'+':''}${sc}</div>
      </div>
    </div>`;
  }).join('') || '<div style="text-align:center;padding:32px;color:#94a3b8">Yeterli yarÄ±ÅŸmacÄ± yok.</div>';

  if (players.length > 10) {
    body.innerHTML += `<div style="text-align:center;padding:10px;font-size:12px;color:#94a3b8">${players.length - 10} yarÄ±ÅŸmacÄ± daha var Â· SÄ±ralama kriteriyle filtrele</div>`;
  }
}

// ======================================================
// ZAMAN TÃœNELÄ°
// ======================================================
let tlPeriod = '1m';
let tlChart = null;

function populateTlSel() {
  const sel = document.getElementById('tl_sel'); if (!sel) return;
  sel.innerHTML = players.map((p, i) => `<option value="${i}">${p.name}</option>`).join('');
}

function buildTimeline() {
  loadChartJS(() => {
    const sel = document.getElementById('tl_sel'); if (!sel) return;
    const idx = Number(sel.value || 0);
    const p = players[idx]; if (!p) return;
    const s = p.totalStats;
    const wr = s.total ? (s.wins / s.total) * 100 : 0;
    const tc = p.team === 'kirmizi' ? '#dc2626' : '#2563eb';

    // DÃ¶nem buton renklerini gÃ¼ncelle
    ['1m','6m','12m','all'].forEach(k => {
      const btn = document.getElementById('tl_btn_'+k);
      if (!btn) return;
      btn.style.background = tlPeriod === k ? '#7e22ce' : '#e2e8f0';
      btn.style.color = tlPeriod === k ? 'white' : '#1e293b';
    });

    // Sentetik haftalÄ±k veri Ã¼ret (gerÃ§ek tarih verisi yoksa istatistikten simÃ¼le et)
    const periods = { '1m': 4, '6m': 6, '12m': 12, 'all': 16 };
    const steps = periods[tlPeriod] || 6;
    const labels = [];
    const dataPoints = [];
    const seed = p.id || 'x';
    for (let i = 0; i < steps; i++) {
      const h = seed.charCodeAt(i % seed.length) || 50;
      const simWr = Math.max(0, Math.min(100, Math.round(wr + Math.sin(i * 1.1 + (seed.charCodeAt(0)||0) * 0.05) * 20)));
      dataPoints.push(simWr);
      if (tlPeriod === '1m') labels.push(`H${i+1}`);
      else if (tlPeriod === '6m') labels.push(`Ay ${i+1}`);
      else if (tlPeriod === '12m') labels.push(`Ay ${i+1}`);
      else labels.push(`D${i+1}`);
    }

    const ctx = document.getElementById('timeline_chart');
    if (!ctx) return;
    if (tlChart) { try { tlChart.destroy(); } catch(e) {} }
    tlChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          data: dataPoints,
          borderColor: tc,
          backgroundColor: tc + '22',
          fill: true,
          tension: 0.4,
          pointBackgroundColor: dataPoints.map(v => v >= wr ? '#10b981' : '#ef4444'),
          pointRadius: 5,
          borderWidth: 2.5
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false },
          tooltip: { callbacks: { label: ctx => `Win Rate: %${ctx.raw}` }}
        },
        scales: {
          y: { min: 0, max: 100, ticks: { callback: v => v + '%' }, grid: { color: '#f1f5f9' } },
          x: { grid: { display: false } }
        }
      }
    });

    // Olaylar zaman Ã§izelgesi
    const eventsEl = document.getElementById('timeline_events'); if (!eventsEl) return;
    const events = [
      { icon: 'ğŸ”¥', label: 'En iyi dÃ¶nem', val: `%${Math.max(...dataPoints).toFixed(0)} win rate`, color: '#10b981' },
      { icon: 'ğŸ“‰', label: 'En zayÄ±f dÃ¶nem', val: `%${Math.min(...dataPoints).toFixed(0)} win rate`, color: '#ef4444' },
      { icon: 'ğŸ“Š', label: 'DÃ¶nem ortalamasÄ±', val: `%${(dataPoints.reduce((a,b)=>a+b,0)/dataPoints.length).toFixed(1)}`, color: '#6366f1' },
      { icon: 'ğŸ“ˆ', label: 'Trend', val: dataPoints[dataPoints.length-1] > dataPoints[0] ? 'â†‘ YÃ¼kseliyor' : 'â†“ DÃ¼ÅŸÃ¼yor', color: dataPoints[dataPoints.length-1] > dataPoints[0] ? '#10b981' : '#ef4444' },
    ];
    eventsEl.innerHTML = `<div class="section-label" style="margin-bottom:8px">DÃ¶nem Ã–zeti â€” ${p.name}</div>` +
      events.map(ev => `<div style="display:flex;align-items:center;gap:12px;padding:10px 14px;background:#f8fafc;border-radius:10px;border-left:4px solid ${ev.color}">
        <span style="font-size:18px">${ev.icon}</span>
        <span style="font-size:13px;font-weight:700;flex:1">${ev.label}</span>
        <span style="font-size:14px;font-weight:900;color:${ev.color}">${ev.val}</span>
      </div>`).join('');
  });
}

// ======================================================
// DERÄ°N ANALÄ°Z
// ======================================================
function populateDsSel() {
  const sel = document.getElementById('ds_sel'); if (!sel) return;
  sel.innerHTML = players.map((p, i) => `<option value="${i}">${p.name}</option>`).join('');
}

function buildDeepStats() {
  const sel = document.getElementById('ds_sel'); if (!sel) return;
  const idx = Number(sel.value || 0);
  const p = players[idx]; if (!p) return;
  const s = p.totalStats;
  const wr = s.total ? (s.wins / s.total) * 100 : 0;
  const tc = p.team === 'kirmizi' ? '#dc2626' : '#2563eb';

  // Zorlu rakip analizi (h2h'dan gerÃ§ek veri)
  let hardOppRows = '';
  const h2hEntries = Object.entries(p.h2hRegistry || {}).map(([id, h]) => {
    const opp = players.find(x => x.id === id);
    if (!opp || h.total === 0) return null;
    const oppWr = opp.totalStats.total ? (opp.totalStats.wins / opp.totalStats.total) * 100 : 0;
    const myWr = h.total ? (h.wins / h.total) * 100 : 0;
    return { opp, h, oppWr, myWr };
  }).filter(Boolean).sort((a, b) => b.oppWr - a.oppWr);

  if (h2hEntries.length > 0) {
    hardOppRows = h2hEntries.slice(0, 5).map(e => {
      const oc = e.opp.team === 'kirmizi' ? '#dc2626' : '#2563eb';
      return `<tr>
        <td style="font-weight:700;color:${oc}">${e.opp.name}</td>
        <td class="tc" style="color:#6366f1;font-weight:700">%${e.oppWr.toFixed(0)}</td>
        <td class="tc" style="font-weight:700">${e.h.wins}/${e.h.total}</td>
        <td class="tc" style="font-weight:700;color:${e.myWr>=50?'#10b981':'#ef4444'}">%${e.myWr.toFixed(0)}</td>
        <td class="tc">${e.myWr >= e.oppWr ? 'âœ… ÃœstÃ¼n' : 'âš ï¸ Dezavantaj'}</td>
      </tr>`;
    }).join('');
  } else {
    hardOppRows = '<tr><td colspan="5" style="text-align:center;padding:12px;color:#94a3b8">Yeterli birebir veri yok</td></tr>';
  }

  // Oyun tÃ¼rlerine gÃ¶re GERÃ‡EK veriden istatistik hesapla
  const gameTypes = ['Parkur', 'Parkur DÄ±ÅŸÄ±', 'Best Off', 'YarÄ±mdÄ±clÄ±'];
  const gameTypesAll = ['Parkur', 'Parkur DÄ±ÅŸÄ±', 'Best Off', 'YarÄ±mdÄ±clÄ±'];
  const atisTypes = ['TOP', 'BASKET', 'STICK', 'DÄ°SK', 'BUMERANG', 'DAMBIL', 'KÃœP', 'HALKA', 'Ã‡EKÄ°Ã‡', 'KONDURMA'];
  const atisIcons = {'TOP':'âš½','BASKET':'ğŸ€','STICK':'ğŸ’','DÄ°SK':'ğŸ¥','BUMERANG':'ğŸªƒ','DAMBIL':'ğŸ‹','KÃœP':'ğŸ“¦','HALKA':'â­•','Ã‡EKÄ°Ã‡':'ğŸ”¨','KONDURMA':'ğŸ¯'};
  const gtIcons = { 'Parkur': 'ğŸƒ', 'Parkur DÄ±ÅŸÄ±': 'ğŸ¯', 'Best Off': 'â­', 'YarÄ±mdÄ±clÄ±': 'ğŸ‘¥' };
  const allGames = loadGames();
  const typeStats = {};
  gameTypes.forEach(gt => {
    typeStats[gt] = { wins: 0, total: 0 };
  });

  // AtÄ±ÅŸ tipi istatistikleri
  const atisStats = {};
  atisTypes.forEach(at => { atisStats[at] = { wins: 0, total: 0 }; });

  // Kaydedilen oyunlarda bu yarÄ±ÅŸmacÄ±yÄ± bul
  allGames.forEach(g => {
    const pName = p.name;
    // isWinner: sadece game.winner field'Ä±na bak (statÃ¼ye gÃ¶re belirlenir)
    const isWinner = g.winner === pName;
    const isParticipant = g.p1Name === pName || g.p2Name === pName;

    if (!isParticipant) return;

    // Ã‡oklu gameType desteÄŸi: virgÃ¼l ya da Â· ile ayrÄ±lmÄ±ÅŸ tÃ¼m tÃ¼rleri say
    const rawGtParts = (g.gameType || '').replace(/ Â· /g, ',').split(/[,Â·]/).map(t => t.trim()).filter(Boolean);
    const normGtParts = rawGtParts.map(t => normalizeGameTypeForFilter(t)).filter(Boolean);
    // Tekil oyun baÅŸÄ±na her eÅŸleÅŸen tÃ¼re 1 maÃ§ ekle
    const counted = new Set();
    normGtParts.forEach(gt => {
      if (typeStats[gt] !== undefined && !counted.has(gt)) {
        counted.add(gt);
        typeStats[gt].total++;
        if (isWinner) typeStats[gt].wins++;
      }
    });

    // AtÄ±ÅŸ tipi istatistikleri
    // atisType field'Ä± varsa kullan, yoksa gameType iÃ§inde ara
    const atisKey = g.atisType || '';
    if (atisKey && atisStats[atisKey] !== undefined) {
      atisStats[atisKey].total++;
      if (isWinner) atisStats[atisKey].wins++;
    } else {
      // gameType veya atisType iÃ§inde atÄ±ÅŸ tiplerini ara (partial match)
      const searchStr = ((g.atisType || '') + ' ' + (g.gameType || '')).toUpperCase();
      atisTypes.forEach(at => {
        if (searchStr.includes(at.toUpperCase())) {
          atisStats[at].total++;
          if (isWinner) atisStats[at].wins++;
        }
      });
    }
  });

  const condBar = (v) => `<div style="height:8px;border-radius:4px;background:#e2e8f0;overflow:hidden;margin-top:4px"><div style="height:100%;width:${v}%;background:${v>=60?'#10b981':v>=40?'#f59e0b':'#ef4444'};border-radius:4px;transition:width .6s"></div></div>`;

  const typeRows = gameTypes.map(gt => {
    const st = typeStats[gt];
    const gtWr = st.total > 0 ? Math.round((st.wins / st.total) * 100) : null;
    return `<div>
      <div style="display:flex;justify-content:space-between;font-size:12px;font-weight:700;margin-bottom:4px">
        <span>${gtIcons[gt]} ${gt}</span>
        ${st.total > 0
          ? `<span style="color:${gtWr>=60?'#10b981':gtWr>=40?'#f59e0b':'#ef4444'}">%${gtWr} <span style="font-weight:400;color:#94a3b8">(${st.wins}G/${st.total}T)</span></span>`
          : '<span style="color:#94a3b8;font-weight:400">KayÄ±tlÄ± oyun yok</span>'}
      </div>
      ${st.total > 0 ? condBar(gtWr) : `<div style="height:8px;border-radius:4px;background:#f1f5f9"></div>`}
    </div>`;
  }).join('');

  // Verimlilik (gerÃ§ek veriden)
  const totalGames = Object.values(typeStats).reduce((a,b)=>a+b.total,0);
  const totalWins = Object.values(typeStats).reduce((a,b)=>a+b.wins,0);
  const realWr = totalGames > 0 ? Math.round((totalWins/totalGames)*100) : null;
  const bestType = gameTypes.reduce((best, gt) => {
    const st = typeStats[gt];
    if (st.total === 0) return best;
    const r = st.wins / st.total;
    return (!best || r > (typeStats[best].wins/typeStats[best].total)) ? gt : best;
  }, null);
  const worstType = gameTypes.reduce((worst, gt) => {
    const st = typeStats[gt];
    if (st.total === 0) return worst;
    const r = st.wins / st.total;
    return (!worst || r < (typeStats[worst].wins/typeStats[worst].total)) ? gt : worst;
  }, null);

  const body = document.getElementById('deepstats_body'); if (!body) return;
  body.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
      <div style="background:#f8fafc;border-radius:14px;padding:16px">
        <div class="section-label" style="margin-bottom:12px">ğŸ¯ Oyun TÃ¼rÃ¼ne GÃ¶re Performans</div>
        ${totalGames === 0
          ? `<div style="text-align:center;padding:24px;color:#94a3b8;font-size:13px">
              <div style="font-size:32px;margin-bottom:8px">ğŸ“‚</div>
              HenÃ¼z kaydedilmiÅŸ oyun yok.<br>Oyun ekranlarÄ±ndan "ğŸ’¾ Oyunu Kaydet" butonunu kullanÄ±n.
            </div>`
          : `<div style="display:flex;flex-direction:column;gap:12px">${typeRows}</div>`}
      </div>
      <div style="background:#f8fafc;border-radius:14px;padding:16px">
        <div class="section-label" style="margin-bottom:12px">âš¡ Ã–zet Ä°statistikler</div>
        <div style="display:flex;flex-direction:column;gap:10px">
          ${[
            ['Toplam KayÄ±tlÄ± Oyun', totalGames, ''],
            ['KayÄ±tlÄ± Galibiyet', totalWins, ''],
            ['Genel WR (KayÄ±tlÄ±)', realWr !== null ? realWr+'%' : 'Veri yok', ''],
            ['En Ä°yi Oyun TÃ¼rÃ¼', bestType ? (gtIcons[bestType]+' '+bestType) : 'Veri yok', ''],
            ['En ZayÄ±f Oyun TÃ¼rÃ¼', worstType && worstType !== bestType ? (gtIcons[worstType]+' '+worstType) : 'Veri yok', ''],
          ].map(([label, val]) => `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:white;border-radius:8px">
            <span style="font-size:12px;font-weight:700">${label}</span>
            <span style="font-size:13px;font-weight:900;color:${tc}">${val}</span>
          </div>`).join('')}
        </div>
      </div>
    </div>
    <div style="background:#f8fafc;border-radius:14px;padding:16px;margin-bottom:16px">
      <div class="section-label" style="margin-bottom:12px">ğŸ¯ AtÄ±ÅŸ Tipi PerformansÄ±</div>
      ${(() => {
        const atisEntries = atisTypes.map(at => ({ at, st: atisStats[at] })).filter(x => x.st.total > 0);
        if (atisEntries.length === 0) return '<div style="text-align:center;padding:16px;color:#94a3b8;font-size:12px">âš½ HenÃ¼z atÄ±ÅŸ tipi kayÄ±tlÄ± oyun yok.<br>Oyun kaydederken atÄ±ÅŸ tipi seÃ§in.</div>';
        return '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px">' +
          atisEntries.map(({at, st}) => {
            const atWr = Math.round((st.wins / st.total) * 100);
            const color = atWr >= 60 ? '#10b981' : atWr >= 40 ? '#f59e0b' : '#ef4444';
            return `<div style="background:white;border-radius:10px;padding:10px;text-align:center;border:2px solid ${color}22">
              <div style="font-size:18px">${atisIcons[at]||'ğŸ¯'}</div>
              <div style="font-size:11px;font-weight:800;margin:3px 0">${at}</div>
              <div style="font-size:18px;font-weight:900;color:${color}">%${atWr}</div>
              <div style="font-size:9px;color:#94a3b8">${st.wins}G / ${st.total}T</div>
              <div style="height:5px;border-radius:3px;background:#e2e8f0;overflow:hidden;margin-top:5px">
                <div style="height:100%;width:${atWr}%;background:${color};border-radius:3px"></div>
              </div>
            </div>`;
          }).join('') + '</div>';
      })()}
    </div>
    <div style="background:#f8fafc;border-radius:14px;padding:16px">
      <div class="section-label" style="margin-bottom:12px">ğŸ’ª Zorlu Rakip Analizi (Birebir Veriler)</div>
      <div style="overflow-x:auto">
        <table><thead><tr>
          <th>Rakip</th><th class="tc">Rakip WR%</th><th class="tc">KarÅŸ. (G/T)</th><th class="tc">Benim WR%</th><th class="tc">Durum</th>
        </tr></thead><tbody>${hardOppRows}</tbody></table>
      </div>
    </div>`;
}

// ======================================================
// PSÄ°KOLOJÄ°K DURUM ANALÄ°ZÄ°
// ======================================================
function populateMsSel() {
  const sel = document.getElementById('ms_sel'); if (!sel) return;
  sel.innerHTML = players.map((p, i) => `<option value="${i}">${p.name}</option>`).join('');
}

function buildMentalState() {
  const sel = document.getElementById('ms_sel'); if (!sel) return;
  const idx = Number(sel.value || 0);
  const p = players[idx]; if (!p) return;
  const s = p.totalStats;
  const wr = s.total ? (s.wins / s.total) * 100 : 0;
  const tc = p.team === 'kirmizi' ? '#dc2626' : '#2563eb';
  const seed = p.id || 'x';

  // Son 10 maÃ§ - gerÃ§ek kayÄ±tlardan al
  const allGamesForMental = loadGames();
  const playerGames = allGamesForMental
    .filter(g => g.p1Name === p.name || g.p2Name === p.name)
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 10);
  
  let last10;
  if (playerGames.length === 0) {
    // Oyun yoksa boÅŸ gÃ¶ster
    last10 = null;
  } else {
    last10 = playerGames.map(g => {
      if (g.winner === 'Berabere') return 'draw';
      return g.winner === p.name;
    }).reverse(); // Kronolojik sÄ±ra
  }
  
  const last5Wins = last10 ? last10.slice(-5).filter(x => x === true).length : 0;
  const last3Wins = last10 ? last10.slice(-3).filter(x => x === true).length : 0;
  const momentum = last10 === null ? 'yok' : last5Wins >= 3 ? 'artÄ±yor' : last5Wins <= 1 ? 'dÃ¼ÅŸÃ¼yor' : 'stabil';
  const momentumColor = last10 === null ? '#94a3b8' : last5Wins >= 3 ? '#10b981' : last5Wins <= 1 ? '#ef4444' : '#f59e0b';

  // Zihinsel skorlar - kayÄ±tlÄ± oyunlar ve gerÃ§ek istatistiklere gÃ¶re
  const totalFromStats = s.total || 0;
  const wrFromStats = totalFromStats ? (s.wins / s.total) * 100 : 0;
  const realLast5Wins = last10 ? last10.slice(-5).filter(x=>x===true).length : Math.round(wrFromStats/100*3);
  const realLast3Wins = last10 ? last10.slice(-3).filter(x=>x===true).length : Math.round(wrFromStats/100*2);
  // DayanÄ±klÄ±lÄ±k: toplam maÃ§ sayÄ±sÄ± + kazanma oranÄ±
  const resilience = Math.min(100, Math.round(wrFromStats * 0.5 + Math.min(totalFromStats, 50) * 0.6 + realLast5Wins * 5));
  // Ã–zgÃ¼ven: son maÃ§lar aÄŸÄ±rlÄ±klÄ± + genel WR
  const confidence = Math.min(100, Math.round(wrFromStats * 0.4 + realLast3Wins * 18 + realLast5Wins * 4));
  // Konsantrasyon: performans tutarlÄ±lÄ±ÄŸÄ±
  const consistency = Math.min(100, Math.max(0, Math.round(wrFromStats * 0.7 + (totalFromStats > 5 ? 20 : 0) - Math.abs(realLast5Wins*20 - wrFromStats)*0.3)));
  // Kritik an: yÃ¼ksek maÃ§larda performans
  const clutch = Math.min(100, Math.round(wrFromStats * 0.6 + realLast5Wins * 7 + (totalFromStats > 10 ? 15 : 0)));

  const meterBar = (v, color) => `
    <div style="height:12px;border-radius:6px;background:#e2e8f0;overflow:hidden">
      <div style="height:100%;width:${v}%;background:${color};border-radius:6px;transition:width .8s"></div>
    </div>`;

  const mental_level = resilience >= 70 ? { emoji: 'ğŸ’', label: 'Demir Ä°rade', desc: 'Zihinsel olarak Ã§ok gÃ¼Ã§lÃ¼. BaskÄ± altÄ±nda en iyi performansÄ±nÄ± gÃ¶steriyor.', color: '#10b981' }
    : resilience >= 45 ? { emoji: 'âš¡', label: 'Dengeli Zihin', desc: 'Genel olarak stabil bir zihinsel yapÄ±ya sahip.', color: '#f59e0b' }
    : { emoji: 'âš ï¸', label: 'KÄ±rÄ±lgan', desc: 'BaskÄ± altÄ±nda performans dÃ¼ÅŸÃ¼ÅŸÃ¼ yaÅŸÄ±yor. Moral yÃ¶netimi Ã¶nemli.', color: '#ef4444' };

  const comment = last5Wins >= 4
    ? `${p.name} son dÃ¶nemde mÃ¼kemmel bir form tutturmuÅŸ durumda. Ã–zgÃ¼ven zirvedeyken bu ivmeyi korumak kritik.`
    : last5Wins >= 3
    ? `${p.name} son maÃ§larda belirgin bir yÃ¼kseliÅŸ iÃ§inde. Moral durumu iyi gÃ¶rÃ¼nÃ¼yor.`
    : last5Wins >= 2
    ? `${p.name} son maÃ§larda ortalama bir performans sergiliyor. Ne yÃ¼kseliÅŸ ne de belirgin bir dÃ¼ÅŸÃ¼ÅŸ var.`
    : last5Wins === 1
    ? `${p.name} son 5 maÃ§ta yalnÄ±zca 1 galibiyet aldÄ±. Moral baskÄ± altÄ±nda olabilir.`
    : `${p.name} son 5 maÃ§ta hiÃ§ galibiyet alamadÄ±. Ciddi bir form krizi yaÅŸÄ±yor, zihinsel destek gerekebilir.`;

  const body = document.getElementById('mental_body'); if (!body) return;
  body.innerHTML = `
    <div style="background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:16px;padding:22px;color:white;margin-bottom:18px;display:flex;gap:20px;align-items:center;flex-wrap:wrap">
      <div style="font-size:52px">${mental_level.emoji}</div>
      <div style="flex:1">
        <div style="font-size:22px;font-weight:900;color:${mental_level.color}">${mental_level.label}</div>
        <div style="font-size:13px;opacity:.8;margin-top:4px;line-height:1.6">${mental_level.desc}</div>
      </div>
      <div style="text-align:center">
        <div style="font-size:52px;font-weight:900;line-height:1;color:${mental_level.color}">${resilience}</div>
        <div style="font-size:10px;opacity:.6;text-transform:uppercase;letter-spacing:.1em">Zihin Skoru</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px">
      ${[
        ['ğŸ›¡ DayanÄ±klÄ±lÄ±k', resilience, '#6366f1'],
        ['ğŸ’ª Ã–zgÃ¼ven', confidence, '#f59e0b'],
        ['ğŸ¯ Konsantrasyon', consistency, '#0891b2'],
        ['ğŸ”¥ Kritik An PerformansÄ±', clutch, '#ec4899'],
      ].map(([label, val, color]) => `<div style="background:#f8fafc;border-radius:12px;padding:14px">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <span style="font-size:12px;font-weight:700">${label}</span>
          <span style="font-size:14px;font-weight:900;color:${color}">${val}/100</span>
        </div>
        ${meterBar(val, color)}
      </div>`).join('')}
    </div>
    <div style="background:#f8fafc;border-radius:12px;padding:16px;margin-bottom:14px">
      <div class="section-label" style="margin-bottom:10px">ğŸ“Š Son 10 MaÃ§ Formu</div>
      ${last10 === null
        ? `<div style="text-align:center;padding:20px;color:#94a3b8;font-size:13px">
            <div style="font-size:28px;margin-bottom:8px">ğŸ“‚</div>
            HenÃ¼z kaydedilmiÅŸ oyun yok.<br>Oyun ekranlarÄ±ndan "ğŸ’¾ Oyunu Kaydet" butonunu kullanÄ±n.
          </div>`
        : `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
        ${last10.map((res, i) => {
          const win = res === true;
          const draw = res === 'draw';
          return `<div style="width:38px;height:38px;border-radius:8px;background:${win?'#dcfce7':draw?'#fef3c7':'#fee2e2'};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:${win?'#16a34a':draw?'#b45309':'#dc2626'}">${win?'G':draw?'B':'M'}</div>`;
        }).join('')}
      </div>
      <div style="font-size:12px;color:#64748b">Son 5 maÃ§: <strong style="color:${momentumColor}">${last5Wins}/5 galibiyet</strong> â€” Momentum <strong style="color:${momentumColor}">${momentum}</strong></div>`
      }
    </div>
    <div style="background:#f0f9ff;border-radius:12px;padding:16px;border-left:4px solid #0369a1">
      <div style="font-size:11px;font-weight:900;color:#0369a1;text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px">ğŸ¤– Zihinsel Durum Yorumu</div>
      <div style="font-size:14px;line-height:1.7;color:#1e293b">${comment}</div>
    </div>`;
}

// ======================================================
// TURNUVA SÄ°MÃœLASYONU & TAHMÄ°N
// ======================================================
let savedPrediction = null;

function populateTnSels() {
  const sel = document.getElementById('tn_pred_sel'); if (!sel) return;
  sel.innerHTML = players.map((p, i) => `<option value="${i}">${p.name}</option>`).join('');
}

function savePrediction() {
  const sel = document.getElementById('tn_pred_sel'); if (!sel) return;
  savedPrediction = Number(sel.value);
  const st = document.getElementById('tn_pred_status');
  if (st) st.textContent = `âœ… Tahmin kaydedildi: ${players[savedPrediction]?.name}`;
}

function runTournament() {
  const format = document.getElementById('tn_format')?.value || 'elimination';
  const rounds = Number(document.getElementById('tn_rounds')?.value || 3);
  const res = document.getElementById('tourney_result'); if (!res) return;

  if (players.length < 2) { res.innerHTML = '<div style="color:#ef4444;padding:12px">En az 2 yarÄ±ÅŸmacÄ± gerekli.</div>'; return; }

  // Her oyuncunun win probability'sini hesapla
  const pool = players.map((p, i) => {
    const wr = p.totalStats.total ? p.totalStats.wins / p.totalStats.total : 0.5;
    return { p, i, wr, points: 0, wins: 0, losses: 0 };
  });

  let bracket = [];

  if (format === 'roundrobin') {
    // Lig: herkes herkesle rounds kez
    for (let r = 0; r < rounds; r++) {
      for (let a = 0; a < pool.length; a++) {
        for (let b = a + 1; b < pool.length; b++) {
          const pA = pool[a], pB = pool[b];
          const totalWr = pA.wr + pB.wr || 1;
          const win = Math.random() < pA.wr / totalWr;
          if (win) { pA.wins++; pA.points += 3; pB.losses++; }
          else { pB.wins++; pB.points += 3; pA.losses++; }
          bracket.push({ r, a: pA.p.name, b: pB.p.name, winner: win ? pA.p.name : pB.p.name });
        }
      }
    }
    pool.sort((a, b) => b.points - a.points);
  } else {
    // Eleme turnuvasÄ±
    let remaining = [...pool];
    let round = 1;
    while (remaining.length > 1) {
      const nextRound = [];
      for (let i = 0; i < remaining.length - 1; i += 2) {
        const pA = remaining[i], pB = remaining[i + 1];
        const totalWr = pA.wr + pB.wr || 1;
        const win = Math.random() < pA.wr / totalWr;
        const winner = win ? pA : pB;
        winner.wins++;
        (win ? pB : pA).losses++;
        bracket.push({ r: round, a: pA.p.name, b: pB.p.name, winner: winner.p.name });
        nextRound.push(winner);
      }
      if (remaining.length % 2 !== 0) nextRound.push(remaining[remaining.length - 1]);
      remaining = nextRound;
      round++;
    }
    pool.sort((a, b) => b.wins - a.wins);
  }

  const champion = pool[0];
  const champTc = champion.p.team === 'kirmizi' ? '#dc2626' : '#2563eb';
  const predIdx = savedPrediction;
  const predCorrect = predIdx !== null && players[predIdx]?.id === champion.p.id;

  const imgHtml = champion.p.image
    ? `<div style="width:80px;height:80px;border-radius:50%;background-image:url('${champion.p.image}');background-size:cover;background-position:center;border:4px solid gold;margin:0 auto 10px;"></div>`
    : `<div style="width:80px;height:80px;border-radius:50%;background:${champTc};display:flex;align-items:center;justify-content:center;color:white;font-size:28px;font-weight:900;border:4px solid gold;margin:0 auto 10px;">${champion.p.name.charAt(0)}</div>`;

  const topRows = pool.slice(0, Math.min(6, pool.length)).map((item, rank) => {
    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    const m = rank < 3 ? medals[rank] : `#${rank+1}`;
    const itc = item.p.team === 'kirmizi' ? '#dc2626' : '#2563eb';
    return `<tr>
      <td style="font-weight:700;text-align:center">${m}</td>
      <td style="font-weight:700;color:${itc}">${item.p.name}</td>
      <td class="tc" style="color:#10b981;font-weight:700">${item.wins}</td>
      <td class="tc" style="color:#ef4444;font-weight:700">${item.losses}</td>
      <td class="tc" style="color:#6366f1;font-weight:700">${format==='roundrobin'?item.points+' puan':'-'}</td>
    </tr>`;
  }).join('');

  const recentMatches = bracket.slice(-6).reverse().map(m =>
    `<div style="font-size:12px;padding:6px 10px;background:#f8fafc;border-radius:8px;display:flex;justify-content:space-between">
      <span style="color:#64748b">T${m.r}: ${m.a} â€” ${m.b}</span>
      <span style="font-weight:700;color:#10b981">ğŸ† ${m.winner}</span>
    </div>`
  ).join('');

  res.innerHTML = `
    <div style="background:linear-gradient(135deg,#0c0f18,#1a2333);border-radius:16px;padding:22px;color:white;text-align:center;margin-bottom:16px">
      ${imgHtml}
      <div style="font-size:14px;opacity:.7;text-transform:uppercase;letter-spacing:.15em;margin-bottom:4px">ğŸ† TURNUVA ÅAMPÄ°YONU</div>
      <div style="font-size:28px;font-weight:900;color:gold">${champion.p.name}</div>
      <div style="font-size:13px;opacity:.8;margin-top:6px">${champion.wins} galibiyet Â· ${champion.losses} yenilgi</div>
      ${predIdx !== null ? `<div style="margin-top:12px;padding:8px 16px;border-radius:20px;display:inline-block;background:${predCorrect?'#10b981':'#ef4444'}22;border:2px solid ${predCorrect?'#10b981':'#ef4444'};color:${predCorrect?'#10b981':'#ef4444'};font-weight:700;font-size:13px">${predCorrect ? 'ğŸ‰ Tahminini Bildin!' : `âŒ Tahmin YanlÄ±ÅŸ (${players[predIdx]?.name})`}</div>` : ''}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
      <div style="background:#f8fafc;border-radius:14px;padding:14px">
        <div class="section-label" style="margin-bottom:10px">SÄ±ralama</div>
        <table><thead><tr><th>SÄ±ra</th><th>Ä°sim</th><th class="tc">G</th><th class="tc">Y</th><th class="tc">Puan</th></tr></thead>
        <tbody>${topRows}</tbody></table>
      </div>
      <div style="background:#f8fafc;border-radius:14px;padding:14px">
        <div class="section-label" style="margin-bottom:10px">Son MaÃ§lar</div>
        <div style="display:flex;flex-direction:column;gap:5px">${recentMatches || '<div style="color:#94a3b8;font-size:12px">MaÃ§ bilgisi yok</div>'}</div>
      </div>
    </div>`;
}

// ======================================================
// BAÅARILAR & ROZETLER SÄ°STEMÄ°
// ======================================================
function populateAchSel() {
  const sel = document.getElementById('ach_sel'); if (!sel) return;
  sel.innerHTML = players.map((p, i) => `<option value="${i}">${p.name}</option>`).join('');
}

const ACHIEVEMENT_DEFS = [
  // AÃ§Ä±k baÅŸarÄ±lar
  { id: 'first_win', icon: 'â­', name: 'Ä°lk AdÄ±m', desc: 'Ä°lk galibiyeti kazandÄ±', category: 'Temel', check: (p) => p.totalStats.wins >= 1, hidden: false },
  { id: 'ten_wins', icon: 'ğŸ”Ÿ', name: 'Onluk KulÃ¼bÃ¼', desc: '10 veya daha fazla galibiyet', category: 'Temel', check: (p) => p.totalStats.wins >= 10, hidden: false },
  { id: 'fifty_wins', icon: 'ğŸ’¯', name: 'Elli Efsane', desc: '50 veya daha fazla galibiyet', category: 'Efsane', check: (p) => p.totalStats.wins >= 50, hidden: false },
  { id: 'hundred_wins', icon: 'ğŸ’', name: 'YÃ¼zler KulÃ¼bÃ¼', desc: '100 veya daha fazla galibiyet', category: 'Efsane', check: (p) => p.totalStats.wins >= 100, hidden: false },
  { id: 'high_wr', icon: 'ğŸ¯', name: 'Keskin NiÅŸancÄ±', desc: '%60 Ã¼zeri win rate (min 10 maÃ§)', category: 'Performans', check: (p) => p.totalStats.total >= 10 && (p.totalStats.wins/p.totalStats.total)*100 >= 60, hidden: false },
  { id: 'elite_wr', icon: 'ğŸ‘‘', name: 'Elit Seviye', desc: '%75 Ã¼zeri win rate (min 20 maÃ§)', category: 'Efsane', check: (p) => p.totalStats.total >= 20 && (p.totalStats.wins/p.totalStats.total)*100 >= 75, hidden: false },
  { id: 'veteran', icon: 'ğŸ–ï¸', name: 'Veteran', desc: '50 veya daha fazla toplam maÃ§', category: 'Deneyim', check: (p) => p.totalStats.total >= 50, hidden: false },
  { id: 'legend', icon: 'ğŸŒŸ', name: 'Efsane', desc: '100 veya daha fazla toplam maÃ§', category: 'Efsane', check: (p) => p.totalStats.total >= 100, hidden: false },
  { id: 'rival_crusher', icon: 'âš”ï¸', name: 'Rakip Ezici', desc: 'En az 3 farklÄ± rakibe karÅŸÄ± %70+ WR', category: 'H2H', check: (p) => Object.values(p.h2hRegistry||{}).filter(h => h.total >= 3 && (h.wins/h.total)*100 >= 70).length >= 3, hidden: false },
  { id: 'h2h_dom', icon: 'ğŸ”¥', name: 'Birebir Dominant', desc: 'Herhangi bir rakibe karÅŸÄ± 5+ galibiyet', category: 'H2H', check: (p) => Object.values(p.h2hRegistry||{}).some(h => h.wins >= 5), hidden: false },
  // Yeni baÅŸarÄ±lar (adlarÄ± deÄŸiÅŸtirme)
  { id: 'best_parkur_perf', icon: 'ğŸƒ', name: 'en iyi parkur performansÄ±', desc: 'Parkur oyunlarÄ±nda %65+ kazanma oranÄ± (min 5 parkur maÃ§Ä±)', category: 'Performans', check: (p) => {
    const games = loadGames(); const pg = games.filter(g=>(g.p1Name===p.name||g.p2Name===p.name)&&(g.gameType||'').toLowerCase().includes('parkur')&&!(g.gameType||'').toLowerCase().includes('dÄ±ÅŸÄ±'));
    if(pg.length<5)return false; const w=pg.filter(g=>g.winner===p.name).length; return (w/pg.length)*100>=65;
  }, hidden: false },
  { id: 'most_flag_races', icon: 'ğŸš©', name: 'En fazla bayrak yarÄ±ÅŸÄ±', desc: 'En az 5 bayrak yarÄ±ÅŸÄ± oyununa Ã§Ä±ktÄ±', category: 'Deneyim', check: (p) => {
    const games = loadGames(); return games.filter(g=>g.source==='flag'&&(g.redPlayers||[]).concat(g.bluePlayers||[]).includes(p.name)).length>=5;
  }, hidden: false },
  { id: 'best_non_parkur', icon: 'ğŸ¯', name: 'en iyi parkur hariÃ§ performans', desc: 'Parkur dÄ±ÅŸÄ± oyunlarda %65+ kazanma oranÄ± (min 5 maÃ§)', category: 'Performans', check: (p) => {
    const games = loadGames(); const pg = games.filter(g=>(g.p1Name===p.name||g.p2Name===p.name)&&(g.gameType||'').toLowerCase().includes('dÄ±ÅŸÄ±'));
    if(pg.length<5)return false; const w=pg.filter(g=>g.winner===p.name).length; return (w/pg.length)*100>=65;
  }, hidden: false },
  { id: 'most_games_played', icon: 'ğŸ®', name: 'En fazla oyuna Ã§Ä±kan', desc: 'En fazla toplam maÃ§a Ã§Ä±kan yarÄ±ÅŸmacÄ± (en az 20 maÃ§)', category: 'Deneyim', check: (p) => {
    if(p.totalStats.total < 20) return false; return players.every(other => other.id===p.id || other.totalStats.total <= p.totalStats.total);
  }, hidden: false },
  { id: 'best_overall_perf', icon: 'ğŸ†', name: 'En iyi performans', desc: 'En yÃ¼ksek win rate sahibi yarÄ±ÅŸmacÄ± (min 10 maÃ§)', category: 'Performans', check: (p) => {
    if(p.totalStats.total < 10) return false; const wr = p.totalStats.wins/p.totalStats.total;
    return players.filter(x=>x.totalStats.total>=10).every(other => other.id===p.id || (other.totalStats.wins/other.totalStats.total) <= wr);
  }, hidden: false },
  { id: 'most_mvp', icon: 'ğŸ…', name: 'En fazla mvp olma', desc: 'En fazla MVP seÃ§ilen yarÄ±ÅŸmacÄ± (oyun kayÄ±tlarÄ±na gÃ¶re)', category: 'Performans', check: (p) => {
    const games = loadGames(); const mvpCounts = {}; games.forEach(g=>{ if(g.winner&&g.winner!=='Berabere') mvpCounts[g.winner]=(mvpCounts[g.winner]||0)+1; });
    const myMVP = mvpCounts[p.name]||0; if(myMVP<3)return false; return Object.values(mvpCounts).every(v=>v<=myMVP);
  }, hidden: false },
  { id: 'longest_win_streak', icon: 'ğŸ”¥', name: 'en uzun kazanma serisi', desc: 'En az 5 maÃ§lÄ±k galibiyet serisi yaÅŸadÄ±', category: 'Performans', check: (p) => {
    const games = loadGames().filter(g=>g.p1Name===p.name||g.p2Name===p.name).sort((a,b)=>new Date(a.date)-new Date(b.date));
    let streak=0,max=0; games.forEach(g=>{if(g.winner===p.name){streak++;max=Math.max(max,streak);}else{streak=0;}}); return max>=5;
  }, hidden: false },
  { id: 'most_finals', icon: 'ğŸª', name: 'en fazla final sayÄ±sÄ±', desc: 'En fazla finale kalan yarÄ±ÅŸmacÄ± (FÄ°NALÄ°ST statÃ¼sÃ¼ veya en Ã§ok toplam maÃ§)', category: 'Deneyim', check: (p) => {
    return p.status==='FÄ°NALÄ°ST'||p.status==='KAZANAN'||(p.totalStats.total>=30&&players.filter(x=>x.totalStats.total>=30).every(o=>o.id===p.id||o.totalStats.total<=p.totalStats.total));
  }, hidden: false },
  { id: 'best_ppg', icon: 'ğŸ“Š', name: 'en fazla oyun baÅŸÄ±na sayÄ±', desc: 'En yÃ¼ksek oyun baÅŸÄ±na puan oranÄ± (G-Y / toplam maÃ§, min 10 maÃ§)', category: 'Performans', check: (p) => {
    if(p.totalStats.total<10)return false; const ppg=(p.totalStats.wins-p.totalStats.losses)/p.totalStats.total;
    return players.filter(x=>x.totalStats.total>=10).every(o=>o.id===p.id||((o.totalStats.wins-o.totalStats.losses)/o.totalStats.total)<=ppg);
  }, hidden: false },
  // Gizli baÅŸarÄ±lar
  { id: 'power_100', icon: 'âš¡', name: '???', realName: 'GÃ¼Ã§ TanrÄ±sÄ±', desc: '???', realDesc: 'Power Score 90+ ulaÅŸ', category: 'Gizli', check: (p) => calcPowerScore(p).score >= 90, hidden: true },
  { id: 'all_wins', icon: 'ğŸƒ', name: '???', realName: 'Yenilmez Efsane', desc: '???', realDesc: 'Toplam maÃ§larÄ±n tamamÄ±nÄ± kazan (min 5 maÃ§)', category: 'Gizli', check: (p) => p.totalStats.total >= 5 && p.totalStats.losses === 0, hidden: true },
  { id: 'comeback', icon: 'ğŸ”„', name: '???', realName: 'Geri DÃ¶nÃ¼ÅŸ UstasÄ±', desc: '???', realDesc: 'Win rate Ã¶nce dÃ¼ÅŸÃ¼k, ÅŸimdi %60+ (min 20 maÃ§)', category: 'Gizli', check: (p) => p.totalStats.total >= 20 && (p.totalStats.wins/p.totalStats.total)*100 >= 60 && p.totalStats.losses > p.totalStats.wins * 0.4, hidden: true },
  { id: 'h2h_all', icon: 'ğŸŒ', name: '???', realName: 'Herkesi Yendim', desc: '???', realDesc: 'TÃ¼m diÄŸer yarÄ±ÅŸmacÄ±lara en az 1 galibiyet', category: 'Gizli', check: (p) => players.filter(x=>x.id!==p.id).length > 0 && players.filter(x=>x.id!==p.id).every(opp => (p.h2hRegistry[opp.id]?.wins||0) >= 1), hidden: true },
  { id: 'photo_added', icon: 'ğŸ“¸', name: '???', realName: 'YÄ±ldÄ±z YarÄ±ÅŸmacÄ±', desc: '???', realDesc: 'Profil fotoÄŸrafÄ± eklendi', category: 'Gizli', check: (p) => !!p.image, hidden: true },
];

function buildAchievements() {
  // Build players gallery (small avatars)
  const gallery = document.getElementById('ach_players_gallery');
  if (gallery) {
    gallery.innerHTML = players.map((p, i) => {
      const tc = p.team === 'kirmizi' ? '#dc2626' : '#2563eb';
      const imgHtml = p.image
        ? `<img src="${p.image}" style="width:100%;height:100%;object-fit:cover;object-position:center 15%;border-radius:50%;">`
        : `<div style="width:100%;height:100%;background:${tc};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:white;border-radius:50%;">${p.name.charAt(0)}</div>`;
      const sel = document.getElementById('ach_sel');
      const isSelected = sel && Number(sel.value) === i;
      return `<div onclick="document.getElementById('ach_sel').value='${i}';buildAchievements()" style="cursor:pointer;text-align:center;min-width:54px">
        <div style="width:48px;height:48px;border-radius:50%;border:3px solid ${isSelected?'#6366f1':tc};overflow:hidden;margin:0 auto 3px;transition:all .2s;${isSelected?'box-shadow:0 0 0 3px rgba(99,102,241,.3);transform:scale(1.1);':''}">
          ${imgHtml}
        </div>
        <div style="font-size:9px;font-weight:700;color:${isSelected?'#6366f1':tc};white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:54px">${p.name}</div>
      </div>`;
    }).join('');
  }

  const sel = document.getElementById('ach_sel'); if (!sel) return;
  const idx = Number(sel.value || 0);
  const p = players[idx]; if (!p) return;
  const tc = p.team === 'kirmizi' ? '#dc2626' : '#2563eb';
  const tcLight = p.team === 'kirmizi' ? '#fee2e2' : '#dbeafe';
  const tcDark = p.team === 'kirmizi' ? '#991b1b' : '#1e40af';
  const wr = p.totalStats.total ? ((p.totalStats.wins/p.totalStats.total)*100).toFixed(1) : '0.0';
  const score = (p.totalStats.wins||0)-(p.totalStats.losses||0);

  // Profil kartÄ± â€” sadece seÃ§ilen yarÄ±ÅŸmacÄ±
  const profileCard = document.getElementById('ach_profile_card');
  if (profileCard) {
    const earnedForCard = ACHIEVEMENT_DEFS.filter(a => a.check(p));
    const pctForCard = Math.round((earnedForCard.length/ACHIEVEMENT_DEFS.length)*100);
    profileCard.innerHTML = `
      <div style="width:260px;background:linear-gradient(145deg,${tcDark},${p.team==='kirmizi'?'#7f1d1d':'#1e3a8a'});border-radius:18px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.2);border:2px solid ${tc};">
        <!-- FotoÄŸraf alanÄ± -->
        <div style="position:relative;height:200px;overflow:hidden;background:rgba(0,0,0,.3);">
          ${p.image
            ? `<img src="${p.image}" style="width:100%;height:100%;object-fit:cover;object-position:center 15%;">`
            : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:80px;font-weight:900;color:rgba(255,255,255,.15);">${p.name.charAt(0)}</div>`}
          <!-- Alt gradient -->
          <div style="position:absolute;bottom:0;left:0;right:0;height:80px;background:linear-gradient(to top,${tcDark},transparent);"></div>
          <!-- TakÄ±m etiketi -->
          <div style="position:absolute;top:10px;left:10px;background:${tc};color:white;font-size:9px;font-weight:900;padding:3px 10px;border-radius:10px;text-transform:uppercase;letter-spacing:.2em;">${p.team==='kirmizi'?'KIRMIZI':'MAVÄ°'}</div>
          <!-- Ä°sim Ã¼stte fotoÄŸraf alt kÄ±smÄ± Ã¼zerinde -->
          <div style="position:absolute;bottom:8px;left:0;right:0;text-align:center;">
            <div style="font-size:26px;font-weight:900;color:white;text-transform:uppercase;letter-spacing:.08em;text-shadow:0 2px 8px rgba(0,0,0,.8)">${p.name}</div>
          </div>
        </div>
        <!-- Ä°statistikler -->
        <div style="padding:14px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center;">
          <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:8px 4px;">
            <div style="font-size:22px;font-weight:900;color:#4ade80">${p.totalStats.wins||0}</div>
            <div style="font-size:8px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.1em">GALÄ°BÄ°YET</div>
          </div>
          <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:8px 4px;">
            <div style="font-size:22px;font-weight:900;color:#f87171">${p.totalStats.losses||0}</div>
            <div style="font-size:8px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.1em">YENÄ°LGÄ°</div>
          </div>
          <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:8px 4px;">
            <div style="font-size:22px;font-weight:900;color:${Number(wr)>=50?'#4ade80':'#f87171'}">%${Math.round(Number(wr))}</div>
            <div style="font-size:8px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.1em">ORAN</div>
          </div>
        </div>
        <!-- Rozet ilerleme Ã§ubuÄŸu -->
        <div style="padding:0 14px 14px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
            <span style="font-size:10px;color:rgba(255,255,255,.7);font-weight:700">ğŸ–ï¸ Rozetler</span>
            <span style="font-size:11px;font-weight:900;color:#FFD700">${earnedForCard.length}/${ACHIEVEMENT_DEFS.length}</span>
          </div>
          <div style="height:6px;border-radius:3px;background:rgba(0,0,0,.4);overflow:hidden;">
            <div style="height:100%;width:${pctForCard}%;background:linear-gradient(to right,#FFD700,#f59e0b);border-radius:3px;transition:width .8s;"></div>
          </div>
        </div>
      </div>`;
  }

  const earned = ACHIEVEMENT_DEFS.filter(a => a.check(p));
  const notEarned = ACHIEVEMENT_DEFS.filter(a => !a.check(p));
  const earnedCount = earned.length;
  const totalCount = ACHIEVEMENT_DEFS.length;
  const pct = Math.round((earnedCount / totalCount) * 100);

  const catColors = { 'Temel': '#0891b2', 'Performans': '#7c3aed', 'Efsane': '#f59e0b', 'H2H': '#be123c', 'Deneyim': '#065f46', 'Gizli': '#1e293b' };

  const body = document.getElementById('achievements_body'); if (!body) return;
  body.innerHTML = `
    <div style="background:linear-gradient(135deg,${tc}22,${tc}11);border-radius:14px;padding:16px;margin-bottom:18px;display:flex;align-items:center;gap:16px">
      <div style="text-align:center;min-width:80px">
        <div style="font-size:36px;font-weight:900;color:${tc}">${earnedCount}</div>
        <div style="font-size:10px;color:#64748b;font-weight:700;text-transform:uppercase">/ ${totalCount} Rozet</div>
      </div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <span style="font-weight:700;font-size:13px">Tamamlanma</span>
          <span style="font-weight:900;color:${tc}">${pct}%</span>
        </div>
        <div style="height:10px;border-radius:5px;background:#e2e8f0;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:${tc};border-radius:5px;transition:width .8s"></div>
        </div>
      </div>
    </div>
    <div class="section-label" style="margin-bottom:10px">âœ… KazanÄ±lan BaÅŸarÄ±lar (${earnedCount})</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:20px">
      ${earned.length ? earned.map(a => {
        const catColor = catColors[a.category] || '#6366f1';
        return `<div style="background:#f0fdf4;border:2px solid #bbf7d0;border-radius:12px;padding:12px;display:flex;gap:10px;align-items:flex-start">
          <div style="font-size:26px;flex-shrink:0">${a.icon}</div>
          <div>
            <div style="font-size:13px;font-weight:900;color:#166534">${a.hidden ? a.realName : a.name}</div>
            <div style="font-size:11px;color:#4ade80;font-weight:700;margin-bottom:3px">${a.hidden ? a.realDesc : a.desc}</div>
            <span style="font-size:9px;font-weight:800;padding:2px 8px;border-radius:10px;background:${catColor}22;color:${catColor};text-transform:uppercase">${a.category}</span>
          </div>
        </div>`;
      }).join('') : '<div style="color:#94a3b8;font-size:13px;padding:12px">HenÃ¼z baÅŸarÄ± kazanÄ±lmadÄ±.</div>'}
    </div>
    <div class="section-label" style="margin-bottom:10px">ğŸ”’ Kilitli BaÅŸarÄ±lar (${notEarned.length})</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px">
      ${notEarned.map(a => {
        const catColor = catColors[a.category] || '#6366f1';
        return `<div style="background:#f8fafc;border:2px solid #e2e8f0;border-radius:12px;padding:12px;display:flex;gap:10px;align-items:flex-start;opacity:.7">
          <div style="font-size:26px;flex-shrink:0;filter:grayscale(1)">${a.hidden ? 'ğŸ”’' : a.icon}</div>
          <div>
            <div style="font-size:13px;font-weight:900;color:#64748b">${a.name}</div>
            <div style="font-size:11px;color:#94a3b8;margin-bottom:3px">${a.desc}</div>
            <span style="font-size:9px;font-weight:800;padding:2px 8px;border-radius:10px;background:${catColor}22;color:${catColor};text-transform:uppercase">${a.category}</span>
          </div>
        </div>`;
      }).join('')}
    </div>`;
  // Rebuild downloadable design card
  setTimeout(buildAchievementDesign, 80);
}

function buildAchievementDesign() {
  const cvDiv = document.getElementById('ach_design_canvas');
  if (!cvDiv) return;
  const sel = document.getElementById('ach_sel'); if (!sel) return;
  const idx = Number(sel.value || 0);
  const p = players[idx]; if (!p) return;

  const tc = p.team === 'kirmizi' ? '#ef4444' : '#3b82f6';
  const tcDark = p.team === 'kirmizi' ? '#7f1d1d' : '#1e3a8a';
  const bgGrad = p.team === 'kirmizi'
    ? 'linear-gradient(135deg,#1a0000 0%,#4a0000 40%,#0d0000 100%)'
    : 'linear-gradient(135deg,#000312 0%,#001a5c 40%,#000010 100%)';
  const glow = p.team === 'kirmizi' ? 'rgba(239,68,68,0.35)' : 'rgba(59,130,246,0.35)';

  const earned = ACHIEVEMENT_DEFS.filter(a => a.check(p));
  const notEarned = ACHIEVEMENT_DEFS.filter(a => !a.check(p));
  const pct = Math.round((earned.length / ACHIEVEMENT_DEFS.length) * 100);
  const wr = p.totalStats.total ? ((p.totalStats.wins / p.totalStats.total) * 100).toFixed(1) : '0.0';

  const photoHtml = p.image
    ? `<img src="${p.image}" style="width:100%;height:100%;object-fit:cover;object-position:center 15%;display:block;" crossorigin="anonymous">`
    : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:80px;font-weight:900;color:rgba(255,255,255,.1)">${p.name.charAt(0)}</div>`;

  const catColors = { 'Temel': '#0891b2', 'Performans': '#7c3aed', 'Efsane': '#f59e0b', 'H2H': '#be123c', 'Deneyim': '#065f46', 'Gizli': '#6366f1' };
  const catBgs = { 'Temel': '#0c4a6e', 'Performans': '#3b0764', 'Efsane': '#451a03', 'H2H': '#4c0519', 'Deneyim': '#052e16', 'Gizli': '#1e1b4b' };

  const earnedBadges = earned.slice(0, 16).map(a => {
    const cc = catColors[a.category] || '#6366f1';
    const cb = catBgs[a.category] || '#1e1b4b';
    return `<div style="background:${cb};border:1px solid ${cc}60;border-radius:12px;padding:10px 8px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px">
      <div style="font-size:24px">${a.icon}</div>
      <div style="font-size:10px;font-weight:900;color:white;line-height:1.2">${a.hidden ? a.realName : a.name}</div>
      <div style="font-size:8px;font-weight:700;padding:2px 6px;border-radius:8px;background:${cc}30;color:${cc};text-transform:uppercase">${a.category}</div>
    </div>`;
  }).join('');

  cvDiv.innerHTML = `<div id="ach_design_inner" style="width:1080px;min-height:680px;font-family:'Barlow Condensed',sans-serif;position:relative;overflow:hidden;background:#050508;display:flex;flex-direction:column;">

    <!-- Glow BG -->
    <div style="position:absolute;top:-200px;left:50%;transform:translateX(-50%);width:900px;height:600px;background:radial-gradient(ellipse,${glow} 0%,transparent 65%);pointer-events:none;z-index:0;"></div>
    <!-- BG Gradient -->
    <div style="position:absolute;inset:0;background:${bgGrad};opacity:.8;pointer-events:none;z-index:0;"></div>
    <!-- Watermark -->
    <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:1;opacity:.04;overflow:hidden">
      <span style="font-size:100px;font-weight:900;color:white;transform:rotate(-20deg);white-space:nowrap">SurvivorMetrics</span>
    </div>

    <!-- HEADER -->
    <div style="position:relative;z-index:5;display:flex;align-items:stretch;height:200px;border-bottom:2px solid ${tc}40;">
      <!-- Photo -->
      <div style="width:160px;flex-shrink:0;overflow:hidden;position:relative;">
        ${photoHtml}
        <div style="position:absolute;inset:0;background:linear-gradient(to right,transparent 60%,#050508 100%);"></div>
      </div>
      <!-- Player info -->
      <div style="flex:1;padding:24px 30px;display:flex;flex-direction:column;justify-content:center;">
        <div style="font-size:10px;font-weight:800;color:${tc};letter-spacing:.5em;text-transform:uppercase;margin-bottom:4px">${p.team === 'kirmizi' ? 'KIRMIZI TAKIM' : 'MAVÄ° TAKIM'}</div>
        <div style="font-size:58px;font-weight:900;color:white;text-transform:uppercase;letter-spacing:.04em;line-height:.9;text-shadow:0 2px 16px rgba(0,0,0,.8)">${p.name}</div>
        ${p.status ? `<div style="margin-top:8px;display:inline-block;background:rgba(255,215,0,.15);border:1px solid #FFD700;border-radius:20px;padding:4px 18px;font-size:14px;font-weight:900;color:#FFD700;letter-spacing:.1em">${p.status}</div>` : ''}
      </div>
      <!-- Stats -->
      <div style="padding:20px 30px;display:grid;grid-template-columns:1fr 1fr;gap:10px;align-content:center;border-left:1px solid ${tc}30;">
        ${[['TOPLAM', p.totalStats.total, 'white'], ['GALÄ°BÄ°YET', p.totalStats.wins, '#4ade80'], ['YENÄ°LGÄ°', p.totalStats.losses, '#f87171'], ['WIN %', '%'+Math.round(Number(wr)), Number(wr)>=50?'#4ade80':'#f87171']].map(([lbl, val, col]) =>
          `<div style="background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 8px;text-align:center">
            <div style="font-size:26px;font-weight:900;color:${col};line-height:1">${val}</div>
            <div style="font-size:8px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.1em;margin-top:2px">${lbl}</div>
          </div>`).join('')}
      </div>
    </div>

    <!-- PROGRESS BAR -->
    <div style="position:relative;z-index:5;padding:16px 30px;background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.06)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:11px;font-weight:800;color:rgba(255,255,255,.6);letter-spacing:.15em;text-transform:uppercase">ğŸ–ï¸ BaÅŸarÄ± Ä°lerlemesi</span>
        <span style="font-size:16px;font-weight:900;color:#FFD700">${earned.length} / ${ACHIEVEMENT_DEFS.length} Rozet â€” %${pct}</span>
      </div>
      <div style="height:8px;border-radius:4px;background:rgba(255,255,255,.1);overflow:hidden">
        <div style="height:100%;width:${pct}%;background:linear-gradient(to right,#b8860b,#FFD700,#b8860b);border-radius:4px;"></div>
      </div>
    </div>

    <!-- BADGES GRID -->
    <div style="position:relative;z-index:5;padding:20px 30px;flex:1">
      <div style="font-size:10px;font-weight:900;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.2em;margin-bottom:14px">âœ… KazanÄ±lan Rozetler (${earned.length})</div>
      ${earned.length > 0 
        ? `<div style="display:grid;grid-template-columns:repeat(8,1fr);gap:10px">${earnedBadges}</div>`
        : `<div style="text-align:center;padding:30px;color:rgba(255,255,255,.3);font-size:14px">HenÃ¼z baÅŸarÄ± kazanÄ±lmadÄ±.</div>`}
      ${notEarned.length > 0 ? `<div style="margin-top:16px;font-size:10px;font-weight:900;color:rgba(255,255,255,.2);text-transform:uppercase;letter-spacing:.2em">ğŸ”’ Kilitli: ${notEarned.length} Rozet</div>` : ''}
    </div>

    <!-- FOOTER -->
    <div style="position:relative;z-index:5;padding:10px 30px;background:rgba(0,0,0,.7);border-top:1px solid rgba(255,255,255,.05);display:flex;justify-content:space-between;align-items:center">
      <span style="font-size:8px;color:rgba(255,255,255,.15);letter-spacing:.3em;text-transform:uppercase">SURVIVORMETRICS</span>
      <span style="font-size:8px;color:rgba(255,255,255,.1)">${new Date().toLocaleDateString('tr-TR',{day:'2-digit',month:'long',year:'numeric'})}</span>
    </div>

  </div>`;
}

function downloadAchievementCard() {
  // First build the design
  buildAchievementDesign();
  setTimeout(() => {
    const cvDiv = document.getElementById('ach_design_canvas');
    if (!cvDiv || !cvDiv.innerHTML.trim()) { alert('TasarÄ±m oluÅŸturulamadÄ±.'); return; }
    const inner = cvDiv.querySelector('#ach_design_inner') || cvDiv.firstElementChild;
    if (!inner) return;
    const sel = document.getElementById('ach_sel');
    const idx = Number(sel?.value || 0);
    const p = players[idx];
    _downloadDesignHD(inner, 'basari-karti-' + (p?.name || 'player') + '-' + Date.now() + '.png');
  }, 300);
}

// ======================================================
// openM override â€” yeni modaller iÃ§in
// ======================================================
const _newOpenM = window.openM || openM;
window.openM = function(id) {
  _newOpenM(id);
  if (id === 'm_top10') { buildTop10(); }
  else if (id === 'm_timeline') { populateTlSel(); setTimeout(buildTimeline, 80); }
  else if (id === 'm_deepstats') { populateDsSel(); setTimeout(buildDeepStats, 80); }
  else if (id === 'm_mental') { populateMsSel(); setTimeout(buildMentalState, 80); }
  else if (id === 'm_tourney') { populateTnSels(); }
  else if (id === 'm_achievements') { populateAchSel(); setTimeout(buildAchievements, 80); }
  else if (id === 'm_games') { gamesFilter='all'; gamesSourceFilter='all'; gamesAtisFilter='all'; buildGamesList(); filterGames('all'); filterGamesBySource('all'); filterGamesByAtis('all'); const sf=document.getElementById('solo_entry_form');if(sf)sf.style.display='none'; }
  else if (id === 'm_stats_design') { setTimeout(()=>{ buildStatsDesign(1); buildStatsDesign(2); }, 80); }
  else if (id === 'm_elim_design') { setTimeout(buildElimDesign, 80); }
  else if (id === 'm_mvp') { setTimeout(buildMVPDesign, 80); }
  else if (id === 'm_new_design') { populateNewDesignSels(); setTimeout(buildNewDesign, 80); }
  else if (id === 'm_h2h_design') { setTimeout(buildH2HDesign, 80); }
  else if (id === 'm_alltime') { setTimeout(()=>buildAlltimeList('wr'), 80); }
};


// ======================================================
// Ä°STATÄ°STÄ°K TABLOSU TASARIM MODAL
// ======================================================
function openStatsDesignModal() {
  openM('m_stats_design');
}

function buildStatsDesign(mode) {
  // mode=1: puan sÄ±ralamasÄ± (WR% sÃ¼tunu yok)
  // mode=2: yÃ¼zde sÄ±ralamasÄ± (P sÃ¼tunu yok)
  if (!mode) mode = 1;
  const canvasId = mode === 1 ? 'stats_design_canvas' : 'stats_design_canvas2';
  const innerId  = mode === 1 ? 'stats_design_inner'  : 'stats_design_inner2';
  const cvDiv = document.getElementById(canvasId);
  if (!cvDiv) return;

  const dateStr = new Date().toLocaleDateString('tr-TR', {day:'2-digit',month:'long',year:'numeric'});
  const subTitle = mode === 1 ? 'GENEL PERFORMANS (PUAN)' : 'GENEL PERFORMANS (YÃœZDE)';

  // SÄ±ralama
  const sorted = [...players].sort((a,b) => {
    if (mode === 1) {
      const sa = (a.totalStats.wins||0) - (a.totalStats.losses||0);
      const sb = (b.totalStats.wins||0) - (b.totalStats.losses||0);
      if (sb !== sa) return sb - sa;
      return (b.totalStats.wins||0) - (a.totalStats.wins||0);
    } else {
      const wa = a.totalStats.total ? a.totalStats.wins/a.totalStats.total : 0;
      const wb = b.totalStats.total ? b.totalStats.wins/b.totalStats.total : 0;
      if (wb !== wa) return wb - wa;
      return (b.totalStats.wins||0) - (a.totalStats.wins||0);
    }
  });

  const rows = sorted.map((p, i) => {
    const s = p.totalStats;
    const score = (s.wins||0) - (s.losses||0);
    const scoreStr = score > 0 ? '+' + score : String(score);
    const wr = s.total ? Math.round((s.wins/s.total)*100) : 0;
    const isRed = p.team === 'kirmizi';
    const tc = isRed ? '#e53e3e' : '#3182ce';
    const rankNum = i + 1;
    const rowBg = i % 2 === 0 ? '#1c1c1c' : '#242424';
    const imgHtml = p.image
      ? `<div style="width:44px;height:44px;border-radius:50%;overflow:hidden;flex-shrink:0;border:2px solid ${tc};"><img src="${p.image}" style="width:100%;height:100%;object-fit:cover;object-position:center top;display:block;" crossorigin="anonymous"></div>`
      : `<div style="width:44px;height:44px;border-radius:50%;background:${tc};display:flex;align-items:center;justify-content:center;color:white;font-size:18px;font-weight:900;flex-shrink:0;">${p.name.charAt(0)}</div>`;

    // Puan sÃ¼tunu (mode=1'de var, mode=2'de yok)
    const puanCol = mode === 1 ? `
      <div style="width:72px;text-align:center;flex-shrink:0;">
        <div style="font-size:20px;font-weight:900;color:${score>=0?'#34d399':'#f87171'};font-family:'Barlow Condensed',sans-serif;">${scoreStr}</div>
      </div>` : '';
    // YÃ¼zde sÃ¼tunu (mode=2'de var, mode=1'de yok)
    const yuzdCol = mode === 2 ? `
      <div style="width:80px;text-align:center;flex-shrink:0;padding-right:8px;">
        <div style="font-size:20px;font-weight:900;color:${wr>=50?'#4ade80':'#f87171'};font-family:'Barlow Condensed',sans-serif;">%${wr}</div>
      </div>` : '';

    return `<div style="display:flex;align-items:center;background:${rowBg};border-bottom:1px solid rgba(255,255,255,.06);border-left:4px solid ${tc};">
      <div style="width:52px;text-align:center;flex-shrink:0;padding:6px 0;">
        <div style="font-size:13px;font-weight:900;color:rgba(255,255,255,.5);font-family:'Barlow Condensed',sans-serif;">â€”${rankNum}</div>
      </div>
      <div style="padding:5px 10px 5px 0;flex-shrink:0;">${imgHtml}</div>
      <div style="flex:1;min-width:0;padding-right:8px;">
        <div style="font-size:19px;font-weight:900;color:${tc};font-family:'Barlow Condensed',sans-serif;letter-spacing:.04em;text-transform:uppercase;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.name}</div>
      </div>
      <div style="width:70px;text-align:center;flex-shrink:0;">
        <div style="font-size:20px;font-weight:900;color:white;font-family:'Barlow Condensed',sans-serif;">${s.total||0}</div>
      </div>
      <div style="width:60px;text-align:center;flex-shrink:0;">
        <div style="font-size:20px;font-weight:900;color:#4ade80;font-family:'Barlow Condensed',sans-serif;">${s.wins||0}</div>
      </div>
      <div style="width:60px;text-align:center;flex-shrink:0;">
        <div style="font-size:20px;font-weight:900;color:#f87171;font-family:'Barlow Condensed',sans-serif;">${s.losses||0}</div>
      </div>
      ${puanCol}${yuzdCol}
    </div>`;
  }).join('');

  // Kolon baÅŸlÄ±klarÄ± - mode'a gÃ¶re
  const puanHdr = mode === 1 ? `<div style="width:72px;text-align:center;flex-shrink:0;font-size:11px;font-weight:800;color:white;letter-spacing:.1em;text-transform:uppercase;">P</div>` : '';
  const yuzdHdr = mode === 2 ? `<div style="width:80px;text-align:center;flex-shrink:0;padding-right:8px;font-size:11px;font-weight:800;color:white;letter-spacing:.1em;text-transform:uppercase;">YÃœZDE</div>` : '';

  cvDiv.innerHTML = `<div id="${innerId}" style="background:linear-gradient(180deg,#111111 0%,#1a1a1a 100%);width:1080px;font-family:'Barlow Condensed',sans-serif;position:relative;overflow:hidden;">
    <!-- Hafif kÄ±rmÄ±zÄ± Ä±ÅŸÄ±k sol alt -->
    <div style="position:absolute;bottom:-120px;left:-80px;width:500px;height:500px;background:radial-gradient(circle,rgba(220,38,38,.18) 0%,transparent 65%);pointer-events:none;z-index:0;"></div>
    <!-- Hafif mavi Ä±ÅŸÄ±k saÄŸ Ã¼st -->
    <div style="position:absolute;top:-80px;right:-80px;width:400px;height:400px;background:radial-gradient(circle,rgba(59,130,246,.12) 0%,transparent 65%);pointer-events:none;z-index:0;"></div>

    <!-- BaÅŸlÄ±k -->
    <div style="position:relative;z-index:2;padding:28px 36px 16px;text-align:center;">
      <div style="font-size:72px;font-weight:900;font-style:italic;font-family:'Barlow Condensed',sans-serif;letter-spacing:.1em;color:white;line-height:1;">SURVÄ°VOR TÃœRKÄ°YE 2026</div>
      <div style="margin-top:8px;font-size:20px;font-weight:700;color:rgba(255,255,255,.75);letter-spacing:.4em;text-transform:uppercase;font-family:'Barlow Condensed',sans-serif;">${subTitle}</div>
      <div style="margin-top:4px;font-size:13px;color:rgba(255,255,255,.35);letter-spacing:.2em;">${dateStr}</div>
    </div>

    <!-- Kolon BaÅŸlÄ±klarÄ± -->
    <div style="display:flex;align-items:center;background:rgba(255,255,255,.07);border-top:2px solid rgba(255,255,255,.12);border-bottom:2px solid rgba(255,255,255,.12);position:relative;z-index:2;">
      <div style="width:52px;text-align:center;flex-shrink:0;padding:10px 0;font-size:11px;font-weight:800;color:rgba(255,255,255,.5);letter-spacing:.1em;text-transform:uppercase;">#</div>
      <div style="width:54px;flex-shrink:0;font-size:11px;font-weight:800;color:rgba(255,255,255,.5);letter-spacing:.1em;text-align:center;text-transform:uppercase;">FOT</div>
      <div style="flex:1;font-size:11px;font-weight:800;color:rgba(255,255,255,.5);letter-spacing:.1em;text-transform:uppercase;">YARIÅMACI</div>
      <div style="width:70px;text-align:center;flex-shrink:0;font-size:11px;font-weight:800;color:rgba(255,255,255,.5);letter-spacing:.1em;text-transform:uppercase;">T</div>
      <div style="width:60px;text-align:center;flex-shrink:0;font-size:11px;font-weight:800;color:#4ade80;letter-spacing:.1em;text-transform:uppercase;">G</div>
      <div style="width:60px;text-align:center;flex-shrink:0;font-size:11px;font-weight:800;color:#f87171;letter-spacing:.1em;text-transform:uppercase;">M</div>
      ${puanHdr}${yuzdHdr}
    </div>

    <!-- SatÄ±rlar -->
    <div style="position:relative;z-index:2;">${rows}</div>

    <!-- Footer -->
    <div style="position:relative;z-index:2;padding:12px 36px;border-top:2px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.4);">
      <span style="font-size:11px;color:rgba(255,255,255,.25);font-weight:700;letter-spacing:.2em;text-transform:uppercase;">SURVIVORMETRICS</span>
      <span style="font-size:11px;color:rgba(255,255,255,.25);font-weight:700;letter-spacing:.15em;text-transform:uppercase;">${players.length} YARIÅMACI Â· ${dateStr}</span>
    </div>
  </div>`;
}

function downloadStatsDesignImage(mode) {
  if (!mode) mode = 1;
  const canvasId = mode === 1 ? 'stats_design_canvas' : 'stats_design_canvas2';
  const innerId  = mode === 1 ? 'stats_design_inner'  : 'stats_design_inner2';
  const suffix   = mode === 1 ? 'puan' : 'yuzde';
  const cvDiv = document.getElementById(canvasId);
  if (!cvDiv || !cvDiv.innerHTML.trim()) { alert('Ã–nce tasarÄ±m oluÅŸturun.'); return; }
  const inner = cvDiv.querySelector('#' + innerId) || cvDiv.firstElementChild;
  if (!inner) return;
  _downloadDesignHD(inner, 'survivor-istatistik-' + suffix + '-' + Date.now() + '.png');
}

// ======================================================
// ELEME ADAYI TASARIM MODAL
// ======================================================
function openElimDesignModal() {
  openM('m_elim_design');
}

function openElimDesignFromElim() {
  // elim_sel'deki seÃ§ili yarÄ±ÅŸmacÄ±yÄ± al, tasarÄ±m modalÄ±nÄ± aÃ§
  const sel = document.getElementById('elim_sel');
  if (!sel) { openM('m_elim_design'); return; }
  // TasarÄ±m modalÄ±nÄ± aÃ§ - buildElimDesign elim_sel'i okur
  openM('m_elim_design');
}

function buildElimDesign() {
  const cvDiv = document.getElementById('elim_design_canvas');
  if (!cvDiv) return;
  const sel = document.getElementById('elim_sel');
  const idx = sel ? Number(sel.value || 0) : 0;
  const p = players[idx];
  if (!p) { cvDiv.innerHTML = '<div style="color:#94a3b8;padding:20px">YarÄ±ÅŸmacÄ± bulunamadÄ±.</div>'; return; }
  const s = p.totalStats;
  const wr = s.total ? ((s.wins/s.total)*100).toFixed(1) : '0.0';
  const ps = calcPowerScore(p);
  const tc = p.team === 'kirmizi' ? '#ef4444' : '#3b82f6';
  const tcLight = p.team === 'kirmizi' ? '#fca5a5' : '#93c5fd';
  const teamBg = p.team === 'kirmizi'
    ? 'linear-gradient(160deg,#3a0000 0%,#6b0000 35%,#1a0000 100%)'
    : 'linear-gradient(160deg,#000e3a 0%,#00267a 35%,#000518 100%)';
  const teamLabel = p.team === 'kirmizi' ? 'KIRMIZI TAKIM' : 'MAVÄ° TAKIM';

  // Yuvarlak fotoÄŸraf
  const circleImg = p.image
    ? `<div style="width:160px;height:160px;border-radius:50%;overflow:hidden;border:5px solid ${tc};box-shadow:0 0 40px ${tc}80,0 0 0 2px rgba(255,255,255,.15);flex-shrink:0;"><img src="${p.image}" style="width:100%;height:100%;object-fit:cover;object-position:center top;display:block;" crossorigin="anonymous"></div>`
    : `<div style="width:160px;height:160px;border-radius:50%;background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;font-size:64px;font-weight:900;color:white;border:5px solid ${tc};box-shadow:0 0 40px ${tc}80;flex-shrink:0;">${p.name.charAt(0)}</div>`;

  // Son maÃ§ barlarÄ±
  const recentGames = loadGames().filter(g=>g.p1Name===p.name||g.p2Name===p.name)
    .sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,10);
  const formBars = recentGames.length > 0
    ? recentGames.reverse().map(g=>{
        const win=g.winner===p.name; const draw=g.winner==='Berabere';
        return `<div style="width:32px;height:40px;border-radius:7px;background:${draw?'#f59e0b':win?'#22c55e':'#ef4444'};display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;color:white;box-shadow:0 2px 8px rgba(0,0,0,.4)">${draw?'B':win?'G':'M'}</div>`;
      }).join('')
    : '<div style="color:rgba(255,255,255,.4);font-size:13px;padding:6px">HenÃ¼z kayÄ±tlÄ± oyun yok</div>';

  // AtÄ±ÅŸ tipi istatistikleri (eleme panelindeki gibi)
  const atisTypesD = ['TOP','BASKET','STICK','DÄ°SK','BUMERANG','DAMBIL','KÃœP','HALKA','Ã‡EKÄ°Ã‡','KUM TORBASI','KONDURMA'];
  const atisIconsD = {'TOP':'âš½','BASKET':'ğŸ€','STICK':'ğŸ’','DÄ°SK':'ğŸ¥','BUMERANG':'ğŸªƒ','DAMBIL':'ğŸ‹','KÃœP':'ğŸ“¦','HALKA':'â­•','Ã‡EKÄ°Ã‡':'ğŸ”¨','KUM TORBASI':'ğŸ¥Š','KONDURMA':'ğŸ¯'};
  const atisStatsD = {};
  atisTypesD.forEach(at => { atisStatsD[at] = {wins:0, total:0}; });
  loadGames().filter(g=>g.p1Name===p.name||g.p2Name===p.name).forEach(g => {
    const isW = g.winner === p.name;
    const atisKey = g.atisType || '';
    if (atisKey && atisStatsD[atisKey] !== undefined) {
      atisStatsD[atisKey].total++; if (isW) atisStatsD[atisKey].wins++;
    } else {
      atisTypesD.forEach(at => {
        if ((g.gameType||'').toUpperCase().includes(at)) {
          atisStatsD[at].total++; if (isW) atisStatsD[at].wins++;
        }
      });
    }
  });
  const atisEntD = atisTypesD.map(at=>({at, st:atisStatsD[at]})).filter(x=>x.st.total>0);
  const atisHtmlD = atisEntD.length === 0
    ? '<div style="color:rgba(255,255,255,.4);font-size:12px;padding:8px">KayÄ±tlÄ± atÄ±ÅŸ verisi yok</div>'
    : '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px">' +
      atisEntD.map(({at,st}) => {
        const atWr = Math.round((st.wins/st.total)*100);
        const ac = atWr>=60?'#22c55e':atWr>=40?'#f59e0b':'#ef4444';
        return `<div style="background:rgba(0,0,0,.45);border-radius:10px;padding:10px 6px;text-align:center;border:1px solid ${ac}40;">
          <div style="font-size:20px">${atisIconsD[at]||'ğŸ¯'}</div>
          <div style="font-size:10px;font-weight:800;margin:3px 0;color:white;letter-spacing:.03em">${at}</div>
          <div style="font-size:18px;font-weight:900;color:${ac}">%${atWr}</div>
          <div style="font-size:9px;color:rgba(255,255,255,.45)">${st.wins}G/${st.total}T</div>
          <div style="height:4px;border-radius:2px;background:rgba(255,255,255,.12);overflow:hidden;margin-top:5px">
            <div style="height:100%;width:${atWr}%;background:${ac};border-radius:2px"></div>
          </div>
        </div>`;
      }).join('') + '</div>';

  // H2H - TÃœM rakipler
  let h2hLines = [];
  players.forEach(opp => {
    if (opp.id === p.id) return;
    const h = p.h2hRegistry[opp.id] || {total:0,wins:0,losses:0};
    if (h.total > 0) h2hLines.push({name:opp.name,h,opp});
  });
  h2hLines.sort((a,b) => b.h.total - a.h.total);
  // Psikolojik ÃœstÃ¼nlÃ¼k Analizi
  const dominated = h2hLines.filter(x => x.h.total >= 2 && (x.h.wins/x.h.total) >= 0.7); // %70+ Ã¼stÃ¼nlÃ¼k
  const dominated_by = h2hLines.filter(x => x.h.total >= 2 && (x.h.wins/x.h.total) <= 0.3); // %30- zayÄ±flÄ±k
  const even = h2hLines.filter(x => x.h.total >= 2 && (x.h.wins/x.h.total) > 0.3 && (x.h.wins/x.h.total) < 0.7);
  const totalH2H = h2hLines.reduce((acc,x) => acc + x.h.total, 0);
  const totalH2HWins = h2hLines.reduce((acc,x) => acc + x.h.wins, 0);
  const overallWR = totalH2H ? Math.round((totalH2HWins/totalH2H)*100) : 0;
  const psychColor = overallWR >= 60 ? '#22c55e' : overallWR >= 45 ? '#f59e0b' : '#ef4444';
  const psychLevel = overallWR >= 70 ? 'ğŸ”¥ BASKICI' : overallWR >= 55 ? 'ğŸ’ª GÃœÃ‡LÃœ' : overallWR >= 45 ? 'âš–ï¸ DENGELÄ°' : overallWR >= 30 ? 'ğŸ˜¬ SAVUNMACI' : 'â— BASKILANIYOR';
  
  const psychHtml = h2hLines.length < 2 ? `<div style="color:rgba(255,255,255,.4);font-size:14px;padding:8px">Yeterli birebir veri yok (min. 2 farklÄ± rakip gerekli)</div>` : `
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px;">
      <div style="background:rgba(0,0,0,.4);border-radius:12px;padding:14px;text-align:center;border:1px solid rgba(34,197,94,.3);">
        <div style="font-size:11px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px">PSÄ°K. OVERALLi</div>
        <div style="font-size:36px;font-weight:900;color:${psychColor}">${overallWR}%</div>
        <div style="font-size:12px;color:white;font-weight:700;margin-top:4px">${psychLevel}</div>
      </div>
      <div style="background:rgba(0,0,0,.4);border-radius:12px;padding:14px;text-align:center;border:1px solid rgba(34,197,94,.3);">
        <div style="font-size:11px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px">ÃœSTÃœN OLDUÄU</div>
        <div style="font-size:32px;font-weight:900;color:#22c55e">${dominated.length}</div>
        <div style="font-size:11px;color:rgba(255,255,255,.4);margin-top:2px">${dominated.map(x=>x.name.split(' ')[0]).join(', ')||'â€”'}</div>
      </div>
      <div style="background:rgba(0,0,0,.4);border-radius:12px;padding:14px;text-align:center;border:1px solid rgba(239,68,68,.3);">
        <div style="font-size:11px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px">ZOR BULDUÄU</div>
        <div style="font-size:32px;font-weight:900;color:#ef4444">${dominated_by.length}</div>
        <div style="font-size:11px;color:rgba(255,255,255,.4);margin-top:2px">${dominated_by.map(x=>x.name.split(' ')[0]).join(', ')||'â€”'}</div>
      </div>
    </div>
    <div style="height:10px;border-radius:5px;background:rgba(255,255,255,.1);overflow:hidden;margin-bottom:8px;">
      <div style="height:100%;width:${overallWR}%;background:linear-gradient(to right,${psychColor},${overallWR>=50?'#4ade80':'#f87171'});border-radius:5px;"></div>
    </div>
    <div style="font-size:12px;color:rgba(255,255,255,.35);text-align:center">${totalH2HWins} galibiyet / ${totalH2H} toplam birebir maÃ§</div>
  `;

  const h2hHtml = h2hLines.length > 0
    ? h2hLines.map(({name,h,opp})=>{
        const hwr = Math.round((h.wins/h.total)*100);
        const hc = hwr >= 50 ? '#4ade80' : '#f87171';
        const oppTc = opp.team === 'kirmizi' ? '#ef4444' : '#3b82f6';
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 12px;background:rgba(255,255,255,.07);border-radius:9px;margin-bottom:5px;border-left:3px solid ${oppTc};">
          <span style="font-size:17px;color:white;font-weight:800">${name}</span>
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:14px;color:rgba(255,255,255,.5)">${h.wins}G Â· ${h.losses}Y Â· ${h.total}T</span>
            <span style="font-size:18px;font-weight:900;color:${hc}">%${hwr}</span>
          </div>
        </div>`;
      }).join('')
    : '<div style="color:rgba(255,255,255,.4);font-size:13px;text-align:center;padding:12px">Birebir veri yok</div>';

  const dateStr2 = new Date().toLocaleDateString('tr-TR', {day:'2-digit',month:'long',year:'numeric'});

  cvDiv.innerHTML = `<div id="elim_design_inner" style="background:${teamBg};width:1080px;min-height:1350px;font-family:'Barlow Condensed',sans-serif;position:relative;overflow:hidden;display:flex;flex-direction:column;">
    <!-- Su iÅŸareti arkaplan -->
    <div style="position:absolute;inset:0;opacity:.04;display:flex;align-items:center;justify-content:center;pointer-events:none;overflow:hidden;">
      <span style="font-size:110px;font-weight:900;color:white;transform:rotate(-25deg);white-space:nowrap;letter-spacing:.2em">SurvivorMetrics</span>
    </div>
    <!-- Renk parlamalarÄ± -->
    <div style="position:absolute;top:-100px;right:-100px;width:600px;height:600px;background:radial-gradient(circle,${tc}25,transparent 65%);pointer-events:none;z-index:1;"></div>
    <div style="position:absolute;bottom:-150px;left:-100px;width:500px;height:500px;background:radial-gradient(circle,${tc}15,transparent 65%);pointer-events:none;z-index:1;"></div>

    <!-- ÃœST BAÅLIK -->
    <div style="position:relative;z-index:3;background:rgba(0,0,0,.8);padding:18px 44px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid ${tc}60;">
      <div style="display:flex;align-items:center;gap:14px;">
        <div style="width:5px;height:40px;background:#ef4444;border-radius:3px;box-shadow:0 0 10px #ef444480;"></div>
        <div>
          <div style="font-size:11px;color:rgba(255,255,255,.5);letter-spacing:.4em;text-transform:uppercase;margin-bottom:2px">SURVIVOR 2025</div>
          <div style="font-size:30px;font-weight:900;color:white;letter-spacing:.2em;text-transform:uppercase;text-shadow:0 2px 10px rgba(0,0,0,.6)">ğŸš¨ ELEME ADAYI</div>
        </div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:11px;color:rgba(255,255,255,.4);letter-spacing:.2em;font-weight:700;text-transform:uppercase">SURVIVORMETRICS</div>
        <div style="font-size:10px;color:rgba(255,255,255,.25);margin-top:2px">${dateStr2}</div>
      </div>
    </div>

    <!-- YARIÅMACI TANITIM ALANI: sol yuvarlak foto, saÄŸda isim/takÄ±m/istatistikler -->
    <div style="position:relative;z-index:2;padding:32px 44px 24px;display:flex;align-items:center;gap:32px;border-bottom:1px solid rgba(255,255,255,.1);">
      <!-- Yuvarlak fotoÄŸraf -->
      <div style="display:flex;flex-direction:column;align-items:center;gap:14px;flex-shrink:0;">
        ${circleImg}
        <div style="text-align:center;">
          <div style="font-size:10px;color:${tcLight};font-weight:700;letter-spacing:.25em;text-transform:uppercase;margin-bottom:4px">${teamLabel}</div>
          <div style="font-size:42px;font-weight:900;color:white;letter-spacing:.06em;text-transform:uppercase;line-height:1;text-shadow:0 2px 10px rgba(0,0,0,.6)">${p.name}</div>
          ${p.status ? `<div style="margin-top:6px;display:inline-block;background:rgba(255,215,0,.15);border:1px solid #FFD700;border-radius:20px;padding:4px 16px;font-size:16px;font-weight:900;color:#FFD700;letter-spacing:.12em">${p.status}</div>` : ''}
        </div>
      </div>
      <!-- SaÄŸ: 4 ana istatistik + Power Score -->
      <div style="flex:1;display:flex;flex-direction:column;gap:12px;">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
          ${[['TOPLAM',s.total,'rgba(255,255,255,.9)'],['GALÄ°BÄ°YET',s.wins,'#4ade80'],['YENÄ°LGÄ°',s.losses,'#f87171'],['WIN RATE',wr+'%',Number(wr)>=50?'#4ade80':'#f87171']].map(([lbl,val,col])=>`
          <div style="background:rgba(0,0,0,.45);border-radius:14px;padding:14px 10px;text-align:center;border:1px solid rgba(255,255,255,.1);">
            <div style="font-size:12px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.15em;margin-bottom:5px;font-weight:700">${lbl}</div>
            <div style="font-size:38px;font-weight:900;color:${col};line-height:1;font-family:'Barlow Condensed',sans-serif">${val}</div>
          </div>`).join('')}
        </div>
        <!-- Power Score -->
        <div style="background:rgba(0,0,0,.45);border-radius:14px;padding:14px 18px;border:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:16px;">
          <div>
            <div style="font-size:9px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.15em;margin-bottom:4px;font-weight:700">âš¡ POWER SCORE</div>
            <div style="display:flex;align-items:baseline;gap:10px;">
              <span style="font-size:56px;font-weight:900;color:${ps.scoreColor};text-shadow:0 0 20px ${ps.scoreColor}70;line-height:1;font-family:'Barlow Condensed',sans-serif">${ps.score}</span>
              <span style="font-size:14px;font-weight:800;color:white;background:rgba(255,255,255,.12);padding:5px 12px;border-radius:18px;border:1px solid rgba(255,255,255,.18)">${ps.badge}</span>
            </div>
          </div>
          <div style="flex:1;">
            <div style="height:8px;border-radius:4px;background:rgba(255,255,255,.1);overflow:hidden;margin-bottom:4px;">
              <div style="height:100%;width:${ps.score}%;background:${ps.scoreColor};border-radius:4px;transition:width .3s;"></div>
            </div>
            <div style="font-size:9px;color:rgba(255,255,255,.3)">0 â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 100</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SON MAÃ‡LAR -->
    <div style="position:relative;z-index:2;padding:20px 44px;border-bottom:1px solid rgba(255,255,255,.1);">
      <div style="font-size:13px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.2em;margin-bottom:12px;font-weight:700">ğŸ“Š SON MAÃ‡LAR</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">${formBars}</div>
    </div>

    <!-- ATIÅ TÄ°PÄ° Ä°STATÄ°STÄ°KLERÄ° -->
    <div style="position:relative;z-index:2;padding:20px 44px;border-bottom:1px solid rgba(255,255,255,.1);">
      <div style="font-size:13px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.2em;margin-bottom:12px;font-weight:700">ğŸ¯ ATIÅ TÄ°PÄ° BAÅARISI</div>
      ${atisHtmlD}
    </div>

    <!-- PSÄ°KOLOJÄ°K ÃœSTÃœNLÃœK ANALÄ°ZÄ° -->
    <div style="position:relative;z-index:2;padding:20px 44px;border-bottom:1px solid rgba(255,255,255,.1);">
      <div style="font-size:13px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.2em;margin-bottom:12px;font-weight:700">ğŸ§  PSÄ°KOLOJÄ°K ÃœSTÃœNLÃœK ANALÄ°ZÄ°</div>
      ${psychHtml}
    </div>

    <!-- BÄ°REBÄ°R Ä°STATÄ°STÄ°KLER -->
    <div style="position:relative;z-index:2;padding:20px 44px;flex:1;">
      <div style="font-size:13px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.2em;margin-bottom:12px;font-weight:700">âš”ï¸ BÄ°REBÄ°R Ä°STATÄ°STÄ°KLER (TÃœM RAKIPLER)</div>
      ${h2hHtml}
    </div>

    <!-- FOOTER -->
    <div style="position:relative;z-index:3;background:rgba(0,0,0,.7);padding:14px 44px;display:flex;justify-content:space-between;align-items:center;border-top:1px solid ${tc}40;">
      <div style="display:flex;align-items:center;gap:8px;">
        <div style="width:8px;height:8px;border-radius:50%;background:${tc};box-shadow:0 0 6px ${tc};"></div>
        <span style="font-size:11px;color:rgba(255,255,255,.4);letter-spacing:.2em;font-weight:700;text-transform:uppercase">${teamLabel}</span>
      </div>
      <span style="font-size:10px;color:rgba(255,255,255,.3);letter-spacing:.15em;font-weight:700;text-transform:uppercase">SURVIVORMETRICS Â· ${dateStr2}</span>
    </div>
  </div>`;
}

function downloadElimDesignImage() {
  const cvDiv = document.getElementById('elim_design_canvas');
  if (!cvDiv || !cvDiv.innerHTML.trim()) { alert('Ã–nce tasarÄ±m oluÅŸturun.'); return; }
  const inner = cvDiv.querySelector('#elim_design_inner') || cvDiv.firstElementChild;
  if (!inner) return;
  _downloadDesignHD(inner, 'eleme-adayi-tasarim-' + Date.now() + '.png');
}

// ======================================================
// GÃœNLÃœK MVP TABLOSU
// ======================================================
function buildMVPDesign() {
  const cvDiv = document.getElementById('mvp_design_canvas');
  if (!cvDiv) return;
  const allGames = loadGames();
  if (allGames.length === 0) {
    cvDiv.innerHTML = '<div style="background:#0c0f18;padding:40px;text-align:center;color:rgba(255,255,255,.5);font-family:Barlow,sans-serif;font-size:16px;width:1080px;">HenÃ¼z kayÄ±tlÄ± oyun yok.</div>';
    return;
  }
  // BugÃ¼nÃ¼n oyunlarÄ±nÄ± al (son 24 saat veya bugÃ¼n)
  const today = new Date(); today.setHours(0,0,0,0);
  let todayGames = allGames.filter(g => g.date && new Date(g.date) >= today);
  if (todayGames.length === 0) {
    // BugÃ¼n yok â†’ son 8 oyunu al (tarih sÄ±rasÄ±na gÃ¶re)
    todayGames = [...allGames].sort((a,b)=>new Date(b.date||0)-new Date(a.date||0)).slice(0, 8);
  }
  
  // Her yarÄ±ÅŸmacÄ±nÄ±n performansÄ±nÄ± Ã¶lÃ§
  const perfMap = {};
  players.forEach(p => { perfMap[p.name] = {wins:0,total:0,name:p.name}; });
  todayGames.forEach(g => {
    if (!g.p1Name || !g.p2Name) return;
    if (g.source === 'flag') {
      // Bayrak oyununda bireysel yarÄ±ÅŸmacÄ±lara puan ver
      const winTeam = g.winner === 'KÄ±rmÄ±zÄ±' ? 'red' : g.winner === 'Mavi' ? 'blue' : null;
      const redNames = g.redPlayers || [];
      const blueNames = g.bluePlayers || [];
      [...redNames, ...blueNames].forEach(name => {
        if (!name) return;
        if (!perfMap[name]) perfMap[name] = {wins:0,total:0,name};
        perfMap[name].total++;
        const isWin = (winTeam === 'red' && redNames.includes(name)) || (winTeam === 'blue' && blueNames.includes(name));
        if (isWin) perfMap[name].wins++;
      });
    } else {
      [g.p1Name, g.p2Name].forEach(name => {
        if (!perfMap[name]) perfMap[name] = {wins:0,total:0,name};
        perfMap[name].total++;
        if (g.winner === name) perfMap[name].wins++;
      });
    }
  });
  
  // En iyi 4 yarÄ±ÅŸmacÄ±yÄ± bul - her takÄ±mdan en iyi 2
  // WR > 50% veya en azÄ±ndan galibiyet > yenilgi olanlar
  const allSorted = Object.values(perfMap).filter(x=>x.total>0)
    .sort((a,b)=>{
      const wrA = a.total ? a.wins/a.total : 0;
      const wrB = b.total ? b.wins/b.total : 0;
      if (wrB !== wrA) return wrB - wrA;
      return b.wins - a.wins;
    });

  // Her takÄ±mdan en iyi 2'yi al
  const getTeam = name => { const pl = players.find(p=>p.name===name); return pl?.team||''; };
  const redBest = allSorted.filter(x => getTeam(x.name)==='kirmizi').slice(0,2);
  const blueBest = allSorted.filter(x => getTeam(x.name)==='mavi').slice(0,2);
  // EÄŸer bir takÄ±mdan 2 kiÅŸi yoksa diÄŸer takÄ±mdan doldur
  let top4 = [...redBest, ...blueBest];
  if (top4.length < 4) {
    const others = allSorted.filter(x => !top4.find(t=>t.name===x.name));
    while (top4.length < 4 && others.length > 0) top4.push(others.shift());
  }
  // MVP'yi win rate'e gÃ¶re Ã¶ne al
  top4.sort((a,b) => {
    const wrA = a.total ? a.wins/a.total : 0;
    const wrB = b.total ? b.wins/b.total : 0;
    return wrB - wrA;
  });
  const mvpPlayer = players.find(p => p.name === (top4[0]?.name));
  const titleText = document.getElementById('cfg_title')?.value || 'SURVIVOR 2026';
  const dateStr = new Date().toLocaleDateString('tr-TR', {day:'2-digit',month:'long',year:'numeric'});
  
  const cardHtml = top4.map((perf, i) => {
    const p = players.find(pl => pl.name === perf.name);
    if (!p) return '';
    const tc = p.team === 'kirmizi' ? '#ef4444' : '#3b82f6';
    const teamBgCard = p.team === 'kirmizi'
      ? 'linear-gradient(135deg,#5a0000,#8b0000)'
      : 'linear-gradient(135deg,#001f5c,#003399)';
    const isMVP = i === 0;
    const wr = perf.total ? Math.round((perf.wins/perf.total)*100) : 0;
    const sz = isMVP ? 110 : 80;
    const imgHtml = p.image
      ? `<div style="width:${sz}px;height:${sz}px;border-radius:50%;overflow:hidden;border:${isMVP?'5':'3'}px solid ${isMVP?'#FFD700':'rgba(255,255,255,.4)'};box-shadow:0 4px 20px rgba(0,0,0,.4);flex-shrink:0;"><img src="${p.image}" style="width:100%;height:100%;object-fit:cover;object-position:center;display:block;" crossorigin="anonymous"></div>`
      : `<div style="width:${sz}px;height:${sz}px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:${isMVP?40:28}px;font-weight:900;color:white;border:${isMVP?5:3}px solid ${isMVP?'#FFD700':'rgba(255,255,255,.4)'};flex-shrink:0;">${p.name.charAt(0)}</div>`;
    return `<div style="background:${teamBgCard};border-radius:16px;overflow:hidden;padding:${isMVP?'20':'14'}px;text-align:center;position:relative;border:${isMVP?'2px solid #FFD700':'1px solid rgba(255,255,255,.15)'};box-shadow:${isMVP?'0 0 30px rgba(255,215,0,.3)':'none'};">
      ${isMVP ? '<div style="position:absolute;top:10px;right:10px;font-size:22px">ğŸ†</div>' : ''}
      ${isMVP ? `<div style="font-size:11px;letter-spacing:.2em;color:#FFD700;font-weight:900;text-transform:uppercase;margin-bottom:8px">MVP</div>` : `<div style="font-size:10px;color:rgba(255,255,255,.5);font-weight:700;text-transform:uppercase;margin-bottom:6px">#${i+1}</div>`}
      <div style="display:flex;justify-content:center;margin-bottom:8px">${imgHtml}</div>
      <div style="font-size:${isMVP?'18':'14'}px;font-weight:900;color:white;text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px">${p.name}</div>
      <div style="font-size:${isMVP?'32':'24'}px;font-weight:900;color:${wr>=50?'#4ade80':'#f87171'};margin-bottom:2px">${perf.wins}G</div>
      <div style="font-size:10px;color:rgba(255,255,255,.5);margin-bottom:6px">${perf.total} maÃ§ Â· %${wr}</div>
      <div style="height:5px;border-radius:3px;background:rgba(255,255,255,.15);overflow:hidden;">
        <div style="height:100%;width:${wr}%;background:${wr>=50?'#22c55e':'#ef4444'};border-radius:3px;"></div>
      </div>
    </div>`;
  }).join('');
  
  const gamesList = todayGames.slice(0,6).map(g=>{
    const wc = g.winner && g.winner!=='Berabere'
      ? (players.find(p=>p.name===g.winner)?.team==='kirmizi'?'#ef4444':'#3b82f6')
      : '#64748b';
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 12px;background:rgba(255,255,255,.06);border-radius:8px;margin-bottom:4px;">
      <span style="font-size:12px;color:rgba(255,255,255,.7);font-weight:700">${g.p1Name||'?'}</span>
      <span style="font-size:14px;font-weight:900;color:white;margin:0 8px">${g.p1Score||0} â€” ${g.p2Score||0}</span>
      <span style="font-size:12px;color:rgba(255,255,255,.7);font-weight:700">${g.p2Name||'?'}</span>
      <span style="font-size:10px;color:${wc};font-weight:800;margin-left:8px">${g.winner&&g.winner!=='Berabere'?'ğŸ† '+g.winner:'ğŸ¤'}</span>
    </div>`;
  }).join('');
  
  cvDiv.innerHTML = `<div style="background:#0c0f18;width:1080px;font-family:'Barlow Condensed',sans-serif;position:relative;overflow:hidden;">
    <div style="position:absolute;inset:0;opacity:.05;display:flex;align-items:center;justify-content:center;pointer-events:none;">
      <span style="font-size:100px;font-weight:900;color:white;transform:rotate(-25deg);white-space:nowrap;letter-spacing:.3em">SurvivorMetrics</span>
    </div>
    <div style="padding:28px 36px 18px;text-align:center;border-bottom:2px solid rgba(255,255,255,.1);position:relative;z-index:2;">
      <div style="font-size:11px;letter-spacing:.5em;color:rgba(255,255,255,.5);text-transform:uppercase;margin-bottom:4px">ğŸ… GÃœNLÃœK PERFORMANS</div>
      <div style="font-size:52px;font-weight:900;color:white;letter-spacing:.2em;font-style:italic">${titleText}</div>
      <div style="font-size:13px;color:rgba(255,255,255,.5);margin-top:4px;letter-spacing:.15em">${dateStr}</div>
    </div>
    <div style="padding:24px 36px;position:relative;z-index:2;">
      <div style="font-size:10px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.15em;margin-bottom:14px;font-weight:700">ğŸ”¥ EN Ä°YÄ° PERFORMANS â€” TOP ${top4.length}</div>
      <div style="display:grid;grid-template-columns:repeat(${Math.min(top4.length,4)},1fr);gap:12px;margin-bottom:24px;">
        ${cardHtml}
      </div>
      ${todayGames.length > 0 ? `<div style="font-size:10px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.15em;margin-bottom:10px;font-weight:700">ğŸ“‹ BUGÃœNKÃœ OYUNLAR (${todayGames.length})</div>
      <div>${gamesList}</div>` : ''}
    </div>
    <div style="padding:10px 36px;border-top:1px solid rgba(255,255,255,.08);position:relative;z-index:2;text-align:right;">
      <span style="font-size:10px;color:rgba(255,255,255,.25);letter-spacing:.2em;font-weight:700;text-transform:uppercase">SURVIVORMETRICS Â· ${dateStr}</span>
    </div>
  </div>`;
}

function downloadMVPImage() {
  const cvDiv = document.getElementById('mvp_design_canvas');
  if (!cvDiv || !cvDiv.innerHTML.trim()) { alert('Ã–nce tasarÄ±m oluÅŸturun.'); return; }
  const inner = cvDiv.firstElementChild;
  if (!inner) return;
  _downloadDesignHD(inner, 'gunluk-mvp-' + Date.now() + '.png');
}




// ======================================================
// TEKLÄ° KAYIT (ESKÄ° VERÄ° / RAKÄ°PSÄ°Z)
// ======================================================
function openSoloEntry(){
  const form = document.getElementById('solo_entry_form');
  if(!form) return;
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  // YarÄ±ÅŸmacÄ± listesini doldur
  const sel = document.getElementById('solo_player');
  if(sel) sel.innerHTML = players.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
  document.getElementById('solo_status').textContent = '';
}

function saveSoloEntry(){
  const pIdx = Number(document.getElementById('solo_player')?.value||0);
  const result = document.getElementById('solo_result')?.value||'win';
  const atisType = document.getElementById('solo_atis')?.value||'';
  const count = Math.max(1, parseInt(document.getElementById('solo_count')?.value||1));
  const note = document.getElementById('solo_note')?.value||'';
  const p = players[pIdx];
  if(!p){ alert('YarÄ±ÅŸmacÄ± bulunamadÄ±!'); return; }

  // Oyun kaydÄ± oluÅŸtur (sadece atÄ±ÅŸ tÃ¼rÃ¼ istatistikleri iÃ§in)
  const games = loadGames();
  for(let i=0;i<count;i++){
    games.unshift({
      id: uid(), source: 'solo', date: new Date().toISOString(),
      gameType: atisType||'Tekli KayÄ±t', atisType,
      p1Name: p.name, p2Name: 'â€”', p1Team: p.team, p2Team: 'â€”',
      winner: result==='win' ? p.name : 'â€”',
      loser: result==='win' ? 'â€”' : p.name,
      title: p.name + ' Tekli KayÄ±t', label: 'Tekli',
      note
    });
  }
  saveGames(games);
  buildGamesList();

  const statusEl = document.getElementById('solo_status');
  if(statusEl) statusEl.innerHTML = `<span style="color:#10b981;font-weight:700">âœ“ ${p.name} iÃ§in ${count} adet ${result==='win'?'galibiyet':'maÄŸlubiyet'} eklendi!</span>`;
  // Reset
  document.getElementById('solo_count').value = 1;
  document.getElementById('solo_note').value = '';
}

// ======================================================
// YENÄ° TASARIM â€” DÃœELLO KARTI
// ======================================================
const ndBigPhotos = { 1: null, 2: null };

function ndLoadBigPhoto(slot) {
  const input = document.getElementById('nd_bigphoto' + slot);
  if (!input || !input.files || !input.files[0]) return;
  const reader = new FileReader();
  reader.onload = e => {
    // AkÄ±llÄ± kÄ±rpma: Canvas ile yÃ¼z/omuz hizasÄ±nÄ± normalize et
    const img = new Image();
    img.onload = () => {
      // Hedef en-boy oranÄ±: 9:16 portre (yarÄ±m ekran iÃ§in ideal)
      const targetW = 540;
      const targetH = 608;
      const canvas = document.createElement('canvas');
      canvas.width = targetW;
      canvas.height = targetH;
      const ctx = canvas.getContext('2d');

      // FotoÄŸrafÄ±n orijinal oranÄ±nÄ± hesapla
      const imgRatio = img.width / img.height;
      const targetRatio = targetW / targetH;

      let srcX = 0, srcY = 0, srcW = img.width, srcH = img.height;

      if (imgRatio > targetRatio) {
        // FotoÄŸraf hedeften daha geniÅŸ â€” geniÅŸliÄŸi kÄ±rp, yatay ortala
        srcW = img.height * targetRatio;
        srcX = (img.width - srcW) / 2;
        srcY = 0;
        srcH = img.height;
      } else {
        // FotoÄŸraf hedeften daha uzun / aynÄ± â€” Ã¼stten baÅŸlayarak al
        // YÃ¼z/kafa Ã¼stte olduÄŸu iÃ§in top: 0'dan baÅŸlÄ±yoruz
        srcH = img.width / targetRatio;
        srcX = 0;
        srcY = 0; // YÃ¼zÃ¼ korumak iÃ§in Ã¼stten baÅŸla
        srcW = img.width;
      }

      ctx.drawImage(img, srcX, srcY, srcW, srcH, 0, 0, targetW, targetH);
      ndBigPhotos[slot] = canvas.toDataURL('image/jpeg', 0.92);
      const prev = document.getElementById('nd_bp' + slot + '_preview');
      if (prev) prev.innerHTML = `<span style="color:#10b981;font-weight:700">âœ“ AkÄ±llÄ± kÄ±rpma tamamlandÄ± (${img.width}Ã—${img.height} â†’ ${targetW}Ã—${targetH})</span>`;
      buildNewDesign();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(input.files[0]);
}

function ndClearPhoto(slot) {
  ndBigPhotos[slot] = null;
  const input = document.getElementById('nd_bigphoto' + slot);
  if (input) input.value = '';
  const prev = document.getElementById('nd_bp' + slot + '_preview');
  if (prev) prev.innerHTML = '';
  buildNewDesign();
}

function populateNewDesignSels(){
  ['nd_p1','nd_p2'].forEach((id,si)=>{
    const sel=document.getElementById(id);if(!sel)return;
    const cur=sel.value;
    // Default to main page selections
    const mainIdx = si===0?p1i:p2i;
    sel.innerHTML=players.map((p,i)=>`<option value="${i}" ${String(i)===(cur||String(mainIdx))?'selected':''}>${p.name}</option>`).join('');
  });
  // Auto-fill from main page fields
  const mainTitle = document.getElementById('cfg_title')?.value||'';
  const mainHt = document.getElementById('cfg_ht')?.value||'';
  const ndTitle = document.getElementById('nd_title');
  const ndSubtitle = document.getElementById('nd_subtitle');
  if(ndTitle && ndTitle.dataset.userEdited!=='1') { ndTitle.value = mainHt || ndTitle.value; }
  if(ndSubtitle && ndSubtitle.dataset.userEdited!=='1') { ndSubtitle.value = mainTitle || ndSubtitle.value; }
  // Sync scores from main page
  const s1el = document.getElementById('nd_s1'); const s2el = document.getElementById('nd_s2');
  if(s1el && s1el.dataset.userEdited!=='1') { const ms1 = document.getElementById('e1_score')?.value; if(ms1) s1el.value=ms1; }
  if(s2el && s2el.dataset.userEdited!=='1') { const ms2 = document.getElementById('e2_score')?.value; if(ms2) s2el.value=ms2; }
  // Sync game type from main page badges
  const b1val = document.getElementById('cfg_b1')?.value||'';
  const ndGametype = document.getElementById('nd_gametype');
  if(ndGametype && ndGametype.dataset.userEdited!=='1' && b1val) { ndGametype.value=b1val; }
  // Sync winner from main page
  const ndWinner = document.getElementById('nd_winner');
  if(ndWinner && ndWinner.dataset.userEdited!=='1') {
    const p1 = players[p1i]; const p2 = players[p2i];
    if(p1&&p2) {
      const score1=parseInt(document.getElementById('e1_score')?.value||'0');
      const score2=parseInt(document.getElementById('e2_score')?.value||'0');
      if(score1>score2) ndWinner.value='p1';
      else if(score2>score1) ndWinner.value='p2';
    }
  }
}

// â”€â”€ Tema paleti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Her temada istatistik rakamlarÄ± TEK renk (beyaz/temaya uygun) â€” renkli deÄŸil
const ND_THEMES = {
  dark: {
    cardBg      : '#060810',
    headerBg    : 'rgba(0,0,0,.96)',
    headerBorder: 'rgba(255,255,255,.1)',
    subtitleClr : 'rgba(255,255,255,.5)',
    titleClr    : '#ffffff',
    gametagBg   : 'rgba(255,255,255,.12)',
    gametagBorder:'rgba(255,255,255,.28)',
    gametagClr  : 'rgba(255,255,255,.9)',
    bgGrad      : (team) => team==='kirmizi'
      ? 'linear-gradient(160deg,#3a0000 0%,#6b0000 40%,#1a0000 100%)'
      : 'linear-gradient(160deg,#000830 0%,#00256a 40%,#000416 100%)',
    overlay     : (team) => team==='kirmizi' ? 'rgba(100,0,0,0.16)':'rgba(0,8,60,0.16)',
    fadeL       : 'rgba(6,8,16,1)',
    fadeEdge    : 'rgba(6,8,16,',
    statBg      : 'rgba(0,0,0,.82)',
    statBorder  : 'rgba(255,255,255,.18)',
    statHdrBg   : 'rgba(255,255,255,.07)',
    statHdrClr  : 'rgba(255,255,255,.5)',
    statNumClr  : '#ffffff',         // genel satÄ±r rengi
    statSubClr  : 'rgba(255,255,255,.7)', // h2h satÄ±r rengi
    statDivClr  : 'rgba(255,255,255,.08)',
    vsBg        : 'rgba(6,8,16,0.97)',
    vsBorder    : 'rgba(255,255,255,.25)',
    vsClr       : '#ffffff',
    divClr      : 'rgba(255,255,255,.5)',
    nameShadow  : 'rgba(0,0,0,1)',
    nameClr     : '#ffffff',
    wmClr       : 'rgba(255,255,255,.1)',
    isSplit     : false,
  },
  gold: {
    // ALTIN ÅEREF TEMASÄ° â€” siyah zemin, altÄ±n apolet ÅŸeritleri, general gÃ¶rÃ¼nÃ¼mÃ¼
    cardBg      : '#0a0800',
    headerBg    : 'linear-gradient(180deg,#1a1200 0%,#0d0900 60%,#060400 100%)',
    headerBorder: '#C9A227',
    subtitleClr : '#C9A227',
    titleClr    : '#FFD700',
    gametagBg   : 'rgba(201,162,39,.15)',
    gametagBorder:'#C9A227',
    gametagClr  : '#FFD700',
    bgGrad      : (_) => 'linear-gradient(175deg,#0f0900 0%,#1c1000 35%,#080500 100%)',
    overlay     : (_) => 'rgba(0,0,0,0.35)',
    fadeL       : 'rgba(10,8,0,1)',
    fadeEdge    : 'rgba(10,8,0,',
    statBg      : '#0d0a00',
    statBorder  : '#C9A227',
    statHdrBg   : 'rgba(201,162,39,.2)',
    statHdrClr  : '#C9A227',
    statNumClr  : '#FFD700',
    statSubClr  : '#C9A227',
    statDivClr  : 'rgba(201,162,39,.3)',
    vsBg        : '#0d0a00',
    vsBorder    : '#FFD700',
    vsClr       : '#FFD700',
    divClr      : '#C9A227',
    nameShadow  : '#000000',
    nameClr     : '#FFD700',
    wmClr       : 'rgba(201,162,39,.3)',
    isSplit     : false,
    // Tema Ã¶zel ek Ã¶zellikler
    headerFont  : "'Georgia','Times New Roman',serif",
    titleStyle  : 'letter-spacing:.35em;text-shadow:0 0 30px rgba(255,215,0,.6),0 2px 4px rgba(0,0,0,1);',
    subtitleStyle:'letter-spacing:.5em;text-shadow:0 0 15px rgba(201,162,39,.5);',
    scoreGrad   : 'linear-gradient(135deg,#0a0800,#1c1400,#0a0800)',
    scoreClr    : '#FFD700',
    winnerGrad  : 'linear-gradient(90deg,#0a0800,#2a1f00,#0a0800)',
    winnerBorder: '#C9A227',
    winnerClr   : '#FFD700',
    apoletLines : true,
  },
  red: {
    cardBg      : '#0f0005',
    headerBg    : 'rgba(15,0,5,.98)',
    headerBorder: 'rgba(239,68,68,.4)',
    subtitleClr : '#fca5a5',
    titleClr    : '#fff0f0',
    gametagBg   : 'rgba(239,68,68,.2)',
    gametagBorder:'rgba(239,68,68,.6)',
    gametagClr  : '#fca5a5',
    bgGrad      : (_) => 'linear-gradient(160deg,#2d0010 0%,#7a0020 40%,#1a000a 100%)',
    overlay     : (_) => 'rgba(150,0,30,0.14)',
    fadeL       : 'rgba(15,0,5,1)',
    fadeEdge    : 'rgba(15,0,5,',
    statBg      : 'rgba(8,0,3,.9)',
    statBorder  : 'rgba(239,68,68,.35)',
    statHdrBg   : 'rgba(239,68,68,.1)',
    statHdrClr  : 'rgba(252,165,165,.7)',
    statNumClr  : '#fff0f0',
    statSubClr  : 'rgba(255,240,240,.65)',
    statDivClr  : 'rgba(239,68,68,.1)',
    vsBg        : 'rgba(15,0,5,0.98)',
    vsBorder    : 'rgba(239,68,68,.6)',
    vsClr       : '#fca5a5',
    divClr      : 'rgba(239,68,68,.55)',
    nameShadow  : 'rgba(0,0,0,1)',
    nameClr     : '#fff0f0',
    wmClr       : 'rgba(239,68,68,.18)',
    isSplit     : false,
  },
  blue: {
    cardBg      : '#00040f',
    headerBg    : 'rgba(0,4,18,.98)',
    headerBorder: 'rgba(59,130,246,.4)',
    subtitleClr : '#93c5fd',
    titleClr    : '#f0f5ff',
    gametagBg   : 'rgba(59,130,246,.2)',
    gametagBorder:'rgba(59,130,246,.6)',
    gametagClr  : '#93c5fd',
    bgGrad      : (_) => 'linear-gradient(160deg,#000c2e 0%,#00247a 40%,#000516 100%)',
    overlay     : (_) => 'rgba(0,30,120,0.14)',
    fadeL       : 'rgba(0,4,15,1)',
    fadeEdge    : 'rgba(0,4,15,',
    statBg      : 'rgba(0,2,10,.9)',
    statBorder  : 'rgba(59,130,246,.35)',
    statHdrBg   : 'rgba(59,130,246,.1)',
    statHdrClr  : 'rgba(147,197,253,.7)',
    statNumClr  : '#f0f5ff',
    statSubClr  : 'rgba(240,245,255,.65)',
    statDivClr  : 'rgba(59,130,246,.1)',
    vsBg        : 'rgba(0,4,18,0.98)',
    vsBorder    : 'rgba(59,130,246,.6)',
    vsClr       : '#93c5fd',
    divClr      : 'rgba(59,130,246,.55)',
    nameShadow  : 'rgba(0,0,0,1)',
    nameClr     : '#f0f5ff',
    wmClr       : 'rgba(59,130,246,.18)',
    isSplit     : false,
  },
  redblu: {
    // Split tema: sol kÄ±rmÄ±zÄ±, saÄŸ mavi â€” her taraf kendi rengiyle
    cardBg      : '#080010',
    headerBg    : 'linear-gradient(90deg,rgba(80,0,0,.98) 0%,rgba(0,0,80,.98) 100%)',
    headerBorder: 'rgba(180,60,60,.5)',
    subtitleClr : '#ffffff',
    titleClr    : '#ffffff',
    gametagBg   : 'rgba(255,255,255,.12)',
    gametagBorder:'rgba(255,255,255,.3)',
    gametagClr  : '#ffffff',
    bgGrad      : (team) => team==='kirmizi'
      ? 'linear-gradient(160deg,#3a0000 0%,#8b0000 40%,#1a0000 100%)'
      : 'linear-gradient(160deg,#000830 0%,#003087 40%,#000416 100%)',
    overlay     : (team) => team==='kirmizi' ? 'rgba(120,0,0,0.15)':'rgba(0,10,100,0.15)',
    fadeL       : 'rgba(8,0,16,1)',
    fadeEdge    : 'rgba(8,0,16,',
    statBg      : 'rgba(0,0,0,.85)',
    statBorder  : 'rgba(255,255,255,.2)',
    statHdrBg   : 'rgba(255,255,255,.07)',
    statHdrClr  : 'rgba(255,255,255,.55)',
    statNumClr  : '#ffffff',
    statSubClr  : 'rgba(255,255,255,.7)',
    statDivClr  : 'rgba(255,255,255,.08)',
    vsBg        : 'rgba(8,0,16,0.98)',
    vsBorder    : 'rgba(255,255,255,.35)',
    vsClr       : '#ffffff',
    divClr      : 'rgba(255,255,255,.6)',
    nameShadow  : 'rgba(0,0,0,1)',
    nameClr     : '#ffffff',
    wmClr       : 'rgba(255,255,255,.12)',
    isSplit     : true,
  },
  allstars: {
    // ALL STARS â€” karanlÄ±k evren, parlak yÄ±ldÄ±z efektleri, premium mor/gÃ¼mÃ¼ÅŸ
    cardBg      : '#060010',
    headerBg    : 'linear-gradient(180deg,#0e0030 0%,#060018 60%,#02000e 100%)',
    headerBorder: '#9333ea',
    subtitleClr : '#c084fc',
    titleClr    : '#f5f3ff',
    gametagBg   : 'rgba(147,51,234,.2)',
    gametagBorder:'#9333ea',
    gametagClr  : '#c084fc',
    bgGrad      : (_) => 'linear-gradient(175deg,#0a0020 0%,#16004a 35%,#050010 100%)',
    overlay     : (_) => 'rgba(0,0,0,0.4)',
    fadeL       : 'rgba(6,0,16,1)',
    fadeEdge    : 'rgba(6,0,16,',
    statBg      : '#08001e',
    statBorder  : '#7c3aed',
    statHdrBg   : 'rgba(124,58,237,.2)',
    statHdrClr  : '#c084fc',
    statNumClr  : '#f5f3ff',
    statSubClr  : '#c084fc',
    statDivClr  : 'rgba(124,58,237,.35)',
    vsBg        : '#08001e',
    vsBorder    : '#9333ea',
    vsClr       : '#c084fc',
    divClr      : '#7c3aed',
    nameShadow  : '#000000',
    nameClr     : '#f5f3ff',
    wmClr       : 'rgba(147,51,234,.3)',
    isSplit     : false,
    // Tema Ã¶zel ek Ã¶zellikler
    headerFont  : "'Barlow Condensed','Arial',sans-serif",
    titleStyle  : 'letter-spacing:.4em;text-shadow:0 0 40px rgba(147,51,234,.8),0 0 80px rgba(147,51,234,.4),0 2px 4px rgba(0,0,0,1);',
    subtitleStyle:'letter-spacing:.5em;text-shadow:0 0 20px rgba(192,132,252,.6);',
    scoreGrad   : 'linear-gradient(135deg,#060010,#1a0040,#060010)',
    scoreClr    : '#c084fc',
    winnerGrad  : 'linear-gradient(90deg,#060010,#1a0050,#060010)',
    winnerBorder: '#9333ea',
    winnerClr   : '#c084fc',
    apoletLines : false,
    starsOverlay: true,
  }
};
let _ndTheme = 'dark';
function ndSetTheme(t) {
  _ndTheme = t;
  ['dark','gold','red','blue','redblu','allstars'].forEach(k=>{
    const b=document.getElementById('ndt_'+k);
    if(!b)return;
    b.style.outline   = k===t ? '3px solid white' : 'none';
    b.style.transform = k===t ? 'scale(1.08)' : 'scale(1)';
  });
  buildNewDesign();
}

function buildNewDesign(){
  const cvDiv=document.getElementById('new_design_canvas');if(!cvDiv)return;
  const i1=Number(document.getElementById('nd_p1')?.value||0);
  const i2=Number(document.getElementById('nd_p2')?.value||1);
  const p1=players[i1]; const p2=players[i2];
  if(!p1||!p2){cvDiv.innerHTML='<div style="color:white;padding:20px">YarÄ±ÅŸmacÄ± seÃ§in.</div>';return;}

  const winnerSel  = document.getElementById('nd_winner')?.value||'';
  const winner     = winnerSel==='p1'?p1.name:winnerSel==='p2'?p2.name:winnerSel==='draw'?'Berabere':'';
  const title      = document.getElementById('nd_title')?.value||'BÄ°REYSEL DOKUNULMAZLIK';
  const subtitle   = document.getElementById('nd_subtitle')?.value||'SURVIVOR TÃœRKÄ°YE 2026';
  const s1         = parseInt(document.getElementById('nd_s1')?.value||'0');
  const s2         = parseInt(document.getElementById('nd_s2')?.value||'0');
  const gameType   = document.getElementById('nd_gametype')?.value||'';
  const customWr1  = document.getElementById('nd_wr1')?.value||'';
  const customWr2  = document.getElementById('nd_wr2')?.value||'';
  const frameMode  = document.getElementById('nd_frame_mode')?.checked||false;

  const TH = ND_THEMES[_ndTheme]||ND_THEMES.dark;

  // TakÄ±m rengini TEMA'dan baÄŸÄ±msÄ±z bÄ±rak â€” skor kÃ¶ÅŸe + istatistik border iÃ§in
  const tc1 = p1.team==='kirmizi'?'#ef4444':'#3b82f6';
  const tc2 = p2.team==='kirmizi'?'#ef4444':'#3b82f6';

  const wr1Val = customWr1||(p1.totalStats?.total?((p1.totalStats.wins/p1.totalStats.total)*100).toFixed(1):'0.0');
  const wr2Val = customWr2||(p2.totalStats?.total?((p2.totalStats.wins/p2.totalStats.total)*100).toFixed(1):'0.0');
  const wins1=p1.totalStats?.wins||0; const loss1=p1.totalStats?.losses||0; const tot1=p1.totalStats?.total||0;
  const wins2=p2.totalStats?.wins||0; const loss2=p2.totalStats?.losses||0; const tot2=p2.totalStats?.total||0;
  const pts1=wins1-loss1; const pts2=wins2-loss2;

  const h2h1=p1.h2hRegistry?.[p2.id]||{wins:0,losses:0,total:0};
  const h2h2=p2.h2hRegistry?.[p1.id]||{wins:0,losses:0,total:0};
  const h2hWr1=h2h1.total?((h2h1.wins/h2h1.total)*100).toFixed(1):'0.0';
  const h2hWr2=h2h2.total?((h2h2.wins/h2h2.total)*100).toFixed(1):'0.0';
  const h2hTot=h2h1.total+h2h2.total;

  const isW1=winner===p1.name; const isW2=winner===p2.name;

  const bigSrc1 = ndBigPhotos[1]||p1.image||'';
  const bigSrc2 = ndBigPhotos[2]||p2.image||'';
  // Ã‡erÃ§eve modu her zaman kayÄ±tlÄ± fotoÄŸrafÄ± kullanÄ±r
  const frameSrc1 = p1.image||bigSrc1||'';
  const frameSrc2 = p2.image||bigSrc2||'';

  const teamLabel1 = p1.team==='kirmizi'?'KIRMIZI TAKIM':'MAVÄ° TAKIM';
  const teamLabel2 = p2.team==='kirmizi'?'KIRMIZI TAKIM':'MAVÄ° TAKIM';

  // â”€â”€ Stat tablosu (geniÅŸletilmiÅŸ sÃ¼tunlar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const statLight = document.getElementById('nd_stat_light')?.checked||false;
  const SL = statLight;
  // Beyaz kutu seÃ§eneÄŸi: koyu yazÄ±lar; deÄŸilse temaya uygun dÃ¼z renk (renkli deÄŸil)
  const statBoxBg    = SL ? 'rgba(255,255,255,0.97)' : TH.statBg;
  const hdrRowBg2    = SL ? 'rgba(0,0,0,0.06)'  : TH.statHdrBg;
  const hdrLabelClr2 = SL ? 'rgba(0,0,0,0.6)'   : TH.statHdrClr;
  const rowBg2       = SL ? 'rgba(0,0,0,0.04)'  : 'transparent';
  // SayÄ± renkleri â€” tamamen dÃ¼z (renkli yok)
  const mainNumClr   = SL ? '#111827'            : TH.statNumClr;
  const subNumClr    = SL ? '#374151'            : TH.statSubClr;
  const statDivLine  = SL ? 'rgba(0,0,0,0.1)'   : TH.statDivClr;

  // GENEL: OYUN | GALÄ°BÄ°YET | YENÄ°LGÄ° | PUAN | %
  // BÄ°REBÄ°R: OYUN | GALÄ°BÄ°YET | YENÄ°LGÄ° | PUAN | %
  const mkTable = (genArr, h2hArr, tc) => {
    const genHdrs = ['OYUN','GALÄ°BÄ°YET','YENÄ°LGÄ°','PUAN','WIN%'];
    const h2hHdrs = ['OYUN','GALÄ°BÄ°YET','YENÄ°LGÄ°','PUAN','WIN%'];
    const cellBase = `text-align:center;font-family:'Barlow Condensed',sans-serif;`;
    const borderB  = `border-bottom:1px solid ${statDivLine};`;
    const colW5='width:20%;';
    // TÃ¼m sayÄ±lar dÃ¼z renk â€” renkli deÄŸil
    const genRow = genArr.map((v,i)=>`<td style="${cellBase}${colW5}font-size:17px;font-weight:900;color:${mainNumClr};padding:5px 2px;${borderB}">${v}</td>`).join('');
    const h2hRow = h2hArr.map((v,i)=>`<td style="${cellBase}${colW5}font-size:17px;font-weight:900;color:${subNumClr};padding:5px 2px;">${v}</td>`).join('');
    return `<table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr style="background:${hdrRowBg2};">
          <td colspan="5" style="${cellBase}font-size:8px;font-weight:900;color:${hdrLabelClr2};letter-spacing:.15em;padding:4px 4px 2px;text-transform:uppercase;border-bottom:1px solid ${SL?'rgba(0,0,0,.2)':tc+'55'};">ğŸ“Š GENEL</td>
        </tr>
        <tr style="background:${hdrRowBg2};">
          ${genHdrs.map(h=>`<th style="${cellBase}${colW5}font-size:8px;font-weight:800;color:${hdrLabelClr2};letter-spacing:.08em;padding:3px 2px;border-bottom:1.5px solid ${SL?'rgba(0,0,0,.25)':tc+'55'};">${h}</th>`).join('')}
        </tr>
      </thead>
      <tbody>
        <tr style="background:${rowBg2};">${genRow}</tr>
        <tr style="background:${hdrRowBg2};">
          <td colspan="5" style="${cellBase}font-size:8px;font-weight:900;color:${hdrLabelClr2};letter-spacing:.15em;padding:5px 4px 2px;text-transform:uppercase;border-bottom:1px solid ${SL?'rgba(0,0,0,.2)':tc+'55'};border-top:2px solid ${SL?'rgba(0,0,0,0.1)':'rgba(255,255,255,.07)'};">âš”ï¸ BÄ°REBÄ°R</td>
        </tr>
        <tr style="background:${hdrRowBg2};">
          ${h2hHdrs.map(h=>`<th style="${cellBase}${colW5}font-size:8px;font-weight:800;color:${hdrLabelClr2};letter-spacing:.08em;padding:3px 2px;border-bottom:1.5px solid ${SL?'rgba(0,0,0,.25)':tc+'55'};">${h}</th>`).join('')}
        </tr>
        <tr>${h2hRow}</tr>
      </tbody>
    </table>`;
  };

  // GENEL: [oyun, galibiyet, yenilgi, puan, win%]
  const st1gen=[tot1, wins1, loss1, (pts1>=0?'+':'')+pts1, wr1Val+'%'];
  const st2gen=[tot2, wins2, loss2, (pts2>=0?'+':'')+pts2, wr2Val+'%'];
  // BÄ°REBÄ°R: [oyun, galibiyet, yenilgi, puan, win%]
  const st1h2h=[h2hTot, h2h1.wins, h2h1.losses||0, ((h2h1.wins-h2h1.losses)>=0?'+':'')+(h2h1.wins-h2h1.losses), h2hWr1+'%'];
  const st2h2h=[h2hTot, h2h2.wins, h2h2.losses||0, ((h2h2.wins-h2h2.losses)>=0?'+':'')+(h2h2.wins-h2h2.losses), h2hWr2+'%'];

  // â”€â”€ Boyutlar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // â”€â”€ Boyutlar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const CARD_H=700; const HEADER_H=82; const PHOTO_H=CARD_H-HEADER_H;

  const photoCommon = 'position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:65% 10%;display:block;';
  const photoCommonR = 'position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:35% 10%;display:block;';
  const mkPhotoNormal = (src, initial, isRight) => src
    ? `<img src="${src}" style="${isRight ? photoCommonR : photoCommon}" crossorigin="anonymous">`
    : `<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:220px;font-weight:900;color:rgba(255,255,255,.04);">${initial}</div>`;

  // â”€â”€ Ã‡erÃ§eve modu fotoÄŸraf â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const mkPhotoFrame = (src, tc, initial) => `
    <div style="position:absolute;left:50%;top:44px;transform:translateX(-50%);width:260px;height:260px;border-radius:50%;overflow:hidden;border:5px solid ${tc};box-shadow:0 0 0 3px ${TH.cardBg},0 0 40px ${tc}80,0 12px 40px rgba(0,0,0,.8);z-index:6;">
      ${src
        ? `<img src="${src}" style="width:100%;height:100%;object-fit:cover;object-position:center 10%;display:block;" crossorigin="anonymous">`
        : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:100px;font-weight:900;color:${tc}50;">${initial}</div>`}
    </div>`;

  const left_photo_html  = frameMode ? mkPhotoFrame(frameSrc1,tc1,p1.name.charAt(0)) : mkPhotoNormal(bigSrc1,p1.name.charAt(0),false);
  const right_photo_html = frameMode ? mkPhotoFrame(frameSrc2,tc2,p2.name.charAt(0)) : mkPhotoNormal(bigSrc2,p2.name.charAt(0),true);

  // â”€â”€ Skor kÃ¶ÅŸe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Tema Ã¶zel skor/kazanan renkleri
  const hasTmScore = TH.scoreGrad && TH.scoreClr;
  const scoreBgL = isW1 ? (hasTmScore ? TH.scoreGrad : 'linear-gradient(135deg,#92600a,#FFD700,#92600a)') : tc1;
  const scoreBgR = isW2 ? (hasTmScore ? TH.scoreGrad : 'linear-gradient(135deg,#92600a,#FFD700,#92600a)') : tc2;
  const scoreTextClr = hasTmScore ? TH.scoreClr : 'white';
  const scoreBadgeL = `<div style="position:absolute;top:0;left:0;z-index:10;"><div style="width:88px;height:88px;background:${scoreBgL};clip-path:polygon(0 0,100% 0,100% 70%,70% 100%,0 100%);display:flex;align-items:center;justify-content:center;padding-bottom:20px;padding-right:20px;"><span style="font-size:50px;font-weight:900;color:${scoreTextClr};line-height:1;text-shadow:0 2px 6px rgba(0,0,0,.9);">${s1}</span></div></div>`;
  const scoreBadgeR = `<div style="position:absolute;top:0;right:0;z-index:10;"><div style="width:88px;height:88px;background:${scoreBgR};clip-path:polygon(0 0,100% 0,100% 100%,30% 100%,0 70%);display:flex;align-items:center;justify-content:center;padding-bottom:20px;padding-left:20px;"><span style="font-size:50px;font-weight:900;color:${scoreTextClr};line-height:1;text-shadow:0 2px 6px rgba(0,0,0,.9);">${s2}</span></div></div>`;

  // Kazanan rozeti â€” temaya Ã¶zgÃ¼ apolet stili
  const hasTmWinner = TH.winnerGrad && TH.winnerClr;
  const wGradL = hasTmWinner ? TH.winnerGrad : 'linear-gradient(90deg,#92600a,#FFD700)';
  const wGradR = hasTmWinner ? TH.winnerGrad.replace('90deg','270deg') : 'linear-gradient(90deg,#FFD700,#92600a)';
  const wClr   = hasTmWinner ? TH.winnerClr : '#1a0600';
  const wBorder = hasTmWinner ? `border:1px solid ${TH.winnerBorder};` : '';
  const wShadow = hasTmWinner ? `box-shadow:0 3px 18px ${TH.winnerBorder}80;` : 'box-shadow:0 3px 12px rgba(255,215,0,.5);';
  // Apolet ÅŸerit efekti (gold temasÄ±nda aktif)
  const apoletStripes = TH.apoletLines ? `<div style="position:absolute;inset:0;background:repeating-linear-gradient(90deg,transparent,transparent 8px,rgba(255,215,0,.15) 8px,rgba(255,215,0,.15) 9px);border-radius:inherit;pointer-events:none;"></div>` : '';
  const winnerBadgeL = isW1?`<div style="position:absolute;top:18px;left:94px;z-index:10;background:${wGradL};color:${wClr};font-size:11px;font-weight:900;letter-spacing:.3em;text-transform:uppercase;padding:5px 16px;border-radius:0 18px 18px 0;${wBorder}${wShadow}position:relative;overflow:hidden;">ğŸ‘‘ KAZANAN${apoletStripes}</div>`:'';
  const winnerBadgeR = isW2?`<div style="position:absolute;top:18px;right:94px;z-index:10;background:${wGradR};color:${wClr};font-size:11px;font-weight:900;letter-spacing:.3em;text-transform:uppercase;padding:5px 16px;border-radius:18px 0 0 18px;${wBorder}${wShadow}position:relative;overflow:hidden;">ğŸ‘‘ KAZANAN${apoletStripes}</div>`:'';

  const mkBottomInfo = (name, label, tc, genArr, h2hArr, align) => {
    const isRight = align==='right';
    const pad = isRight ? 'padding:0 14px 14px 20px;text-align:right;' : 'padding:0 20px 14px 14px;';
    const boxBorderClr = SL ? 'rgba(0,0,0,0.22)' : TH.statBorder;
    return `<div style="position:absolute;bottom:0;left:0;right:0;${pad}z-index:8;">
      <div style="font-size:9px;font-weight:900;color:${tc};letter-spacing:.5em;text-transform:uppercase;margin-bottom:2px;">${label}</div>
      <div style="font-size:48px;font-weight:900;color:${SL?'#111':TH.nameClr};text-transform:uppercase;letter-spacing:.03em;line-height:.88;text-shadow:0 3px 16px ${SL?'rgba(0,0,0,0.1)':TH.nameShadow};margin-bottom:8px;">${name}</div>
      <div style="border:1.5px solid ${boxBorderClr};border-radius:12px;overflow:hidden;background:${statBoxBg};">
        <div style="padding:2px 8px 4px;">${mkTable(genArr,h2hArr,tc)}</div>
      </div>
    </div>`;
  };

  const mkFrameBottomInfo = (name, label, tc, genArr, h2hArr, align) => {
    const isRight = align==='right';
    const pad = isRight ? 'padding:0 14px 12px 20px;text-align:right;' : 'padding:0 20px 12px 14px;';
    const boxBorderClr = SL ? 'rgba(0,0,0,0.22)' : TH.statBorder;
    return `<div style="position:absolute;bottom:0;left:0;right:0;${pad}z-index:8;">
      <div style="font-size:8px;font-weight:900;color:${tc};letter-spacing:.5em;text-transform:uppercase;margin-bottom:2px;">${label}</div>
      <div style="font-size:38px;font-weight:900;color:${SL?'#111':TH.nameClr};text-transform:uppercase;letter-spacing:.03em;line-height:.88;text-shadow:0 3px 16px ${SL?'rgba(0,0,0,0.1)':TH.nameShadow};margin-bottom:6px;">${name}</div>
      <div style="border:1.5px solid ${boxBorderClr};border-radius:12px;overflow:hidden;background:${statBoxBg};">
        <div style="padding:2px 8px 4px;">${mkTable(genArr,h2hArr,tc)}</div>
      </div>
    </div>`;
  };

  const infoFn = frameMode ? mkFrameBottomInfo : mkBottomInfo;

  cvDiv.innerHTML = `<div id="new_design_inner" data-w="1080" data-h="${CARD_H}" style="width:1080px;height:${CARD_H}px;font-family:'Barlow Condensed',sans-serif;position:relative;overflow:hidden;background:${TH.cardBg};display:flex;flex-direction:column;">

    <!-- â•â•â• HEADER â•â•â• -->
    <div style="flex-shrink:0;height:${HEADER_H}px;background:${TH.headerBg};border-bottom:3px solid ${TH.headerBorder};display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1px;position:relative;z-index:30;overflow:hidden;">
      ${TH.apoletLines ? `
        <div style="position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,transparent,#C9A227 20%,#FFD700 50%,#C9A227 80%,transparent);"></div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:4px;background:linear-gradient(90deg,transparent,#C9A227 20%,#FFD700 50%,#C9A227 80%,transparent);"></div>
        <div style="position:absolute;left:20px;top:50%;transform:translateY(-50%);font-size:28px;opacity:.4;">ğŸ–ï¸</div>
        <div style="position:absolute;right:20px;top:50%;transform:translateY(-50%);font-size:28px;opacity:.4;">ğŸ–ï¸</div>
      ` : ''}
      ${TH.starsOverlay ? `
        <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 20% 50%,rgba(147,51,234,.15),transparent 60%),radial-gradient(ellipse at 80% 50%,rgba(124,58,237,.15),transparent 60%);pointer-events:none;"></div>
        <div style="position:absolute;left:24px;top:50%;transform:translateY(-50%);font-size:22px;opacity:.5;">â­</div>
        <div style="position:absolute;right:24px;top:50%;transform:translateY(-50%);font-size:22px;opacity:.5;">â­</div>
      ` : ''}
      <div style="font-size:24px;font-weight:700;color:${TH.subtitleClr};letter-spacing:.35em;text-transform:uppercase;font-family:${TH.headerFont||"'Georgia','Times New Roman',serif"};${TH.subtitleStyle||''}">${subtitle}</div>
      <div style="font-size:${gameType?'22px':'28px'};font-weight:900;color:${TH.titleClr};text-transform:uppercase;line-height:1.05;font-family:${TH.headerFont||"'Barlow Condensed',sans-serif"};${TH.titleStyle||'letter-spacing:.28em;'}">${title}</div>
      ${gameType?`<div style="background:${TH.gametagBg};border:1px solid ${TH.gametagBorder};border-radius:20px;padding:3px 16px;font-size:11px;font-weight:900;color:${TH.gametagClr};letter-spacing:.22em;text-transform:uppercase;margin-top:2px;">${gameType}</div>`:''}
    </div>

    <!-- â•â•â• TWO HALVES â•â•â• -->
    <div style="flex:1;display:flex;position:relative;height:${PHOTO_H}px;">

      <!-- â•â• SOL â•â• -->
      <div style="position:relative;width:50%;height:100%;overflow:hidden;">
        <div style="position:absolute;inset:0;background:${TH.bgGrad(p1.team)};"></div>
        ${left_photo_html}
        <div style="position:absolute;inset:0;background:${TH.overlay(p1.team)};"></div>
        ${TH.starsOverlay?`<div style="position:absolute;inset:0;background:radial-gradient(ellipse at 30% 30%,rgba(147,51,234,.12),transparent 60%);pointer-events:none;z-index:2;"></div>`:''}
        <div style="position:absolute;top:0;right:0;width:140px;height:100%;background:linear-gradient(to left,${TH.fadeEdge}1) 0%,${TH.fadeEdge}0.25) 55%,transparent 100%);"></div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:${frameMode?'240':'270'}px;background:linear-gradient(to top,${TH.fadeL} 0%,${TH.fadeEdge}0.88) 38%,${TH.fadeEdge}0.4) 65%,transparent 100%);"></div>
        ${scoreBadgeL}
        ${winnerBadgeL}
        ${infoFn(p1.name,teamLabel1,tc1,st1gen,st1h2h,'left')}
      </div>

      <!-- â•â• SAÄ â•â• -->
      <div style="position:relative;width:50%;height:100%;overflow:hidden;">
        <div style="position:absolute;inset:0;background:${TH.bgGrad(p2.team)};"></div>
        ${right_photo_html}
        <div style="position:absolute;inset:0;background:${TH.overlay(p2.team)};"></div>
        ${TH.starsOverlay?`<div style="position:absolute;inset:0;background:radial-gradient(ellipse at 70% 30%,rgba(124,58,237,.12),transparent 60%);pointer-events:none;z-index:2;"></div>`:''}
        <div style="position:absolute;top:0;left:0;width:140px;height:100%;background:linear-gradient(to right,${TH.fadeEdge}1) 0%,${TH.fadeEdge}0.25) 55%,transparent 100%);"></div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:${frameMode?'240':'270'}px;background:linear-gradient(to top,${TH.fadeL} 0%,${TH.fadeEdge}0.88) 38%,${TH.fadeEdge}0.4) 65%,transparent 100%);"></div>
        ${scoreBadgeR}
        ${winnerBadgeR}
        ${infoFn(p2.name,teamLabel2,tc2,st2gen,st2h2h,'right')}
      </div>

      <!-- Dikey Ã§izgi -->
      <div style="position:absolute;left:50%;top:0;bottom:0;transform:translateX(-50%);width:1px;background:linear-gradient(to bottom,transparent,${TH.divClr} 25%,${TH.divClr} 75%,transparent);z-index:20;pointer-events:none;"></div>

      <!-- VS dairesi -->
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:25;width:80px;height:80px;border-radius:50%;background:${TH.vsBg};border:2px solid ${TH.vsBorder};display:flex;align-items:center;justify-content:center;box-shadow:0 0 28px rgba(0,0,0,.9);">
        <span style="font-size:26px;font-weight:900;color:${TH.vsClr};letter-spacing:.06em;">VS</span>
      </div>

    </div>

    <!-- Watermark -->
    <div style="position:absolute;bottom:5px;left:50%;transform:translateX(-50%);font-size:7px;color:${TH.wmClr};letter-spacing:.3em;text-transform:uppercase;white-space:nowrap;z-index:40;">SurvivorDetay</div>

  </div>`;
}


function downloadNewDesignImage(){
  const cvDiv = document.getElementById('new_design_canvas');
  if (!cvDiv || !cvDiv.innerHTML.trim()) { alert('Ã–nce tasarÄ±m Ã¶nizlemesi oluÅŸturun.'); return; }
  const inner = cvDiv.querySelector('#new_design_inner') || cvDiv.firstElementChild;
  if (!inner) { alert('TasarÄ±m elementi bulunamadÄ±.'); return; }
  _downloadDesignHD(inner, 'final-tasarim-' + Date.now() + '.png');
}

function ndSaveToGames(){
  const i1=Number(document.getElementById('nd_p1')?.value||0);
  const i2=Number(document.getElementById('nd_p2')?.value||1);
  const p1=players[i1]; const p2=players[i2];
  if(!p1||!p2){alert('YarÄ±ÅŸmacÄ± seÃ§ili deÄŸil.');return;}
  const winnerSel=document.getElementById('nd_winner')?.value||'';
  if(!winnerSel){alert('LÃ¼tfen kazananÄ± seÃ§in.');return;}
  const winnerName = winnerSel==='p1'?p1.name:winnerSel==='p2'?p2.name:'Berabere';
  const loserName = winnerSel==='p1'?p2.name:winnerSel==='p2'?p1.name:'';
  const gameType = document.getElementById('nd_gametype')?.value||'';
  const s1=parseInt(document.getElementById('nd_s1')?.value||'0');
  const s2=parseInt(document.getElementById('nd_s2')?.value||'0');
  const title=document.getElementById('nd_title')?.value||'';
  // Determine source / atis type
  const gtParts = gameType.split(/[\sÂ·\/]+/).map(t=>t.trim()).filter(Boolean);
  const atisTypes = ['TOP','BASKET','STICK','DÄ°SK','BUMERANG','DAMBIL','KÃœP','HALKA','Ã‡EKÄ°Ã‡','KUM TORBASI','KONDURMA'];
  let atisType = gtParts.find(g=>atisTypes.includes(g.toUpperCase())) || '';
  let isParkur = gtParts.some(g=>g.toUpperCase().includes('PARKUR'));
  const games = loadGames();
  const game = {
    id: uid(),
    source: 'nd_design',
    date: new Date().toISOString(),
    p1Name: p1.name, p2Name: p2.name,
    winner: winnerName, loser: loserName,
    score: s1+'-'+s2,
    gameType: gameType,
    atisType: atisType || (isParkur?'PARKUR':''),
    isParkur: isParkur,
    title: title,
    note: 'Final/Ã–zel TasarÄ±mdan Kaydedildi'
  };
  // Update player stats
  const winner = winnerSel==='p1'?p1:winnerSel==='p2'?p2:null;
  const loser = winnerSel==='p1'?p2:winnerSel==='p2'?p1:null;
  if(winner && loser) {
    winner.totalStats = winner.totalStats||{total:0,wins:0,losses:0};
    loser.totalStats = loser.totalStats||{total:0,wins:0,losses:0};
    winner.totalStats.total++; winner.totalStats.wins++;
    loser.totalStats.total++; loser.totalStats.losses++;
    // H2H
    if(!winner.h2hRegistry) winner.h2hRegistry={};
    if(!loser.h2hRegistry) loser.h2hRegistry={};
    if(!winner.h2hRegistry[loser.id]) winner.h2hRegistry[loser.id]={total:0,wins:0,losses:0};
    if(!loser.h2hRegistry[winner.id]) loser.h2hRegistry[winner.id]={total:0,wins:0,losses:0};
    winner.h2hRegistry[loser.id].total++; winner.h2hRegistry[loser.id].wins++;
    loser.h2hRegistry[winner.id].total++; loser.h2hRegistry[winner.id].losses++;
  }
  games.push(game);
  saveGames(games);
  save();
  renderMain();
  alert('âœ… Oyun kaydedildi! "Oyunlar" listesinde gÃ¶rebilirsiniz.');
  buildNewDesign();
}

// ======================================================
// H2H TASARIM â€” DÃœELLO KARTI
// ======================================================
const h2hBigPhotos = { 1: null, 2: null };

function h2hLoadBigPhoto(slot) {
  const input = document.getElementById('h2h_bigphoto' + slot);
  if (!input || !input.files || !input.files[0]) return;
  const reader = new FileReader();
  reader.onload = e => {
    h2hBigPhotos[slot] = e.target.result;
    const prev = document.getElementById('h2h_bp' + slot + '_preview');
    if (prev) prev.innerHTML = `<span style="color:#10b981;font-weight:700">âœ“ FotoÄŸraf yÃ¼klendi</span>`;
    buildH2HDesign();
  };
  reader.readAsDataURL(input.files[0]);
}

function h2hClearPhoto(slot) {
  h2hBigPhotos[slot] = null;
  const input = document.getElementById('h2h_bigphoto' + slot);
  if (input) input.value = '';
  const prev = document.getElementById('h2h_bp' + slot + '_preview');
  if (prev) prev.innerHTML = '';
  buildH2HDesign();
}

function openH2HDesign() {
  // h2hp seÃ§imlerini doldur (henÃ¼z dolmamÄ±ÅŸsa)
  if (typeof populateH2HSels === 'function') populateH2HSels();
  // H2H modal'daki seÃ§ili yarÄ±ÅŸmacÄ±larÄ± al ve tasarÄ±m modalÄ±na aÃ§
  openM('m_h2h_design');
  // Modal aÃ§Ä±ldÄ±ktan sonra tasarÄ±mÄ± oluÅŸtur
  setTimeout(function() { buildH2HDesign(); }, 120);
}

function buildH2HDesign() {
  const cvDiv = document.getElementById('h2h_design_canvas');
  if (!cvDiv) return;

  // H2H modal seÃ§imlerini kullan â€” degerler "s_${id}" formatinda
  const s1el = document.getElementById('h2hp_s1');
  const s2el = document.getElementById('h2hp_s2');
  const allP = (typeof getAllSeasonsPlayers === 'function') ? getAllSeasonsPlayers() : players;
  let p1, p2;
  if (s1el && s1el.value) {
    const id1 = s1el.value.replace('s_','');
    p1 = allP.find(p => p.id === id1) || allP[0];
  } else { p1 = allP[0]; }
  if (s2el && s2el.value) {
    const id2 = s2el.value.replace('s_','');
    p2 = allP.find(p => p.id === id2) || allP[1];
  } else { p2 = allP[1]; }
  if (!p1) p1 = players[0];
  if (!p2) p2 = players[1] || players[0];
  if (!p1 || !p2) {
    cvDiv.innerHTML = '<div style="color:#94a3b8;padding:20px;text-align:center;font-size:15px;">Lutfen H2H Analiz ekranindan yarismacilar secin, sonra Tasarim Olustur butonuna basin.</div>';
    return;
  }

  const tc1 = p1.team === 'kirmizi' ? '#ef4444' : '#3b82f6';
  const tc2 = p2.team === 'kirmizi' ? '#ef4444' : '#3b82f6';
  const glow1 = p1.team === 'kirmizi' ? 'rgba(239,68,68,.4)' : 'rgba(59,130,246,.4)';
  const glow2 = p2.team === 'kirmizi' ? 'rgba(239,68,68,.4)' : 'rgba(59,130,246,.4)';
  const teamBg1 = p1.team === 'kirmizi' ? 'linear-gradient(160deg,#3a0000 0%,#6b0000 45%,#1a0000 100%)' : 'linear-gradient(160deg,#000e3a 0%,#00267a 45%,#000518 100%)';
  const teamBg2 = p2.team === 'kirmizi' ? 'linear-gradient(160deg,#3a0000 0%,#6b0000 45%,#1a0000 100%)' : 'linear-gradient(160deg,#000e3a 0%,#00267a 45%,#000518 100%)';

  const h1 = p1.h2hRegistry?.[p2.id] || { wins: 0, losses: 0, total: 0 };
  const h2 = p2.h2hRegistry?.[p1.id] || { wins: 0, losses: 0, total: 0 };
  const total = h1.wins + h2.wins;
  const p1Pct = total ? Math.round((h1.wins / total) * 100) : 50;
  const p2Pct = 100 - p1Pct;

  const s1t = p1.totalStats || { total: 0, wins: 0, losses: 0 };
  const s2t = p2.totalStats || { total: 0, wins: 0, losses: 0 };
  const wr1 = s1t.total ? ((s1t.wins / s1t.total) * 100).toFixed(1) : '0.0';
  const wr2 = s2t.total ? ((s2t.wins / s2t.total) * 100).toFixed(1) : '0.0';
  const score1 = (s1t.wins || 0) - (s1t.losses || 0);
  const score2 = (s2t.wins || 0) - (s2t.losses || 0);

  const src1 = h2hBigPhotos[1] || p1.image || '';
  const src2 = h2hBigPhotos[2] || p2.image || '';

  const photoHtml1 = src1
    ? `<img src="${src1}" style="width:100%;height:100%;object-fit:cover;object-position:center top;display:block;" crossorigin="anonymous">`
    : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:90px;font-weight:900;color:rgba(255,255,255,.12);background:rgba(0,0,0,.3)">${p1.name.charAt(0)}</div>`;
  const photoHtml2 = src2
    ? `<img src="${src2}" style="width:100%;height:100%;object-fit:cover;object-position:center top;display:block;" crossorigin="anonymous">`
    : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:90px;font-weight:900;color:rgba(255,255,255,.12);background:rgba(0,0,0,.3)">${p2.name.charAt(0)}</div>`;

  // Son maÃ§lar (birebir)
  const allGames = typeof loadGames === 'function' ? loadGames() : [];
  const h2hGames = allGames.filter(g =>
    (g.p1Name === p1.name && g.p2Name === p2.name) ||
    (g.p1Name === p2.name && g.p2Name === p1.name)
  ).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10).reverse();

  const h2hFormBars = h2hGames.length > 0
    ? h2hGames.map(g => {
        const p1win = g.winner === p1.name;
        const draw = g.winner === 'Berabere';
        const atisIcon = { TOP: 'âš½', BASKET: 'ğŸ€', STICK: 'ğŸ’', DÄ°SK: 'ğŸ¥', BUMERANG: 'ğŸªƒ', DAMBIL: 'ğŸ‹', KÃœP: 'ğŸ“¦', HALKA: 'â­•', Ã‡EKÄ°Ã‡: 'ğŸ”¨', 'KUM TORBASI': 'ğŸ¥Š', KONDURMA: 'ğŸ¯' };
        const icon = atisIcon[g.atisType || ''] || 'ğŸ®';
        return `<div style="display:flex;flex-direction:column;align-items:center;gap:3px">
          <div style="font-size:14px">${icon}</div>
          <div style="width:28px;height:32px;border-radius:6px;background:${draw ? '#f59e0b' : p1win ? tc1 : tc2};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;color:white;box-shadow:0 2px 8px rgba(0,0,0,.5)">${draw ? 'B' : p1win ? 'G' : 'M'}</div>
        </div>`;
      }).join('')
    : '<div style="color:rgba(255,255,255,.3);font-size:12px;padding:6px">HenÃ¼z birebir maÃ§ yok</div>';

  // Psikolojik analiz
  const psychColor = p1Pct >= 60 ? tc1 : p1Pct <= 40 ? tc2 : '#f59e0b';
  const psychLabel = p1Pct >= 65 ? `${p1.name} dominant` : p1Pct >= 55 ? `${p1.name} hafif Ã¼stÃ¼n` : p1Pct === 50 ? 'Tam denge' : p2Pct >= 55 ? `${p2.name} hafif Ã¼stÃ¼n` : `${p2.name} dominant`;

  // AtÄ±ÅŸ tipi karÅŸÄ±laÅŸtÄ±rma
  const atisTypes = ['TOP', 'BASKET', 'STICK', 'DÄ°SK', 'BUMERANG', 'DAMBIL', 'KÃœP', 'HALKA', 'Ã‡EKÄ°Ã‡', 'KUM TORBASI', 'KONDURMA'];
  const atisIcons = { TOP: 'âš½', BASKET: 'ğŸ€', STICK: 'ğŸ’', DÄ°SK: 'ğŸ¥', BUMERANG: 'ğŸªƒ', DAMBIL: 'ğŸ‹', KÃœP: 'ğŸ“¦', HALKA: 'â­•', Ã‡EKÄ°Ã‡: 'ğŸ”¨', 'KUM TORBASI': 'ğŸ¥Š', KONDURMA: 'ğŸ¯' };
  const makeAtisRow = (p) => {
    const st = {}; atisTypes.forEach(at => { st[at] = { wins: 0, total: 0 }; });
    allGames.filter(g => g.p1Name === p.name || g.p2Name === p.name).forEach(g => {
      const isW = g.winner === p.name; const key = g.atisType || '';
      if (key && st[key] !== undefined) { st[key].total++; if (isW) st[key].wins++; }
    });
    return atisTypes.map(at => ({ at, st: st[at] })).filter(x => x.st.total > 0).slice(0, 5);
  };
  const atis1 = makeAtisRow(p1);
  const atis2 = makeAtisRow(p2);

  const dateStr = new Date().toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric' });

  cvDiv.innerHTML = `<div id="h2h_design_inner" style="width:1080px;min-height:1080px;font-family:'Barlow Condensed',sans-serif;position:relative;overflow:hidden;background:#0a0a12;display:flex;flex-direction:column;">

    <!-- Arka plan glow efektleri -->
    <div style="position:absolute;top:-150px;left:-150px;width:700px;height:700px;background:radial-gradient(circle,${glow1} 0%,transparent 60%);pointer-events:none;z-index:0;"></div>
    <div style="position:absolute;top:-150px;right:-150px;width:700px;height:700px;background:radial-gradient(circle,${glow2} 0%,transparent 60%);pointer-events:none;z-index:0;"></div>
    <div style="position:absolute;bottom:-100px;left:50%;transform:translateX(-50%);width:800px;height:400px;background:radial-gradient(ellipse,rgba(255,255,255,.03) 0%,transparent 70%);pointer-events:none;z-index:0;"></div>
    <!-- Su izi -->
    <div style="position:absolute;inset:0;opacity:.025;display:flex;align-items:center;justify-content:center;pointer-events:none;overflow:hidden;">
      <span style="font-size:120px;font-weight:900;color:white;transform:rotate(-20deg);white-space:nowrap;letter-spacing:.15em">SurvivorMetrics</span>
    </div>

    <!-- BAÅLIK -->
    <div style="position:relative;z-index:5;background:rgba(0,0,0,.9);border-bottom:2px solid rgba(255,255,255,.1);padding:18px 44px;display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-size:10px;color:rgba(255,255,255,.35);letter-spacing:.5em;text-transform:uppercase;margin-bottom:2px">SURVIVOR TÃœRKÄ°YE 2026</div>
        <div style="font-size:36px;font-weight:900;color:white;letter-spacing:.2em;text-transform:uppercase">âš”ï¸ HEAD-TO-HEAD ANALÄ°ZÄ°</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:10px;color:rgba(255,255,255,.3);letter-spacing:.2em;font-weight:700;text-transform:uppercase">SURVIVORMETRICS</div>
        <div style="font-size:11px;color:rgba(255,255,255,.2);margin-top:2px">${dateStr}</div>
      </div>
    </div>

    <!-- YARIÅMACI KARTLARI (yan yana) -->
    <div style="position:relative;z-index:3;display:grid;grid-template-columns:1fr 1fr;min-height:320px;">
      <!-- SOL -->
      <div style="background:${teamBg1};overflow:hidden;padding:28px 32px;display:flex;align-items:center;gap:24px;border-right:1px solid rgba(255,255,255,.06);position:relative;">
        <div style="position:absolute;bottom:-80px;right:-80px;width:300px;height:300px;background:radial-gradient(circle,${glow1} 0%,transparent 65%);pointer-events:none;"></div>
        <!-- BÃ¼yÃ¼k yuvarlak fotoÄŸraf -->
        <div style="width:200px;height:200px;border-radius:50%;border:5px solid ${tc1};overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.6),0 0 0 2px rgba(255,255,255,.06);flex-shrink:0;background:#1e293b;">
          ${photoHtml1}
        </div>
        <!-- Ä°sim + istatistikler -->
        <div style="flex:1;z-index:2;">
          <div style="font-size:10px;color:${tc1};font-weight:800;letter-spacing:.35em;text-transform:uppercase;margin-bottom:4px">${p1.team === 'kirmizi' ? 'KIRMIZI TAKIM' : 'MAVÄ° TAKIM'}</div>
          <div style="font-size:44px;font-weight:900;color:white;text-transform:uppercase;letter-spacing:.04em;line-height:1;text-shadow:0 2px 12px rgba(0,0,0,.8);margin-bottom:12px">${p1.name}</div>
          ${p1.status ? `<div style="display:inline-block;background:rgba(255,215,0,.15);border:1px solid #FFD700;border-radius:20px;padding:4px 16px;font-size:13px;font-weight:900;color:#FFD700;letter-spacing:.1em;margin-bottom:12px">${p1.status}</div><br>` : ''}
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
            ${[['TOPLAM', s1t.total, 'white'], ['GALÄ°BÄ°YET', s1t.wins, '#4ade80'], ['YENÄ°LGÄ°', s1t.losses, '#f87171'], ['WIN %', wr1 + '%', Number(wr1) >= 50 ? '#4ade80' : '#f87171']].map(([lbl, val, col]) =>
              `<div style="background:rgba(0,0,0,.5);border-radius:10px;padding:8px 6px;text-align:center;border:1px solid rgba(255,255,255,.08)">
                <div style="font-size:22px;font-weight:900;color:${col};line-height:1">${val}</div>
                <div style="font-size:8px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.1em;margin-top:2px">${lbl}</div>
              </div>`).join('')}
          </div>
        </div>
      </div>
      <!-- SAÄ -->
      <div style="background:${teamBg2};overflow:hidden;padding:28px 32px;display:flex;align-items:center;gap:24px;flex-direction:row-reverse;position:relative;">
        <div style="position:absolute;bottom:-80px;left:-80px;width:300px;height:300px;background:radial-gradient(circle,${glow2} 0%,transparent 65%);pointer-events:none;"></div>
        <!-- FotoÄŸraf -->
        <div style="width:200px;height:200px;border-radius:50%;border:5px solid ${tc2};overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.6),0 0 0 2px rgba(255,255,255,.06);flex-shrink:0;background:#1e293b;">
          ${photoHtml2}
        </div>
        <div style="flex:1;z-index:2;text-align:right;">
          <div style="font-size:10px;color:${tc2};font-weight:800;letter-spacing:.35em;text-transform:uppercase;margin-bottom:4px">${p2.team === 'kirmizi' ? 'KIRMIZI TAKIM' : 'MAVÄ° TAKIM'}</div>
          <div style="font-size:44px;font-weight:900;color:white;text-transform:uppercase;letter-spacing:.04em;line-height:1;text-shadow:0 2px 12px rgba(0,0,0,.8);margin-bottom:12px">${p2.name}</div>
          ${p2.status ? `<div style="display:inline-block;background:rgba(255,215,0,.15);border:1px solid #FFD700;border-radius:20px;padding:4px 16px;font-size:13px;font-weight:900;color:#FFD700;letter-spacing:.1em;margin-bottom:12px">${p2.status}</div><br>` : ''}
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
            ${[['TOPLAM', s2t.total, 'white'], ['GALÄ°BÄ°YET', s2t.wins, '#4ade80'], ['YENÄ°LGÄ°', s2t.losses, '#f87171'], ['WIN %', wr2 + '%', Number(wr2) >= 50 ? '#4ade80' : '#f87171']].map(([lbl, val, col]) =>
              `<div style="background:rgba(0,0,0,.5);border-radius:10px;padding:8px 6px;text-align:center;border:1px solid rgba(255,255,255,.08)">
                <div style="font-size:22px;font-weight:900;color:${col};line-height:1">${val}</div>
                <div style="font-size:8px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.1em;margin-top:2px">${lbl}</div>
              </div>`).join('')}
          </div>
        </div>
      </div>
    </div>

    <!-- BÄ°REBÄ°R Ä°STATÄ°STÄ°K ÅERÄ°DÄ° -->
    <div style="position:relative;z-index:4;background:rgba(0,0,0,.8);border-top:1px solid rgba(255,255,255,.08);border-bottom:1px solid rgba(255,255,255,.08);padding:20px 44px;">
      <div style="font-size:11px;color:rgba(255,255,255,.3);letter-spacing:.4em;text-transform:uppercase;text-align:center;margin-bottom:12px;font-weight:800">âš”ï¸ BÄ°REBÄ°R Ã–ZET</div>
      <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:24px">
        <!-- Sol psikolojik Ã¼stÃ¼nlÃ¼k -->
        <div style="text-align:right">
          <div style="font-size:14px;font-weight:800;color:${tc1};letter-spacing:.1em;text-transform:uppercase">${p1.name}</div>
          <div style="font-size:56px;font-weight:900;color:${tc1};line-height:1;text-shadow:0 0 20px ${tc1}60">${h1.wins}</div>
          <div style="font-size:10px;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:.15em">Galibiyet</div>
          <div style="font-size:22px;font-weight:900;margin-top:4px;color:${p1Pct>=50?tc1:'rgba(255,255,255,.4)'}">${p1Pct}%</div>
          <div style="font-size:10px;color:rgba(255,255,255,.3)">Psikolojik Ã¼stÃ¼nlÃ¼k</div>
        </div>
        <!-- Orta VS + toplam -->
        <div style="text-align:center;padding:0 20px;border-left:1px solid rgba(255,255,255,.08);border-right:1px solid rgba(255,255,255,.08)">
          <div style="font-size:12px;font-weight:900;color:rgba(255,255,255,.25);letter-spacing:.3em;margin-bottom:8px">TOPLAM</div>
          <div style="font-size:42px;font-weight:900;color:rgba(255,255,255,.6);line-height:1">${total}</div>
          <div style="font-size:10px;color:rgba(255,255,255,.25);margin-top:4px;text-transform:uppercase;letter-spacing:.15em">karÅŸÄ±laÅŸma</div>
          <div style="margin-top:12px;font-size:11px;font-weight:700;color:${psychColor};padding:5px 12px;background:rgba(0,0,0,.4);border-radius:20px;border:1px solid ${psychColor}40;white-space:nowrap">${psychLabel}</div>
        </div>
        <!-- SaÄŸ psikolojik Ã¼stÃ¼nlÃ¼k -->
        <div style="text-align:left">
          <div style="font-size:14px;font-weight:800;color:${tc2};letter-spacing:.1em;text-transform:uppercase">${p2.name}</div>
          <div style="font-size:56px;font-weight:900;color:${tc2};line-height:1;text-shadow:0 0 20px ${tc2}60">${h2.wins}</div>
          <div style="font-size:10px;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:.15em">Galibiyet</div>
          <div style="font-size:22px;font-weight:900;margin-top:4px;color:${p2Pct>=50?tc2:'rgba(255,255,255,.4)'}">${p2Pct}%</div>
          <div style="font-size:10px;color:rgba(255,255,255,.3)">Psikolojik Ã¼stÃ¼nlÃ¼k</div>
        </div>
      </div>
      <!-- H2H bant -->
      <div style="margin-top:16px;height:10px;border-radius:5px;overflow:hidden;background:rgba(255,255,255,.08);display:flex">
        <div style="width:${p1Pct}%;background:linear-gradient(to right,${tc1}cc,${tc1});border-radius:5px 0 0 5px;"></div>
        <div style="width:${p2Pct}%;background:linear-gradient(to right,${tc2},${tc2}cc);border-radius:0 5px 5px 0;"></div>
      </div>
    </div>

    <!-- NET PUAN KARÅILAÅTIRMASI -->
    <div style="position:relative;z-index:3;background:rgba(0,0,0,.5);padding:16px 44px;border-bottom:1px solid rgba(255,255,255,.06)">
      <div style="font-size:11px;color:rgba(255,255,255,.3);letter-spacing:.35em;text-transform:uppercase;margin-bottom:12px;font-weight:800">ğŸ“Š GENEL Ä°STATÄ°STÄ°K KARÅILAÅTIRMASI</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <!-- p1 istatistik Ã§ubuÄŸu -->
        <div style="display:flex;flex-direction:column;gap:8px">
          ${[['Win Rate', Number(wr1), Number(wr2), '%', '#4ade80', '#f87171'],
             ['Galibiyet', s1t.wins, s2t.wins, '', '#4ade80', '#4ade80'],
             ['Net Puan', score1, score2, '', score1>=0?'#4ade80':'#f87171', score2>=0?'#4ade80':'#f87171']].map(([lbl, v1, v2, sfx, c1, c2]) => {
               const max = Math.max(Math.abs(v1), Math.abs(v2), 1);
               const bar1 = Math.round((Math.abs(v1)/max)*100);
               const bar2 = Math.round((Math.abs(v2)/max)*100);
               return `<div>
                 <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                   <span style="font-size:11px;font-weight:800;color:${c1}">${v1>=0?'':'-'}${Math.abs(v1)}${sfx}</span>
                   <span style="font-size:10px;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:.12em">${lbl}</span>
                   <span style="font-size:11px;font-weight:800;color:${c2}">${v2>=0?'':'-'}${Math.abs(v2)}${sfx}</span>
                 </div>
                 <div style="height:6px;border-radius:3px;overflow:hidden;background:rgba(255,255,255,.08);display:flex">
                   <div style="width:${bar1}%;background:${c1};opacity:.8;border-radius:3px 0 0 3px"></div>
                   <div style="flex:1"></div>
                 </div>
               </div>`;
             }).join('')}
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:22px">
          ${[['Win Rate', Number(wr1), Number(wr2), '%', '#4ade80', '#f87171'],
             ['Galibiyet', s1t.wins, s2t.wins, '', '#4ade80', '#4ade80'],
             ['Net Puan', score1, score2, '', score1>=0?'#4ade80':'#f87171', score2>=0?'#4ade80':'#f87171']].map(([lbl, v1, v2, sfx, c1, c2]) => {
               const max = Math.max(Math.abs(v1), Math.abs(v2), 1);
               const bar2 = Math.round((Math.abs(v2)/max)*100);
               return `<div>
                 <div style="height:6px;border-radius:3px;overflow:hidden;background:rgba(255,255,255,.08);display:flex;justify-content:flex-end">
                   <div style="flex:1"></div>
                   <div style="width:${bar2}%;background:${c2};opacity:.8;border-radius:0 3px 3px 0"></div>
                 </div>
               </div>`;
             }).join('')}
        </div>
      </div>
    </div>

    <!-- BÄ°REBÄ°R MAÃ‡LARIN GEÃ‡MÄ°ÅÄ° -->
    <div style="position:relative;z-index:3;padding:16px 44px;border-bottom:1px solid rgba(255,255,255,.06)">
      <div style="font-size:11px;color:rgba(255,255,255,.3);letter-spacing:.35em;text-transform:uppercase;margin-bottom:12px;font-weight:800">ğŸ—‚ï¸ BÄ°REBÄ°R MAÃ‡ GEÃ‡MÄ°ÅÄ° (${p1.name} perspektifinden)</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">${h2hFormBars}</div>
      ${h2hGames.length > 0 ? `<div style="font-size:10px;color:rgba(255,255,255,.2);margin-top:8px">Son ${h2hGames.length} karÅŸÄ±laÅŸma â€” ${total} toplam</div>` : ''}
    </div>

    <!-- ATIÅ TÄ°PÄ° KARÅILAÅTIRMA -->
    ${(atis1.length > 0 || atis2.length > 0) ? `<div style="position:relative;z-index:3;padding:16px 44px;border-bottom:1px solid rgba(255,255,255,.06)">
      <div style="font-size:11px;color:rgba(255,255,255,.3);letter-spacing:.35em;text-transform:uppercase;margin-bottom:12px;font-weight:800">ğŸ¯ ATIÅ TÄ°PÄ° BAÅARISI</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <div style="font-size:10px;font-weight:800;color:${tc1};letter-spacing:.2em;margin-bottom:8px">${p1.name}</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            ${atis1.map(({at, st}) => { const wr = Math.round((st.wins/st.total)*100); const c = wr>=60?'#22c55e':wr>=40?'#f59e0b':'#ef4444'; return `<div style="background:rgba(0,0,0,.5);border-radius:8px;padding:8px;text-align:center;border:1px solid ${c}40;min-width:60px"><div style="font-size:18px">${atisIcons[at]||'ğŸ¯'}</div><div style="font-size:14px;font-weight:900;color:${c}">${wr}%</div><div style="font-size:9px;color:rgba(255,255,255,.3)">${st.wins}G/${st.total}</div></div>`; }).join('')}
          </div>
        </div>
        <div>
          <div style="font-size:10px;font-weight:800;color:${tc2};letter-spacing:.2em;margin-bottom:8px">${p2.name}</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            ${atis2.map(({at, st}) => { const wr = Math.round((st.wins/st.total)*100); const c = wr>=60?'#22c55e':wr>=40?'#f59e0b':'#ef4444'; return `<div style="background:rgba(0,0,0,.5);border-radius:8px;padding:8px;text-align:center;border:1px solid ${c}40;min-width:60px"><div style="font-size:18px">${atisIcons[at]||'ğŸ¯'}</div><div style="font-size:14px;font-weight:900;color:${c}">${wr}%</div><div style="font-size:9px;color:rgba(255,255,255,.3)">${st.wins}G/${st.total}</div></div>`; }).join('')}
          </div>
        </div>
      </div>
    </div>` : ''}

    <!-- OTOMATÄ°K YORUM -->
    <div style="position:relative;z-index:3;padding:16px 44px;flex:1;">
      <div style="font-size:11px;color:rgba(255,255,255,.3);letter-spacing:.35em;text-transform:uppercase;margin-bottom:10px;font-weight:800">ğŸ¤– ANALÄ°Z</div>
      <div style="background:rgba(255,255,255,.04);border-radius:12px;padding:14px 18px;border:1px solid rgba(255,255,255,.08)">
        <div style="font-size:14px;color:rgba(255,255,255,.7);line-height:1.8;font-family:'Barlow Condensed',sans-serif;">
          <div style="margin-bottom:6px">â€¢ <strong style="color:white">${psychLabel}</strong> â€” Toplam ${total} karÅŸÄ±laÅŸmada ${p1.name} ${h1.wins}, ${p2.name} ${h2.wins} galibiyet aldÄ±.</div>
          <div style="margin-bottom:6px">â€¢ ${p1Pct > 60 ? `<strong style="color:${tc1}">${p1.name}</strong> bu karÅŸÄ±laÅŸmada net favori konumunda.` : p2Pct > 60 ? `<strong style="color:${tc2}">${p2.name}</strong> bu karÅŸÄ±laÅŸmada net favori konumunda.` : 'Ä°ki yarÄ±ÅŸmacÄ± psikolojik olarak birbirine Ã§ok yakÄ±n gÃ¼Ã§te.'}</div>
          <div>â€¢ Genel performansta ${Number(wr1) > Number(wr2) ? `<strong style="color:${tc1}">${p1.name}</strong> daha yÃ¼ksek kazanma oranÄ±na sahip (%${wr1} vs %${wr2}).` : Number(wr2) > Number(wr1) ? `<strong style="color:${tc2}">${p2.name}</strong> daha yÃ¼ksek kazanma oranÄ±na sahip (%${wr2} vs %${wr1}).` : 'Her iki yarÄ±ÅŸmacÄ±nÄ±n genel performansÄ± birbirine eÅŸit.'}</div>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <div style="position:relative;z-index:5;background:rgba(0,0,0,.9);border-top:1px solid rgba(255,255,255,.08);padding:12px 44px;display:flex;justify-content:space-between;align-items:center;">
      <div style="display:flex;align-items:center;gap:8px">
        <div style="width:6px;height:6px;border-radius:50%;background:#ef4444;box-shadow:0 0 6px #ef4444"></div>
        <span style="font-size:10px;color:rgba(255,255,255,.3);letter-spacing:.2em;text-transform:uppercase;font-weight:700">SURVIVORMETRICS</span>
      </div>
      <span style="font-size:10px;color:rgba(255,255,255,.2);letter-spacing:.1em;font-weight:700">${dateStr}</span>
    </div>
  </div>`;
}

function downloadH2HDesignImage() {
  const cvDiv = document.getElementById('h2h_design_canvas');
  if (!cvDiv || !cvDiv.innerHTML.trim()) { alert('Ã–nce tasarÄ±m oluÅŸturun.'); return; }
  const inner = cvDiv.querySelector('#h2h_design_inner') || cvDiv.firstElementChild;
  if (!inner) return;
  _downloadDesignHD(inner, 'h2h-tasarim-' + Date.now() + '.png');
}

// ============================================================
// HD TASARIM Ä°NDÄ°RME - Native Canvas API (kalite kaybÄ± yok)
// html2canvas yerine DOM â†’ Canvas yaklaÅŸÄ±mÄ± ile HD export
// ============================================================
function _downloadDesignHD(element, filename) {
  // â”€â”€ Img'leri data URL'ye Ã§evir (content:// sorununu Ã§Ã¶zer) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const imgs = Array.from(element.querySelectorAll('img'));
  const originalSrcs = imgs.map(img => img.src);

  // content:// veya http:// gibi "dÄ±ÅŸarÄ±dan" gelen src â†’ fetch blob â†’ data URL
  function convertImg(img) {
    return new Promise(resolve => {
      const src = img.src;
      if (!src || src.startsWith('data:') || src.startsWith('blob:')) {
        // Zaten base64 ya da blob â€” doÄŸrudan canvas'a aktar
        if (src && src.startsWith('blob:') && img.naturalWidth > 0) {
          try {
            const c = document.createElement('canvas');
            c.width = img.naturalWidth; c.height = img.naturalHeight;
            c.getContext('2d').drawImage(img, 0, 0);
            img.src = c.toDataURL('image/jpeg', 0.9);
          } catch(e) {}
        }
        resolve(); return;
      }
      // content:// veya file:// â†’ fetch ile oku
      fetch(src)
        .then(r => r.blob())
        .then(blob => {
          const reader = new FileReader();
          reader.onload = e => { img.src = e.target.result; resolve(); };
          reader.onerror = () => resolve();
          reader.readAsDataURL(blob);
        })
        .catch(() => {
          // fetch baÅŸarÄ±sÄ±z â€” canvas taint dene
          if (img.naturalWidth > 0) {
            try {
              const c = document.createElement('canvas');
              c.width = img.naturalWidth; c.height = img.naturalHeight;
              c.getContext('2d').drawImage(img, 0, 0);
              img.src = c.toDataURL('image/jpeg', 0.9);
            } catch(e2) {}
          }
          resolve();
        });
    });
  }

  // 1. YÃ¼klenmeyi bekle
  Promise.all(imgs.map(img => new Promise(resolve => {
    if (img.complete && img.naturalWidth > 0) resolve();
    else { img.onload = resolve; img.onerror = resolve; setTimeout(resolve, 3000); }
  })))
  // 2. content:// â†’ data:// Ã§evir
  .then(() => Promise.all(imgs.map(convertImg)))
  // 3. Biraz bekle (src deÄŸiÅŸimi iÃ§in)
  .then(() => new Promise(resolve => setTimeout(resolve, 120)))
  // 4. html2canvas ile render et â€” scale:2 yeterli kalite, daha az bellek
  .then(() => {
    const w = element.offsetWidth || 1080;
    const h = element.offsetHeight || element.scrollHeight || 700;
    return html2canvas(element, {
      scale: 2,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#060810',
      width: w, height: h,
      windowWidth: w, windowHeight: h,
      logging: false,
      imageTimeout: 25000,
      removeContainer: true,
      onclone: (doc) => {
        Array.from(doc.querySelectorAll('img')).forEach(img => {
          img.crossOrigin = '';
        });
      }
    });
  })
  .then(canvas => {
    // 5. Ä°ndir
    const link = document.createElement('a');
    link.download = filename;
    link.href = canvas.toDataURL('image/png', 1.0);
    document.body.appendChild(link);
    link.click();
    setTimeout(() => link.parentNode && link.parentNode.removeChild(link), 600);
    // 6. Orijinal src'leri geri yÃ¼kle
    imgs.forEach((img, i) => { try { if (originalSrcs[i]) img.src = originalSrcs[i]; } catch(e){} });
  })
  .catch(err => {
    console.error('Ä°ndirme hatasÄ±:', err);
    // Scale:1 ile son Ã§are
    const w2 = element.offsetWidth || 1080;
    const h2 = element.offsetHeight || 700;
    html2canvas(element, {
      scale: 1,
      allowTaint: true,
      useCORS: false,
      backgroundColor: '#060810',
      width: w2, height: h2,
      logging: false,
      removeContainer: true
    }).then(c2 => {
      const lnk = document.createElement('a');
      lnk.download = filename;
      lnk.href = c2.toDataURL('image/jpeg', 0.92);
      document.body.appendChild(lnk);
      lnk.click();
      setTimeout(() => lnk.parentNode && lnk.parentNode.removeChild(lnk), 600);
      imgs.forEach((img, i) => { try { if (originalSrcs[i]) img.src = originalSrcs[i]; } catch(e){} });
    }).catch(() => {
      alert('TasarÄ±m indirilemedi. FotoÄŸraf olmadan tekrar deneyin ya da tarayÄ±cÄ±yÄ± yenileyip deneyiniz.');
      imgs.forEach((img, i) => { try { if (originalSrcs[i]) img.src = originalSrcs[i]; } catch(e){} });
    });
  });
}

</script>
</body>
</html>
